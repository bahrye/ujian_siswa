<script>
  // ===========================================
  // MODULE: APPLICATION LOGIC (FULL & UPDATED)
  // ===========================================
  const App = {
    // --- Global Variables ---
    data: {
      role: '',
      user: null,
      soalList: [],
      userList: [],
      mapelList: [],
      jenisUjianList: [], // Data Baru
      jadwalList: [],     // Data Baru
      jawabanSiswa: {},
      raguSiswa: {},
      opsiImages: { A:null, B:null, C:null, D:null, E:null },
      examRunning: false,
      timer: null,
      timeLeft: 0,
      currentSoalIdx: 0,
      quill: null
    },

    // --- Module 0: Caching System ---
    Cache: {
      store: {},
      get: function(key) { return this.store[key] || null; },
      set: function(key, data) { this.store[key] = data; },
      remove: function(key) { delete this.store[key]; },
      clearPattern: function(pattern) {
        Object.keys(this.store).forEach(key => {
          if (key.includes(pattern)) delete this.store[key];
        });
      },
      clearAll: function() { this.store = {}; }
    },

    // --- Module 1: Authentication ---
    Auth: {
      login: function(e) {
        e.preventDefault();
        const u = document.getElementById('user').value;
        const p = document.getElementById('pass').value;
        const btn = document.getElementById('btnLogin');
        
        App.UI.setLoading(btn, true, 'MEMERIKSA...');
        
        google.script.run.withSuccessHandler((res) => {
          App.UI.setLoading(btn, false, 'MASUK');
          if (res.status === 'success') {
            const sess = { role: res.role, nama: res.nama, data: res };
            sessionStorage.setItem('cbt_session', JSON.stringify(sess));
            sessionStorage.setItem('last_activity', Date.now());
            App.data.role = res.role;
            if (res.role === 'siswa') App.Exam.initSiswa(res); 
            else App.Dashboard.init(res);
          } else {
            Swal.fire('Login Gagal', res.message, 'error');
          }
        }).withFailureHandler((err) => {
          App.UI.setLoading(btn, false, 'MASUK');
          Swal.fire('Error', err.message, 'error');
        }).loginUser(u, p);
      },

      logout: function() {
        Swal.fire({ title: 'Keluar?', text: "Akhiri sesi.", icon: 'warning', showCancelButton: true, confirmButtonText: 'Ya' })
        .then((result) => { if (result.isConfirmed) App.Auth.forceLogout(); });
      },

      forceLogout: function() {
        sessionStorage.clear();
        App.Cache.clearAll();
        App.Util.resetGlobals();
        App.UI.showLoginOnly();
        document.getElementById('user').value = "";
        document.getElementById('pass').value = "";
      },

      checkSession: function() {
        const sess = sessionStorage.getItem('cbt_session');
        if (sess) {
          const user = JSON.parse(sess);
          App.data.role = user.role;
          if (user.role === 'siswa') {
            document.getElementById('login-container').classList.add('hidden');
            Swal.fire('Info', 'Reload terdeteksi. Masukkan Mapel kembali.', 'info').then(() => App.Exam.initSiswa(user.data));
          } else {
            App.Dashboard.init(user.data);
          }
        } else {
          App.UI.showLoginOnly();
        }
      }
    },

    // --- Module 2: Dashboard UI & Navigation ---
    Dashboard: {
      init: function(user) {
        document.getElementById('login-container').classList.add('hidden');
        document.getElementById('dashboard-container').classList.remove('hidden');
        document.getElementById('dash-nama').innerText = user.nama;
        document.getElementById('dash-initial').innerText = user.nama.charAt(0);
        document.getElementById('dash-role').innerText = user.role;
        App.Dashboard.renderMenu(user.role);
        App.Dashboard.loadStats();
      },

      renderMenu: function(role) {
        const menuContainer = document.getElementById('sidebar-menu');
        menuContainer.innerHTML = '';
        
        // DEFINISI MENU STRICT SESUAI REQUEST
        let menus = [];
        
        if (role === 'admin') {
           menus = [
             { id: 'dashboard', icon: 'fa-home', label: 'Dashboard' },
             { id: 'akun', icon: 'fa-users-cog', label: 'Kelola User' },
             { id: 'mapel', icon: 'fa-tags', label: 'Kelola Mapel' },
             { id: 'bank-soal', icon: 'fa-file-alt', label: 'Bank Soal' },
             { id: 'ujian', icon: 'fa-calendar-alt', label: 'Kelola Ujian' },
             { id: 'admin-monitoring', icon: 'fa-desktop', label: 'Monitoring Live' }, // Menu Baru
             { id: 'admin-hasil', icon: 'fa-poll', label: 'Hasil Ujian' },           // Menu Baru
           ];
        } else if (role === 'guru') {
           menus = [
             { id: 'dashboard', icon: 'fa-home', label: 'Dashboard' },
             { id: 'bank-soal', icon: 'fa-file-alt', label: 'Bank Soal' },
             { id: 'hasil', icon: 'fa-poll', label: 'Hasil Ujian' },
           ];
        } else if (role === 'pengawas') {
           menus = [
             { id: 'dashboard', icon: 'fa-home', label: 'Dashboard' },
             { id: 'pengawas-area', icon: 'fa-eye', label: 'Monitoring & Token' },
           ];
        } else if (role === 'siswa') {
           menus = [
             { id: 'dashboard', icon: 'fa-home', label: 'Dashboard' },
             { id: 'jadwal-siswa', icon: 'fa-pencil-alt', label: 'Jadwal Ujian' },
           ];
        }

        menus.forEach(m => {
            const isActive = m.id === 'dashboard' ? 'bg-slate-800 border-l-4 border-indigo-500' : 'hover:bg-slate-800 text-gray-400 hover:text-white';
            menuContainer.insertAdjacentHTML('beforeend', `<button onclick="App.UI.switchView('${m.id}', this)" class="nav-item w-full flex items-center gap-3 px-6 py-3 transition text-left ${isActive}"><i class="fas ${m.icon} w-5"></i> <span>${m.label}</span></button>`);
        });
      },

      loadStats: function(forceRefresh = false) {
        if (!forceRefresh && App.Cache.get('stats')) {
           App.Dashboard.renderStats(App.Cache.get('stats')); return;
        }
        google.script.run.withSuccessHandler(stats => {
           App.Cache.set('stats', stats);
           App.Dashboard.renderStats(stats);
           const btn = document.getElementById('btn-refresh-dash');
           if(btn) btn.classList.remove('fa-spin');
        }).getDashboardStats();
      },

      renderStats: function(stats) {
         document.getElementById('stat-user').innerText = stats.users;
         document.getElementById('stat-soal').innerText = stats.soals;
         document.getElementById('stat-nilai').innerText = stats.nilais;
      }
    },

    // --- Module 3: Bank Soal Management ---
    BankSoal: {
      toggleForm: function(show) {
        if(show) {
           document.getElementById('bs-list-section').classList.add('hidden');
           document.getElementById('bs-form-section').classList.remove('hidden');
           setTimeout(App.BankSoal.initQuill, 100);
           if(!document.getElementById('soal-id').value) App.BankSoal.resetForm();
        } else {
           document.getElementById('bs-list-section').classList.remove('hidden');
           document.getElementById('bs-form-section').classList.add('hidden');
           App.BankSoal.resetForm();
        }
      },

      initQuill: function() {
        if (App.data.quill != null) return;
        const container = document.getElementById('editor-container');
        if (container && container.previousElementSibling?.classList.contains('ql-toolbar')) container.previousElementSibling.remove();
        
        let modulesConfig = { toolbar: [['bold', 'italic', 'underline'], [{ 'list': 'ordered'}, { 'list': 'bullet' }], ['image', 'formula']] };
        if (window.Quill && window.ImageResize) { Quill.register('modules/imageResize', window.ImageResize.default || window.ImageResize); modulesConfig.imageResize = { displaySize: true }; }
        
        App.data.quill = new Quill('#editor-container', { theme: 'snow', placeholder: 'Tulis pertanyaan...', modules: modulesConfig });
      },

      loadOptionsMapel: function() {
         if(App.Cache.get('mapel_opts')) {
             App.BankSoal.renderOptionsMapel(App.Cache.get('mapel_opts'));
             App.BankSoal.loadDaftar();
             return;
         }
         google.script.run.withSuccessHandler(data => {
            App.Cache.set('mapel_opts', data);
            App.BankSoal.renderOptionsMapel(data);
            App.BankSoal.loadDaftar();
         }).getAllMapel();
      },

      renderOptionsMapel: function(data) {
         const selFilter = document.getElementById('filter-mapel'); 
         const selForm = document.getElementById('soal-mapel-select');
         const oldFilter = selFilter.value;
         selFilter.innerHTML = '<option value="">- Tampilkan Semua -</option>';
         selForm.innerHTML = '<option value="">-- Pilih Mapel --</option>';
         data.forEach(m => {
            const opt = `<option value="${m.kode}">${m.kode} - ${m.nama}</option>`;
            selFilter.insertAdjacentHTML('beforeend', opt);
            selForm.insertAdjacentHTML('beforeend', opt);
         });
         if(oldFilter) selFilter.value = oldFilter;
      },

      loadDaftar: function(forceRefresh = false) {
        const tbody = document.getElementById('tbody-soal');
        const filter = document.getElementById('filter-mapel').value;
        const cacheKey = 'soal_' + (filter || 'all');
        const btnRefresh = document.getElementById('btn-refresh-soal');

        if(forceRefresh && btnRefresh) btnRefresh.classList.add('fa-spin');

        if (!forceRefresh && App.Cache.get(cacheKey)) {
          App.BankSoal.renderTable(App.Cache.get(cacheKey));
          return;
        }

        tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>';
        
        google.script.run.withSuccessHandler(data => {
          if(btnRefresh) btnRefresh.classList.remove('fa-spin');
          App.Cache.set(cacheKey, data);
          App.BankSoal.renderTable(data);
        }).getSoalAdmin(filter);
      },

      renderTable: function(data) {
        const tbody = document.getElementById('tbody-soal');
        tbody.innerHTML = '';
        if (data.length === 0) { tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-400">Tidak ada soal.</td></tr>'; return; }
        
        data.forEach((s, idx) => {
             const tmp = document.createElement("DIV"); tmp.innerHTML = s.soal;
             let snippet = tmp.textContent || tmp.innerText || "";
             if(snippet.length > 50) snippet = snippet.substring(0, 50) + "...";
             if(s.soal.includes('<img')) snippet = "ðŸ“· " + snippet;
             
             const dataStr = encodeURIComponent(JSON.stringify(s));
             const row = `
               <tr class="hover:bg-slate-50 border-b border-gray-100">
                 <td class="p-4 text-center font-bold text-gray-500">${idx+1}</td>
                 <td class="p-4"><span class="bg-indigo-100 text-indigo-800 text-xs px-2 py-1 rounded font-bold">${s.tipe}</span><br><span class="text-xs text-gray-400">${s.mapel}</span></td>
                 <td class="p-4 text-gray-700 font-medium">${snippet}</td>
                 <td class="p-4 font-mono text-sm text-emerald-600 font-bold">${s.kunci || '-'}</td>
                 <td class="p-4 text-right">
                   <button onclick="App.BankSoal.edit('${dataStr}')" class="text-blue-600 mr-3"><i class="fas fa-edit"></i></button>
                   <button onclick="App.BankSoal.hapus('${s.id}')" class="text-red-500"><i class="fas fa-trash"></i></button>
                 </td>
               </tr>`;
             tbody.insertAdjacentHTML('beforeend', row);
        });
      },

      submit: function(e) {
        e.preventDefault();
        const idSoal = document.getElementById('soal-id').value;
        const mapel = document.getElementById('soal-mapel-select').value;
        const tipe = document.getElementById('tipe-soal').value;
        const htmlSoal = App.data.quill.root.innerHTML;

        if (App.data.quill.getText().trim().length === 0 && !htmlSoal.includes('<img')) return Swal.fire('Error', 'Pertanyaan kosong!', 'warning');

        let opsiData = {}; let kunciJawaban = "";
        if (tipe === 'PG') {
          opsiData = { A: document.getElementById('pg-a').value, B: document.getElementById('pg-b').value, C: document.getElementById('pg-c').value, D: document.getElementById('pg-d').value, E: document.getElementById('pg-e').value };
          ['A','B','C','D','E'].forEach(h => { if(App.data.opsiImages[h]) opsiData['img_'+h] = App.data.opsiImages[h]; });
          kunciJawaban = document.getElementById('kunci-pg').value;
          if((!opsiData.A && !opsiData.img_A) || (!opsiData.B && !opsiData.img_B)) return Swal.fire('Error', 'Min. Opsi A & B', 'warning');
        } 
        else if (tipe === 'ISIAN') kunciJawaban = document.getElementById('kunci-isian').value;
        else if (tipe === 'BS') { const r = document.querySelector('input[name="kunci_bs"]:checked'); kunciJawaban = r ? r.value : ""; opsiData = { A: "BENAR", B: "SALAH" }; }
        else if (tipe === 'COCOK') {
           const kiris = document.querySelectorAll('.cocok-kiri'); const kanans = document.querySelectorAll('.cocok-kanan');
           let pairs = []; kiris.forEach((el, idx) => { if(el.value && kanans[idx].value) pairs.push({ k: el.value, v: kanans[idx].value }); });
           if(pairs.length < 2) return Swal.fire('Warning','Min. 2 pasang','warning');
           opsiData = pairs; kunciJawaban = "COCOK_AUTO";
        } else { kunciJawaban = "MANUAL"; }

        const btn = document.getElementById('btnSave');
        App.UI.setLoading(btn, true, 'MENYIMPAN...');
        const payload = { id: idSoal, mapel: mapel, tipe: tipe, soal: htmlSoal, opsiJson: JSON.stringify(opsiData), kunci: kunciJawaban };
        
        google.script.run.withSuccessHandler((res) => {
           App.UI.setLoading(btn, false, 'SIMPAN SOAL');
           if(res.status === 'success') { 
             Swal.fire('Sukses', res.message, 'success'); 
             App.BankSoal.toggleForm(false); 
             App.Cache.clearPattern('soal_'); App.Cache.remove('stats'); // Reset Cache
             App.BankSoal.loadDaftar(true); 
           } else Swal.fire('Gagal', res.message, 'error');
        }).simpanSoal(payload);
      },

      edit: function(str) {
        const s = JSON.parse(decodeURIComponent(str));
        document.getElementById('soal-id').value = s.id;
        document.getElementById('form-soal-title').innerText = "Edit Soal";
        document.getElementById('btnSave').innerText = "UPDATE SOAL";
        App.BankSoal.toggleForm(true);
        document.getElementById('soal-mapel-select').value = s.mapel;
        document.getElementById('tipe-soal').value = s.tipe;
        App.data.quill.clipboard.dangerouslyPasteHTML(s.soal);
        App.BankSoal.changeType();
        let opsi = {}; try { opsi = JSON.parse(s.opsi); } catch(e){}
        if (s.tipe === 'PG') {
           ['A','B','C','D','E'].forEach(h => {
             document.getElementById('pg-'+h.toLowerCase()).value = opsi[h] || "";
             if(opsi['img_'+h]) { App.data.opsiImages[h] = opsi['img_'+h]; document.getElementById('prev-box-'+h).classList.remove('hidden'); document.getElementById('img-prev-'+h).src = opsi['img_'+h]; }
           });
           document.getElementById('kunci-pg').value = s.kunci;
        } 
        else if (s.tipe === 'ISIAN') document.getElementById('kunci-isian').value = s.kunci;
        else if (s.tipe === 'BS') { const radios = document.getElementsByName('kunci_bs'); for(let r of radios) { if(r.value === s.kunci) r.checked = true; } }
        else if (s.tipe === 'COCOK') {
           const container = document.getElementById('container-cocok'); container.innerHTML = "";
           if(Array.isArray(opsi)) opsi.forEach(p => App.BankSoal.addRowCocok(p.k, p.v));
        }
      },

      hapus: function(id) {
        Swal.fire({ title: 'Hapus?', text: "Tak bisa balik.", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33' })
        .then((r) => { 
            if (r.isConfirmed) {
                google.script.run.withSuccessHandler(res => { 
                    App.Cache.clearPattern('soal_'); App.Cache.remove('stats');
                    App.BankSoal.loadDaftar(true); 
                    Swal.fire('Deleted', res.message, 'success'); 
                }).hapusSoalDb(id); 
            }
        });
      },

      resetForm: function() {
        document.getElementById('formSoal').reset();
        document.getElementById('soal-id').value = "";
        document.getElementById('form-soal-title').innerText = "Input Soal Baru";
        document.getElementById('btnSave').innerText = "SIMPAN SOAL";
        if(App.data.quill) App.data.quill.setContents([]);
        App.BankSoal.changeType();
        ['A','B','C','D','E'].forEach(h => App.BankSoal.removeImage(h));
      },
      changeType: function() {
        const tipe = document.getElementById('tipe-soal').value;
        document.querySelectorAll('.opsi-area').forEach(el => el.classList.add('hidden'));
        if (tipe === 'PG') document.getElementById('area-pg').classList.remove('hidden');
        if (tipe === 'ISIAN') document.getElementById('area-isian').classList.remove('hidden');
        if (tipe === 'ESSAY') document.getElementById('area-essay').classList.remove('hidden');
        if (tipe === 'BS') document.getElementById('area-bs').classList.remove('hidden');
        if (tipe === 'COCOK') { document.getElementById('area-cocok').classList.remove('hidden'); if(document.getElementById('container-cocok').children.length === 0) App.BankSoal.addRowCocok(); }
      },
      handleImage: function(input, hur) {
        if (input.files && input.files[0]) {
          const file = input.files[0];
          if(file.size > 2 * 1024 * 1024) return Swal.fire('Max 2MB', '', 'warning');
          const reader = new FileReader();
          reader.onload = (e) => { const b64 = e.target.result; App.data.opsiImages[hur] = b64; document.getElementById('prev-box-'+hur).classList.remove('hidden'); document.getElementById('img-prev-'+hur).src = b64; }
          reader.readAsDataURL(file);
        }
      },
      removeImage: function(hur) {
        App.data.opsiImages[hur] = null; document.getElementById('file-'+hur.toLowerCase()).value = ""; document.getElementById('prev-box-'+hur).classList.add('hidden'); document.getElementById('img-prev-'+hur).src = "";
      },
      addRowCocok: function(k='', v='') {
        const div = document.createElement('div'); div.className = 'flex gap-2 items-center';
        div.innerHTML = `<input type="text" class="input-std text-sm cocok-kiri" value="${k}" placeholder="Kiri"><i class="fas fa-arrow-right text-gray-400"></i><input type="text" class="input-std text-sm cocok-kanan" value="${v}" placeholder="Kanan"><button type="button" onclick="this.parentElement.remove()" class="text-red-400 px-2"><i class="fas fa-times"></i></button>`;
        document.getElementById('container-cocok').appendChild(div);
      }
    },

    // --- Module 4: Users Management ---
    User: {
      loadAll: function(forceRefresh = false) {
        const tbody = document.getElementById('tbody-users');
        const btnRefresh = document.getElementById('btn-refresh-user');
        if(forceRefresh && btnRefresh) btnRefresh.classList.add('fa-spin');
        if (!forceRefresh && App.Cache.get('users')) {
            App.data.userList = App.Cache.get('users'); App.User.render(App.data.currentTabRole || 'all'); return;
        }
        tbody.innerHTML = '<tr><td colspan="5" class="p-6 text-center">Loading...</td></tr>';
        google.script.run.withSuccessHandler(data => {
            if(btnRefresh) btnRefresh.classList.remove('fa-spin');
            App.Cache.set('users', data); App.data.userList = data; App.User.render(App.data.currentTabRole || 'all');
        }).getAllUsers();
      },
      render: function(role) {
        const tbody = document.getElementById('tbody-users'); tbody.innerHTML = '';
        const filtered = (role === 'all') ? App.data.userList : App.data.userList.filter(u => u.role.toLowerCase() === role);
        if (filtered.length === 0) { tbody.innerHTML = '<tr><td colspan="5" class="p-6 text-center text-gray-400">Belum ada data.</td></tr>'; return; }
        filtered.forEach(u => {
           let badge = 'bg-gray-100 text-gray-800'; if(u.role==='admin') badge='bg-red-100 text-red-800'; if(u.role==='guru') badge='bg-blue-100 text-blue-800'; if(u.role==='siswa') badge='bg-green-100 text-green-800';
           const status = (u.status === 'Aktif') ? '<span class="px-2 py-0.5 rounded text-xs font-bold bg-green-100 text-green-700">Aktif</span>' : '<span class="px-2 bg-gray-200 text-gray-500 text-xs rounded">Nonaktif</span>';
           let actions = (u.role === 'admin') ? '<span class="text-xs italic text-gray-400">Locked</span>' : `<button onclick="App.User.edit('${encodeURIComponent(JSON.stringify(u))}')" class="text-indigo-600 mr-3"><i class="fas fa-edit"></i></button><button onclick="App.User.hapus('${u.id}', '${u.nama}')" class="text-red-500"><i class="fas fa-trash"></i></button>`;
           tbody.insertAdjacentHTML('beforeend', `<tr class="hover:bg-slate-50 transition"><td class="p-4 font-semibold text-gray-700">${u.nama}</td><td class="p-4"><div class="flex flex-col"><span class="text-xs text-gray-500 mb-1 font-mono">${u.username}</span><span class="w-fit px-2 py-0.5 rounded text-[10px] font-bold border uppercase ${badge}">${u.role}</span></div></td><td class="p-4 text-gray-600">${u.kelas || '-'}</td><td class="p-4">${status}</td><td class="p-4 text-right">${actions}</td></tr>`);
        });
      },
      filterTab: function(role, btn) {
        App.data.currentTabRole = role;
        document.querySelectorAll('.tab-btn').forEach(b => { b.classList.remove('bg-indigo-100', 'text-indigo-700'); b.classList.add('text-gray-500', 'hover:bg-gray-50'); });
        btn.classList.remove('text-gray-500', 'hover:bg-gray-50'); btn.classList.add('bg-indigo-100', 'text-indigo-700');
        App.User.render(role);
      },
      save: function(e) {
        e.preventDefault(); const btn = document.getElementById('btnSimpanUser'); App.UI.setLoading(btn, true, 'Simpan');
        const data = { id: document.getElementById('u-id').value, role: document.getElementById('u-role').value, nama: document.getElementById('u-nama').value, username: document.getElementById('u-username').value, password: document.getElementById('u-password').value, kelas: document.getElementById('u-kelas').value, status: document.getElementById('u-status').value };
        google.script.run.withSuccessHandler(res => { 
            App.UI.setLoading(btn, false, 'Simpan'); 
            if(res.status === 'success') { 
                App.UI.closeModal('modal-user'); Swal.fire('Sukses', res.message, 'success'); 
                App.Cache.remove('users'); App.Cache.remove('stats'); App.User.loadAll(true); 
            } else Swal.fire('Gagal', res.message, 'error'); 
        }).simpanUser(data);
      },
      edit: function(enc) {
        const u = JSON.parse(decodeURIComponent(enc));
        App.UI.openModal('modal-user'); document.getElementById('modal-title').innerText = "Edit User";
        document.getElementById('u-id').value = u.id; document.getElementById('u-role').value = u.role.toLowerCase(); document.getElementById('u-nama').value = u.nama; document.getElementById('u-username').value = u.username; document.getElementById('u-password').value = u.password; document.getElementById('u-kelas').value = u.kelas; document.getElementById('u-status').value = u.status || 'Aktif';
        App.User.toggleKelasInput();
      },
      hapus: function(id, nama) { 
          Swal.fire({ title: 'Hapus?', text: nama, icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33' })
          .then((r) => { if (r.isConfirmed) { google.script.run.withSuccessHandler(res => { if(res.status === 'success') { Swal.fire('Terhapus', '', 'success'); App.Cache.remove('users'); App.Cache.remove('stats'); App.User.loadAll(true); } else Swal.fire('Gagal', res.message, 'error'); }).hapusUser(id); }}); 
      },
      modalOpen: function() { App.UI.openModal('modal-user'); document.getElementById('modal-title').innerText = "Tambah User"; document.getElementById('u-id').value = ""; document.getElementById('u-role').value = "siswa"; document.getElementById('u-nama').value = ""; document.getElementById('u-username').value = ""; document.getElementById('u-password').value = ""; document.getElementById('u-kelas').value = ""; App.User.toggleKelasInput(); },
      toggleKelasInput: function() { const r = document.getElementById('u-role').value; const div = document.getElementById('div-kelas'); if(r === 'siswa') div.classList.remove('hidden'); else div.classList.add('hidden'); }
    },

    // --- Module 5: Mapel Management ---
    Mapel: {
      load: function(forceRefresh = false) {
        const tbody = document.getElementById('tbody-mapel'); 
        const btnRefresh = document.getElementById('btn-refresh-mapel');
        if(forceRefresh && btnRefresh) btnRefresh.classList.add('fa-spin');
        if (!forceRefresh && App.Cache.get('mapel')) { App.Mapel.render(App.Cache.get('mapel')); return; }
        tbody.innerHTML = '<tr><td colspan="4" class="p-6 text-center">Loading...</td></tr>';
        google.script.run.withSuccessHandler(data => {
           if(btnRefresh) btnRefresh.classList.remove('fa-spin');
           App.Cache.set('mapel', data); App.Cache.set('mapel_opts', data); App.Mapel.render(data);
        }).getAllMapel();
      },
      render: function(data) {
        const tbody = document.getElementById('tbody-mapel'); tbody.innerHTML = ''; 
        if(data.length===0) { tbody.innerHTML = '<tr><td colspan="4" class="p-6 text-center text-gray-400">Kosong.</td></tr>'; return; }
        data.forEach(m => { tbody.insertAdjacentHTML('beforeend', `<tr class="hover:bg-slate-50 transition border-b border-gray-100"><td class="p-4 font-mono font-bold text-indigo-600">${m.kode}</td><td class="p-4 font-semibold text-gray-700">${m.nama}</td><td class="p-4 text-gray-600">${m.guru || '-'}</td><td class="p-4 text-right"><button onclick="App.Mapel.edit('${encodeURIComponent(JSON.stringify(m))}')" class="text-indigo-600 mr-3"><i class="fas fa-edit"></i></button><button onclick="App.Mapel.hapus('${m.id}', '${m.kode}')" class="text-red-500"><i class="fas fa-trash"></i></button></td></tr>`); });
      },
      save: function(e) {
        e.preventDefault(); const btn = document.getElementById('btnSimpanMapel'); App.UI.setLoading(btn, true, 'Simpan');
        const data = { id: document.getElementById('m-id').value, kode: document.getElementById('m-kode').value.toUpperCase(), nama: document.getElementById('m-nama').value, guru: document.getElementById('m-guru').value };
        google.script.run.withSuccessHandler(res => { 
            App.UI.setLoading(btn, false, 'Simpan'); 
            if(res.status === 'success') { App.UI.closeModal('modal-mapel'); Swal.fire('Sukses', res.message, 'success'); App.Cache.remove('mapel'); App.Mapel.load(true); } 
            else Swal.fire('Gagal', res.message, 'error'); 
        }).simpanMapel(data);
      },
      edit: function(enc) {
        const m = JSON.parse(decodeURIComponent(enc)); App.UI.openModal('modal-mapel'); document.getElementById('modal-mapel-title').innerText = "Edit Mapel"; document.getElementById('m-id').value = m.id; document.getElementById('m-kode').value = m.kode; document.getElementById('m-nama').value = m.nama;
        const selGuru = document.getElementById('m-guru'); selGuru.innerHTML = '<option>Loading...</option>';
        google.script.run.withSuccessHandler(gurus => { selGuru.innerHTML = '<option value="-">- Pilih Guru -</option>'; gurus.forEach(g => { selGuru.insertAdjacentHTML('beforeend', `<option value="${g}" ${g===m.guru?'selected':''}>${g}</option>`); }); }).getListGuru();
      },
      hapus: function(id, kode) { 
          Swal.fire({ title: 'Hapus?', text: kode, icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33' })
          .then(r => { if(r.isConfirmed) { google.script.run.withSuccessHandler(res => { if(res.status==='success') { App.Cache.remove('mapel'); App.Mapel.load(true); Swal.fire('Deleted','','success'); } else Swal.fire('Gagal', res.message, 'error'); }).hapusMapel(id); }}); 
      },
      modalOpen: function() { App.UI.openModal('modal-mapel'); document.getElementById('modal-mapel-title').innerText = "Tambah Mapel"; document.getElementById('m-id').value = ""; document.getElementById('m-kode').value = ""; document.getElementById('m-nama').value = ""; const selGuru = document.getElementById('m-guru'); selGuru.innerHTML = '<option value="-">Loading...</option>'; google.script.run.withSuccessHandler(gs => { selGuru.innerHTML = '<option value="-">- Pilih Guru -</option>'; gs.forEach(g => selGuru.insertAdjacentHTML('beforeend', `<option value="${g}">${g}</option>`)); }).getListGuru(); }
    },

    // ===========================================
    // MODULE 8: KELOLA UJIAN (BARU !!!)
    // ===========================================
    Ujian: {
      // A. Load Data
      loadJenis: function(force=false) {
        const tb = document.getElementById('tbody-jenis-ujian');
        const btn = document.getElementById('btn-refresh-ujian');
        if(force && btn) btn.classList.add('fa-spin');
        
        if(!force && App.Cache.get('jenis_ujian')) return App.Ujian.renderJenis(App.Cache.get('jenis_ujian'));

        tb.innerHTML = '<tr><td colspan="4" class="p-4 text-center">Loading...</td></tr>';
        google.script.run.withSuccessHandler(data => {
           if(btn) btn.classList.remove('fa-spin');
           App.Cache.set('jenis_ujian', data);
           App.data.jenisUjianList = data; // Simpan untuk dropdown jadwal
           App.Ujian.renderJenis(data);
           // Jika Jenis berubah, dropdown jadwal harus update
           App.Ujian.loadJadwal(true); 
        }).getJenisUjian();
      },

      loadJadwal: function(force=false) {
        const tb = document.getElementById('tbody-jadwal');
        if(!force && App.Cache.get('jadwal')) return App.Ujian.renderJadwal(App.Cache.get('jadwal'));

        tb.innerHTML = '<tr><td colspan="6" class="p-4 text-center">Loading...</td></tr>';
        google.script.run.withSuccessHandler(data => {
           App.Cache.set('jadwal', data);
           App.Ujian.renderJadwal(data);
        }).getJadwalUjian();
      },

      // B. Render Tables
      renderJenis: function(data) {
        const tb = document.getElementById('tbody-jenis-ujian'); tb.innerHTML = '';
        if(data.length===0) { tb.innerHTML='<tr><td colspan="4" class="p-4 text-center text-gray-400">Belum ada Nama Ujian.</td></tr>'; return; }
        
        data.forEach((item, i) => {
           const badge = item.status === 'Aktif' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
           const json = encodeURIComponent(JSON.stringify(item));
           tb.insertAdjacentHTML('beforeend', `
             <tr class="border-b hover:bg-slate-50">
               <td class="p-3 font-semibold text-gray-700">${item.nama}</td>
               <td class="p-3 text-sm text-gray-500">${item.ket || '-'}</td>
               <td class="p-3"><span class="px-2 py-1 rounded text-xs font-bold ${badge}">${item.status}</span></td>
               <td class="p-3 text-right">
                 <button onclick="App.Ujian.editJenis('${json}')" class="text-indigo-600 mr-2"><i class="fas fa-edit"></i></button>
                 <button onclick="App.Ujian.hapusJenis('${item.id}')" class="text-red-500"><i class="fas fa-trash"></i></button>
               </td>
             </tr>
           `);
        });
      },

      renderJadwal: function(data) {
        const tb = document.getElementById('tbody-jadwal'); tb.innerHTML = '';
        if(data.length===0) { tb.innerHTML='<tr><td colspan="6" class="p-4 text-center text-gray-400">Belum ada Jadwal / Set Ujian.</td></tr>'; return; }

        data.forEach((item, i) => {
           const badge = item.status === 'Aktif' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500';
           const fmt = { dateStyle: 'medium', timeStyle: 'short' };
           const mulai = new Date(item.mulai).toLocaleString('id-ID', fmt);
           const selesai = new Date(item.selesai).toLocaleString('id-ID', fmt);
           const json = encodeURIComponent(JSON.stringify(item));
           
           tb.insertAdjacentHTML('beforeend', `
             <tr class="border-b hover:bg-slate-50">
               <td class="p-3">
                 <div class="font-bold text-gray-700">${item.nama_ujian}</div>
                 <div class="text-xs text-indigo-600 font-mono">${item.nama_mapel}</div>
               </td>
               <td class="p-3 text-xs">
                 <div class="text-gray-600"><i class="fas fa-play text-green-500 w-4"></i> ${mulai}</div>
                 <div class="text-gray-600 mt-1"><i class="fas fa-stop text-red-500 w-4"></i> ${selesai}</div>
               </td>
               <td class="p-3"><span class="px-2 py-1 rounded text-xs font-bold ${badge}">${item.status}</span></td>
               <td class="p-3 text-right">
                 <button onclick="App.Ujian.editJadwal('${json}')" class="text-indigo-600 mr-2"><i class="fas fa-edit"></i></button>
                 <button onclick="App.Ujian.hapusJadwal('${item.id}')" class="text-red-500"><i class="fas fa-trash"></i></button>
               </td>
             </tr>
           `);
        });
      },

      // C. CRUD Operations (Jenis)
      saveJenis: function(e) {
        e.preventDefault(); const btn=document.getElementById('btnSimpanJenis'); App.UI.setLoading(btn,true,'Simpan');
        const d = { id: document.getElementById('j-id').value, nama: document.getElementById('j-nama').value, ket: document.getElementById('j-ket').value, status: document.getElementById('j-status').value };
        google.script.run.withSuccessHandler(r=>{
           App.UI.setLoading(btn,false,'Simpan'); 
           if(r.status==='success') { App.UI.closeModal('modal-jenis'); App.Cache.remove('jenis_ujian'); App.Ujian.loadJenis(true); Swal.fire('Sukses',r.message,'success'); }
        }).simpanJenisUjian(d);
      },
      editJenis: function(str) {
        const d=JSON.parse(decodeURIComponent(str)); App.UI.openModal('modal-jenis'); document.getElementById('modal-jenis-title').innerText="Edit Nama Ujian";
        document.getElementById('j-id').value=d.id; document.getElementById('j-nama').value=d.nama; document.getElementById('j-ket').value=d.ket; document.getElementById('j-status').value=d.status;
      },
      hapusJenis: function(id) { Swal.fire({title:'Hapus?',text:'Jadwal terkait mungkin error',icon:'warning',showCancelButton:true,confirmButtonColor:'#d33'}).then(r=>{ if(r.isConfirmed) google.script.run.withSuccessHandler(()=>{ App.Cache.remove('jenis_ujian'); App.Ujian.loadJenis(true); }).hapusJenisUjian(id); }); },
      openModalJenis: function() { App.UI.openModal('modal-jenis'); document.getElementById('modal-jenis-title').innerText="Tambah Nama Ujian"; document.getElementById('formJenis').reset(); document.getElementById('j-id').value=""; },

      // D. CRUD Operations (Jadwal)
      saveJadwal: function(e) {
        e.preventDefault(); const btn=document.getElementById('btnSimpanJadwal'); App.UI.setLoading(btn,true,'Simpan');
        const m = new Date(document.getElementById('sch-mulai').value).toISOString();
        const s = new Date(document.getElementById('sch-selesai').value).toISOString();
        
        const d = { 
          id: document.getElementById('sch-id').value, 
          id_jenis: document.getElementById('sch-jenis').value,
          kode_mapel: document.getElementById('sch-mapel').value,
          mulai: m, selesai: s, status: document.getElementById('sch-status').value 
        };
        google.script.run.withSuccessHandler(r=>{
           App.UI.setLoading(btn,false,'Simpan'); 
           if(r.status==='success') { App.UI.closeModal('modal-jadwal'); App.Cache.remove('jadwal'); App.Ujian.loadJadwal(true); Swal.fire('Sukses',r.message,'success'); }
           else Swal.fire('Error', r.message, 'error');
        }).simpanJadwal(d);
      },
      editJadwal: function(str) {
        const d=JSON.parse(decodeURIComponent(str)); 
        App.Ujian.openModalJadwal(true); // Load dropdowns first
        document.getElementById('modal-jadwal-title').innerText="Edit Set Ujian";
        document.getElementById('sch-id').value=d.id;
        // Delay setting values to wait for dropdowns
        setTimeout(() => {
           document.getElementById('sch-jenis').value=d.id_jenis;
           document.getElementById('sch-mapel').value=d.kode_mapel;
           document.getElementById('sch-status').value=d.status;
           document.getElementById('sch-mulai').value=d.mulai.slice(0,16);
           document.getElementById('sch-selesai').value=d.selesai.slice(0,16);
        }, 300);
      },
      hapusJadwal: function(id) { Swal.fire({title:'Hapus Jadwal?',icon:'warning',showCancelButton:true,confirmButtonColor:'#d33'}).then(r=>{ if(r.isConfirmed) google.script.run.withSuccessHandler(()=>{ App.Cache.remove('jadwal'); App.Ujian.loadJadwal(true); }).hapusJadwal(id); }); },
      
      openModalJadwal: function(isEdit=false) {
        App.UI.openModal('modal-jadwal'); 
        if(!isEdit) {
           document.getElementById('modal-jadwal-title').innerText="Set Ujian Baru";
           document.getElementById('formJadwal').reset(); 
           document.getElementById('sch-id').value="";
        }
        
        // Populate Dropdown Jenis
        const selJenis = document.getElementById('sch-jenis');
        selJenis.innerHTML = '<option value="">- Pilih Ujian -</option>';
        (App.data.jenisUjianList || []).forEach(j => {
           if(j.status === 'Aktif') selJenis.insertAdjacentHTML('beforeend', `<option value="${j.id}">${j.nama}</option>`);
        });

        // Populate Dropdown Mapel
        const selMapel = document.getElementById('sch-mapel');
        selMapel.innerHTML = '<option value="">- Loading -</option>';
        if(App.Cache.get('mapel')) {
           renderMapelOpts(App.Cache.get('mapel'));
        } else {
           google.script.run.withSuccessHandler(d=>{ App.Cache.set('mapel',d); renderMapelOpts(d); }).getAllMapel();
        }

        function renderMapelOpts(d) {
           selMapel.innerHTML = '<option value="">- Pilih Mapel/Bank Soal -</option>';
           d.forEach(m => selMapel.insertAdjacentHTML('beforeend', `<option value="${m.kode}">${m.kode} - ${m.nama}</option>`));
        }
      }
    },

    // --- Module 6: Siswa / Exam Logic ---
    Exam: {
      initSiswa: function(user) {
        document.getElementById('login-container').classList.add('hidden');
        document.getElementById('header-nama').innerText = user.nama;
        Swal.fire({ title: 'Kode Mapel', input: 'text', allowOutsideClick: false, confirmButtonText: 'Mulai' }).then((r) => { if (r.value) App.Exam.start(r.value); else App.Auth.logout(); });
      },
      start: function(kode) {
        App.data.examRunning = true; App.Security.enterFullscreen();
        document.getElementById('page-siswa').classList.remove('hidden'); document.getElementById('header-mapel').innerText = kode;
        App.Exam.timerStart(60); // Default 60 mins
        google.script.run.withSuccessHandler(res => {
           if(res.status === 'success') {
             App.data.soalList = res.data; document.getElementById('exam-loading').classList.add('hidden'); document.getElementById('soal-container').classList.remove('hidden'); document.getElementById('nav-buttons').classList.remove('hidden'); document.getElementById('nav-buttons').classList.add('flex'); App.Exam.render(0);
           } else { Swal.fire('Gagal', res.message, 'warning').then(() => App.Auth.logout()); }
        }).getSoalUjian(kode);
      },
      render: function(idx) {
        App.data.currentSoalIdx = idx; const s = App.data.soalList[idx];
        document.getElementById('disp-no').innerText = idx + 1;
        document.getElementById('disp-pertanyaan').innerText = s.pertanyaan;
        const imgCont = document.getElementById('disp-gambar-container'); const img = document.getElementById('disp-gambar');
        if(s.gambar) { imgCont.classList.remove('hidden'); img.src = s.gambar; } else { imgCont.classList.add('hidden'); }
        const ops = document.getElementById('disp-opsi'); ops.innerHTML = '';
        ['A','B','C','D','E'].forEach(h => {
           if(s.opsi[h]) {
             const active = App.data.jawabanSiswa[s.id] === h ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white hover:bg-gray-50';
             ops.insertAdjacentHTML('beforeend', `<div onclick="App.Exam.pilih('${s.id}','${h}')" class="cursor-pointer border rounded p-3 flex gap-3 items-center transition ${active}"><span class="font-bold w-6 text-center shrink-0">${h}</span> <span class="text-sm md:text-base">${s.opsi[h]}</span></div>`);
           }
        });
        App.Exam.renderGrid();
      },
      pilih: function(id, h) { App.data.jawabanSiswa[id] = h; App.Exam.render(App.data.currentSoalIdx); },
      next: function() { if(App.data.currentSoalIdx < App.data.soalList.length-1) App.Exam.render(App.data.currentSoalIdx+1); },
      prev: function() { if(App.data.currentSoalIdx > 0) App.Exam.render(App.data.currentSoalIdx-1); },
      toggleRagu: function() { const id = App.data.soalList[App.data.currentSoalIdx].id; if(App.data.raguSiswa[id]) delete App.data.raguSiswa[id]; else App.data.raguSiswa[id] = true; App.Exam.render(App.data.currentSoalIdx); },
      renderGrid: function() {
        const g = document.getElementById('grid-nomor'); g.innerHTML='';
        App.data.soalList.forEach((s,i) => {
           let c = 'bg-white border text-gray-600'; if(App.data.jawabanSiswa[s.id]) c = 'bg-indigo-600 text-white border-indigo-600'; if(App.data.raguSiswa[s.id]) c = 'bg-yellow-400 text-white border-yellow-400'; if(i===App.data.currentSoalIdx) c += ' ring-2 ring-indigo-300';
           g.insertAdjacentHTML('beforeend', `<button onclick="App.Exam.render(${i})" class="h-8 w-full rounded font-bold text-xs ${c}">${i+1}</button>`);
        });
      },
      finish: function() { Swal.fire({ title:'Kirim?', icon:'question', showCancelButton:true, confirmButtonText:'Ya' }).then(r=>{ if(r.isConfirmed) App.Exam.submit(false); }); },
      submit: function(auto) {
         App.data.examRunning = false; clearInterval(App.data.timer); Swal.showLoading();
         const p = { nama: document.getElementById('header-nama').innerText, mapel: document.getElementById('header-mapel').innerText, jawaban: App.data.jawabanSiswa };
         google.script.run.withSuccessHandler(res => { if(res.status==='success') Swal.fire('Selesai', `Nilai: ${res.nilai}`, 'success').then(()=>App.Auth.logout()); else Swal.fire('Gagal', res.message, 'error'); }).submitUjian(p);
      },
      timerStart: function(m) {
         App.data.timeLeft = m * 60;
         App.data.timer = setInterval(() => {
            App.data.timeLeft--;
            const min = Math.floor(App.data.timeLeft/60).toString().padStart(2,'0');
            const sec = (App.data.timeLeft%60).toString().padStart(2,'0');
            document.getElementById('timer-display').innerText = `${min}:${sec}`;
            if(App.data.timeLeft<=0) { clearInterval(App.data.timer); App.Exam.submit(true); }
         }, 1000);
      }
    },

    // --- Module Pengawas ---
    Pengawas: {
       loadToken: function() {
          document.getElementById('token-display').innerText = "Loading...";
          google.script.run.withSuccessHandler(res => {
             document.getElementById('token-display').innerText = res.token;
             // Load Dropdown Jadwal untuk monitoring
             const sel = document.getElementById('mon-pilih-jadwal');
             sel.innerHTML = '<option value="">- Pilih Ujian -</option>';
             res.jadwal.forEach(j => {
                sel.insertAdjacentHTML('beforeend', `<option value="${j.mapel}">${j.mapel} (${j.mulai})</option>`); // Idealnya value=ID Jadwal
             });
          }).getPengawasDashboard();
       },
       loadMonitoring: function() {
          const mapel = document.getElementById('mon-pilih-jadwal').value;
          const tbody = document.getElementById('tbody-monitoring');
          if(!mapel) return;
          
          tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center">Mengambil data...</td></tr>';
          
          google.script.run.withSuccessHandler(data => {
             tbody.innerHTML = '';
             if(data.length === 0) tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center">Tidak ada siswa.</td></tr>';
             
             data.forEach(s => {
                let badge = "bg-gray-100 text-gray-500";
                if(s.status === 'SEDANG MENGERJAKAN') badge = "bg-blue-100 text-blue-700 animate-pulse";
                if(s.status === 'SELESAI') badge = "bg-green-100 text-green-700";
                if(s.status === 'TERKUNCI') badge = "bg-red-100 text-red-700 font-bold";
                
                let btnUnlock = '';
                if(s.isLocked || s.status === 'TERKUNCI') {
                   btnUnlock = `<button onclick="App.Pengawas.bukaKunci('${s.username}', '${s.nama}')" class="px-3 py-1 bg-red-600 text-white rounded text-xs hover:bg-red-700">Buka Kunci</button>`;
                }
                
                tbody.insertAdjacentHTML('beforeend', `
                   <tr class="border-b">
                     <td class="p-3 font-semibold">${s.nama}</td>
                     <td class="p-3 text-gray-500">${s.kelas}</td>
                     <td class="p-3 text-center"><span class="px-2 py-1 rounded text-[10px] uppercase font-bold ${badge}">${s.status}</span></td>
                     <td class="p-3 text-center">${btnUnlock}</td>
                   </tr>
                `);
             });
          }).getMonitoringSiswa(mapel);
       },
       bukaKunci: function(username, nama) {
          Swal.fire({title: 'Buka Kunci?', text: `Dapatkan token untuk ${nama}`, showCancelButton:true, confirmButtonText:'Dapatkan Token'})
          .then(r => {
             if(r.isConfirmed) {
                google.script.run.withSuccessHandler(token => {
                   Swal.fire({
                     title: 'TOKEN BUKA KUNCI',
                     html: `<h1 class="text-4xl font-bold text-red-600 mt-2">${token}</h1><p class="text-sm text-gray-500 mt-2">Berikan token ini ke siswa.</p>`,
                     icon: 'info'
                   });
                }).generateUnlockToken(username);
             }
          });
       }
    },

    // --- Module Siswa (Dashboard Logic) ---
    Siswa: {
       loadJadwal: function() {
          const div = document.getElementById('list-ujian-siswa');
          div.innerHTML = '<p class="text-center"><i class="fas fa-spinner fa-spin"></i> Memuat...</p>';
          
          google.script.run.withSuccessHandler(jadwal => {
             div.innerHTML = '';
             if(jadwal.length === 0) { div.innerHTML = '<p class="text-center text-gray-400">Tidak ada jadwal ujian aktif.</p>'; return; }
             
             jadwal.forEach(j => {
                // Filter Jadwal di Client side atau Server side (sebaiknya server)
                // Disini kita tampilkan tombol "Mulai"
                div.insertAdjacentHTML('beforeend', `
                  <div class="flex justify-between items-center bg-gray-50 p-4 rounded border hover:bg-indigo-50 transition">
                     <div>
                        <h4 class="font-bold text-lg text-indigo-700">${j.nama_mapel}</h4>
                        <p class="text-xs text-gray-500"><i class="fas fa-clock"></i> ${new Date(j.mulai).toLocaleTimeString()} - ${new Date(j.selesai).toLocaleTimeString()}</p>
                     </div>
                     <button onclick="App.Siswa.promptToken('${j.kode_mapel}', '${j.id}')" class="px-6 py-2 bg-indigo-600 text-white rounded-full font-bold shadow hover:bg-indigo-700">KERJAKAN</button>
                  </div>
                `);
             });
          }).getJadwalUjian(); // Perlu modif getJadwalUjian agar mengembalikan jadwal yang statusnya Aktif saja
       },
       promptToken: function(kodeMapel, idJadwal) {
          Swal.fire({
            title: 'Masukkan Token',
            text: 'Minta token kepada Pengawas',
            input: 'text',
            inputAttributes: { autocapitalize: 'off' },
            showCancelButton: true,
            confirmButtonText: 'Mulai Ujian',
            showLoaderOnConfirm: true,
            preConfirm: (token) => {
               return new Promise((resolve) => {
                  google.script.run.withSuccessHandler(res => {
                     if(res.status === 'success') resolve();
                     else Swal.showValidationMessage(res.message);
                  }).verifikasiTokenUjian(token.toUpperCase());
               });
            }
          }).then((result) => {
             if (result.isConfirmed) {
                // Simpan state Started
                google.script.run.startExamSession(App.data.user.username, idJadwal);
                App.Exam.start(kodeMapel);
             }
          });
       }
    },

    // --- MODULE MONITORING ADMIN ---
    AdminMonitor: {
       currentExamId: null,
       loadSummary: function() {
          const listDiv = document.getElementById('adm-list-exams');
          listDiv.innerHTML = '<p class="text-center text-gray-400 mt-4"><i class="fas fa-spinner fa-spin"></i> Memuat Ujian Aktif...</p>';
          document.getElementById('adm-token-display').innerText = '...';

          google.script.run.withSuccessHandler(res => {
             document.getElementById('adm-token-display').innerText = res.globalToken;
             listDiv.innerHTML = '';
             
             if(res.exams.length === 0) {
                listDiv.innerHTML = '<div class="text-center p-4 bg-yellow-50 rounded text-yellow-700 text-sm">Tidak ada ujian yang statusnya AKTIF saat ini.</div>';
                return;
             }

             res.exams.forEach(ex => {
                 // Format tanggal jam
                 const jamMulai = new Date(ex.mulai).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                 const jamSelesai = new Date(ex.selesai).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                 
                 const item = document.createElement('div');
                 item.className = 'cursor-pointer p-3 rounded-lg border hover:border-indigo-500 hover:bg-indigo-50 transition group';
                 item.onclick = () => App.AdminMonitor.loadDetail(ex.id, ex.mapel, ex.jenis);
                 item.innerHTML = `
                    <div class="flex justify-between items-start">
                       <div>
                          <p class="font-bold text-indigo-800 text-sm group-hover:text-indigo-600">${ex.mapel}</p>
                          <p class="text-[10px] text-gray-500 font-bold uppercase">${ex.jenis}</p>
                       </div>
                       <i class="fas fa-chevron-right text-gray-300 group-hover:text-indigo-400 mt-2"></i>
                    </div>
                    <div class="mt-2 flex gap-2 text-[10px] text-gray-500">
                       <span class="bg-gray-100 px-1.5 py-0.5 rounded"><i class="far fa-clock"></i> ${jamMulai} - ${jamSelesai}</span>
                    </div>
                 `;
                 listDiv.appendChild(item);
             });
          }).getAdminMonitoringSummary();
       },

       loadDetail: function(idJadwal, mapelName, jenisName) {
          App.AdminMonitor.currentExamId = idJadwal;
          document.getElementById('adm-mon-title').innerText = mapelName;
          document.getElementById('adm-mon-subtitle').innerText = jenisName;
          
          const tbody = document.getElementById('tbody-adm-monitoring');
          const listLocked = document.getElementById('list-adm-locked');
          
          tbody.innerHTML = '<tr><td colspan="4" class="p-10 text-center"><i class="fas fa-spinner fa-spin"></i> Mengambil data siswa...</td></tr>';
          
          // Reuse fungsi monitoring yang ada (yang dipakai pengawas), karena logikanya sama
          google.script.run.withSuccessHandler(data => {
             tbody.innerHTML = '';
             listLocked.innerHTML = '';
             
             let countActive = 0;
             let countLocked = 0;
             let hasLocked = false;

             if(data.length === 0) {
                 tbody.innerHTML = '<tr><td colspan="4" class="p-10 text-center text-gray-400">Tidak ada siswa terdaftar.</td></tr>';
             }

             data.forEach(s => {
                // Styling Status
                let badge = "bg-gray-100 text-gray-500";
                if(s.status === 'SEDANG MENGERJAKAN') { badge = "bg-blue-100 text-blue-700 animate-pulse"; countActive++; }
                if(s.status === 'SELESAI') badge = "bg-green-100 text-green-700";
                
                let btnAction = '-';
                
                // Handle Locked / Pelanggaran
                if(s.status === 'TERKUNCI' || s.isLocked) {
                    badge = "bg-red-600 text-white font-bold animate-bounce";
                    countLocked++;
                    hasLocked = true;
                    
                    // Tombol Buka Kunci di Tabel Utama
                    btnAction = `<button onclick="App.Pengawas.bukaKunci('${s.username}', '${s.nama}')" class="px-3 py-1 bg-red-100 text-red-700 border border-red-200 rounded text-xs font-bold hover:bg-red-200 shadow-sm"><i class="fas fa-key"></i> Buka Kunci</button>`;
                    
                    // Tambahkan ke Panel Bawah (List Pelanggaran)
                    listLocked.insertAdjacentHTML('beforeend', `
                       <div class="flex justify-between items-center bg-white p-2 rounded border border-red-200 shadow-sm">
                          <div class="flex items-center gap-2">
                             <div class="w-8 h-8 rounded-full bg-red-100 text-red-600 flex items-center justify-center font-bold text-xs"><i class="fas fa-user-lock"></i></div>
                             <div><p class="text-sm font-bold text-gray-800">${s.nama}</p><p class="text-xs text-red-500">Terkunci</p></div>
                          </div>
                          <button onclick="App.Pengawas.bukaKunci('${s.username}', '${s.nama}')" class="text-xs bg-red-600 text-white px-3 py-1.5 rounded hover:bg-red-700">Buka</button>
                       </div>
                    `);
                }

                tbody.insertAdjacentHTML('beforeend', `
                   <tr class="hover:bg-gray-50 border-b">
                     <td class="p-3">
                        <div class="font-semibold text-gray-700">${s.nama}</div>
                        <div class="text-[10px] text-gray-400 font-mono">${s.username}</div>
                     </td>
                     <td class="p-3 text-center text-sm">${s.kelas}</td>
                     <td class="p-3 text-center"><span class="px-2 py-1 rounded text-[10px] uppercase font-bold ${badge}">${s.status}</span></td>
                     <td class="p-3 text-center">${btnAction}</td>
                   </tr>
                `);
             });

             if(!hasLocked) listLocked.innerHTML = '<p class="text-xs text-gray-400 italic text-center py-4">Aman. Tidak ada pelanggaran.</p>';
             
             document.getElementById('counter-active').innerText = `Mengerjakan: ${countActive}`;
             document.getElementById('counter-locked').innerText = `Terkunci: ${countLocked}`;

          }).getMonitoringSiswa(mapelName); // Note: Backend getMonitoringSiswa pakai parameter 'Mapel' string untuk filter sementara
       }
    },

    // --- MODULE HASIL UJIAN ADMIN ---
    AdminHasil: {
       load: function(force=false) {
          const tbody = document.getElementById('tbody-hasil-admin');
          const filter = document.getElementById('filter-hasil-admin').value;
          
          if(App.Cache.get('mapel_opts')) {
             // Populate dropdown filter mapel admin jika kosong
             const sel = document.getElementById('filter-hasil-admin');
             if(sel.options.length <= 1) {
                App.Cache.get('mapel_opts').forEach(m => sel.insertAdjacentHTML('beforeend', `<option value="${m.kode}">${m.kode}</option>`));
             }
          }

          tbody.innerHTML = '<tr><td colspan="5" class="p-6 text-center"><i class="fas fa-spinner fa-spin"></i> Memuat Hasil...</td></tr>';
          
          google.script.run.withSuccessHandler(data => {
             tbody.innerHTML = '';
             if(data.length === 0) { tbody.innerHTML = '<tr><td colspan="5" class="p-6 text-center text-gray-400">Belum ada data nilai masuk.</td></tr>'; return; }
             
             data.forEach(r => {
                const w = new Date(r.waktu).toLocaleString('id-ID');
                let color = 'text-gray-700';
                if(r.nilai < 60) color = 'text-red-600 font-bold';
                if(r.nilai >= 85) color = 'text-green-600 font-bold';
                
                tbody.insertAdjacentHTML('beforeend', `
                   <tr class="hover:bg-slate-50 border-b">
                      <td class="p-4 text-xs text-gray-500">${w}</td>
                      <td class="p-4 font-semibold text-gray-700">${r.nama}</td>
                      <td class="p-4"><span class="bg-indigo-50 text-indigo-700 px-2 py-1 rounded text-xs font-bold">${r.mapel}</span></td>
                      <td class="p-4 text-center font-mono text-xs">${r.detail}</td>
                      <td class="p-4 text-center text-lg ${color}">${r.nilai}</td>
                   </tr>
                `);
             });
          }).getHasilUjianAdmin(filter);
       }
    },

    // --- Module 7: UI Utilities ---
    UI: {
      setLoading: function(btn, isLoading, text) {
        btn.disabled = isLoading;
        btn.innerHTML = isLoading ? `<i class="fas fa-circle-notch fa-spin"></i> ${text}` : text;
      },
      switchView: function(viewId, btn) {
        if(window.innerWidth < 768) App.UI.toggleSidebar(false);
        document.querySelectorAll('.nav-item').forEach(el => el.className = 'nav-item w-full flex items-center gap-3 px-6 py-3 transition text-left hover:bg-slate-800 text-gray-400 hover:text-white');
        if(btn) btn.className = 'nav-item w-full flex items-center gap-3 px-6 py-3 transition text-left bg-slate-800 border-l-4 border-indigo-500 text-white';
        
        ['view-dashboard','view-bank-soal','view-akun','view-mapel','view-ujian','view-jadwal-siswa','view-hasil-ujian','view-pengawas','view-admin-monitoring','view-admin-hasil','view-placeholder'].forEach(id => { 
            const el = document.getElementById(id); if(el) el.classList.add('hidden'); 
        });
        const map = { 'dashboard':'Dashboard', 'akun':'Kelola Akun', 'mapel':'Mapel', 'bank-soal':'Bank Soal', 'ujian':'Kelola Ujian' };
        document.getElementById('page-title').innerText = map[viewId] || viewId.toUpperCase();

        // Logika View
        if(viewId === 'jadwal-siswa') {
            document.getElementById('view-jadwal-siswa').classList.remove('hidden');
            App.Siswa.loadJadwal();
        } 
        else if (viewId === 'pengawas-area') {
            document.getElementById('view-pengawas').classList.remove('hidden');
            App.Pengawas.loadToken();
            // Auto refresh token tiap 60 detik (optional)
        }
        else if (viewId === 'hasil') {
            document.getElementById('view-hasil-ujian').classList.remove('hidden');
            // Logic load hasil ujian guru...
        }
        else if (viewId === 'bank-soal') {
            document.getElementById('view-bank-soal').classList.remove('hidden');
            App.BankSoal.loadOptionsMapel();
            // TODO: Jika Role Guru, filter otomatis dropdown mapel hanya mapel dia
        }

        else if (viewId === 'admin-monitoring') {
             document.getElementById('view-admin-monitoring').classList.remove('hidden');
             App.AdminMonitor.loadSummary();
        }
        else if (viewId === 'admin-hasil') {
             document.getElementById('view-admin-hasil').classList.remove('hidden');
             App.AdminHasil.load();
        }
        
        else if(viewId==='dashboard') { document.getElementById('view-dashboard').classList.remove('hidden'); App.Dashboard.loadStats(); }
        else if(viewId==='akun') { document.getElementById('view-akun').classList.remove('hidden'); App.User.loadAll(); }
        else if(viewId==='mapel') { document.getElementById('view-mapel').classList.remove('hidden'); App.Mapel.load(); }
        else if(viewId==='bank-soal') { document.getElementById('view-bank-soal').classList.remove('hidden'); App.BankSoal.loadOptionsMapel(); }
        else if(viewId==='ujian') { document.getElementById('view-ujian').classList.remove('hidden'); App.Ujian.loadJenis(); App.Ujian.loadJadwal(); }
        else document.getElementById('view-placeholder').classList.remove('hidden');
      },
      toggleSidebar: function(forceState) {
        const sidebar = document.getElementById('sidebar-panel');
        const backdrop = document.getElementById('sidebar-backdrop');
        const isClosed = sidebar.classList.contains('-translate-x-full');
        const shouldOpen = forceState !== undefined ? forceState : isClosed;
        if (shouldOpen) { sidebar.classList.remove('-translate-x-full'); backdrop.classList.remove('hidden'); } 
        else { sidebar.classList.add('-translate-x-full'); backdrop.classList.add('hidden'); }
      },
      zoomImg: function(el) { Swal.fire({ imageUrl: el.src, width: '90%', showConfirmButton: false, background: 'transparent' }); },
      openModal: function(id) { document.getElementById(id).classList.remove('hidden'); },
      closeModal: function(id) { document.getElementById(id).classList.add('hidden'); },
      showLoginOnly: function() {
        document.getElementById('dashboard-container').classList.add('hidden'); document.getElementById('page-siswa').classList.add('hidden'); document.getElementById('lock-screen').classList.add('hidden');
        document.getElementById('login-container').classList.remove('hidden'); document.getElementById('login-container').classList.add('flex');
      }
    },

    // --- Module 8: Security & Utils ---
    Security: {
      enterFullscreen: function() { document.documentElement.requestFullscreen().catch(()=>{}); },
      triggerLock: function(msg) { document.getElementById('lock-screen').classList.remove('hidden'); document.getElementById('lock-reason').innerText = msg; },
      unlock: function() {
         const t = document.getElementById('token-unlock').value;
         google.script.run.withSuccessHandler(r => {
            if(r.status==='success') { document.getElementById('lock-screen').classList.add('hidden'); App.Security.enterFullscreen(); }
            else Swal.fire('Salah', 'Token tidak valid', 'error');
         }).verifikasiTokenUnlock(t);
      }
    },
    Util: {
      resetGlobals: function() {
        App.data = { role: '', user: null, soalList: [], userList: [], mapelList: [], jawabanSiswa: {}, raguSiswa: {}, opsiImages: { A:null, B:null, C:null, D:null, E:null }, examRunning: false, timer: null, timeLeft: 0, currentSoalIdx: 0, quill: null };
        document.getElementById('tbody-users').innerHTML = ''; document.getElementById('tbody-mapel').innerHTML = ''; document.getElementById('tbody-soal').innerHTML = ''; document.querySelectorAll('.fixed.z-50').forEach(el => el.classList.add('hidden'));
      }
    }
  };

  // ===========================================
  // INITIALIZATION
  // ===========================================
  document.getElementById('current-date').innerText = new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
  document.addEventListener("visibilitychange", () => { if(App.data.examRunning && document.hidden) App.Security.triggerLock("Pindah Tab"); });
  window.addEventListener("blur", () => { if(App.data.examRunning) App.Security.triggerLock("Keluar App"); });
  let activityTimer;
  ['click', 'mousemove', 'keypress', 'scroll', 'touchstart'].forEach(evt => document.addEventListener(evt, () => sessionStorage.setItem('last_activity', Date.now()), false));
  setInterval(() => {
     const lastAct = sessionStorage.getItem('last_activity');
     if (lastAct && (Date.now() - parseInt(lastAct) > 10 * 60 * 1000)) { 
        sessionStorage.clear(); Swal.fire('Sesi Habis', 'Login kembali.', 'warning').then(() => window.location.reload()); 
     }
  }, 60 * 1000);

  window.addEventListener('load', App.Auth.checkSession);
</script>
