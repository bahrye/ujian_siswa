<script>
  // ===========================================
  // MODULE: APPLICATION LOGIC (FULL & UPDATED)
  // ===========================================
  const App = {
    // --- Global Variables ---
    data: {
      role: '',
      user: null,
      scriptUrl: null,
      soalList: [],
      userList: [],
      mapelList: [],
      jenisUjianList: [], // Data Baru
      jadwalList: [],     // Data Baru
      jawabanSiswa: {},
      raguSiswa: {},
      opsiImages: { A:null, B:null, C:null, D:null, E:null },
      examRunning: false,
      timer: null,
      timeLeft: 0,
      currentSoalIdx: 0,
      quill: null,
      saveTimeout: null,
      activeJadwalId: null
    },

    // --- Module 0: Caching System ---
    Cache: {
      store: {},
      get: function(key) { return this.store[key] || null; },
      set: function(key, data) { this.store[key] = data; },
      remove: function(key) { delete this.store[key]; },
      clearPattern: function(pattern) {
        Object.keys(this.store).forEach(key => {
          if (key.includes(pattern)) delete this.store[key];
        });
      },
      clearAll: function() { this.store = {}; }
    },

    // --- Module 1: Authentication ---
    Auth: {
      login: function(e) {
        e.preventDefault();
        const u = document.getElementById('user').value;
        const p = document.getElementById('pass').value;
        const btn = document.getElementById('btnLogin');
        
        App.UI.setLoading(btn, true, 'MEMERIKSA...');
        
        google.script.run.withSuccessHandler((res) => {
          App.UI.setLoading(btn, false, 'MASUK');
          if (res.status === 'success') {
            const sess = { role: res.role, nama: res.nama, data: res };
            sessionStorage.setItem('cbt_session', JSON.stringify(sess));
            sessionStorage.setItem('last_activity', Date.now());
            App.data.role = res.role;
            
            // PERUBAHAN DISINI: Semua role masuk ke Dashboard.init
            App.Dashboard.init(res);
          } else {
            Swal.fire('Login Gagal', res.message, 'error');
          }
        }).withFailureHandler((err) => {
          App.UI.setLoading(btn, false, 'MASUK');
          Swal.fire('Error', err.message, 'error');
        }).loginUser(u, p);
      },

      logout: function() {
        Swal.fire({ title: 'Keluar?', text: "Akhiri sesi.", icon: 'warning', showCancelButton: true, confirmButtonText: 'Ya' })
        .then((result) => { if (result.isConfirmed) App.Auth.forceLogout(); });
      },

      forceLogout: function() {
        sessionStorage.clear();
        App.Cache.clearAll();
        App.Util.resetGlobals();
        App.UI.showLoginOnly();
        document.getElementById('user').value = "";
        document.getElementById('pass').value = "";
      },

      checkSession: function() {
        const sess = sessionStorage.getItem('cbt_session');
        if (sess) {
          const user = JSON.parse(sess);
          App.data.role = user.role;
          // PERUBAHAN: Langsung init dashboard, tidak perlu cek siswa reload exam
          App.Dashboard.init(user.data);
        } else {
          App.UI.showLoginOnly();
        }
      }
    },

    // --- Module 2: Dashboard UI & Navigation ---
    Dashboard: {
      init: function(user) {
        document.getElementById('login-container').classList.add('hidden');
        document.getElementById('dashboard-container').classList.remove('hidden');
        document.getElementById('dash-nama').innerText = user.nama;
        document.getElementById('dash-initial').innerText = user.nama.charAt(0);
        document.getElementById('dash-role').innerText = user.role;
        App.Dashboard.renderMenu(user.role);
        
        // LOGIKA REDIRECT
        const firstMenuBtn = document.querySelector('#sidebar-menu .nav-item');
        
        if (user.role === 'admin' || user.role === 'guru') {
            App.Dashboard.loadStats();
            App.UI.switchView('dashboard', firstMenuBtn);
        } else {
            // SISWA & PENGAWAS tidak butuh loadStats (Statistik Sistem)
            App.UI.switchView('dashboard', firstMenuBtn);
        }
      },

      renderMenu: function(role) {
        const menuContainer = document.getElementById('sidebar-menu');
        menuContainer.innerHTML = '';
        
        let menus = [];
        
        if (role === 'admin') {
           menus = [
             { id: 'dashboard', icon: 'fa-home', label: 'Dashboard' },
             { id: 'akun', icon: 'fa-users-cog', label: 'Kelola User' },
             { id: 'mapel', icon: 'fa-tags', label: 'Kelola Mapel' },
             { id: 'bank-soal', icon: 'fa-file-alt', label: 'Bank Soal' },
             { id: 'ujian', icon: 'fa-calendar-alt', label: 'Kelola Ujian' },
             { id: 'admin-monitoring', icon: 'fa-desktop', label: 'Monitoring Live' }, 
             { id: 'admin-hasil', icon: 'fa-poll', label: 'Hasil Ujian' },           
           ];
        } else if (role === 'guru') {
           menus = [
             { id: 'dashboard', icon: 'fa-home', label: 'Dashboard' },
             { id: 'bank-soal', icon: 'fa-file-alt', label: 'Bank Soal' },
             { id: 'hasil', icon: 'fa-poll', label: 'Hasil Ujian' },
           ];
        } else if (role === 'pengawas') {
           menus = [
             { id: 'dashboard', icon: 'fa-calendar-alt', label: 'Jadwal Ujian' }, // Dashboard isinya Jadwal Semua
             { id: 'pengawas-token', icon: 'fa-key', label: 'Token Ujian' },      // Menu Token
             { id: 'pengawas-monitor', icon: 'fa-desktop', label: 'Monitoring Live' }, // Menu Monitoring
             { id: 'pengawas-pelanggaran', icon: 'fa-exclamation-triangle', label: 'Pelanggaran Siswa' },
           ];
        } else if (role === 'siswa') {
           menus = [
             // Label tetap Dashboard, tapi isinya nanti Jadwal Ujian
             { id: 'dashboard', icon: 'fa-calendar-check', label: 'Jadwal Ujian' }, 
             { id: 'hasil-siswa', icon: 'fa-poll', label: 'Riwayat Nilai' }, 
           ];
        }

        menus.forEach(m => {
            // Hapus class active default saat render, biarkan switchView yang mengaturnya
            const btnClass = 'nav-item w-full flex items-center gap-3 px-6 py-3 transition text-left hover:bg-slate-800 text-gray-400 hover:text-white';
            menuContainer.insertAdjacentHTML('beforeend', `<button onclick="App.UI.switchView('${m.id}', this)" class="${btnClass}"><i class="fas ${m.icon} w-5"></i> <span>${m.label}</span></button>`);
        });
      },

      loadStats: function(forceRefresh = false) {
        // Guard: Pastikan Siswa tidak pernah memanggil ini
        if (App.data.role === 'siswa') return;

        if (!forceRefresh && App.Cache.get('stats')) {
           App.Dashboard.renderStats(App.Cache.get('stats')); return;
        }
        google.script.run.withSuccessHandler(stats => {
           App.Cache.set('stats', stats);
           App.Dashboard.renderStats(stats);
           const btn = document.getElementById('btn-refresh-dash');
           if(btn) btn.classList.remove('fa-spin');
        }).getDashboardStats();
      },

      renderStats: function(stats) {
         document.getElementById('stat-user').innerText = stats.users;
         document.getElementById('stat-soal').innerText = stats.soals;
         document.getElementById('stat-nilai').innerText = stats.nilais;
      }
    },

    // --- Module 3: Bank Soal Management ---
    BankSoal: {
      toggleForm: function(show) {
        if(show) {
           document.getElementById('bs-list-section').classList.add('hidden');
           document.getElementById('bs-form-section').classList.remove('hidden');
           setTimeout(App.BankSoal.initQuill, 100);
           if(!document.getElementById('soal-id').value) App.BankSoal.resetForm();
        } else {
           document.getElementById('bs-list-section').classList.remove('hidden');
           document.getElementById('bs-form-section').classList.add('hidden');
           App.BankSoal.resetForm();
        }
      },

      initQuill: function() {
        if (App.data.quill != null) return;
        const container = document.getElementById('editor-container');
        if (container && container.previousElementSibling?.classList.contains('ql-toolbar')) container.previousElementSibling.remove();
        
        let modulesConfig = { toolbar: [['bold', 'italic', 'underline'], [{ 'list': 'ordered'}, { 'list': 'bullet' }], ['image', 'formula']] };
        if (window.Quill && window.ImageResize) { Quill.register('modules/imageResize', window.ImageResize.default || window.ImageResize); modulesConfig.imageResize = { displaySize: true }; }
        
        App.data.quill = new Quill('#editor-container', { theme: 'snow', placeholder: 'Tulis pertanyaan...', modules: modulesConfig });
      },

      loadOptionsMapel: function() {
         if(App.Cache.get('mapel_opts')) {
             App.BankSoal.renderOptionsMapel(App.Cache.get('mapel_opts'));
             App.BankSoal.loadDaftar();
             return;
         }
         google.script.run.withSuccessHandler(data => {
            App.Cache.set('mapel_opts', data);
            App.BankSoal.renderOptionsMapel(data);
            App.BankSoal.loadDaftar();
         }).getAllMapel();
      },

      renderOptionsMapel: function(data) {
         const selFilter = document.getElementById('filter-mapel'); 
         const selForm = document.getElementById('soal-mapel-select');
         const oldFilter = selFilter.value;
         selFilter.innerHTML = '<option value="">- Tampilkan Semua -</option>';
         selForm.innerHTML = '<option value="">-- Pilih Mapel --</option>';
         data.forEach(m => {
            const opt = `<option value="${m.kode}">${m.kode} - ${m.nama}</option>`;
            selFilter.insertAdjacentHTML('beforeend', opt);
            selForm.insertAdjacentHTML('beforeend', opt);
         });
         if(oldFilter) selFilter.value = oldFilter;
      },

      loadDaftar: function(forceRefresh = false) {
        const tbody = document.getElementById('tbody-soal');
        const filter = document.getElementById('filter-mapel').value;
        const cacheKey = 'soal_' + (filter || 'all');
        const btnRefresh = document.getElementById('btn-refresh-soal');

        if(forceRefresh && btnRefresh) btnRefresh.classList.add('fa-spin');

        if (!forceRefresh && App.Cache.get(cacheKey)) {
          App.BankSoal.renderTable(App.Cache.get(cacheKey));
          return;
        }

        tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>';
        
        google.script.run.withSuccessHandler(data => {
          if(btnRefresh) btnRefresh.classList.remove('fa-spin');
          App.Cache.set(cacheKey, data);
          App.BankSoal.renderTable(data);
        }).getSoalAdmin(filter);
      },

      renderTable: function(data) {
        const tbody = document.getElementById('tbody-soal');
        tbody.innerHTML = '';
        if (data.length === 0) { tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-400">Tidak ada soal.</td></tr>'; return; }
        
        data.forEach((s, idx) => {
             const tmp = document.createElement("DIV"); tmp.innerHTML = s.soal;
             let snippet = tmp.textContent || tmp.innerText || "";
             if(snippet.length > 50) snippet = snippet.substring(0, 50) + "...";
             if(s.soal.includes('<img')) snippet = "ðŸ“· " + snippet;
             
             // Tampilan Bobot (Badge Kecil)
             let badgeBobot = "";
             if(s.bobot) {
                badgeBobot = `<span class="ml-2 bg-yellow-100 text-yellow-700 text-[10px] px-1.5 py-0.5 rounded border border-yellow-200" title="Bobot Nilai"><i class="fas fa-weight-hanging"></i> ${s.bobot}</span>`;
             }

             const dataStr = encodeURIComponent(JSON.stringify(s));
             const row = `
               <tr class="hover:bg-slate-50 border-b border-gray-100">
                 <td class="p-4 text-center font-bold text-gray-500">${idx+1}</td>
                 <td class="p-4">
                    <span class="bg-indigo-100 text-indigo-800 text-xs px-2 py-1 rounded font-bold">${s.tipe}</span>
                    <br><span class="text-xs text-gray-400">${s.mapel}</span>
                 </td>
                 <td class="p-4 text-gray-700 font-medium">
                    ${snippet} ${badgeBobot}
                 </td>
                 <td class="p-4 font-mono text-sm text-emerald-600 font-bold">${s.kunci || '-'}</td>
                 <td class="p-4 text-right">
                   <button onclick="App.BankSoal.edit('${dataStr}')" class="text-blue-600 mr-3"><i class="fas fa-edit"></i></button>
                   <button onclick="App.BankSoal.hapus('${s.id}')" class="text-red-500"><i class="fas fa-trash"></i></button>
                 </td>
               </tr>`;
             tbody.insertAdjacentHTML('beforeend', row);
        });
      },

      submit: function(e) {
        e.preventDefault();
        const idSoal = document.getElementById('soal-id').value;
        const mapel = document.getElementById('soal-mapel-select').value;
        const tipe = document.getElementById('tipe-soal').value;
        const bobot = document.getElementById('soal-bobot').value;
        const htmlSoal = App.data.quill.root.innerHTML;

        if (App.data.quill.getText().trim().length === 0 && !htmlSoal.includes('<img')) return Swal.fire('Error', 'Pertanyaan kosong!', 'warning');

        let opsiData = {}; let kunciJawaban = "";
        if (tipe === 'PG') {
          opsiData = { A: document.getElementById('pg-a').value, B: document.getElementById('pg-b').value, C: document.getElementById('pg-c').value, D: document.getElementById('pg-d').value, E: document.getElementById('pg-e').value };
          ['A','B','C','D','E'].forEach(h => { if(App.data.opsiImages[h]) opsiData['img_'+h] = App.data.opsiImages[h]; });
          kunciJawaban = document.getElementById('kunci-pg').value;
          if((!opsiData.A && !opsiData.img_A) || (!opsiData.B && !opsiData.img_B)) return Swal.fire('Error', 'Min. Opsi A & B', 'warning');
        } 
        else if (tipe === 'ISIAN') kunciJawaban = document.getElementById('kunci-isian').value;
        else if (tipe === 'BS') { const r = document.querySelector('input[name="kunci_bs"]:checked'); kunciJawaban = r ? r.value : ""; opsiData = { A: "BENAR", B: "SALAH" }; }
        else if (tipe === 'COCOK') {
           const kiris = document.querySelectorAll('.cocok-kiri'); const kanans = document.querySelectorAll('.cocok-kanan');
           let pairs = []; kiris.forEach((el, idx) => { if(el.value && kanans[idx].value) pairs.push({ k: el.value, v: kanans[idx].value }); });
           if(pairs.length < 2) return Swal.fire('Warning','Min. 2 pasang','warning');
           opsiData = pairs; kunciJawaban = "COCOK_AUTO";
        } else { kunciJawaban = "MANUAL"; }

        const btn = document.getElementById('btnSave');
        App.UI.setLoading(btn, true, 'MENYIMPAN...');
        const payload = { id: idSoal, mapel: mapel, tipe: tipe, bobot: bobot, soal: htmlSoal, opsiJson: JSON.stringify(opsiData), kunci: kunciJawaban };
        
        google.script.run.withSuccessHandler((res) => {
           App.UI.setLoading(btn, false, 'SIMPAN SOAL');
           if(res.status === 'success') { 
             Swal.fire('Sukses', res.message, 'success'); 
             App.BankSoal.toggleForm(false); 
             App.Cache.clearPattern('soal_'); App.Cache.remove('stats'); // Reset Cache
             App.BankSoal.loadDaftar(true); 
           } else Swal.fire('Gagal', res.message, 'error');
        }).simpanSoal(payload);
      },

      edit: function(str) {
        const s = JSON.parse(decodeURIComponent(str));
        
        // 1. Set ID & Judul dulu
        document.getElementById('soal-id').value = s.id;
        document.getElementById('form-soal-title').innerText = "Edit Soal";
        document.getElementById('btnSave').innerText = "UPDATE SOAL";
        
        // 2. Buka Form
        // Fungsi ini akan memicu pembuatan Quill dengan delay internal 100ms
        App.BankSoal.toggleForm(true);

        // 3. GUNAKAN SETTIMEOUT (PENTING!)
        // Kita tunggu 300ms agar Quill & DOM benar-benar siap sebelum mengisi data
        setTimeout(() => {
            
            // --- A. ISI EDITOR QUILL (PERTANYAAN) ---
            if (App.data.quill) {
                // Bersihkan dulu isinya agar bersih
                App.data.quill.setContents([]); 
                // Paste HTML Pertanyaan
                App.data.quill.clipboard.dangerouslyPasteHTML(0, s.soal);
            }

            // --- B. LOGIKA MAPEL (SMART SELECT) ---
            const selMapel = document.getElementById('soal-mapel-select');
            
            // Defensif: Load ulang opsi jika kosong
            if (selMapel.options.length <= 1 && App.Cache.get('mapel_opts')) {
                 App.BankSoal.renderOptionsMapel(App.Cache.get('mapel_opts'));
            }

            // Strategi 1: Exact Match
            selMapel.value = s.mapel;
            
            // Strategi 2: Trim Spasi
            if (!selMapel.value && s.mapel) {
                selMapel.value = s.mapel.trim();
            }

            // Strategi 3: Case Insensitive Loop
            if (!selMapel.value && s.mapel) {
                const target = s.mapel.trim().toUpperCase();
                for (let i = 0; i < selMapel.options.length; i++) {
                    if (selMapel.options[i].value.toUpperCase() === target) {
                        selMapel.selectedIndex = i;
                        break;
                    }
                }
            }

            // --- C. ISI TIPE & BOBOT ---
            document.getElementById('tipe-soal').value = s.tipe;
            
            // Isi Bobot (Jika elemen ada)
            if(document.getElementById('soal-bobot')) {
                document.getElementById('soal-bobot').value = s.bobot || ""; 
            }

            // PENTING: Panggil ini agar area opsi yang sesuai (PG/Essay/dll) dimunculkan
            App.BankSoal.changeType();

            // --- D. ISI OPSI JAWABAN ---
            let opsi = {}; 
            try { opsi = JSON.parse(s.opsi); } catch(e){}
            
            if (s.tipe === 'PG') {
               ['A','B','C','D','E'].forEach(h => {
                 // Isi Text Input
                 const inputEl = document.getElementById('pg-'+h.toLowerCase());
                 if(inputEl) inputEl.value = opsi[h] || "";
                 
                 // Isi Gambar Preview (Reset dulu biar gak nyangkut gambar soal lain)
                 App.BankSoal.removeImage(h); 

                 if(opsi['img_'+h]) { 
                   App.data.opsiImages[h] = opsi['img_'+h]; 
                   const box = document.getElementById('prev-box-'+h);
                   const img = document.getElementById('img-prev-'+h);
                   if(box && img) {
                      box.classList.remove('hidden'); 
                      img.src = opsi['img_'+h]; 
                   }
                 }
               });
               // Set Kunci PG
               document.getElementById('kunci-pg').value = s.kunci;
            } 
            else if (s.tipe === 'ISIAN') {
                document.getElementById('kunci-isian').value = s.kunci;
            }
            else if (s.tipe === 'BS') { 
                const radios = document.getElementsByName('kunci_bs'); 
                for(let r of radios) { 
                    r.checked = (r.value === s.kunci);
                } 
            }
            else if (s.tipe === 'COCOK') {
               const container = document.getElementById('container-cocok'); 
               container.innerHTML = "";
               if(Array.isArray(opsi)) {
                   opsi.forEach(p => App.BankSoal.addRowCocok(p.k, p.v));
               }
            }

        }, 300); // <-- Delay 300 milidetik (0.3 detik)
      },

      // --- IMPORT EXCEL & MEDIA ---
      openImportModal: function() {
        App.UI.openModal('modal-import');
        document.getElementById('file-label').innerText = "Klik untuk pilih file ZIP";
        document.getElementById('import-file').value = ""; // Reset file input

        const sel = document.getElementById('import-mapel');
        // Helper Render
        const render = (data) => {
            sel.innerHTML = '<option value="">- Pilih Mapel -</option>';
            data.forEach(m => sel.insertAdjacentHTML('beforeend', `<option value="${m.kode}">${m.kode} - ${m.nama}</option>`));
        };

        if(App.Cache.get('mapel_opts')) {
            render(App.Cache.get('mapel_opts'));
        } else {
            sel.innerHTML = '<option value="">Loading...</option>';
            google.script.run.withSuccessHandler(d => {
                App.Cache.set('mapel_opts', d);
                render(d);
            }).getAllMapel();
        }
      },

      downloadTemplate: function() {
        const btn = document.getElementById('btn-dl-template');
        App.UI.setLoading(btn, true, 'Menyiapkan...');
        
        google.script.run.withSuccessHandler(res => {
            App.UI.setLoading(btn, false, '<i class="fas fa-download"></i> Download .ZIP');
            // Trik download file via JS
            const link = document.createElement('a');
            link.href = 'data:application/zip;base64,' + res.base64;
            link.download = res.filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }).withFailureHandler(err => {
            App.UI.setLoading(btn, false, 'Error');
            Swal.fire('Gagal', err.message, 'error');
        }).downloadTemplateImport();
      },

      handleImport: function(e) {
        e.preventDefault();
        const btn = document.getElementById('btn-action-import');
        const mapel = document.getElementById('import-mapel').value;
        const fileInput = document.getElementById('import-file');
        
        if(!mapel) return Swal.fire('Pilih Mapel', 'Silakan pilih mapel tujuan.', 'warning');
        if(fileInput.files.length === 0) return Swal.fire('Pilih File', 'File ZIP belum dipilih.', 'warning');
        
        const file = fileInput.files[0];
        // Limit client-side 25MB (Script limit is 50MB but safe 25)
        if(file.size > 25 * 1024 * 1024) return Swal.fire('Terlalu Besar', 'Maksimal ukuran file ZIP adalah 25MB.', 'warning');

        App.UI.setLoading(btn, true, 'Mengupload & Memproses...');
        
        const reader = new FileReader();
        reader.onload = function(evt) {
            const base64 = evt.target.result.split(',')[1];
            
            google.script.run.withSuccessHandler(res => {
                App.UI.setLoading(btn, false, 'Mulai Import');
                if(res.status === 'success') {
                    App.UI.closeModal('modal-import');
                    Swal.fire('Sukses!', res.message, 'success');
                    App.Cache.clearPattern('soal_'); // Clear cache soal lama
                    App.Cache.remove('stats');
                    App.BankSoal.loadDaftar(true); // Refresh tabel
                } else {
                    Swal.fire('Gagal Import', res.message, 'error');
                }
            }).processImportZip(base64, mapel);
        };
        reader.readAsDataURL(file);
      },

      hapus: function(id) {
        Swal.fire({ title: 'Hapus?', text: "Tak bisa balik.", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33' })
        .then((r) => { 
            if (r.isConfirmed) {
                google.script.run.withSuccessHandler(res => { 
                    App.Cache.clearPattern('soal_'); App.Cache.remove('stats');
                    App.BankSoal.loadDaftar(true); 
                    Swal.fire('Deleted', res.message, 'success'); 
                }).hapusSoalDb(id); 
            }
        });
      },

      resetForm: function() {
        document.getElementById('formSoal').reset();
        document.getElementById('soal-id').value = "";
        document.getElementById('soal-bobot').value = "";
        document.getElementById('form-soal-title').innerText = "Input Soal Baru";
        document.getElementById('btnSave').innerText = "SIMPAN SOAL";
        if(App.data.quill) App.data.quill.setContents([]);
        App.BankSoal.changeType();
        ['A','B','C','D','E'].forEach(h => App.BankSoal.removeImage(h));
      },
      changeType: function() {
        const tipe = document.getElementById('tipe-soal').value;
        document.querySelectorAll('.opsi-area').forEach(el => el.classList.add('hidden'));
        if (tipe === 'PG') document.getElementById('area-pg').classList.remove('hidden');
        if (tipe === 'ISIAN') document.getElementById('area-isian').classList.remove('hidden');
        if (tipe === 'ESSAY') document.getElementById('area-essay').classList.remove('hidden');
        if (tipe === 'BS') document.getElementById('area-bs').classList.remove('hidden');
        if (tipe === 'COCOK') { document.getElementById('area-cocok').classList.remove('hidden'); if(document.getElementById('container-cocok').children.length === 0) App.BankSoal.addRowCocok(); }
      },
      handleImage: function(input, hur) {
        if (input.files && input.files[0]) {
          const file = input.files[0];
          if(file.size > 2 * 1024 * 1024) return Swal.fire('Max 2MB', '', 'warning');
          const reader = new FileReader();
          reader.onload = (e) => { const b64 = e.target.result; App.data.opsiImages[hur] = b64; document.getElementById('prev-box-'+hur).classList.remove('hidden'); document.getElementById('img-prev-'+hur).src = b64; }
          reader.readAsDataURL(file);
        }
      },
      removeImage: function(hur) {
        App.data.opsiImages[hur] = null; document.getElementById('file-'+hur.toLowerCase()).value = ""; document.getElementById('prev-box-'+hur).classList.add('hidden'); document.getElementById('img-prev-'+hur).src = "";
      },
      addRowCocok: function(k='', v='') {
        const div = document.createElement('div'); div.className = 'flex gap-2 items-center';
        div.innerHTML = `<input type="text" class="input-std text-sm cocok-kiri" value="${k}" placeholder="Kiri"><i class="fas fa-arrow-right text-gray-400"></i><input type="text" class="input-std text-sm cocok-kanan" value="${v}" placeholder="Kanan"><button type="button" onclick="this.parentElement.remove()" class="text-red-400 px-2"><i class="fas fa-times"></i></button>`;
        document.getElementById('container-cocok').appendChild(div);
      }
    },

    // --- Module 4: Users Management ---
    User: {
      loadAll: function(forceRefresh = false) {
        const tbody = document.getElementById('tbody-users');
        const btnRefresh = document.getElementById('btn-refresh-user');
        if(forceRefresh && btnRefresh) btnRefresh.classList.add('fa-spin');
        if (!forceRefresh && App.Cache.get('users')) {
            App.data.userList = App.Cache.get('users'); App.User.render(App.data.currentTabRole || 'all'); return;
        }
        tbody.innerHTML = '<tr><td colspan="5" class="p-6 text-center">Loading...</td></tr>';
        google.script.run.withSuccessHandler(data => {
            if(btnRefresh) btnRefresh.classList.remove('fa-spin');
            App.Cache.set('users', data); App.data.userList = data; App.User.render(App.data.currentTabRole || 'all');
        }).getAllUsers();
      },

      render: function(role) {
        const tbody = document.getElementById('tbody-users'); tbody.innerHTML = '';
        const filtered = (role === 'all') ? App.data.userList : App.data.userList.filter(u => u.role.toLowerCase() === role);
        
        if (filtered.length === 0) { tbody.innerHTML = '<tr><td colspan="5" class="p-6 text-center text-gray-400">Belum ada data.</td></tr>'; return; }
        
        filtered.forEach(u => {
           let badge = 'bg-gray-100 text-gray-800'; 
           if(u.role==='admin') badge='bg-red-100 text-red-800'; 
           if(u.role==='guru') badge='bg-blue-100 text-blue-800'; 
           if(u.role==='siswa') badge='bg-green-100 text-green-800';
           
           const status = (u.status === 'Aktif') ? '<span class="px-2 py-0.5 rounded text-xs font-bold bg-green-100 text-green-700">Aktif</span>' : '<span class="px-2 bg-gray-200 text-gray-500 text-xs rounded">Nonaktif</span>';
           
           // LOGIKA TOMBOL HAPUS
           let btnDelete = '';
           
           // 1. Jika Admin -> Locked
           if (u.role === 'admin') {
              btnDelete = '<span class="text-xs italic text-gray-300 cursor-not-allowed"><i class="fas fa-lock"></i> Admin</span>';
           } 
           // 2. Jika Pengawas sedang dipakai di Jadwal Aktif -> Locked
           else if (u.isUsed) {
              btnDelete = '<span class="text-xs italic text-gray-400 cursor-not-allowed" title="Pengawas sedang bertugas di Jadwal Aktif"><i class="fas fa-user-clock"></i> Bertugas</span>';
           }
           // 3. Normal -> Bisa Hapus
           else {
              btnDelete = `<button onclick="App.User.hapus('${u.id}', '${u.nama}')" class="text-red-500 hover:text-red-700 transition"><i class="fas fa-trash"></i></button>`;
           }

           const actions = `<button onclick="App.User.edit('${encodeURIComponent(JSON.stringify(u))}')" class="text-indigo-600 mr-3 hover:text-indigo-800"><i class="fas fa-edit"></i></button>${btnDelete}`;
           
           tbody.insertAdjacentHTML('beforeend', `<tr class="hover:bg-slate-50 transition border-b border-gray-100"><td class="p-4 font-semibold text-gray-700">${u.nama}</td><td class="p-4"><div class="flex flex-col"><span class="text-xs text-gray-500 mb-1 font-mono">${u.username}</span><span class="w-fit px-2 py-0.5 rounded text-[10px] font-bold border uppercase ${badge}">${u.role}</span></div></td><td class="p-4 text-gray-600">${u.kelas || '-'}</td><td class="p-4">${status}</td><td class="p-4 text-right">${actions}</td></tr>`);
        });
      },

      filterTab: function(role, btn) {
        App.data.currentTabRole = role;
        document.querySelectorAll('.tab-btn').forEach(b => { b.classList.remove('bg-indigo-100', 'text-indigo-700'); b.classList.add('text-gray-500', 'hover:bg-gray-50'); });
        btn.classList.remove('text-gray-500', 'hover:bg-gray-50'); btn.classList.add('bg-indigo-100', 'text-indigo-700');
        App.User.render(role);
      },
      save: function(e) {
        e.preventDefault(); const btn = document.getElementById('btnSimpanUser'); App.UI.setLoading(btn, true, 'Simpan');
        const data = { id: document.getElementById('u-id').value, role: document.getElementById('u-role').value, nama: document.getElementById('u-nama').value, username: document.getElementById('u-username').value, password: document.getElementById('u-password').value, kelas: document.getElementById('u-kelas').value, status: document.getElementById('u-status').value };
        google.script.run.withSuccessHandler(res => { 
            App.UI.setLoading(btn, false, 'Simpan'); 
            if(res.status === 'success') { 
                App.UI.closeModal('modal-user'); Swal.fire('Sukses', res.message, 'success'); 
                App.Cache.remove('users'); App.Cache.remove('stats'); App.User.loadAll(true); 
            } else Swal.fire('Gagal', res.message, 'error'); 
        }).simpanUser(data);
      },

      edit: function(enc) {
        const u = JSON.parse(decodeURIComponent(enc));
        App.UI.openModal('modal-user'); document.getElementById('modal-title').innerText = "Edit User";
        document.getElementById('u-id').value = u.id; document.getElementById('u-role').value = u.role.toLowerCase(); document.getElementById('u-nama').value = u.nama; document.getElementById('u-username').value = u.username; document.getElementById('u-password').value = u.password; document.getElementById('u-kelas').value = u.kelas; document.getElementById('u-status').value = u.status || 'Aktif';
        App.User.toggleKelasInput();
      },

      hapus: function(id, nama) { 
          Swal.fire({ 
              title: 'Hapus User?', 
              text: `Yakin menghapus "${nama}"? Data tidak bisa kembali.`, 
              icon: 'warning', 
              showCancelButton: true, 
              confirmButtonColor: '#d33',
              confirmButtonText: 'Ya, Hapus',
              cancelButtonText: 'Batal',
              showLoaderOnConfirm: true, // Fitur bawaan Swal untuk loading spinner
              preConfirm: () => {
                  // Membungkus google.script.run dalam Promise agar Swal menunggu
                  return new Promise((resolve, reject) => {
                      google.script.run
                        .withSuccessHandler((res) => {
                            if(res.status === 'success') {
                                resolve(res); // Lanjut ke .then()
                            } else {
                                Swal.showValidationMessage(res.message); // Tampilkan error di modal
                                resolve(false); // Batalkan tutup modal (opsional) atau reject
                            }
                        })
                        .withFailureHandler((err) => {
                            Swal.showValidationMessage(err.message);
                        })
                        .hapusUser(id);
                  });
              },
              allowOutsideClick: () => !Swal.isLoading() // Cegah klik luar saat loading
          })
          .then((result) => { 
              // Blok ini hanya jalan jika preConfirm berhasil (resolve)
              if (result.isConfirmed && result.value) { 
                  Swal.fire({
                      title: 'Terhapus!',
                      text: result.value.message,
                      icon: 'success',
                      timer: 1500,
                      showConfirmButton: false
                  });
                  App.Cache.remove('users'); 
                  App.Cache.remove('stats'); 
                  App.User.loadAll(true); 
              }
          }); 
      },

      modalOpen: function() { App.UI.openModal('modal-user'); document.getElementById('modal-title').innerText = "Tambah User"; document.getElementById('u-id').value = ""; document.getElementById('u-role').value = "siswa"; document.getElementById('u-nama').value = ""; document.getElementById('u-username').value = ""; document.getElementById('u-password').value = ""; document.getElementById('u-kelas').value = ""; App.User.toggleKelasInput(); },
      toggleKelasInput: function() { const r = document.getElementById('u-role').value; const div = document.getElementById('div-kelas'); if(r === 'siswa') div.classList.remove('hidden'); else div.classList.add('hidden'); }
    },

    // --- Module 5: Mapel Management ---
    Mapel: {
      load: function(forceRefresh = false) {
        const tbody = document.getElementById('tbody-mapel'); 
        const btnRefresh = document.getElementById('btn-refresh-mapel');
        if(forceRefresh && btnRefresh) btnRefresh.classList.add('fa-spin');
        if (!forceRefresh && App.Cache.get('mapel')) { App.Mapel.render(App.Cache.get('mapel')); return; }
        tbody.innerHTML = '<tr><td colspan="4" class="p-6 text-center">Loading...</td></tr>';
        google.script.run.withSuccessHandler(data => {
           if(btnRefresh) btnRefresh.classList.remove('fa-spin');
           App.Cache.set('mapel', data); App.Cache.set('mapel_opts', data); App.Mapel.render(data);
        }).getAllMapel();
      },
      render: function(data) {
        const tbody = document.getElementById('tbody-mapel'); tbody.innerHTML = ''; 
        if(data.length===0) { tbody.innerHTML = '<tr><td colspan="4" class="p-6 text-center text-gray-400">Kosong.</td></tr>'; return; }
        data.forEach(m => { tbody.insertAdjacentHTML('beforeend', `<tr class="hover:bg-slate-50 transition border-b border-gray-100"><td class="p-4 font-mono font-bold text-indigo-600">${m.kode}</td><td class="p-4 font-semibold text-gray-700">${m.nama}</td><td class="p-4 text-gray-600">${m.guru || '-'}</td><td class="p-4 text-right"><button onclick="App.Mapel.edit('${encodeURIComponent(JSON.stringify(m))}')" class="text-indigo-600 mr-3"><i class="fas fa-edit"></i></button><button onclick="App.Mapel.hapus('${m.id}', '${m.kode}')" class="text-red-500"><i class="fas fa-trash"></i></button></td></tr>`); });
      },
      save: function(e) {
        e.preventDefault(); const btn = document.getElementById('btnSimpanMapel'); App.UI.setLoading(btn, true, 'Simpan');
        const data = { id: document.getElementById('m-id').value, kode: document.getElementById('m-kode').value.toUpperCase(), nama: document.getElementById('m-nama').value, guru: document.getElementById('m-guru').value };
        google.script.run.withSuccessHandler(res => { 
            App.UI.setLoading(btn, false, 'Simpan'); 
            if(res.status === 'success') { App.UI.closeModal('modal-mapel'); Swal.fire('Sukses', res.message, 'success'); App.Cache.remove('mapel'); App.Mapel.load(true); } 
            else Swal.fire('Gagal', res.message, 'error'); 
        }).simpanMapel(data);
      },
      edit: function(enc) {
        const m = JSON.parse(decodeURIComponent(enc)); App.UI.openModal('modal-mapel'); document.getElementById('modal-mapel-title').innerText = "Edit Mapel"; document.getElementById('m-id').value = m.id; document.getElementById('m-kode').value = m.kode; document.getElementById('m-nama').value = m.nama;
        const selGuru = document.getElementById('m-guru'); selGuru.innerHTML = '<option>Loading...</option>';
        google.script.run.withSuccessHandler(gurus => { selGuru.innerHTML = '<option value="-">- Pilih Guru -</option>'; gurus.forEach(g => { selGuru.insertAdjacentHTML('beforeend', `<option value="${g}" ${g===m.guru?'selected':''}>${g}</option>`); }); }).getListGuru();
      },
      hapus: function(id, kode) { 
          Swal.fire({ title: 'Hapus?', text: kode, icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33' })
          .then(r => { if(r.isConfirmed) { google.script.run.withSuccessHandler(res => { if(res.status==='success') { App.Cache.remove('mapel'); App.Mapel.load(true); Swal.fire('Deleted','','success'); } else Swal.fire('Gagal', res.message, 'error'); }).hapusMapel(id); }}); 
      },
      modalOpen: function() { App.UI.openModal('modal-mapel'); document.getElementById('modal-mapel-title').innerText = "Tambah Mapel"; document.getElementById('m-id').value = ""; document.getElementById('m-kode').value = ""; document.getElementById('m-nama').value = ""; const selGuru = document.getElementById('m-guru'); selGuru.innerHTML = '<option value="-">Loading...</option>'; google.script.run.withSuccessHandler(gs => { selGuru.innerHTML = '<option value="-">- Pilih Guru -</option>'; gs.forEach(g => selGuru.insertAdjacentHTML('beforeend', `<option value="${g}">${g}</option>`)); }).getListGuru(); }
    },

    // ===========================================
    // MODULE 8: KELOLA UJIAN (BARU !!!)
    // ===========================================
    Ujian: {
      // A. Load Data
      loadJenis: function(force=false) {
        const tb = document.getElementById('tbody-jenis-ujian');
        const btn = document.getElementById('btn-refresh-ujian');
        if(force && btn) btn.classList.add('fa-spin');
        
        if(!force && App.Cache.get('jenis_ujian')) return App.Ujian.renderJenis(App.Cache.get('jenis_ujian'));

        tb.innerHTML = '<tr><td colspan="4" class="p-4 text-center">Loading...</td></tr>';
        google.script.run.withSuccessHandler(data => {
           if(btn) btn.classList.remove('fa-spin');
           App.Cache.set('jenis_ujian', data);
           App.data.jenisUjianList = data; // Simpan untuk dropdown jadwal
           App.Ujian.renderJenis(data);
           // Jika Jenis berubah, dropdown jadwal harus update
           App.Ujian.loadJadwal(true); 
        }).getJenisUjian();
      },

      loadJadwal: function(force=false) {
        const tb = document.getElementById('tbody-jadwal');
        if(!force && App.Cache.get('jadwal')) return App.Ujian.renderJadwal(App.Cache.get('jadwal'));

        tb.innerHTML = '<tr><td colspan="6" class="p-4 text-center">Loading...</td></tr>';
        google.script.run.withSuccessHandler(data => {
           App.Cache.set('jadwal', data);
           App.Ujian.renderJadwal(data);
        }).getJadwalUjian();
      },

      // B. Render Tables
      renderJenis: function(data) {
        const tb = document.getElementById('tbody-jenis-ujian'); 
        tb.innerHTML = '';
        
        if(data.length === 0) { 
            tb.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-400">Belum ada Nama Ujian.</td></tr>'; 
            return; 
        }
        
        data.forEach((item, i) => {
           const badge = item.status === 'Aktif' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
           // encodeURIComponent agar aman saat dipassing ke fungsi edit
           const json = encodeURIComponent(JSON.stringify(item));
           
           // LOGIKA DISABLE TOMBOL HAPUS
           let btnHapus = '';
           if (item.isUsed) {
              // Jika sedang dipakai: Tampilkan ikon gembok/sampah abu-abu, cursor not-allowed, dan tooltip
              btnHapus = `
                <button class="text-gray-300 cursor-not-allowed" title="Sedang digunakan di Jadwal. Tidak bisa dihapus." disabled>
                    <i class="fas fa-trash"></i>
                </button>
              `;
           } else {
              // Jika aman: Tombol merah normal
              btnHapus = `
                <button onclick="App.Ujian.hapusJenis('${item.id}')" class="text-red-500 hover:text-red-700 transition" title="Hapus">
                    <i class="fas fa-trash"></i>
                </button>
              `;
           }

           tb.insertAdjacentHTML('beforeend', `
             <tr class="border-b hover:bg-slate-50 transition">
               <td class="p-3 font-semibold text-gray-700">${item.nama}</td>
               <td class="p-3 text-sm text-gray-500">${item.ket || '-'}</td>
               <td class="p-3"><span class="px-2 py-1 rounded text-xs font-bold ${badge}">${item.status}</span></td>
               <td class="p-3 text-right">
                 <button onclick="App.Ujian.editJenis('${json}')" class="text-indigo-600 mr-3 hover:text-indigo-800 transition" title="Edit">
                    <i class="fas fa-edit"></i>
                 </button>
                 ${btnHapus}
               </td>
             </tr>
           `);
        });
      },

      // A. RENDER TABEL JADWAL (Tambah kolom Pengawas)
      // 1. UPDATE: Render Tabel Jadwal (Menampilkan Info Kelas)
      renderJadwal: function(data) {
        const tb = document.getElementById('tbody-jadwal'); tb.innerHTML = '';
        if(data.length===0) { tb.innerHTML='<tr><td colspan="6" class="p-4 text-center text-gray-400">Belum ada Jadwal.</td></tr>'; return; } // Colspan update jadi 6

        data.forEach((item, i) => {
           const badge = item.status === 'Aktif' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500';
           const fmt = { dateStyle: 'medium', timeStyle: 'short' };
           const mulai = new Date(item.mulai).toLocaleString('id-ID', fmt);
           const selesai = new Date(item.selesai).toLocaleString('id-ID', fmt);
           const json = encodeURIComponent(JSON.stringify(item));
           
           // Display Kelas
           const kelasDisplay = item.target_kelas === 'Semua' 
              ? '<span class="px-2 py-0.5 bg-gray-100 text-gray-600 rounded text-xs font-bold">Semua Kelas</span>' 
              : `<span class="px-2 py-0.5 bg-yellow-100 text-yellow-700 rounded text-xs font-bold"><i class="fas fa-users"></i> ${item.target_kelas}</span>`;

           // Display Pengawas
           let pengawasDisplay = '<span class="text-gray-400 italic">Semua</span>';
           if(item.pengawas && item.pengawas.toLowerCase() !== 'semua') {
              pengawasDisplay = `<span class="bg-purple-100 text-purple-700 px-2 py-0.5 rounded text-xs font-bold"><i class="fas fa-user-shield"></i> ${item.pengawas}</span>`;
           }
           
           tb.insertAdjacentHTML('beforeend', `
             <tr class="border-b hover:bg-slate-50">
               <td class="p-3">
                 <div class="font-bold text-gray-700">${item.nama_ujian}</div>
                 <div class="text-xs text-indigo-600 font-mono">${item.nama_mapel}</div>
               </td>
               <td class="p-3 text-xs">
                 <div class="text-gray-600"><i class="fas fa-play text-green-500 w-4"></i> ${mulai}</div>
                 <div class="text-gray-600 mt-1"><i class="fas fa-stop text-red-500 w-4"></i> ${selesai}</div>
               </td>
               <td class="p-3 text-xs">${pengawasDisplay}</td>
               <td class="p-3 text-xs">${kelasDisplay}</td> <td class="p-3"><span class="px-2 py-1 rounded text-xs font-bold ${badge}">${item.status}</span></td>
               <td class="p-3 text-right">
                 <button onclick="App.Ujian.editJadwal('${json}')" class="text-indigo-600 mr-2"><i class="fas fa-edit"></i></button>
                 <button onclick="App.Ujian.hapusJadwal('${item.id}')" class="text-red-500"><i class="fas fa-trash"></i></button>
               </td>
             </tr>
           `);
        });
      },

      // C. CRUD Operations (Jenis)
      saveJenis: function(e) {
        e.preventDefault(); const btn=document.getElementById('btnSimpanJenis'); App.UI.setLoading(btn,true,'Simpan');
        const d = { id: document.getElementById('j-id').value, nama: document.getElementById('j-nama').value, ket: document.getElementById('j-ket').value, status: document.getElementById('j-status').value };
        google.script.run.withSuccessHandler(r=>{
           App.UI.setLoading(btn,false,'Simpan'); 
           if(r.status==='success') { App.UI.closeModal('modal-jenis'); App.Cache.remove('jenis_ujian'); App.Ujian.loadJenis(true); Swal.fire('Sukses',r.message,'success'); }
        }).simpanJenisUjian(d);
      },
      editJenis: function(str) {
        const d=JSON.parse(decodeURIComponent(str)); App.UI.openModal('modal-jenis'); document.getElementById('modal-jenis-title').innerText="Edit Nama Ujian";
        document.getElementById('j-id').value=d.id; document.getElementById('j-nama').value=d.nama; document.getElementById('j-ket').value=d.ket; document.getElementById('j-status').value=d.status;
      },
      hapusJenis: function(id) { Swal.fire({title:'Hapus?',text:'Jadwal terkait mungkin error',icon:'warning',showCancelButton:true,confirmButtonColor:'#d33'}).then(r=>{ if(r.isConfirmed) google.script.run.withSuccessHandler(()=>{ App.Cache.remove('jenis_ujian'); App.Ujian.loadJenis(true); }).hapusJenisUjian(id); }); },
      openModalJenis: function() { App.UI.openModal('modal-jenis'); document.getElementById('modal-jenis-title').innerText="Tambah Nama Ujian"; document.getElementById('formJenis').reset(); document.getElementById('j-id').value=""; },

      // B. SAVE JADWAL (Kirim data Pengawas)
      saveJadwal: function(e) {
        e.preventDefault(); 
        const btn = document.getElementById('btnSimpanJadwal'); 
        App.UI.setLoading(btn, true, 'Simpan');
        
        const m = document.getElementById('sch-mulai').value;
        const s = document.getElementById('sch-selesai').value;
        
        const d = { 
          id: document.getElementById('sch-id').value, 
          id_jenis: document.getElementById('sch-jenis').value,
          kode_mapel: document.getElementById('sch-mapel').value,
          mulai: m, 
          selesai: s, 
          status: document.getElementById('sch-status').value,
          pengawas: document.getElementById('sch-pengawas').value,
          target_kelas: document.getElementById('sch-kelas').value,
          // DATA BARU
          durasi: document.getElementById('sch-durasi').value,
          acak_soal: document.getElementById('sch-acak-soal').checked,
          acak_opsi: document.getElementById('sch-acak-opsi').checked
        };
        
        google.script.run.withSuccessHandler(r=>{
          App.UI.setLoading(btn,false,'Simpan'); 
          if(r.status==='success') { App.UI.closeModal('modal-jadwal'); App.Cache.remove('jadwal'); App.Ujian.loadJadwal(true); Swal.fire('Sukses',r.message,'success'); }
          else Swal.fire('Error', r.message, 'error');
        }).simpanJadwal(d);
      },

      editJadwal: function(str) {
        const d = JSON.parse(decodeURIComponent(str)); 
        App.Ujian.openModalJadwal(true, d.pengawas || 'semua', d.kode_mapel, d.target_kelas || 'Semua'); 
        
        document.getElementById('modal-jadwal-title').innerText = "Edit Set Ujian";
        document.getElementById('sch-id').value = d.id;
        
        setTimeout(() => {
          document.getElementById('sch-jenis').value = d.id_jenis;
          document.getElementById('sch-status').value = d.status;
          document.getElementById('sch-mulai').value = d.mulai;
          document.getElementById('sch-selesai').value = d.selesai;
          // DATA BARU
          document.getElementById('sch-durasi').value = d.durasi || 60;
          document.getElementById('sch-acak-soal').checked = d.acak_soal;
          document.getElementById('sch-acak-opsi').checked = d.acak_opsi;
        }, 500); 
      },

      hapusJadwal: function(id) { Swal.fire({title:'Hapus Jadwal?',icon:'warning',showCancelButton:true,confirmButtonColor:'#d33'}).then(r=>{ if(r.isConfirmed) google.script.run.withSuccessHandler(()=>{ App.Cache.remove('jadwal'); App.Ujian.loadJadwal(true); }).hapusJadwal(id); }); },
      
      // Tambahkan parameter 'selectedVal' (default null)
      // 3. UPDATE: Open Modal (Load Dropdown Kelas)
      // Tambahkan parameter 'selectedKelas'
      openModalJadwal: function(isEdit=false, selectedPengawas=null, selectedMapel=null, selectedKelas=null) {
        App.UI.openModal('modal-jadwal'); 
        
        if(!isEdit) {
          document.getElementById('modal-jadwal-title').innerText = "Set Ujian Baru";
          document.getElementById('formJadwal').reset(); 
          document.getElementById('sch-id').value = "";
          // RESET FIELD BARU
          document.getElementById('sch-durasi').value = "60"; 
          document.getElementById('sch-acak-soal').checked = false;
          document.getElementById('sch-acak-opsi').checked = false;

          selectedPengawas = 'semua';
          selectedMapel = "";
          selectedKelas = "Semua"; // Default
        }
        
        // --- LOGIKA JENIS UJIAN ---
        const selJenis = document.getElementById('sch-jenis');
        if(selJenis.options.length <= 1) {
            selJenis.innerHTML = '<option value="">- Pilih Ujian -</option>';
            (App.data.jenisUjianList || []).forEach(j => {
              if(j.status === 'Aktif') selJenis.insertAdjacentHTML('beforeend', `<option value="${j.id}">${j.nama}</option>`);
            });
        }
        
        // --- LOGIKA MAPEL ---
        const selMapel = document.getElementById('sch-mapel');
        const renderMapelOpts = (data) => {
            selMapel.innerHTML = '<option value="">- Pilih Mapel/Bank Soal -</option>';
            data.forEach(m => selMapel.insertAdjacentHTML('beforeend', `<option value="${m.kode}">${m.kode} - ${m.nama}</option>`));
            if(selectedMapel) selMapel.value = selectedMapel;
        };
        if(selMapel.options.length <= 1) {
            if(App.Cache.get('mapel')) renderMapelOpts(App.Cache.get('mapel'));
            else google.script.run.withSuccessHandler(d => { App.Cache.set('mapel',d); renderMapelOpts(d); }).getAllMapel();
        } else {
            if(selectedMapel) selMapel.value = selectedMapel;
        }

        // --- LOGIKA PENGAWAS ---
        const selPengawas = document.getElementById('sch-pengawas');
        selPengawas.innerHTML = '<option value="">Loading...</option>';
        google.script.run.withSuccessHandler(users => {
            selPengawas.innerHTML = '<option value="semua">Semua Pengawas</option>';
            users.forEach(u => selPengawas.insertAdjacentHTML('beforeend', `<option value="${u.username}">${u.nama} (${u.username})</option>`));
            if(selectedPengawas) selPengawas.value = selectedPengawas;
        }).getListPengawas();

        // --- TAMBAHAN: LOGIKA DROP DOWN KELAS ---
        const selKelas = document.getElementById('sch-kelas');
        selKelas.innerHTML = '<option value="Semua">Loading...</option>';
        google.script.run.withSuccessHandler(kelasList => {
           selKelas.innerHTML = '<option value="Semua">Semua Kelas</option>';
           kelasList.forEach(k => {
               selKelas.insertAdjacentHTML('beforeend', `<option value="${k}">${k}</option>`);
           });
           if(selectedKelas) selKelas.value = selectedKelas;
        }).getListKelasUnik();
      }
    },

    // --- Module 6: Exam Logic ---
    Exam: {
      initSiswa: function(user) { /* Deprecated by Dashboard logic but kept for safety */ },

      shuffleArray: function(array) {
          for (let i = array.length - 1; i > 0; i--) {
              const j = Math.floor(Math.random() * (i + 1));
              [array[i], array[j]] = [array[j], array[i]];
          }
          return array;
      },

      start: function(kodeMapel, config) {
          // Guard: Ambil data jadwal saat ini
          const idJadwal = App.data.activeJadwalId; 
          const username = App.data.user ? App.data.user.username : JSON.parse(sessionStorage.getItem('cbt_session')).data.username;

          // 1. Panggil Server untuk cek Sisa Waktu & Status
          Swal.fire({title: 'Memuat Ujian...', didOpen: () => Swal.showLoading()});
          
          google.script.run.withSuccessHandler(res => {
              Swal.close();

              // Jika status Terkunci di server
              if (res.status === 'locked') {
                 App.Security.triggerLock("Status Terkunci. Masukkan Token.");
                 return;
              }

              // Jika Sukses
              App.data.examRunning = true; 
              
              // UI Changes
              document.getElementById('dashboard-container').classList.add('hidden');
              document.getElementById('page-siswa').classList.remove('hidden');
              document.getElementById('header-mapel').innerText = kodeMapel;
              
              // Reset UI Load
              document.getElementById('exam-loading').classList.remove('hidden');
              document.getElementById('soal-container').classList.add('hidden');
              document.getElementById('nav-buttons').classList.add('hidden');
              document.getElementById('disp-pertanyaan').innerHTML = "";

              try { App.Security.enterFullscreen(); } catch(e){}

              // --- TIMER DARI SERVER ---
              // res.remainingSeconds adalah sisa detik yang valid dari server
              App.Exam.timerStart(res.remainingSeconds); 

              // Fetch Soal
              App.Exam.loadSoal(kodeMapel, config);

          }).startExamSession(username, idJadwal);
      },

      loadSoal: function(kode, config) {
          const username = App.data.user ? App.data.user.username : JSON.parse(sessionStorage.getItem('cbt_session')).data.username;
          const idJadwal = App.data.activeJadwalId;

          google.script.run.withSuccessHandler(res => {
            if(res.status === 'success') {
              let rawSoal = res.data;
              if(config && config.acakSoal) rawSoal = App.Exam.shuffleArray(rawSoal);
              
              rawSoal.forEach(s => {
                  let keys = ['A','B','C','D','E'];
                  if(config && config.acakOpsi && s.tipe === 'PG') s.shuffledKeys = App.Exam.shuffleArray([...keys]);
                  else s.shuffledKeys = keys;
              });

              App.data.soalList = rawSoal; 
              
              // === FITUR LOAD PROGRESS ===
              // Panggil DB Progress untuk mengembalikan jawaban siswa
              google.script.run.withSuccessHandler(savedJson => {
                  if (savedJson && savedJson !== "{}") {
                      try {
                          const savedJawaban = JSON.parse(savedJson);
                          App.data.jawabanSiswa = savedJawaban;
                          
                          // Optional: Toast notifikasi
                          Swal.fire({
                              toast: true, position: 'top-end', icon: 'info', 
                              title: 'Jawaban tersimpan dimuat kembali', 
                              timer: 3000, showConfirmButton: false
                          });
                      } catch(e) { console.log("Error parse progress", e); }
                  }

                  // Tampilkan UI setelah data siap
                  document.getElementById('exam-loading').classList.add('hidden'); 
                  document.getElementById('soal-container').classList.remove('hidden'); 
                  document.getElementById('nav-buttons').classList.remove('hidden'); 
                  document.getElementById('nav-buttons').classList.add('flex'); 
                  
                  App.Exam.render(0);
                  App.Exam.renderGrid();

              }).getProgressSiswa(username, idJadwal);
              // ============================

            } else { 
              Swal.fire('Gagal', res.message, 'error').then(() => window.location.reload());
            }
          }).getSoalUjian(kode);
      },

      render: function(idx) {
          App.data.currentSoalIdx = idx; 
          const s = App.data.soalList[idx];
          const totalSoal = App.data.soalList.length;
          
          document.getElementById('disp-no').innerText = idx + 1;
          document.getElementById('disp-pertanyaan').innerHTML = s.pertanyaan; 

          const imgCont = document.getElementById('disp-gambar-container'); 
          const img = document.getElementById('disp-gambar');
          if(s.gambar) { imgCont.classList.remove('hidden'); img.src = s.gambar; } else { imgCont.classList.add('hidden'); }
          
          const ops = document.getElementById('disp-opsi'); 
          ops.innerHTML = '';

          // RENDER OPSI (PG / BS / ESSAY) - Kode tetap sama
          const labelUrut = ['A','B','C','D','E'];
          if(s.tipe === 'PG') {
              const labelUrut = ['A','B','C','D','E']; 
              let visualIndex = 0; // <--- PENGHITUNG MANUAL (KUNCI PERBAIKANNYA)

              s.shuffledKeys.forEach((realKey) => {
                // Hanya render jika isi opsi benar-benar ada
                if(s.opsi[realKey]) {
                  // Ambil label berdasarkan urutan visual yang valid (0=A, 1=B, dst)
                  const visualLabel = labelUrut[visualIndex]; 
                  visualIndex++; // Naikkan penghitung hanya setelah render berhasil

                  const isActive = App.data.jawabanSiswa[s.id] === realKey 
                      ? 'bg-indigo-600 text-white border-indigo-600' 
                      : 'bg-white hover:bg-gray-50 text-gray-700';
                  
                  ops.insertAdjacentHTML('beforeend', `
                    <div onclick="App.Exam.pilih('${s.id}','${realKey}')" class="cursor-pointer border rounded-lg p-3 flex gap-3 items-center transition shadow-sm mb-2 ${isActive}">
                        <div class="w-8 h-8 flex items-center justify-center rounded-full font-bold border shrink-0 ${isActive.includes('bg-white') ? 'bg-gray-100 text-gray-600 border-gray-200' : 'bg-white text-indigo-600 border-white'}">
                            ${visualLabel}
                        </div>
                        <div class="flex-1 text-sm md:text-base">
                            ${s.opsi[realKey]}
                        </div>
                    </div>
                  `);
                }
              });
          } else if (s.tipe === 'BS') {
              ['A','B'].forEach(h => {
                  const val = h==='A'?'BENAR':'SALAH';
                  const active = App.data.jawabanSiswa[s.id] === val ? 'bg-indigo-600 text-white' : 'bg-white';
                  ops.insertAdjacentHTML('beforeend', `<div onclick="App.Exam.pilih('${s.id}','${val}')" class="cursor-pointer border rounded p-3 font-bold ${active}">${val}</div>`);
              });
          } else {
              const val = App.data.jawabanSiswa[s.id] || '';
              ops.innerHTML = `<textarea onkeyup="App.Exam.pilih('${s.id}', this.value)" class="w-full border rounded p-2 h-32 focus:ring-2 ring-indigo-500 outline-none">${val}</textarea>`;
          }

          App.Exam.renderGrid();

          // === LOGIKA TOMBOL NEXT / SELESAI (BARU) ===
          const btnNextContainer = document.getElementById('nav-buttons');
          // Cari tombol Next (asumsi tombol terakhir di container)
          // Kita cari berdasarkan onclick atau buat ID khusus. 
          // Agar aman, kita update HTML tombol Next di fungsi loadSoal/HTML, 
          // atau kita manipulasi children terakhir:
          
          const btnNext = btnNextContainer.lastElementChild; 
          
          if (idx === totalSoal - 1) {
              // Jika Soal Terakhir: Ubah jadi SELESAI
              btnNext.innerHTML = 'Selesai <i class="fas fa-check-circle"></i>';
              btnNext.className = "px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-bold w-24 shadow-md transition";
              btnNext.onclick = function() { App.Exam.finish(); }; // Panggil Finish
          } else {
              // Jika Bukan Soal Terakhir: Ubah jadi NEXT
              btnNext.innerHTML = 'Next <i class="fas fa-chevron-right"></i>';
              btnNext.className = "px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-bold w-24 shadow-md transition";
              btnNext.onclick = function() { App.Exam.next(); }; // Panggil Next
          }
      },

      pilih: function(id, val) { 
          // 1. Update State Lokal (Agar UI langsung berubah)
          App.data.jawabanSiswa[id] = val; 
          
          // 2. Update Grid Navigasi (Agar warna nomor berubah)
          App.Exam.renderGrid(); 
          
          // Jika soal tipe PG/BS, update UI opsi aktif tanpa render ulang seluruh soal (agar tidak kedip)
          const currentSoal = App.data.soalList.find(s => s.id === id);
          if(currentSoal && (currentSoal.tipe === 'PG' || currentSoal.tipe === 'BS')) {
              // Hapus kelas aktif dari semua opsi di soal ini
              // (Implementasi sederhana: render ulang opsi saja jika mau, atau biarkan render ulang soal)
              // Untuk konsistensi visual yang cepat, kita biarkan logic render ulang soal jika perlu, 
              // tapi biasanya render ulang soal (App.Exam.render) akan memutuskan fokus input essay.
              // Jadi kita cek: jika Essay jangan render ulang soal.
              if(currentSoal.tipe !== 'ESSAY' && currentSoal.tipe !== 'ISIAN') {
                 // Tidak perlu render ulang full jika hanya klik opsi, tapi kode lama me-render ulang.
                 // Kita biarkan render ulang untuk PG/BS agar visual update.
                 // Tapi UNTUK ESSAY JANGAN RENDER ULANG (nanti keyboard close di HP).
                 // Logic render ada di luar fungsi pilih di kode lama? 
                 // Di kode sebelumnya, pilih() tidak memanggil render() kecuali untuk update UI.
                 // Kita update UI opsi manual atau panggil render() hanya untuk PG.
                 // Di kode render() sebelumnya saya melihat ada onclick="...render()..."
                 // Mari kita update UI via DOM manipulation sederhana atau panggil render jika bukan essay.
                 // (Untuk keamanan, panggil render jika bukan essay/isian)
              }
          }

          // 3. LOGIKA AUTO-SAVE REALTIME (THE MAGIC)
          const username = App.data.user ? App.data.user.username : JSON.parse(sessionStorage.getItem('cbt_session')).data.username;
          const idJadwal = App.data.activeJadwalId;
          
          // Fungsi Pembantu untuk mengirim data
          const executeSave = () => {
              const jawabanJson = JSON.stringify(App.data.jawabanSiswa);
              google.script.run
                  .withFailureHandler(e => console.error("Gagal AutoSave", e)) // Silent fail (hanya console)
                  .simpanProgressSiswa(username, idJadwal, jawabanJson);
          };

          // 4. CEK TIPE SOAL UNTUK STRATEGI PENYIMPANAN
          if (currentSoal && (currentSoal.tipe === 'ESSAY' || currentSoal.tipe === 'ISIAN')) {
              // STRATEGI DEBOUNCE (Tunda Simpan)
              // Jika user masih mengetik, batalkan simpan sebelumnya
              if (App.data.saveTimeout) clearTimeout(App.data.saveTimeout);
              
              // Tunggu 1 detik (1000ms) setelah ketikan terakhir, baru kirim ke server
              App.data.saveTimeout = setTimeout(() => {
                  executeSave();
              }, 1000); 
          } else {
              // STRATEGI INSTANT (Langsung Simpan)
              // Untuk PG/BS/Cocok, langsung kirim saat diklik
              executeSave();
              
              // Render ulang UI agar terlihat terpilih (Khusus PG/BS)
              if (currentSoal.tipe !== 'ESSAY' && currentSoal.tipe !== 'ISIAN') {
                 App.Exam.render(App.data.currentSoalIdx);
              }
          }
      },
      
      next: function() { 
          // 1. AUTO SAVE KE DATABASE CADANGAN
          const username = App.data.user ? App.data.user.username : JSON.parse(sessionStorage.getItem('cbt_session')).data.username;
          const idJadwal = App.data.activeJadwalId;
          const jawabanJson = JSON.stringify(App.data.jawabanSiswa);

          // Kirim ke backend secara "Silent" (tanpa loading spinner agar tidak mengganggu)
          google.script.run.withFailureHandler(err => console.log("Gagal AutoSave", err))
                           .simpanProgressSiswa(username, idJadwal, jawabanJson);

          // 2. PINDAH SOAL
          if(App.data.currentSoalIdx < App.data.soalList.length-1) {
              App.Exam.render(App.data.currentSoalIdx+1);
          }
      },

      prev: function() { if(App.data.currentSoalIdx > 0) App.Exam.render(App.data.currentSoalIdx-1); },
      toggleRagu: function() { 
          const id = App.data.soalList[App.data.currentSoalIdx].id; 
          if(App.data.raguSiswa[id]) delete App.data.raguSiswa[id]; else App.data.raguSiswa[id] = true; 
          App.Exam.render(App.data.currentSoalIdx); // Refresh grid & UI
      },
      
      // Update Render Grid (Nomor Soal)
      renderGrid: function() {
        const g = document.getElementById('grid-nomor'); 
        g.innerHTML='';
        App.data.soalList.forEach((s,i) => {
           let c = 'bg-white border text-gray-600 hover:bg-gray-100'; // Default
           
           // Jika sudah dijawab
           if(App.data.jawabanSiswa[s.id]) c = 'bg-indigo-600 text-white border-indigo-600'; 
           
           // Jika ragu-ragu (Overwrite warna jawab)
           if(App.data.raguSiswa[s.id]) c = 'bg-yellow-400 text-white border-yellow-400'; 
           
           // Jika soal yang sedang aktif
           if(i === App.data.currentSoalIdx) {
               c += ' ring-4 ring-indigo-200 transform scale-105 font-black'; // Highlight current
           }
           
           g.insertAdjacentHTML('beforeend', `<button onclick="App.Exam.render(${i})" class="h-10 w-full rounded font-bold text-sm ${c} transition-all shadow-sm">${i+1}</button>`);
        });
      },

      // 1. UPDATE: Validasi Tombol Selesai
      finish: function() {
          // A. Cek Soal Kosong & Ragu-ragu
          let kosong = [];
          let ragu = [];

          App.data.soalList.forEach((s, i) => {
              const nomor = i + 1;
              // Cek Kosong (undefined, null, atau string kosong)
              if (!App.data.jawabanSiswa[s.id] || App.data.jawabanSiswa[s.id] === "") {
                  kosong.push(nomor);
              }
              // Cek Ragu (harus true)
              if (App.data.raguSiswa[s.id] === true) {
                  ragu.push(nomor);
              }
          });

          // B. Jika Ada Masalah -> Tolak Submit
          if (kosong.length > 0 || ragu.length > 0) {
              let htmlMsg = '<div class="text-left text-sm bg-red-50 p-4 rounded border border-red-100">';
              if (kosong.length > 0) htmlMsg += `<p class="mb-2"><strong class="text-red-600">Belum dijawab:</strong><br>No. ${kosong.join(", ")}</p>`;
              if (ragu.length > 0) htmlMsg += `<p><strong class="text-yellow-600">Masih Ragu-ragu:</strong><br>No. ${ragu.join(", ")}</p>`;
              htmlMsg += '</div>';

              Swal.fire({
                  title: 'Tidak Bisa Mengirim!',
                  html: htmlMsg + '<p class="mt-3 text-xs text-gray-500">Silakan lengkapi atau hilangkan tanda ragu-ragu.</p>',
                  icon: 'warning',
                  confirmButtonText: 'Periksa Kembali'
              });
              return; // STOP PROSES
          }

          // C. Jika Bersih -> Konfirmasi Akhir
          Swal.fire({ 
              title: 'Kumpulkan Jawaban?', 
              text: 'Yakin semua jawaban sudah benar? Anda tidak bisa mengubahnya lagi.', 
              icon: 'question', 
              showCancelButton: true, 
              confirmButtonText: 'Ya, Kumpulkan', 
              confirmButtonColor: '#059669',
              cancelButtonText: 'Batal' 
          }).then(r => { 
              if (r.isConfirmed) App.Exam.submit(false); // False = Manual Submit
          }); 
      },
      
      // 2. UPDATE: Fungsi Submit (Handle Manual vs Auto)
      submit: function(isAutoSubmit) {
         // Hentikan semua timer
         App.data.examRunning = false; 
         clearInterval(App.data.timer); 
         if (App.data.saveTimeout) clearTimeout(App.data.saveTimeout);

         // Tampilan Loading
         let titleMsg = isAutoSubmit ? 'Waktu Habis!' : 'Menyimpan Jawaban...';
         let textMsg = isAutoSubmit ? 'Mengirim jawaban otomatis...' : 'Mohon tunggu sebentar.';

         Swal.fire({ 
             title: titleMsg, 
             text: textMsg, 
             icon: isAutoSubmit ? 'warning' : 'info',
             allowOutsideClick: false, 
             allowEscapeKey: false,
             didOpen: () => { Swal.showLoading(); } 
         });
         
         const username = App.data.user ? App.data.user.username : JSON.parse(sessionStorage.getItem('cbt_session')).data.username;

         const p = { 
             nama: document.getElementById('header-nama').innerText, 
             mapel: document.getElementById('header-mapel').innerText, 
             jawaban: App.data.jawabanSiswa,
             username: username,
             idJadwal: App.data.activeJadwalId
         };
         
         google.script.run.withSuccessHandler(res => { 
             if(res.status === 'success') {
                 // Berhasil
                 Swal.fire({
                     title: 'Ujian Selesai!', 
                     // PERBAIKAN 1: Teks diubah, tidak menampilkan res.nilai lagi
                     text: 'Jawaban Anda telah tersimpan ke sistem. Terima kasih.', 
                     icon: 'success',
                     confirmButtonText: 'Kembali ke Dashboard',
                     allowOutsideClick: false
                 }).then(() => {
                     // PERBAIKAN 2: Reload Instan menggunakan URL yang sudah disimpan di awal
                     if(App.data.scriptUrl) {
                        window.top.location.href = App.data.scriptUrl;
                     } else {
                        // Fallback (Jaga-jaga jika url belum terambil, baru reload manual)
                        window.top.location.reload();
                     }
                 });
             } else { 
                 Swal.fire('Gagal Menyimpan', res.message + '. Silakan lapor pengawas.', 'error'); 
             }
         }).submitUjian(p);
      },

      // 3. UPDATE: Timer (Picu Auto Submit)
      timerStart: function(secondsLeft) {
         if(App.data.timer) clearInterval(App.data.timer);
         App.data.timeLeft = secondsLeft;

         App.data.timer = setInterval(() => {
            App.data.timeLeft--;
            
            // Format Waktu
            const hours = Math.floor(App.data.timeLeft / 3600);
            const minutes = Math.floor((App.data.timeLeft % 3600) / 60);
            const seconds = App.data.timeLeft % 60;
            const timerStr = hours > 0 
                ? `${hours}:${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}` 
                : `${minutes}:${seconds.toString().padStart(2,'0')}`;

            const timerEl = document.getElementById('timer-display');
            if(timerEl) timerEl.innerText = timerStr;
            
            // Warning 5 menit
            if(App.data.timeLeft === 300) {
                Swal.fire({ toast: true, position: 'top-end', icon: 'warning', title: 'Waktu tinggal 5 menit!', timer: 3000, showConfirmButton: false });
            }

            // AUTO SUBMIT SAAT WAKTU HABIS (0 DETIK)
            if(App.data.timeLeft <= 0) { 
                clearInterval(App.data.timer); 
                // Panggil submit dengan parameter TRUE (Auto Submit)
                // Ini akan mem-bypass validasi kosong/ragu
                App.Exam.submit(true); 
            }
         }, 1000);
      }
    },

    // --- Module Pengawas (REVISED) ---
    Pengawas: {
       // A. DASHBOARD: JADWAL SEMUA KELAS (Read Only)
       loadJadwalGlobal: function() {
          // Sembunyikan elemen admin di view-ujian
          document.querySelectorAll('#view-ujian button').forEach(b => b.classList.add('hidden')); // Sembunyikan tombol tambah
          document.querySelectorAll('#view-ujian h3').forEach(h => {
              if(h.innerText.includes('1. Nama Ujian')) h.parentElement.parentElement.classList.add('hidden'); // Sembunyikan tabel master jenis
          });
          
          document.getElementById('page-title').innerText = "Jadwal Ujian Sekolah";
          const tbody = document.getElementById('tbody-jadwal');
          tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center"><i class="fas fa-spinner fa-spin"></i> Memuat Jadwal...</td></tr>';
          
          google.script.run.withSuccessHandler(data => {
             App.Ujian.renderJadwal(data); // Reuse render admin
             // Hapus kolom aksi (Edit/Delete) setelah render
             setTimeout(() => {
                 const rows = tbody.querySelectorAll('tr');
                 rows.forEach(r => { 
                     if(r.lastElementChild) r.lastElementChild.innerHTML = '<span class="text-gray-400 text-xs italic">Read Only</span>'; 
                 });
             }, 100);
          }).getJadwalUjian();
       },

       // B. HALAMAN TOKEN
       loadPageToken: function() {
          document.getElementById('page-title').innerText = "Manajemen Token";
          const container = document.getElementById('list-token-pengawas');
          container.innerHTML = '<div class="text-center p-10"><i class="fas fa-circle-notch fa-spin text-indigo-500 text-2xl"></i><p class="mt-2 text-gray-500">Mengambil Jadwal Anda...</p></div>';

          const user = JSON.parse(sessionStorage.getItem('cbt_session')).data;
          
          google.script.run.withSuccessHandler(res => {
             container.innerHTML = '';
             const jadwal = res.jadwal; // List jadwal yang ditugaskan ke pengawas ini
             
             if(jadwal.length === 0) {
                 container.innerHTML = '<div class="p-8 text-center border-2 border-dashed border-gray-300 rounded-xl"><i class="fas fa-coffee text-gray-300 text-4xl mb-3"></i><p class="text-gray-500 font-bold">Tidak ada jadwal ujian aktif untuk Anda saat ini.</p></div>';
                 return;
             }

             const now = new Date();

             jadwal.forEach(j => {
                 const start = new Date(j.mulai);
                 const end = new Date(j.selesai);
                 
                 // Logika Tombol Aktif/Tidak
                 let btnState = 'disabled class="w-full py-3 bg-gray-200 text-gray-400 rounded-lg font-bold cursor-not-allowed"';
                 let btnText = 'BELUM MULAI';
                 let cardBorder = 'border-l-4 border-gray-300';
                 let statusText = `<span class="text-xs font-bold text-gray-500 bg-gray-100 px-2 py-1 rounded">MENUNGGU</span>`;

                 if (now >= start && now <= end) {
                     // AKTIF
                     btnState = `onclick="App.Pengawas.lihatToken('${j.id}', '${j.mapel}')" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold shadow-lg transform active:scale-95 transition"`;
                     btnText = '<i class="fas fa-eye"></i> LIHAT TOKEN';
                     cardBorder = 'border-l-4 border-indigo-500 shadow-md ring-1 ring-indigo-50';
                     statusText = `<span class="text-xs font-bold text-green-700 bg-green-100 px-2 py-1 rounded animate-pulse">BERLANGSUNG</span>`;
                 } else if (now > end) {
                     // SELESAI
                     btnState = 'disabled class="w-full py-3 bg-red-50 text-red-300 rounded-lg font-bold cursor-not-allowed"';
                     btnText = 'UJIAN DITUTUP';
                     cardBorder = 'border-l-4 border-red-200 opacity-70';
                     statusText = `<span class="text-xs font-bold text-red-500 bg-red-50 px-2 py-1 rounded">SELESAI</span>`;
                 }

                 const tgl = start.toLocaleDateString('id-ID', { weekday:'long', day:'numeric', month:'short' });
                 const jam = start.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'}) + ' - ' + end.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});

                 container.insertAdjacentHTML('beforeend', `
                    <div class="bg-white p-5 rounded-xl border border-gray-100 ${cardBorder} flex flex-col justify-between">
                       <div class="mb-4">
                          <div class="flex justify-between items-start mb-2">
                             <h4 class="font-bold text-lg text-gray-800 leading-tight">${j.mapel}</h4>
                             ${statusText}
                          </div>
                          <div class="text-sm text-gray-500 space-y-1">
                             <div class="flex items-center gap-2"><i class="far fa-calendar text-indigo-400 w-5"></i> ${tgl}</div>
                             <div class="flex items-center gap-2"><i class="far fa-clock text-indigo-400 w-5"></i> ${jam}</div>
                          </div>
                       </div>
                       <button ${btnState}>${btnText}</button>
                    </div>
                 `);
             });

          }).getPengawasDashboard(user.username);
       },

       lihatToken: function(idJadwal, mapelName) {
           Swal.fire({
               title: 'Mengambil Token...',
               allowOutsideClick: false,
               didOpen: () => { Swal.showLoading(); }
           });
           
           google.script.run.withSuccessHandler(res => {
               Swal.close();
               if(res.token && res.token !== 'ERROR') {
                   Swal.fire({
                       title: mapelName,
                       html: `<div class="bg-indigo-50 p-4 rounded-lg border border-indigo-100 mb-2">
                                <p class="text-xs text-gray-500 uppercase font-bold mb-1">Token Ujian</p>
                                <h1 class="text-5xl font-mono font-black text-indigo-700 tracking-widest">${res.token}</h1>
                              </div>
                              <p class="text-sm text-gray-400">Berikan token ini kepada siswa.</p>`,
                       showConfirmButton: true,
                       confirmButtonText: 'Tutup'
                   });
               } else {
                   Swal.fire('Gagal', 'Token tidak tersedia atau waktu ujian habis.', 'error');
               }
           }).getMonitoringSiswa(idJadwal); // Kita reuse fungsi ini karena dia return {token, students}
       },

       // C. HALAMAN MONITORING
       loadPageMonitoring: function() {
          document.getElementById('page-title').innerText = "Monitoring Ujian";
          const sel = document.getElementById('mon-list-ujian');
          const tbody = document.getElementById('tbody-mon-pgw');
          const panelInfo = document.getElementById('mon-info-panel');
          
          // Reset UI
          sel.innerHTML = '<option value="">Loading...</option>';
          tbody.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-gray-400">Silakan pilih ujian di atas.</td></tr>';
          panelInfo.classList.add('hidden');

          const user = JSON.parse(sessionStorage.getItem('cbt_session')).data;

          // 1. Load Dropdown Jadwal (Khusus Pengawas Ini)
          google.script.run.withSuccessHandler(res => {
              sel.innerHTML = '<option value="">- Pilih Ujian untuk Dimonitor -</option>';
              if(res.jadwal.length === 0) {
                  sel.innerHTML = '<option value="">(Tidak ada ujian aktif)</option>';
                  return;
              }
              res.jadwal.forEach(j => {
                  sel.insertAdjacentHTML('beforeend', `<option value="${j.id}">${j.mapel} (${new Date(j.mulai).toLocaleTimeString()})</option>`);
              });
          }).getPengawasDashboard(user.username);
       },

       refreshMonitoring: function() {
           const idJadwal = document.getElementById('mon-list-ujian').value;
           const tbody = document.getElementById('tbody-mon-pgw');
           const panelInfo = document.getElementById('mon-info-panel');
           
           if(!idJadwal) {
               // colspan 3 karena kolom aksi sudah dihapus
               tbody.innerHTML = '<tr><td colspan="3" class="p-8 text-center text-gray-400">Silakan pilih ujian.</td></tr>';
               panelInfo.classList.add('hidden');
               return;
           }

           tbody.innerHTML = '<tr><td colspan="3" class="p-8 text-center"><i class="fas fa-spinner fa-spin"></i> Loading data siswa...</td></tr>';
           
           google.script.run.withSuccessHandler(res => {
               panelInfo.classList.remove('hidden');
               document.getElementById('mon-token-small').innerText = res.token;
               
               tbody.innerHTML = '';
               if(res.students.length === 0) {
                   tbody.innerHTML = '<tr><td colspan="3" class="p-8 text-center text-gray-400 italic">Belum ada siswa terdaftar.</td></tr>';
                   return;
               }

               res.students.forEach(s => {
                   let badge = "";
                   let statusTxt = s.status;

                   // --- UPDATE WARNA STATUS ---
                   if(s.status === 'SEDANG MENGERJAKAN') {
                       // KUNING
                       badge = "bg-yellow-100 text-yellow-800 border border-yellow-200 animate-pulse";
                       statusTxt = `<i class="fas fa-pen"></i> SEDANG MENGERJAKAN`;
                   } 
                   else if(s.status === 'SELESAI') {
                       // HIJAU
                       badge = "bg-green-100 text-green-700 border border-green-200";
                       statusTxt = `<i class="fas fa-check"></i> SELESAI`;
                   } 
                   else if(s.status === 'TERKUNCI' || s.isLocked) {
                       // MERAH
                       badge = "bg-red-600 text-white font-bold animate-bounce shadow";
                       statusTxt = `<i class="fas fa-lock"></i> TERKUNCI`;
                   } 
                   else {
                       // ABU-ABU (Default)
                       badge = "bg-gray-200 text-gray-600 border border-gray-300";
                       statusTxt = "BELUM MENGERJAKAN";
                   }

                   // Render Baris (TANPA KOLOM AKSI)
                   tbody.insertAdjacentHTML('beforeend', `
                       <tr class="border-b hover:bg-slate-50 transition">
                           <td class="p-3">
                               <div class="font-bold text-gray-700 text-sm">${s.nama}</div>
                               <div class="text-[10px] text-gray-400 font-mono">${s.username}</div>
                           </td>
                           <td class="p-3 text-center text-xs text-gray-600">${s.kelas || '-'}</td>
                           <td class="p-3 text-center">
                                <span class="px-3 py-1.5 rounded text-[10px] uppercase font-bold tracking-wide border ${badge}">
                                    ${statusTxt}
                                </span>
                           </td>
                       </tr>
                   `);
               });

           }).getMonitoringSiswa(idJadwal);
       },

       // D. HALAMAN PELANGGARAN SISWA
       loadPagePelanggaran: function() {
          document.getElementById('page-title').innerText = "Daftar Pelanggaran Siswa";
          const sel = document.getElementById('pel-list-ujian');
          const tbody = document.getElementById('tbody-pel-pgw');
          
          // Reset UI
          sel.innerHTML = '<option value="">Loading...</option>';
          tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-400">Silakan pilih ujian di atas.</td></tr>';

          const user = JSON.parse(sessionStorage.getItem('cbt_session')).data;

          // Load Dropdown Jadwal (Sama seperti monitoring)
          google.script.run.withSuccessHandler(res => {
              sel.innerHTML = '<option value="">- Pilih Ujian -</option>';
              if(res.jadwal.length === 0) {
                  sel.innerHTML = '<option value="">(Tidak ada ujian aktif)</option>';
                  return;
              }
              res.jadwal.forEach(j => {
                  sel.insertAdjacentHTML('beforeend', `<option value="${j.id}">${j.mapel} (${new Date(j.mulai).toLocaleTimeString()})</option>`);
              });
          }).getPengawasDashboard(user.username);
       },

       refreshPelanggaran: function() {
           const idJadwal = document.getElementById('pel-list-ujian').value;
           const tbody = document.getElementById('tbody-pel-pgw');
           
           if(!idJadwal) {
               tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-400">Silakan pilih ujian.</td></tr>';
               return;
           }

           tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center"><i class="fas fa-spinner fa-spin"></i> Memeriksa pelanggaran...</td></tr>';
           
           google.script.run.withSuccessHandler(res => {
               tbody.innerHTML = '';
               const violators = res.students.filter(s => s.status === 'TERKUNCI' || s.isLocked);

               if(violators.length === 0) {
                   tbody.innerHTML = '<tr><td colspan="5" class="p-10 text-center"><div class="text-green-500 text-4xl mb-2"><i class="fas fa-check-circle"></i></div><p class="text-gray-500 font-bold">Aman. Tidak ada pelanggaran saat ini.</p></td></tr>';
                   return;
               }

               violators.forEach(s => {
                   // AMBIL ALASAN DARI SERVER
                   const violationDetail = s.violationReason || "Terkunci Sistem";

                   tbody.insertAdjacentHTML('beforeend', `
                       <tr class="border-b bg-red-50 hover:bg-red-100 transition">
                           <td class="p-4 font-bold text-gray-700">${s.nama} <br> <span class="text-xs font-normal text-gray-500 font-mono">${s.username}</span></td>
                           <td class="p-4 text-center text-sm">${s.kelas}</td>
                           <td class="p-4 text-center"><span class="bg-red-600 text-white px-3 py-1 rounded-full text-xs font-bold animate-pulse">TERKUNCI</span></td>
                           <td class="p-4 text-sm text-red-700 font-medium"><i class="fas fa-exclamation-circle"></i> ${violationDetail}</td>
                           <td class="p-4 text-center">
                               <button onclick="App.Pengawas.bukaKunci('${s.username}', '${s.nama}')" class="px-4 py-2 bg-white border border-red-300 text-red-600 rounded-lg text-sm font-bold hover:bg-red-600 hover:text-white shadow-sm transition">
                                 <i class="fas fa-key"></i> Buka
                               </button>
                           </td>
                       </tr>
                   `);
               });
           }).getMonitoringSiswa(idJadwal);
       },

       bukaKunci: function(username, nama) {
          Swal.fire({
             title: 'Buka Kunci Siswa?', 
             text: `Siswa: ${nama}. Pastikan siswa melapor kepada Anda.`, 
             icon: 'warning',
             showCancelButton:true, 
             confirmButtonText:'Generate Token',
             confirmButtonColor: '#d33'
          }).then(r => {
             if(r.isConfirmed) {
                google.script.run.withSuccessHandler(token => {
                   Swal.fire({
                     title: 'TOKEN BUKA KUNCI',
                     html: `<h1 class="text-4xl font-bold text-red-600 mt-2 tracking-widest bg-red-50 p-4 rounded border border-red-100">${token}</h1><p class="text-sm text-gray-500 mt-3">Berikan token ini ke siswa untuk membuka kunci layar.</p>`,
                   });
                }).generateUnlockToken(username);
             }
          });
       }
    },

    // --- Module Siswa (Dashboard Logic) ---
    Siswa: {
       // Load Dashboard: Jadwal + Status
       loadDashboard: function() {
          const div = document.getElementById('list-ujian-siswa');
          div.innerHTML = '<div class="text-center py-10"><i class="fas fa-spinner fa-spin text-3xl text-indigo-500"></i><p class="mt-2 text-gray-400">Memuat Jadwal & Status...</p></div>';
          
          const session = JSON.parse(sessionStorage.getItem('cbt_session'));
          const user = session ? session.data : null;

          if (!user) {
             div.innerHTML = '<p class="text-center text-red-500">Sesi error. Silakan logout dan login ulang.</p>';
             return;
          }
          
          google.script.run.withSuccessHandler(data => {
             div.innerHTML = '';
             
             if(!data || data.length === 0) { 
                 div.innerHTML = '<div class="text-center p-8 bg-white rounded-xl shadow-sm border border-gray-100"><img src="https://img.icons8.com/fluency/96/null/nothing-found.png" class="mx-auto mb-3 h-16"><h3 class="font-bold text-gray-700">Tidak ada jadwal ujian.</h3><p class="text-xs text-gray-400">Jadwal untuk kelas Anda belum tersedia saat ini.</p></div>'; 
                 return; 
             }
             
             data.forEach(j => {
                const dMulai = new Date(j.mulai);
                const dSelesai = new Date(j.selesai);
                const tanggal = dMulai.toLocaleDateString('id-ID', {day: 'numeric', month: 'short'});
                const jam = dMulai.toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'}) + ' - ' + dSelesai.toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'});

                let cardColor = "border-l-4 border-gray-400";
                let statusBadge = '<span class="bg-gray-100 text-gray-500 px-2 py-1 rounded text-xs font-bold">BELUM MENGERJAKAN</span>';
                let btnAction = '';

                // Encode config dengan aman
                const configStr = encodeURIComponent(JSON.stringify({ durasi: j.durasi, acakSoal: j.acak_soal, acakOpsi: j.acak_opsi }));

                if (j.status_personal === 'SELESAI') {
                    cardColor = "border-l-4 border-green-500 bg-green-50/30"; // Sedikit background hijau transparan
                    
                    statusBadge = '<span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold"><i class="fas fa-check-circle"></i> SELESAI MENGERJAKAN</span>';
                    
                    // Tombol berubah jadi teks biasa warna hijau tebal
                    btnAction = '<div class="px-5 py-2 font-black text-green-600 tracking-wider text-lg">SELESAI</div>';
                } 
                else if (j.status_personal === 'SEDANG') {
                    cardColor = "border-l-4 border-yellow-500 ring-1 ring-yellow-200";
                    statusBadge = '<span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-xs font-bold animate-pulse"><i class="fas fa-pen"></i> SEDANG MENGERJAKAN</span>';
                    btnAction = `<button onclick="App.Siswa.actionMulai('${j.kode_mapel}', '${j.id}', '${configStr}', false)" class="px-5 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg font-bold shadow text-sm transition">LANJUT MENGERJAKAN <i class="fas fa-arrow-right"></i></button>`;
                }
                else if (j.status_personal === 'TERKUNCI') {
                    cardColor = "border-l-4 border-red-600 bg-red-50";
                    statusBadge = '<span class="bg-red-600 text-white px-2 py-1 rounded text-xs font-bold"><i class="fas fa-lock"></i> TERKUNCI</span>';
                    btnAction = `<button onclick="App.Siswa.actionUnlock('${j.kode_mapel}', '${j.id}', '${configStr}')" class="px-5 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-bold shadow text-sm transition"><i class="fas fa-key"></i> MASUKKAN TOKEN BUKA KUNCI</button>`;
                }
                else {
                    cardColor = "border-l-4 border-indigo-500 hover:shadow-md transition";
                    const now = new Date();
                    if (now < dMulai) {
                        btnAction = `<button disabled class="px-4 py-2 bg-gray-200 text-gray-400 rounded-lg font-bold cursor-not-allowed text-sm">Belum Dimulai</button>`;
                    } else if (now > dSelesai) {
                        btnAction = `<button disabled class="px-4 py-2 bg-red-100 text-red-400 rounded-lg font-bold cursor-not-allowed text-sm">Waktu Habis</button>`;
                    } else {
                        btnAction = `<button onclick="App.Siswa.actionMulai('${j.kode_mapel}', '${j.id}', '${configStr}', true)" class="px-5 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold shadow text-sm transition">MULAI MENGERJAKAN</button>`;
                    }
                }

                div.insertAdjacentHTML('beforeend', `
                  <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 ${cardColor} mb-4 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                     <div class="space-y-2 flex-1">
                        <div class="flex items-center gap-2 mb-1">
                           <span class="text-[10px] font-bold uppercase tracking-wider bg-gray-100 text-gray-600 px-2 py-0.5 rounded">${j.jenis}</span>
                           ${statusBadge}
                        </div>
                        <h4 class="font-bold text-xl text-gray-800">${j.nama_mapel} <span class="text-sm font-normal text-gray-500">(${j.kode_mapel})</span></h4>
                        <div class="grid grid-cols-2 md:flex md:gap-6 text-sm text-gray-600 mt-2">
                            <div class="flex items-center gap-2"><i class="far fa-calendar-alt text-indigo-400"></i> ${tanggal}</div>
                            <div class="flex items-center gap-2"><i class="far fa-clock text-indigo-400"></i> ${jam}</div>
                            <div class="flex items-center gap-2"><i class="fas fa-hourglass-half text-indigo-400"></i> ${j.durasi} Menit</div>
                            <div class="flex items-center gap-2"><i class="fas fa-user-tie text-indigo-400"></i> ${j.pengawas}</div>
                        </div>
                     </div>
                     <div class="w-full md:w-auto flex justify-end">${btnAction}</div>
                  </div>
                `);
             });
          }).getStudentDashboardData(user.username, user.kelas); 
       },

       // Action: Mulai (DIPERBAIKI)
       actionMulai: function(kodeMapel, idJadwal, configStr, needToken) {
           App.data.activeJadwalId = idJadwal;
           // Fungsi Internal untuk start
           const executeStart = () => {
               try {
                   const config = JSON.parse(decodeURIComponent(configStr));
                   
                   // Ambil username dengan aman
                   let username = '';
                   if (App.data.user) username = App.data.user.username;
                   else {
                       const s = JSON.parse(sessionStorage.getItem('cbt_session'));
                       if(s) username = s.data.username;
                   }

                   // Panggil server untuk set status
                   google.script.run.startExamSession(username, idJadwal);
                   // Panggil frontend untuk ganti tampilan
                   App.Exam.start(kodeMapel, config);

               } catch (e) {
                   console.error(e);
                   Swal.fire('Error Sistem', 'Gagal memproses konfigurasi ujian: ' + e.message, 'error');
               }
           };

           if(!needToken) {
               executeStart();
               return;
           }

           Swal.fire({
            title: 'Token Ujian',
            text: 'Minta token kepada Pengawas',
            input: 'text',
            inputAttributes: { autocapitalize: 'off', autocomplete: 'off' },
            showCancelButton: true,
            confirmButtonText: 'Mulai',
            confirmButtonColor: '#4f46e5',
            showLoaderOnConfirm: true,
            preConfirm: (token) => {
               return new Promise((resolve) => {
                  google.script.run.withSuccessHandler(res => {
                     if(res.status === 'success') {
                         resolve(true); // Berhasil, tutup modal dan lanjut
                     } else {
                         // JANGAN resolve(false), cukup showValidationMessage
                         // Agar modal tetap terbuka dan siswa bisa input ulang
                         Swal.showValidationMessage(res.message);
                         resolve(); // Resolve kosong agar loading berhenti tapi modal tidak close (tergantung versi Swal)
                         // Jika modal tetap tertutup, hapus baris resolve() ini.
                     }
                  }).withFailureHandler(err => {
                      Swal.showValidationMessage("Error Koneksi: " + err.message);
                      resolve(); 
                  }).verifikasiTokenUjian(token.toUpperCase(), idJadwal);
               });
            },
            allowOutsideClick: () => !Swal.isLoading()
          }).then((result) => {
             // Pastikan isConfirmed true DAN value true
             if (result.isConfirmed && result.value === true) {
                executeStart();
             }
          });
       },

       // Action: Unlock (FIXED & TESTED)
       actionUnlock: function(kodeMapel, idJadwal, configStr) {
           // 1. Simpan ID Jadwal ke Global (Penting untuk Security)
           App.data.activeJadwalId = idJadwal;
           
           // 2. Ambil Username
           const username = App.data.user ? App.data.user.username : JSON.parse(sessionStorage.getItem('cbt_session')).data.username;

           Swal.fire({
            title: 'TERKUNCI',
            text: 'Masukkan Token Buka Kunci',
            input: 'text',
            inputAttributes: { autocapitalize: 'off' },
            showCancelButton: true,
            confirmButtonText: 'Buka & Lanjut',
            confirmButtonColor: '#dc2626',
            showLoaderOnConfirm: true,
            preConfirm: (token) => {
               return new Promise((resolve) => {
                  // Verifikasi Token
                  google.script.run.withSuccessHandler(res => {
                     if(res.status === 'success') resolve(true);
                     else { Swal.showValidationMessage(res.message); resolve(false); }
                  }).verifikasiTokenUnlock(token, username);
               });
            }
          }).then((result) => {
             if (result.isConfirmed && result.value === true) {
                const config = JSON.parse(decodeURIComponent(configStr));
                
                // Tampilkan Loading
                Swal.fire({title: 'Membuka Kunci...', didOpen: () => Swal.showLoading()});

                // === PERBAIKAN UTAMA DISINI ===
                // Panggil unlockSiswa dulu untuk mereset status DB dari 'LOCKED' ke 'STARTED'
                google.script.run.withSuccessHandler(() => {
                    
                    // Setelah DB bersih, baru mulai ujian
                    Swal.close();
                    App.Exam.start(kodeMapel, config);
                    
                }).unlockSiswa(username, idJadwal);
             }
          });
       },

       loadHasil: function() {
           const tbody = document.getElementById('tbody-hasil-siswa');
           tbody.innerHTML = '<tr><td colspan="4" class="p-6 text-center"><i class="fas fa-spinner fa-spin"></i> Memuat...</td></tr>';
           const sess = JSON.parse(sessionStorage.getItem('cbt_session'));
           if(!sess) return;

           google.script.run.withSuccessHandler(data => {
               tbody.innerHTML = '';
               if(!data || data.length === 0) { tbody.innerHTML = '<tr><td colspan="4" class="p-6 text-center text-gray-400">Belum ada riwayat ujian.</td></tr>'; return; }

               data.forEach(r => {
                   const tgl = new Date(r.waktu).toLocaleString('id-ID');
                   let nilaiClass = "text-gray-800";
                   if(r.nilai < 70) nilaiClass = "text-red-600";
                   if(r.nilai >= 85) nilaiClass = "text-green-600";

                   tbody.insertAdjacentHTML('beforeend', `
                     <tr class="hover:bg-slate-50 border-b">
                        <td class="p-4 text-xs text-gray-500">${tgl}</td>
                        <td class="p-4 font-bold text-gray-700">${r.mapel}</td>
                        <td class="p-4 text-center text-sm">${r.benar}</td>
                        <td class="p-4 text-center font-bold text-lg ${nilaiClass}">${r.nilai}</td>
                     </tr>
                   `);
               });
           }).getRiwayatNilaiSiswa(sess.data.nama);
       }
    },

    // --- MODULE MONITORING ADMIN (UPDATED) ---
    AdminMonitor: {
       currentExamId: null,
       listCache: [],

       loadSummary: function() {
          const listDiv = document.getElementById('adm-list-exams');
          listDiv.innerHTML = '<div class="text-center mt-10 text-gray-400"><i class="fas fa-circle-notch fa-spin text-2xl"></i><p class="text-xs mt-2">Memuat Data...</p></div>';
          
          google.script.run.withSuccessHandler(res => {
             App.AdminMonitor.listCache = res.exams || []; 
             App.AdminMonitor.renderList(); 
          }).getAdminMonitoringSummary();
       },

       // 1. UPDATE: RENDER LIST (SIDEBAR KIRI)
       renderList: function() {
          const listDiv = document.getElementById('adm-list-exams');
          listDiv.innerHTML = '';
          
          const exams = App.AdminMonitor.listCache; 

          if (exams.length === 0) {
             listDiv.innerHTML = '<div class="text-center p-6 bg-white rounded-lg border border-gray-200"><i class="fas fa-coffee text-gray-300 text-3xl mb-2"></i><p class="text-gray-500 text-sm font-bold">Tidak ada ujian aktif.</p></div>';
             return;
          }

          exams.forEach(ex => {
              const dMulai = new Date(ex.mulai);
              const dSelesai = new Date(ex.selesai);
              const optsDate = { weekday: 'long', day: 'numeric', month: 'short' }; 
              const optsTime = { hour: '2-digit', minute: '2-digit' };
              const tanggalStr = dMulai.toLocaleDateString('id-ID', optsDate);
              const jamStr = dMulai.toLocaleTimeString('id-ID', optsTime) + ' - ' + dSelesai.toLocaleTimeString('id-ID', optsTime);

              const isActive = (App.AdminMonitor.currentExamId === ex.id) ? 'border-indigo-500 ring-1 ring-indigo-500 bg-indigo-50' : 'border-gray-200 bg-white hover:border-indigo-400';
              
              // LOGIKA WARNA BADGE TOKEN DI LIST
              let badgeClass = "bg-indigo-100 text-indigo-700";
              let icon = "fa-key";
              
              if(ex.statusWaktu === 'waiting') {
                  badgeClass = "bg-yellow-100 text-yellow-700"; // Kuning untuk Belum Mulai
                  icon = "fa-clock";
              } else if (ex.statusWaktu === 'done') {
                  badgeClass = "bg-gray-200 text-gray-600"; // Abu untuk Selesai
                  icon = "fa-check-circle";
              } else {
                  badgeClass = "bg-green-100 text-green-700 animate-pulse"; // Hijau untuk Aktif
              }

              const item = document.createElement('div');
              item.className = `cursor-pointer p-4 rounded-xl border transition group relative overflow-hidden ${isActive}`;
              item.onclick = () => App.AdminMonitor.loadDetail(ex.id, ex.mapel, ex.jenis, ex.token, ex.statusWaktu); // Pass statusWaktu
              
              item.innerHTML = `
                 <div class="flex justify-between items-start mb-2 relative z-10">
                    <span class="text-[10px] font-bold uppercase tracking-wider text-gray-500 bg-gray-100 px-2 py-0.5 rounded">${ex.jenis}</span>
                    <span class="text-[10px] font-bold px-2 py-0.5 rounded flex items-center gap-1 ${badgeClass}">
                        <i class="fas ${icon}"></i> ${ex.token}
                    </span>
                 </div>
                 <h4 class="font-bold text-gray-800 text-base mb-1 leading-tight group-hover:text-indigo-700">${ex.mapel}</h4>
                 <div class="mt-3 pt-3 border-t border-dashed border-gray-200 text-xs text-gray-600 space-y-1">
                    <div class="flex items-center gap-2"><i class="far fa-calendar-alt w-4 text-center text-gray-400"></i> <span>${tanggalStr}</span></div>
                    <div class="flex items-center gap-2"><i class="far fa-clock w-4 text-center text-gray-400"></i> <span class="font-mono font-bold">${jamStr}</span></div>
                 </div>
              `;
              listDiv.appendChild(item);
          });
       },

       // 2. UPDATE: LOAD DETAIL (HEADER KANAN)
       loadDetail: function(idJadwal, mapelName, jenisName, initialToken, statusWaktu) {
          App.AdminMonitor.currentExamId = idJadwal;
          App.AdminMonitor.renderList(); // Refresh highlight kiri

          document.getElementById('adm-mon-title').innerText = mapelName;
          document.getElementById('adm-mon-subtitle').innerText = jenisName;
          
          // Update Header Token
          const elToken = document.getElementById('adm-mon-token');
          const elHeader = document.querySelector('#adm-mon-title').parentElement.parentElement; // Header Container (bg-indigo-600)
          
          elToken.innerText = initialToken;
          
          // LOGIKA WARNA HEADER DETAIL
          // Default Class Header: p-4 border-b bg-indigo-600 text-white ...
          
          if(statusWaktu === 'waiting' || initialToken === 'BELUM MULAI') {
             elHeader.className = "p-4 border-b bg-yellow-500 text-white flex justify-between items-center z-10 shrink-0 transition-colors";
             elToken.className = "block text-xl font-bold tracking-tight text-white";
          } 
          else if (statusWaktu === 'done' || initialToken === 'SELESAI') {
             elHeader.className = "p-4 border-b bg-gray-600 text-white flex justify-between items-center z-10 shrink-0 transition-colors";
             elToken.className = "block text-xl font-bold tracking-tight text-gray-300";
          } 
          else {
             // AKTIF
             elHeader.className = "p-4 border-b bg-indigo-600 text-white flex justify-between items-center z-10 shrink-0 transition-colors";
             elToken.className = "block text-2xl font-mono font-black tracking-widest text-yellow-300";
          }

          document.getElementById('adm-header-stats').classList.remove('hidden');
          
          const tbody = document.getElementById('tbody-adm-monitoring');
          const listLocked = document.getElementById('list-adm-locked');
          const badgeLocked = document.getElementById('badge-locked-count');
          
          tbody.innerHTML = '<tr><td colspan="4" class="p-10 text-center"><i class="fas fa-spinner fa-spin text-indigo-500 text-2xl"></i><p class="mt-2 text-gray-500">Mengambil data realtime...</p></td></tr>';
          
          // Panggil Data Realtime
          google.script.run.withSuccessHandler(res => {
             // Update Token (Siapa tau berubah realtime)
             elToken.innerText = res.token;

             const data = res.students;
             tbody.innerHTML = '';
             listLocked.innerHTML = '';
             let lockedCount = 0;

             if(data.length === 0) {
                 tbody.innerHTML = '<tr><td colspan="4" class="p-10 text-center text-gray-400 bg-gray-50 italic">Belum ada siswa yang login pada ujian ini.</td></tr>';
                 listLocked.innerHTML = '<p class="text-xs text-gray-400 italic w-full text-center col-span-full mt-4">Tidak ada data.</p>';
                 badgeLocked.classList.add('hidden');
                 return;
             }

             data.forEach(s => {
                let badge = "bg-gray-100 text-gray-500";
                let statusText = s.status;
                if(s.status === 'SEDANG MENGERJAKAN') { badge = "bg-blue-100 text-blue-700 border border-blue-200 animate-pulse"; statusText = "MENGERJAKAN"; }
                if(s.status === 'SELESAI') { badge = "bg-emerald-100 text-emerald-700 border border-emerald-200"; }
                
                let actionBtn = '<span class="text-gray-300">-</span>';
                if(s.status === 'TERKUNCI' || s.isLocked) {
                    badge = "bg-red-600 text-white font-bold shadow-sm animate-bounce"; statusText = "TERKUNCI"; lockedCount++;
                    actionBtn = `<button onclick="App.Pengawas.bukaKunci('${s.username}', '${s.nama}')" class="px-3 py-1 bg-white border border-red-200 text-red-600 rounded text-xs font-bold hover:bg-red-50 shadow-sm transition"><i class="fas fa-unlock"></i> Buka</button>`;
                    listLocked.insertAdjacentHTML('beforeend', `<div class="flex justify-between items-center bg-white p-3 rounded-lg border-l-4 border-red-500 shadow-sm hover:shadow-md transition"><div class="overflow-hidden mr-2"><p class="text-sm font-bold text-gray-800 truncate">${s.nama}</p><p class="text-[10px] text-gray-500 font-mono">${s.username}</p><p class="text-[10px] text-red-500 font-bold mt-1"><i class="fas fa-lock"></i> TERKUNCI</p></div><button onclick="App.Pengawas.bukaKunci('${s.username}', '${s.nama}')" class="shrink-0 px-4 py-2 bg-red-600 text-white text-xs font-bold rounded hover:bg-red-700 shadow flex items-center gap-2"><i class="fas fa-key"></i> Buka</button></div>`);
                }

                tbody.insertAdjacentHTML('beforeend', `<tr class="hover:bg-slate-50 border-b transition"><td class="p-3"><div class="font-bold text-gray-700 text-sm">${s.nama}</div><div class="text-[10px] text-gray-400 font-mono">${s.username}</div></td><td class="p-3 text-center text-xs font-medium text-gray-600">${s.kelas}</td><td class="p-3 text-center"><span class="px-2 py-1 rounded text-[10px] uppercase font-bold tracking-wide ${badge}">${statusText}</span></td><td class="p-3 text-center">${actionBtn}</td></tr>`);
             });

             if(lockedCount === 0) { listLocked.innerHTML = `<div class="col-span-full flex flex-col items-center justify-center text-gray-400 py-4 opacity-70"><i class="fas fa-check-circle text-4xl mb-2 text-green-200"></i><p class="text-xs font-bold">Aman. Tidak ada pelanggaran.</p></div>`; badgeLocked.classList.add('hidden'); } 
             else { badgeLocked.innerText = lockedCount; badgeLocked.classList.remove('hidden'); }

          }).getMonitoringSiswa(idJadwal);
       }
    },

    // --- MODULE HASIL UJIAN ADMIN ---
    AdminHasil: {
       load: function(force=false) {
          const tbody = document.getElementById('tbody-hasil-admin');
          const filter = document.getElementById('filter-hasil-admin').value;
          
          if(App.Cache.get('mapel_opts')) {
             // Populate dropdown filter mapel admin jika kosong
             const sel = document.getElementById('filter-hasil-admin');
             if(sel.options.length <= 1) {
                App.Cache.get('mapel_opts').forEach(m => sel.insertAdjacentHTML('beforeend', `<option value="${m.kode}">${m.kode}</option>`));
             }
          }

          tbody.innerHTML = '<tr><td colspan="5" class="p-6 text-center"><i class="fas fa-spinner fa-spin"></i> Memuat Hasil...</td></tr>';
          
          google.script.run.withSuccessHandler(data => {
             tbody.innerHTML = '';
             if(data.length === 0) { tbody.innerHTML = '<tr><td colspan="5" class="p-6 text-center text-gray-400">Belum ada data nilai masuk.</td></tr>'; return; }
             
             data.forEach(r => {
                const w = new Date(r.waktu).toLocaleString('id-ID');
                let color = 'text-gray-700';
                if(r.nilai < 60) color = 'text-red-600 font-bold';
                if(r.nilai >= 85) color = 'text-green-600 font-bold';
                
                tbody.insertAdjacentHTML('beforeend', `
                   <tr class="hover:bg-slate-50 border-b">
                      <td class="p-4 text-xs text-gray-500">${w}</td>
                      <td class="p-4 font-semibold text-gray-700">${r.nama}</td>
                      <td class="p-4"><span class="bg-indigo-50 text-indigo-700 px-2 py-1 rounded text-xs font-bold">${r.mapel}</span></td>
                      <td class="p-4 text-center font-mono text-xs">${r.detail}</td>
                      <td class="p-4 text-center text-lg ${color}">${r.nilai}</td>
                   </tr>
                `);
             });
          }).getHasilUjianAdmin(filter);
       }
    },

    // --- Module 7: UI Utilities ---
    UI: {
      setLoading: function(btn, isLoading, text) {
        btn.disabled = isLoading;
        btn.innerHTML = isLoading ? `<i class="fas fa-circle-notch fa-spin"></i> ${text}` : text;
      },

      switchView: function(viewId, btn) {
        // 1. Mobile Sidebar Toggle
        if(window.innerWidth < 768) App.UI.toggleSidebar(false);
        
        // 2. Active State Styling (Navigasi)
        document.querySelectorAll('.nav-item').forEach(el => el.className = 'nav-item w-full flex items-center gap-3 px-6 py-3 transition text-left hover:bg-slate-800 text-gray-400 hover:text-white');
        if(btn) btn.className = 'nav-item w-full flex items-center gap-3 px-6 py-3 transition text-left bg-slate-800 border-l-4 border-indigo-500 text-white';
        
        // 3. Sembunyikan Semua View
        const allViews = [
            'view-dashboard', 'view-bank-soal', 'view-akun', 'view-mapel', 'view-ujian',
            'view-jadwal-siswa', 'view-hasil-ujian', 'view-pengawas', // view-pengawas (legacy)
            'view-admin-monitoring', 'view-admin-hasil', 'view-hasil-siswa',
            'view-pengawas-token', 'view-pengawas-monitor', // View Baru Pengawas
            'view-pengawas-pelanggaran',
            'view-placeholder'
        ];

        allViews.forEach(id => { 
            const el = document.getElementById(id); 
            if(el) el.classList.add('hidden'); 
        });

        // --- RESET UI STATES ---
        // Kembalikan view-ujian ke kondisi normal (Admin Mode) jika sebelumnya diubah oleh Pengawas
        const viewUjian = document.getElementById('view-ujian');
        if (viewUjian) {
            viewUjian.querySelectorAll('button').forEach(b => b.classList.remove('hidden'));
            viewUjian.querySelectorAll('h3').forEach(h => {
                if(h.innerText.includes('1. Nama Ujian')) h.parentElement.parentElement.classList.remove('hidden');
            });
            // Hapus label Read Only jika ada
            viewUjian.querySelectorAll('.read-only-label').forEach(el => el.remove());
        }

        // 4. Set Judul Halaman
        const map = { 
            'dashboard':'Dashboard', 
            'akun':'Kelola Akun', 
            'mapel':'Mapel', 
            'bank-soal':'Bank Soal', 
            'ujian':'Kelola Ujian',
            'hasil-siswa': 'Riwayat Nilai',
            'pengawas-token': 'Token Ujian',
            'pengawas-monitor': 'Monitoring Ujian'
        };
        const pageTitle = document.getElementById('page-title');
        if(pageTitle) pageTitle.innerText = map[viewId] || viewId.toUpperCase();

        // 5. Logika Percabangan View

        // --- LOGIC SISWA ---
        if (App.data.role === 'siswa') {
            if (viewId === 'dashboard') {
                document.getElementById('view-jadwal-siswa').classList.remove('hidden');
                App.Siswa.loadDashboard();
                if(pageTitle) pageTitle.innerText = "Jadwal Ujian Kelas Anda";
                return; 
            }
            if (viewId === 'hasil-siswa') {
                document.getElementById('view-hasil-siswa').classList.remove('hidden');
                App.Siswa.loadHasil();
                return;
            }
        }

        // --- LOGIC PENGAWAS (BARU) ---
        if (App.data.role === 'pengawas') {
            // A. Dashboard Pengawas -> Jadwal Global (Read Only)
            if (viewId === 'dashboard') {
                document.getElementById('view-ujian').classList.remove('hidden'); 
                App.Pengawas.loadJadwalGlobal(); // Memuat tabel jadwal ujian (read-only)
                return;
            }
            // B. Halaman Token
            if (viewId === 'pengawas-token') {
                document.getElementById('view-pengawas-token').classList.remove('hidden');
                App.Pengawas.loadPageToken();
                return;
            }
            // C. Halaman Monitoring
            if (viewId === 'pengawas-monitor') {
                document.getElementById('view-pengawas-monitor').classList.remove('hidden');
                App.Pengawas.loadPageMonitoring();
                return;
            }
            // D. HALAMAN BARU: PELANGGARAN SISWA
            if (viewId === 'pengawas-pelanggaran') {
                document.getElementById('view-pengawas-pelanggaran').classList.remove('hidden');
                App.Pengawas.loadPagePelanggaran();
                return;
            }
        }

        // --- LOGIC UMUM / ADMIN / GURU ---

        if (viewId === 'hasil') {
            document.getElementById('view-hasil-ujian').classList.remove('hidden');
            // Logic load hasil ujian guru (jika ada) bisa ditambahkan di sini
        }
        else if (viewId === 'bank-soal') {
            document.getElementById('view-bank-soal').classList.remove('hidden');
            App.BankSoal.loadOptionsMapel();
        }
        else if (viewId === 'admin-monitoring') {
             document.getElementById('view-admin-monitoring').classList.remove('hidden');
             App.AdminMonitor.loadSummary();
        }
        else if (viewId === 'admin-hasil') {
             document.getElementById('view-admin-hasil').classList.remove('hidden');
             App.AdminHasil.load();
        }
        else if (viewId === 'dashboard') { 
            // Dashboard Admin/Guru (Statistik Sistem)
            // Siswa & Pengawas sudah direturn di atas, jadi ini aman untuk Admin/Guru
            document.getElementById('view-dashboard').classList.remove('hidden'); 
            App.Dashboard.loadStats(); 
        }
        else if (viewId === 'akun') { 
            document.getElementById('view-akun').classList.remove('hidden'); 
            App.User.loadAll(); 
        }
        else if (viewId === 'mapel') { 
            document.getElementById('view-mapel').classList.remove('hidden'); 
            App.Mapel.load(); 
        }
        else if (viewId === 'ujian') { 
            document.getElementById('view-ujian').classList.remove('hidden'); 
            App.Ujian.loadJenis(); 
            App.Ujian.loadJadwal(); 
        }
        else {
            // Fallback jika view tidak ditemukan
            const ph = document.getElementById('view-placeholder');
            if(ph) ph.classList.remove('hidden');
        }
      },

      toggleSidebar: function(forceState) {
        const sidebar = document.getElementById('sidebar-panel');
        const backdrop = document.getElementById('sidebar-backdrop');
        const isClosed = sidebar.classList.contains('-translate-x-full');
        const shouldOpen = forceState !== undefined ? forceState : isClosed;
        if (shouldOpen) { sidebar.classList.remove('-translate-x-full'); backdrop.classList.remove('hidden'); } 
        else { sidebar.classList.add('-translate-x-full'); backdrop.classList.add('hidden'); }
      },
      zoomImg: function(el) { Swal.fire({ imageUrl: el.src, width: '90%', showConfirmButton: false, background: 'transparent' }); },
      openModal: function(id) { document.getElementById(id).classList.remove('hidden'); },
      closeModal: function(id) { document.getElementById(id).classList.add('hidden'); },
      showLoginOnly: function() {
        document.getElementById('dashboard-container').classList.add('hidden'); document.getElementById('page-siswa').classList.add('hidden'); document.getElementById('lock-screen').classList.add('hidden');
        document.getElementById('login-container').classList.remove('hidden'); document.getElementById('login-container').classList.add('flex');
      }
    },

    // --- Module 8: Security (FIXED) ---
    Security: {
      enterFullscreen: function() { document.documentElement.requestFullscreen().catch(()=>{}); },
      
      triggerLock: function(msg) { 
         if(!App.data.examRunning && msg !== "Status Terkunci. Masukkan Token.") return;

         document.getElementById('lock-screen').classList.remove('hidden'); 
         document.getElementById('lock-reason').innerText = msg; 
         
         const username = App.data.user ? App.data.user.username : JSON.parse(sessionStorage.getItem('cbt_session')).data.username;
         const idJadwal = App.data.activeJadwalId;

         if (idJadwal) {
             google.script.run.setSiswaViolation(username, idJadwal, msg);
         }
      },
      
      unlock: function() {
         const t = document.getElementById('token-unlock').value;
         const btn = document.getElementById('btnUnlock');
         
         // Pastikan Username Terambil
         const sess = JSON.parse(sessionStorage.getItem('cbt_session'));
         const username = App.data.user ? App.data.user.username : (sess ? sess.data.username : '');
         
         // Pastikan ID Jadwal ada (diambil dari global state saat ujian berjalan/terkunci)
         const idJadwal = App.data.activeJadwalId;

         if(!username) { Swal.fire('Error', 'Sesi invalid. Silakan login ulang.', 'error'); return; }

         App.UI.setLoading(btn, true, 'Memeriksa...');

         google.script.run.withSuccessHandler(r => {
            App.UI.setLoading(btn, false, 'BUKA KUNCI');
            
            if(r.status === 'success') { 
                // Jika Token Benar -> Reset Status di Database -> Buka Layar
                google.script.run.withSuccessHandler(() => {
                    document.getElementById('lock-screen').classList.add('hidden'); 
                    document.getElementById('token-unlock').value = "";
                    App.Security.enterFullscreen();
                }).unlockSiswa(username, idJadwal);

            } else {
                Swal.fire('Token Salah', 'Minta token baru ke Pengawas.', 'error');
            }
         }).verifikasiTokenUnlock(t, username); 
      }
    },

    Util: {
      resetGlobals: function() {
        App.data = { role: '', user: null, soalList: [], userList: [], mapelList: [], jawabanSiswa: {}, raguSiswa: {}, opsiImages: { A:null, B:null, C:null, D:null, E:null }, examRunning: false, timer: null, timeLeft: 0, currentSoalIdx: 0, quill: null };
        document.getElementById('tbody-users').innerHTML = ''; document.getElementById('tbody-mapel').innerHTML = ''; document.getElementById('tbody-soal').innerHTML = ''; document.querySelectorAll('.fixed.z-50').forEach(el => el.classList.add('hidden'));
      }
    }
  };

  // ===========================================
  // INITIALIZATION
  // ===========================================
  document.getElementById('current-date').innerText = new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
  document.addEventListener("visibilitychange", () => { if(App.data.examRunning && document.hidden) App.Security.triggerLock("Pindah Tab"); });
  window.addEventListener("blur", () => { if(App.data.examRunning) App.Security.triggerLock("Keluar App"); });
  let activityTimer;
  ['click', 'mousemove', 'keypress', 'scroll', 'touchstart'].forEach(evt => document.addEventListener(evt, () => sessionStorage.setItem('last_activity', Date.now()), false));

  setInterval(() => {
     const lastAct = sessionStorage.getItem('last_activity');
     // Cek jika ada sesi (lastAct) DAN waktu sudah lewat (misal 10 menit)
     if (lastAct && (Date.now() - parseInt(lastAct) > 10 * 60 * 1000)) { 
        
        // Hapus sesi
        sessionStorage.clear(); 
        
        // Tampilkan pesan, lalu panggil forceLogout (bukan reload)
        Swal.fire({
          title: 'Sesi Habis', 
          text: 'Silakan login kembali.', 
          icon: 'warning',
          confirmButtonText: 'OK'
        }).then(() => {
            // Panggil fungsi logout aplikasi agar langsung ganti ke tampilan Login
            App.Auth.forceLogout(); 
        });
     }
  }, 60 * 1000);

  window.addEventListener('load', () => {
      App.Auth.checkSession();
      
      // PERBAIKAN: Ambil URL Web App sekarang, simpan untuk dipakai nanti.
      // Ini menghilangkan jeda waktu saat reload selesai ujian.
      google.script.run.withSuccessHandler(url => {
          App.data.scriptUrl = url;
      }).getScriptUrl();
  });
</script>
