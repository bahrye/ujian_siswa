<script>
  // ===========================================
  // MODULE: APPLICATION LOGIC (FULL & UPDATED)
  // ===========================================
  const App = {
    // --- Global Variables ---
    data: {
      role: '',
      user: null,
      scriptUrl: null,
      soalList: [],
      userList: [],
      mapelList: [],
      jenisUjianList: [], // Data Baru
      jadwalList: [],     // Data Baru
      jawabanSiswa: {},
      raguSiswa: {},
      opsiImages: { A:null, B:null, C:null, D:null, E:null },
      examRunning: false,
      timer: null,
      timeLeft: 0,
      currentSoalIdx: 0,
      quill: null,
      saveTimeout: null,
      activeJadwalId: null
    },

    // --- Module 0: Caching System ---
    Cache: {
      store: {},
      get: function(key) { return this.store[key] || null; },
      set: function(key, data) { this.store[key] = data; },
      remove: function(key) { delete this.store[key]; },
      clearPattern: function(pattern) {
        Object.keys(this.store).forEach(key => {
          if (key.includes(pattern)) delete this.store[key];
        });
      },
      clearAll: function() { this.store = {}; }
    },

    // --- Module 1: Authentication ---
    Auth: {
      login: function(e) {
        e.preventDefault();
        const u = document.getElementById('user').value;
        const p = document.getElementById('pass').value;
        const btn = document.getElementById('btnLogin');
        
        App.UI.setLoading(btn, true, 'MEMERIKSA...');
        
        google.script.run.withSuccessHandler((res) => {
          App.UI.setLoading(btn, false, 'MASUK');
          if (res.status === 'success') {
            const sess = { role: res.role, nama: res.nama, data: res };
            sessionStorage.setItem('cbt_session', JSON.stringify(sess));
            sessionStorage.setItem('last_activity', Date.now());
            App.data.role = res.role;
            
            // PERUBAHAN DISINI: Semua role masuk ke Dashboard.init
            App.Dashboard.init(res);
          } else {
            Swal.fire('Login Gagal', res.message, 'error');
          }
        }).withFailureHandler((err) => {
          App.UI.setLoading(btn, false, 'MASUK');
          Swal.fire('Error', err.message, 'error');
        }).loginUser(u, p);
      },

      logout: function() {
        Swal.fire({ 
            title: 'Keluar?', 
            text: "Akhiri sesi dan kembali ke halaman login.", 
            icon: 'warning', 
            showCancelButton: true, 
            confirmButtonText: 'Ya, Keluar',
            confirmButtonColor: '#d33'
        }).then((result) => { 
            if (result.isConfirmed) App.Auth.forceLogout(); 
        });
      },

      forceLogout: function() {
        // 1. Hentikan semua timer yang berjalan di background
        App.Util.stopAllTimers();

        // 2. Hapus Data Sesi Browser
        sessionStorage.clear();
        localStorage.clear(); // Bersihkan juga localStorage jika ada sisa
        
        // 3. Reset Global Variables & Cache
        App.Cache.clearAll();
        App.Util.resetGlobals();

        // 4. Reset Form Login
        const uField = document.getElementById('user');
        const pField = document.getElementById('pass');
        if(uField) uField.value = "";
        if(pField) pField.value = "";

        // 5. [KRUSIAL] Refresh Halaman
        // Ini memastikan tampilan bersih total dari user sebelumnya
        // Menggunakan scriptUrl jika ada, atau location.reload()
        if (App.data.scriptUrl) {
            window.top.location.href = App.data.scriptUrl;
        } else {
            window.top.location.reload();
        }
      },

      checkSession: function() {
        const sess = sessionStorage.getItem('cbt_session');
        if (sess) {
          try {
              const user = JSON.parse(sess);
              App.data.role = user.role;
              App.Dashboard.init(user.data);
          } catch(e) {
              // Jika JSON corrupt, paksa logout
              App.Auth.forceLogout();
          }
        } else {
          App.UI.showLoginOnly();
        }
      }
    },

    // --- Module 2: Dashboard UI & Navigation ---
    Dashboard: {
      init: function(user) {
        document.getElementById('login-container').classList.add('hidden');
        document.getElementById('dashboard-container').classList.remove('hidden');
        document.getElementById('dash-nama').innerText = user.nama;
        document.getElementById('dash-initial').innerText = user.nama.charAt(0);
        document.getElementById('dash-role').innerText = user.role;
        App.Dashboard.renderMenu(user.role);
        
        // LOGIKA REDIRECT
        const firstMenuBtn = document.querySelector('#sidebar-menu .nav-item');
        
        if (user.role === 'admin' || user.role === 'guru') {
            App.Dashboard.loadStats();
            App.UI.switchView('dashboard', firstMenuBtn);
        } else {
            // SISWA & PENGAWAS tidak butuh loadStats (Statistik Sistem)
            App.UI.switchView('dashboard', firstMenuBtn);
        }
      },

      renderMenu: function(role) {
        const menuContainer = document.getElementById('sidebar-menu');
        menuContainer.innerHTML = '';
        
        let menus = [];
        
        if (role === 'admin') {
           menus = [
             { id: 'dashboard', icon: 'fa-home', label: 'Dashboard' },
             { id: 'akun', icon: 'fa-users-cog', label: 'Kelola User' },
             { id: 'mapel', icon: 'fa-tags', label: 'Kelola Mapel' },
             { id: 'bank-soal', icon: 'fa-file-alt', label: 'Bank Soal' },
             { id: 'ujian', icon: 'fa-calendar-alt', label: 'Kelola Ujian' },
             { id: 'admin-monitoring', icon: 'fa-desktop', label: 'Monitoring Live' }, 
             { id: 'admin-hasil', icon: 'fa-poll', label: 'Hasil Ujian' },           
           ];
        } else if (role === 'guru') {
           menus = [
             { id: 'dashboard', icon: 'fa-home', label: 'Dashboard' },
             { id: 'bank-soal', icon: 'fa-file-alt', label: 'Bank Soal' },
             { id: 'hasil', icon: 'fa-poll', label: 'Hasil & Koreksi' },
           ];
        } else if (role === 'pengawas') {
           menus = [
             { id: 'dashboard', icon: 'fa-calendar-alt', label: 'Jadwal Ujian' }, // Dashboard isinya Jadwal Semua
             { id: 'pengawas-token', icon: 'fa-key', label: 'Token Ujian' },      // Menu Token
             { id: 'pengawas-kehadiran', icon: 'fa-user-check', label: 'Cek Kehadiran' },
             { id: 'pengawas-monitor', icon: 'fa-desktop', label: 'Monitoring Live' }, // Menu Monitoring
             { id: 'pengawas-pelanggaran', icon: 'fa-exclamation-triangle', label: 'Pelanggaran Siswa' },
           ];
        } else if (role === 'siswa') {
           menus = [
             // Label tetap Dashboard, tapi isinya nanti Jadwal Ujian
             { id: 'dashboard', icon: 'fa-calendar-check', label: 'Jadwal Ujian' }, 
             { id: 'hasil-siswa', icon: 'fa-poll', label: 'Riwayat Nilai' }, 
           ];
        }

        menus.forEach(m => {
            // Hapus class active default saat render, biarkan switchView yang mengaturnya
            const btnClass = 'nav-item w-full flex items-center gap-3 px-6 py-3 transition text-left hover:bg-slate-800 text-gray-400 hover:text-white';
            menuContainer.insertAdjacentHTML('beforeend', `<button onclick="App.UI.switchView('${m.id}', this)" class="${btnClass}"><i class="fas ${m.icon} w-5"></i> <span>${m.label}</span></button>`);
        });
      },

      loadStats: function(forceRefresh = false) {
        // Guard: Pastikan Siswa tidak pernah memanggil ini
        if (App.data.role === 'siswa') return;

        if (!forceRefresh && App.Cache.get('stats')) {
           App.Dashboard.renderStats(App.Cache.get('stats')); return;
        }
        google.script.run.withSuccessHandler(stats => {
           App.Cache.set('stats', stats);
           App.Dashboard.renderStats(stats);
           const btn = document.getElementById('btn-refresh-dash');
           if(btn) btn.classList.remove('fa-spin');
        }).getDashboardStats();
      },

      renderStats: function(stats) {
         document.getElementById('stat-user').innerText = stats.users;
         document.getElementById('stat-soal').innerText = stats.soals;
         document.getElementById('stat-nilai').innerText = stats.nilais;
      }
    },

    // --- Module 3: Bank Soal Management ---
    BankSoal: {
      toggleForm: function(show) {
        if(show) {
           document.getElementById('bs-list-section').classList.add('hidden');
           document.getElementById('bs-form-section').classList.remove('hidden');
           setTimeout(App.BankSoal.initQuill, 100);
           if(!document.getElementById('soal-id').value) App.BankSoal.resetForm();
        } else {
           document.getElementById('bs-list-section').classList.remove('hidden');
           document.getElementById('bs-form-section').classList.add('hidden');
           App.BankSoal.resetForm();
        }
      },

      initQuill: function() {
        if (App.data.quill != null) return;
        const container = document.getElementById('editor-container');
        if (container && container.previousElementSibling?.classList.contains('ql-toolbar')) container.previousElementSibling.remove();
        
        // UPDATE: Tambahkan 'video' ke toolbar agar user bisa masukkan Link Youtube/Video URL
        // Hapus 'image' dari toolbar bawaan Quill jika ingin memaksa pakai tombol upload kita sendiri, 
        // tapi membiarkannya juga tidak masalah.
        let modulesConfig = { 
            toolbar: [
                ['bold', 'italic', 'underline'], 
                [{ 'list': 'ordered'}, { 'list': 'bullet' }], 
                ['image', 'video', 'link', 'formula'] // Tambahkan 'video' & 'link'
            ] 
        };
        
        if (window.Quill && window.ImageResize) { Quill.register('modules/imageResize', window.ImageResize.default || window.ImageResize); modulesConfig.imageResize = { displaySize: true }; }
        
        App.data.quill = new Quill('#editor-container', { theme: 'snow', placeholder: 'Tulis pertanyaan atau tempel link video/audio...', modules: modulesConfig });
      },

      loadOptionsMapel: function() {
         // Cek Role User
         const user = App.data.user || JSON.parse(sessionStorage.getItem('cbt_session')).data;
         const role = user.role.toLowerCase();
         const nama = user.nama;

         // Handler Rendering (Dipisah agar rapi)
         const handleData = (data) => {
            App.Cache.set('mapel_opts', data); // Simpan daftar mapel yg diizinkan ke cache
            App.BankSoal.renderOptionsMapel(data);
            App.BankSoal.loadDaftar(); // Load soal setelah mapel siap
         };

         // Gunakan Cache jika ada
         if(App.Cache.get('mapel_opts')) {
             handleData(App.Cache.get('mapel_opts'));
             return;
         }

         // Panggil Server Sesuai Role
         if (role === 'guru') {
             // KHUSUS GURU: Ambil mapel miliknya saja
             google.script.run.withSuccessHandler(data => {
                handleData(data);
             }).getMapelByGuru(nama);
         } else {
             // ADMIN: Ambil semua mapel
             google.script.run.withSuccessHandler(data => {
                handleData(data);
             }).getAllMapel();
         }
      },

      renderOptionsMapel: function(data) {
         const selFilter = document.getElementById('filter-mapel'); 
         const selForm = document.getElementById('soal-mapel-select');
         const oldFilter = selFilter.value;
         selFilter.innerHTML = '<option value="">- Tampilkan Semua -</option>';
         selForm.innerHTML = '<option value="">-- Pilih Mapel --</option>';
         data.forEach(m => {
            const opt = `<option value="${m.kode}">${m.kode} - ${m.nama}</option>`;
            selFilter.insertAdjacentHTML('beforeend', opt);
            selForm.insertAdjacentHTML('beforeend', opt);
         });
         if(oldFilter) selFilter.value = oldFilter;
      },

      loadDaftar: function(forceRefresh = false) {
        const tbody = document.getElementById('tbody-soal');
        const filter = document.getElementById('filter-mapel').value;
        const cacheKey = 'soal_' + (filter || 'all');
        const btnRefresh = document.getElementById('btn-refresh-soal');

        if(forceRefresh && btnRefresh) btnRefresh.classList.add('fa-spin');

        if (!forceRefresh && App.Cache.get(cacheKey)) {
          App.BankSoal.renderTable(App.Cache.get(cacheKey));
          return;
        }

        tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>';
        
        google.script.run.withSuccessHandler(data => {
          if(btnRefresh) btnRefresh.classList.remove('fa-spin');
          App.Cache.set(cacheKey, data);
          App.BankSoal.renderTable(data);
        }).getSoalAdmin(filter);
      },

      renderTable: function(data) {
        const tbody = document.getElementById('tbody-soal');
        tbody.innerHTML = '';
        
        if (data.length === 0) { tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-400">Tidak ada soal.</td></tr>'; return; }
        
        // --- LOGIKA FILTER CLIENT-SIDE (KHUSUS GURU) ---
        // Kita hanya tampilkan soal jika Kode Mapel-nya ada di daftar mapel guru
        const allowedMapels = App.Cache.get('mapel_opts') || [];
        const isGuru = App.data.role === 'guru';
        
        // Buat Set kode mapel yg diizinkan agar pencarian cepat
        const allowedCodes = new Set(allowedMapels.map(m => m.kode));

        let count = 0;

        data.forEach((s, idx) => {
             // JIKA GURU: Skip soal jika mapelnya tidak ada di daftar izin
             if (isGuru && !allowedCodes.has(s.mapel)) return;

             count++;
             const tmp = document.createElement("DIV"); tmp.innerHTML = s.soal;
             let snippet = tmp.textContent || tmp.innerText || "";
             if(snippet.length > 50) snippet = snippet.substring(0, 50) + "...";
             if(s.soal.includes('<img')) snippet = "ðŸ“· " + snippet;
             
             let badgeBobot = "";
             if(s.bobot) {
                badgeBobot = `<span class="ml-2 bg-yellow-100 text-yellow-700 text-[10px] px-1.5 py-0.5 rounded border border-yellow-200" title="Bobot Nilai"><i class="fas fa-weight-hanging"></i> ${s.bobot}</span>`;
             }

             const dataStr = encodeURIComponent(JSON.stringify(s));
             const row = `
               <tr class="hover:bg-slate-50 border-b border-gray-100 animate__animated animate__fadeIn">
                 <td class="p-4 text-center font-bold text-gray-500">${count}</td>
                 <td class="p-4">
                    <span class="bg-indigo-100 text-indigo-800 text-xs px-2 py-1 rounded font-bold">${s.tipe}</span>
                    <br><span class="text-xs text-gray-400 font-mono mt-1 inline-block">${s.mapel}</span>
                 </td>
                 <td class="p-4 text-gray-700 font-medium">
                    ${snippet} ${badgeBobot}
                 </td>
                 <td class="p-4 font-mono text-sm text-emerald-600 font-bold">${s.kunci || '-'}</td>
                 <td class="p-4 text-right whitespace-nowrap">
                    <button onclick="App.BankSoal.preview('${dataStr}')" class="text-emerald-600 mr-3 hover:text-emerald-800 transition bg-emerald-50 p-2 rounded-lg" title="Preview Soal">
                        <i class="fas fa-eye"></i>
                    </button>
                    
                    <button onclick="App.BankSoal.edit('${dataStr}')" class="text-blue-600 mr-3 hover:text-blue-800 transition bg-blue-50 p-2 rounded-lg" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="App.BankSoal.hapus('${s.id}')" class="text-red-500 hover:text-red-700 transition bg-red-50 p-2 rounded-lg" title="Hapus">
                        <i class="fas fa-trash"></i>
                    </button>
                 </td>
               </tr>`;
             tbody.insertAdjacentHTML('beforeend', row);
        });

        // Jika setelah difilter ternyata kosong
        if (count === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-400">Tidak ada soal untuk mapel Anda.</td></tr>';
        }
      },

      // [BARU] Trigger Klik Input File
      triggerMedia: function(type) {
        const input = document.getElementById('q-media-input');
        input.accept = "image/*"; // Paksa Image
        input.click();
      },

      // [BARU] Handler setelah file dipilih
      handleEditorMedia: function(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            
            // Limit 5MB untuk gambar
            if(file.size > 5 * 1024 * 1024) return Swal.fire('Terlalu Besar', 'Maksimal ukuran gambar 5MB', 'warning');
            
            // Validasi Tipe File
            if(!file.type.startsWith('image/')) return Swal.fire('Salah Format', 'Hanya boleh upload gambar.', 'error');

            const loadingMsg = Swal.fire({
              title: 'Memproses Gambar...', text: 'Mohon tunggu sebentar',
              allowOutsideClick: false, didOpen: () => Swal.showLoading()
            });

            const reader = new FileReader();
            reader.onload = (e) => {
              const b64 = e.target.result;
              App.data.quill.focus();
              const range = App.data.quill.getSelection(true);
              let index = range ? range.index : App.data.quill.getLength();

              // HANYA INSERT IMAGE
              App.data.quill.insertEmbed(index, 'image', b64);
              
              App.data.quill.setSelection(index + 1);
              Swal.close();
            };
            reader.onerror = () => { Swal.fire('Error', 'Gagal membaca file', 'error'); };
            reader.readAsDataURL(file);
        }
        input.value = '';
      },

      submit: function(e) {
        e.preventDefault();
        const idSoal = document.getElementById('soal-id').value;
        const mapel = document.getElementById('soal-mapel-select').value;
        const tipe = document.getElementById('tipe-soal').value;
        const bobot = document.getElementById('soal-bobot').value;
        const htmlSoal = App.data.quill.root.innerHTML;

        if (App.data.quill.getText().trim().length === 0 && !htmlSoal.includes('<img')) return Swal.fire('Error', 'Pertanyaan kosong!', 'warning');

        let opsiData = {}; let kunciJawaban = "";
        if (tipe === 'PG') {
          opsiData = { 
            A: document.getElementById('pg-a').value, 
            B: document.getElementById('pg-b').value, 
            C: document.getElementById('pg-c').value, 
            D: document.getElementById('pg-d').value, 
            E: document.getElementById('pg-e').value 
          };
          
          // [UPDATE PENTING] Logika Prioritas Media
          ['A','B','C','D','E'].forEach(h => { 
              const newFile = App.data.opsiImages[h]; // File Baru (Base64)
              const oldFile = document.getElementById('existing-media-'+h.toLowerCase()).value; // File Lama (URL)
              
              if(newFile) {
                  // Jika user upload baru, pakai yang baru
                  opsiData['media_'+h] = newFile; 
              } else if(oldFile) {
                  // Jika tidak upload baru, tapi ada file lama, pakai yang lama
                  opsiData['media_'+h] = oldFile;
              }
          });
          
          kunciJawaban = document.getElementById('kunci-pg').value;
          
          // Validasi (Cek Teks ATAU Media)
          // Sekarang opsiData.media_A sudah terisi URL lama, jadi validasi ini akan lolos
          if((!opsiData.A && !opsiData.media_A) || (!opsiData.B && !opsiData.media_B)) {
              return Swal.fire('Error', 'Min. Opsi A & B (Teks atau Media)', 'warning');
          }
        }
        else if (tipe === 'ISIAN') kunciJawaban = document.getElementById('kunci-isian').value;
        else if (tipe === 'BS') { const r = document.querySelector('input[name="kunci_bs"]:checked'); kunciJawaban = r ? r.value : ""; opsiData = { A: "BENAR", B: "SALAH" }; }
        else if (tipe === 'COCOK') {
           const kiris = document.querySelectorAll('.cocok-kiri'); 
           const kanans = document.querySelectorAll('.cocok-kanan');
           const skors = document.querySelectorAll('.cocok-skor');
           
           let pairs = []; 
           kiris.forEach((el, idx) => { 
             if(el.value && kanans[idx].value) {
                // Simpan K:Kiri, V:Kanan, S:Score
                pairs.push({ 
                   k: el.value, 
                   v: kanans[idx].value, 
                   s: skors[idx].value || 1 // Default bobot 1 jika kosong
                }); 
             }
           });
           
           if(pairs.length < 2) return Swal.fire('Warning','Minimal buat 2 pasang pencocokan.','warning');
           opsiData = pairs; 
           kunciJawaban = "COCOK_AUTO";
        } else { kunciJawaban = "MANUAL"; }

        const btn = document.getElementById('btnSave');
        App.UI.setLoading(btn, true, 'MENYIMPAN...');
        const payload = { id: idSoal, mapel: mapel, tipe: tipe, bobot: bobot, soal: htmlSoal, opsiJson: JSON.stringify(opsiData), kunci: kunciJawaban };
        
        google.script.run.withSuccessHandler((res) => {
           App.UI.setLoading(btn, false, 'SIMPAN SOAL');
           if(res.status === 'success') { 
             Swal.fire('Sukses', res.message, 'success'); 
             App.BankSoal.toggleForm(false); 
             App.Cache.clearPattern('soal_'); App.Cache.remove('stats'); // Reset Cache
             App.BankSoal.loadDaftar(true); 
           } else Swal.fire('Gagal', res.message, 'error');
        }).simpanSoal(payload);
      },

      edit: function(str) {
        const s = JSON.parse(decodeURIComponent(str));
        
        // 1. Set ID & Judul
        document.getElementById('soal-id').value = s.id;
        document.getElementById('form-soal-title').innerText = "Edit Soal";
        document.getElementById('btnSave').innerText = "UPDATE SOAL";
        
        // 2. Buka Form
        App.BankSoal.toggleForm(true);

        // 3. GUNAKAN SETTIMEOUT
        // Tunggu 300ms agar Quill & DOM benar-benar siap
        setTimeout(() => {
            
            // --- A. ISI EDITOR QUILL (PERTANYAAN) ---
            if (App.data.quill) {
                App.data.quill.setContents([]); 
                
                let cleanSoal = s.soal || "";
                
                // HAPUS PERGANTIAN VIDEO MENJADI IFRAME (VIDEO REMOVAL)
                
                // UBAH AUDIO AGAR MENJADI TAG AUDIO BIASA (BUKAN IFRAME LAGI)
                // Regex ini menghapus tag audio lama dan menggantinya dengan tag audio HTML5 standar jika perlu,
                // atau biarkan Quill menanganinya jika format sudah benar.
                // Namun untuk amannya kita bersihkan replace iframe video.
                
                App.data.quill.clipboard.dangerouslyPasteHTML(0, cleanSoal);
            }

            // --- B. LOGIKA MAPEL (SMART SELECT) ---
            const selMapel = document.getElementById('soal-mapel-select');
            
            // Defensif: Load ulang opsi jika kosong
            if (selMapel.options.length <= 1 && App.Cache.get('mapel_opts')) {
                 App.BankSoal.renderOptionsMapel(App.Cache.get('mapel_opts'));
            }

            selMapel.value = s.mapel;
            
            // Fallback trim/case-insensitive
            if (!selMapel.value && s.mapel) {
                selMapel.value = s.mapel.trim();
            }
            if (!selMapel.value && s.mapel) {
                const target = s.mapel.trim().toUpperCase();
                for (let i = 0; i < selMapel.options.length; i++) {
                    if (selMapel.options[i].value.toUpperCase() === target) {
                        selMapel.selectedIndex = i;
                        break;
                    }
                }
            }

            // --- C. ISI TIPE & BOBOT ---
            document.getElementById('tipe-soal').value = s.tipe;
            if(document.getElementById('soal-bobot')) {
                document.getElementById('soal-bobot').value = s.bobot || ""; 
            }

            // Panggil ini agar area opsi yang sesuai muncul
            App.BankSoal.changeType();

            // --- D. ISI OPSI JAWABAN ---
            let opsi = {}; 
            try { opsi = JSON.parse(s.opsi); } catch(e){}
            
            if (s.tipe === 'PG') {
               ['A','B','C','D','E'].forEach(h => {
                 // 1. Isi Text Input
                 const inputEl = document.getElementById('pg-'+h.toLowerCase());
                 if(inputEl) inputEl.value = opsi[h] || "";
                 
                 // 2. Reset Preview Box
                 App.BankSoal.removeMedia(h); 

                 // 3. Cek Media (Legacy 'img_' atau Baru 'media_')
                 const mediaVal = opsi['media_'+h] || opsi['img_'+h];

                 if(mediaVal) { 
                   // [FIX] Simpan URL lama ke Hidden Input (Wajib agar tidak hilang saat save)
                   const hiddenInp = document.getElementById('existing-media-'+h.toLowerCase());
                   if(hiddenInp) hiddenInp.value = mediaVal;

                   // Tampilkan Preview (DI FORM EDIT)
                   const box = document.getElementById('prev-box-'+h);
                   const content = document.getElementById('media-content-A'.replace('A', h));
                   
                   if(box && content) {
                      box.classList.remove('hidden'); 
                      // Gunakan Helper Baru
                      content.innerHTML = App.Util.renderMediaHtml(mediaVal, "img-opsi-preview");
                   }
                 }
               });
               document.getElementById('kunci-pg').value = s.kunci;
            }
            else if (s.tipe === 'ISIAN') {
                document.getElementById('kunci-isian').value = s.kunci;
            }
            else if (s.tipe === 'BS') { 
                const radios = document.getElementsByName('kunci_bs'); 
                for(let r of radios) { 
                    r.checked = (r.value === s.kunci);
                } 
            }
            else if (s.tipe === 'COCOK') {
               const container = document.getElementById('container-cocok'); 
               container.innerHTML = "";
               if(Array.isArray(opsi)) {
                   opsi.forEach(p => App.BankSoal.addRowCocok(p.k, p.v, p.s));
               }
            }

        }, 300); 
      },

      // --- FUNGSI PREVIEW SOAL (DOM PARSER VERSION) ---
      preview: function(str) {
        const s = JSON.parse(decodeURIComponent(str));
        App.UI.openModal('modal-preview-soal');
        
        const container = document.getElementById('container-preview-content');
        container.innerHTML = ''; 

        let cleanSoal = App.Util.fixMediaTags(s.soal || "");

        // 1. Render Pertanyaan (Gunakan DOM Parser untuk akurasi)
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = cleanSoal;

        // A. Fix Video/Audio di Pertanyaan
        const medias = tempDiv.querySelectorAll('iframe, video, audio');
        medias.forEach(el => {
            const src = el.getAttribute('src');
            if(src) {
                // Ganti elemen lama dengan HTML baru dari Helper
                const wrapper = document.createElement('div');
                wrapper.innerHTML = App.Util.renderMediaHtml(src);
                el.parentNode.replaceChild(wrapper.firstElementChild, el);
            }
        });

        // B. Fix Gambar
        tempDiv.querySelectorAll('img').forEach(img => {
            img.classList.add('max-w-full', 'h-auto', 'rounded-lg', 'border', 'shadow-sm', 'my-4');
        });

        // Badge & Header
        let metaHtml = `
            <div class="flex flex-wrap gap-2 mb-4">
                <span class="bg-indigo-100 text-indigo-800 text-xs font-bold px-3 py-1 rounded-full border border-indigo-200 uppercase tracking-wide">${s.tipe}</span>
                <span class="bg-yellow-100 text-yellow-800 text-xs font-bold px-3 py-1 rounded-full border border-yellow-200"><i class="fas fa-weight-hanging"></i> Bobot: ${s.bobot || 1}</span>
                <span class="bg-green-100 text-green-800 text-xs font-bold px-3 py-1 rounded-full border border-green-200"><i class="fas fa-key"></i> Kunci: ${s.kunci}</span>
            </div>`;

        let html = `
           <div class="bg-white p-6 md:p-8 rounded-xl shadow-sm border border-gray-200">
               ${metaHtml}
               <div class="text-gray-800 text-base md:text-lg leading-loose font-medium ql-editor" style="padding:0;">
                   ${tempDiv.innerHTML}
               </div>
           </div>`;

        // 2. Render Opsi Jawaban
        let opsi = {}; try { opsi = JSON.parse(s.opsi); } catch(e){}
        html += '<div class="mt-4 space-y-3">';

        if (s.tipe === 'PG') {
            ['A','B','C','D','E'].forEach(k => {
                const hasText = opsi[k] && opsi[k].trim() !== "";
                const mediaVal = opsi['media_' + k] || opsi['img_' + k];
                
                if (hasText || mediaVal) {
                    const isKey = (String(s.kunci) === k);
                    let baseClass = isKey ? "bg-green-50 border-green-500 ring-1 ring-green-400 shadow-md" : "border-gray-200 hover:bg-gray-50";
                    let circleClass = isKey ? "bg-green-600 text-white border-green-600" : "bg-gray-100 text-gray-500 border-gray-200";
                    
                    // RENDER MEDIA OPSI VIA HELPER
                    let mediaHtml = mediaVal ? `<div class="mt-2 w-full">${App.Util.renderMediaHtml(mediaVal, "h-32")}</div>` : '';

                    html += `
                      <div class="relative p-4 rounded-xl border-2 flex items-start gap-4 transition ${baseClass}">
                          <div class="w-10 h-10 flex items-center justify-center rounded-full font-bold border-2 text-lg shrink-0 ${circleClass}">${k}</div>
                          <div class="flex-1 min-w-0 pt-1">
                              <div class="text-gray-800 font-medium text-base break-words">${opsi[k] || ''}</div>
                              ${mediaHtml}
                          </div>
                          ${isKey ? '<div class="absolute top-3 right-3 text-green-600 bg-white rounded-full p-1 shadow"><i class="fas fa-check-circle text-2xl"></i></div>' : ''}
                      </div>`;
                }
            });
        }
        else if (s.tipe === 'BS') {
             ['BENAR','SALAH'].forEach(val => {
                 const isKey = (s.kunci === val);
                 const color = val === 'BENAR' ? 'green' : 'red';
                 const active = isKey 
                    ? `bg-${color}-600 text-white border-${color}-600 shadow-lg scale-105 ring-2 ring-${color}-200` 
                    : `bg-white text-gray-400 border-gray-200 grayscale opacity-60`;
                 
                 html += `
                    <div class="p-5 rounded-xl border-2 font-bold text-center text-xl transition transform ${active}">
                        ${val} ${isKey ? '<i class="fas fa-check-circle ml-2"></i>' : ''}
                    </div>`;
             });
        }
        else if (s.tipe === 'COCOK') {
             if(Array.isArray(opsi)) {
                 html += `
                 <div class="bg-white p-5 rounded-xl border shadow-sm">
                    <h4 class="font-bold text-gray-600 mb-3 border-b pb-2">Pasangan Jawaban (Kunci)</h4>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50 text-gray-500 uppercase text-xs">
                                <tr><th class="p-2 text-left">Pernyataan (Kiri)</th><th class="p-2 text-left">Pasangan (Kanan)</th><th class="p-2 text-center">Skor</th></tr>
                            </thead>
                            <tbody class="divide-y">`;
                 opsi.forEach(p => {
                     html += `
                        <tr>
                            <td class="p-3 font-medium text-gray-800">${p.k}</td>
                            <td class="p-3 font-bold text-indigo-600"><i class="fas fa-arrow-right text-gray-300 mr-2"></i> ${p.v}</td>
                            <td class="p-3 text-center text-gray-500 bg-gray-50 font-mono">${p.s}</td>
                        </tr>`;
                 });
                 html += `</tbody></table></div></div>`;
             }
        }
        else {
             // Essay
             html += `
                <div class="bg-blue-50 p-5 rounded-xl border border-blue-200">
                    <p class="text-xs font-bold text-blue-500 uppercase tracking-wider mb-2">Kunci Jawaban Guru:</p>
                    <div class="text-blue-900 font-mono text-lg font-bold bg-white p-3 rounded border border-blue-100 shadow-inner">
                        ${s.kunci || '-'}
                    </div>
                    <p class="text-xs text-blue-400 mt-2 italic">* Siswa akan melihat kotak input teks kosong.</p>
                </div>
             `;
        }

        html += '</div>';
        container.innerHTML = html;
      },

      // --- IMPORT EXCEL & MEDIA ---
      openImportModal: function() {
        App.UI.openModal('modal-import');
        document.getElementById('file-label').innerText = "Klik untuk pilih file ZIP";
        document.getElementById('import-file').value = ""; // Reset file input

        const sel = document.getElementById('import-mapel');
        // Helper Render
        const render = (data) => {
            sel.innerHTML = '<option value="">- Pilih Mapel -</option>';
            data.forEach(m => sel.insertAdjacentHTML('beforeend', `<option value="${m.kode}">${m.kode} - ${m.nama}</option>`));
        };

        if(App.Cache.get('mapel_opts')) {
            render(App.Cache.get('mapel_opts'));
        } else {
            sel.innerHTML = '<option value="">Loading...</option>';
            google.script.run.withSuccessHandler(d => {
                App.Cache.set('mapel_opts', d);
                render(d);
            }).getAllMapel();
        }
      },

      downloadTemplate: function() {
        const btn = document.getElementById('btn-dl-template');
        App.UI.setLoading(btn, true, 'Menyiapkan...');
        
        google.script.run.withSuccessHandler(res => {
            App.UI.setLoading(btn, false, '<i class="fas fa-download"></i> Download .ZIP');
            // Trik download file via JS
            const link = document.createElement('a');
            link.href = 'data:application/zip;base64,' + res.base64;
            link.download = res.filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }).withFailureHandler(err => {
            App.UI.setLoading(btn, false, 'Error');
            Swal.fire('Gagal', err.message, 'error');
        }).downloadTemplateImport();
      },

      handleImport: function(e) {
        e.preventDefault();
        const btn = document.getElementById('btn-action-import');
        const mapel = document.getElementById('import-mapel').value;
        const fileInput = document.getElementById('import-file');
        
        if(!mapel) return Swal.fire('Pilih Mapel', 'Silakan pilih mapel tujuan.', 'warning');
        if(fileInput.files.length === 0) return Swal.fire('Pilih File', 'File ZIP belum dipilih.', 'warning');
        
        const file = fileInput.files[0];
        // Limit client-side 25MB (Script limit is 50MB but safe 25)
        if(file.size > 25 * 1024 * 1024) return Swal.fire('Terlalu Besar', 'Maksimal ukuran file ZIP adalah 25MB.', 'warning');

        App.UI.setLoading(btn, true, 'Mengupload & Memproses...');
        
        const reader = new FileReader();
        reader.onload = function(evt) {
            const base64 = evt.target.result.split(',')[1];
            
            google.script.run.withSuccessHandler(res => {
                App.UI.setLoading(btn, false, 'Mulai Import');
                if(res.status === 'success') {
                    App.UI.closeModal('modal-import');
                    Swal.fire('Sukses!', res.message, 'success');
                    App.Cache.clearPattern('soal_'); // Clear cache soal lama
                    App.Cache.remove('stats');
                    App.BankSoal.loadDaftar(true); // Refresh tabel
                } else {
                    Swal.fire('Gagal Import', res.message, 'error');
                }
            }).processImportZip(base64, mapel);
        };
        reader.readAsDataURL(file);
      },

      hapus: function(id) {
        Swal.fire({ title: 'Hapus?', text: "Tak bisa balik.", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33' })
        .then((r) => { 
            if (r.isConfirmed) {
                google.script.run.withSuccessHandler(res => { 
                    App.Cache.clearPattern('soal_'); App.Cache.remove('stats');
                    App.BankSoal.loadDaftar(true); 
                    Swal.fire('Deleted', res.message, 'success'); 
                }).hapusSoalDb(id); 
            }
        });
      },

      resetForm: function() {
        document.getElementById('formSoal').reset();
        document.getElementById('soal-id').value = "";
        document.getElementById('soal-bobot').value = "";
        document.getElementById('form-soal-title').innerText = "Input Soal Baru";
        document.getElementById('btnSave').innerText = "SIMPAN SOAL";
        if(App.data.quill) App.data.quill.setContents([]);
        // [BARU] Reset semua hidden input
        ['a','b','c','d','e'].forEach(h => {
            const el = document.getElementById('existing-media-'+h);
            if(el) el.value = "";
        });
        App.BankSoal.changeType();
        ['A','B','C','D','E'].forEach(h => App.BankSoal.removeMedia(h)); // Ganti removeImage jadi removeMedia
      },

      changeType: function() {
        const tipe = document.getElementById('tipe-soal').value;
        document.querySelectorAll('.opsi-area').forEach(el => el.classList.add('hidden'));
        if (tipe === 'PG') document.getElementById('area-pg').classList.remove('hidden');
        if (tipe === 'ISIAN') document.getElementById('area-isian').classList.remove('hidden');
        if (tipe === 'ESSAY') document.getElementById('area-essay').classList.remove('hidden');
        if (tipe === 'BS') document.getElementById('area-bs').classList.remove('hidden');
        if (tipe === 'COCOK') { document.getElementById('area-cocok').classList.remove('hidden'); if(document.getElementById('container-cocok').children.length === 0) App.BankSoal.addRowCocok(); }
      },

      handleMedia: function(input, hur) {
        if (input.files && input.files[0]) {
          const file = input.files[0];
          
          if(file.size > 5 * 1024 * 1024) return Swal.fire('File Terlalu Besar', 'Maksimal 5MB', 'warning');
          if(!file.type.startsWith('image/')) return Swal.fire('Salah Format', 'Hanya boleh upload gambar.', 'error');
          
          const reader = new FileReader();
          reader.onload = (e) => { 
              const b64 = e.target.result; 
              App.data.opsiImages[hur] = b64; 
              
              const box = document.getElementById('prev-box-'+hur);
              const content = document.getElementById('media-content-'+hur);
              
              if(box && content) {
                  box.classList.remove('hidden');
                  // HANYA RENDER IMAGE
                  content.innerHTML = `<img src="${b64}" class="img-opsi-preview" onclick="App.UI.zoomImg(this)">`;
              }
          }
          reader.readAsDataURL(file);
        }
      },

      removeMedia: function(hur) {
        App.data.opsiImages[hur] = null; 
        document.getElementById('file-'+hur.toLowerCase()).value = ""; 
        
        // [BARU] Kosongkan juga hidden input URL lama
        const hiddenInp = document.getElementById('existing-media-'+hur.toLowerCase());
        if(hiddenInp) hiddenInp.value = "";

        const box = document.getElementById('prev-box-'+hur);
        const content = document.getElementById('media-content-'+hur);
        
        if(box) box.classList.add('hidden');
        if(content) content.innerHTML = "";
      },

      // Tambahkan input score (p.s)
      addRowCocok: function(k='', v='', s='') {
        const div = document.createElement('div'); 
        div.className = 'flex gap-2 items-center mb-2';
        // Input Kiri, Kanan, dan Bobot Kecil
        div.innerHTML = `
          <input type="text" class="input-std text-sm cocok-kiri flex-1" value="${k}" placeholder="Pertanyaan (Kiri)">
          <i class="fas fa-arrow-right text-gray-400"></i>
          <input type="text" class="input-std text-sm cocok-kanan flex-1" value="${v}" placeholder="Jawaban (Kanan)">
          <div class="flex items-center gap-1 w-20">
             <span class="text-[10px] text-gray-500 font-bold">Bobot:</span>
             <input type="number" class="input-std text-sm cocok-skor px-1 py-1 text-center" value="${s}" placeholder="1">
          </div>
          <button type="button" onclick="this.parentElement.remove()" class="text-red-400 px-2 hover:text-red-600"><i class="fas fa-times"></i></button>
        `;
        document.getElementById('container-cocok').appendChild(div);
      },
    },

    // --- Module 4: Users Management ---
    User: {
      loadAll: function(forceRefresh = false) {
        const tbody = document.getElementById('tbody-users');
        const btnRefresh = document.getElementById('btn-refresh-user');
        if(forceRefresh && btnRefresh) btnRefresh.classList.add('fa-spin');
        if (!forceRefresh && App.Cache.get('users')) {
            App.data.userList = App.Cache.get('users'); App.User.render(App.data.currentTabRole || 'all'); return;
        }
        tbody.innerHTML = '<tr><td colspan="5" class="p-6 text-center">Loading...</td></tr>';
        google.script.run.withSuccessHandler(data => {
            if(btnRefresh) btnRefresh.classList.remove('fa-spin');
            App.Cache.set('users', data); App.data.userList = data; App.User.render(App.data.currentTabRole || 'all');
        }).getAllUsers();
      },

      render: function(role) {
        const tbody = document.getElementById('tbody-users'); tbody.innerHTML = '';
        const filtered = (role === 'all') ? App.data.userList : App.data.userList.filter(u => u.role.toLowerCase() === role);
        
        if (filtered.length === 0) { tbody.innerHTML = '<tr><td colspan="5" class="p-6 text-center text-gray-400">Belum ada data.</td></tr>'; return; }
        
        filtered.forEach(u => {
           let badge = 'bg-gray-100 text-gray-800'; 
           if(u.role==='admin') badge='bg-red-100 text-red-800'; 
           if(u.role==='guru') badge='bg-blue-100 text-blue-800'; 
           if(u.role==='siswa') badge='bg-green-100 text-green-800';
           
           const status = (u.status === 'Aktif') ? '<span class="px-2 py-0.5 rounded text-xs font-bold bg-green-100 text-green-700">Aktif</span>' : '<span class="px-2 bg-gray-200 text-gray-500 text-xs rounded">Nonaktif</span>';
           
           // LOGIKA TOMBOL HAPUS
           let btnDelete = '';
           
           // 1. Jika Admin -> Locked
           if (u.role === 'admin') {
              btnDelete = '<span class="text-xs italic text-gray-300 cursor-not-allowed"><i class="fas fa-lock"></i> Admin</span>';
           } 
           // 2. Jika Pengawas sedang dipakai di Jadwal Aktif -> Locked
           else if (u.isUsed) {
              btnDelete = '<span class="text-xs italic text-gray-400 cursor-not-allowed" title="Pengawas sedang bertugas di Jadwal Aktif"><i class="fas fa-user-clock"></i> Bertugas</span>';
           }
           // 3. Normal -> Bisa Hapus
           else {
              btnDelete = `<button onclick="App.User.hapus('${u.id}', '${u.nama}')" class="text-red-500 hover:text-red-700 transition"><i class="fas fa-trash"></i></button>`;
           }

           const actions = `<button onclick="App.User.edit('${encodeURIComponent(JSON.stringify(u))}')" class="text-indigo-600 mr-3 hover:text-indigo-800"><i class="fas fa-edit"></i></button>${btnDelete}`;
           
           tbody.insertAdjacentHTML('beforeend', `<tr class="hover:bg-slate-50 transition border-b border-gray-100"><td class="p-4 font-semibold text-gray-700">${u.nama}</td><td class="p-4"><div class="flex flex-col"><span class="text-xs text-gray-500 mb-1 font-mono">${u.username}</span><span class="w-fit px-2 py-0.5 rounded text-[10px] font-bold border uppercase ${badge}">${u.role}</span></div></td><td class="p-4 text-gray-600">${u.kelas || '-'}</td><td class="p-4">${status}</td><td class="p-4 text-right">${actions}</td></tr>`);
        });
      },

      filterTab: function(role, btn) {
        App.data.currentTabRole = role;
        document.querySelectorAll('.tab-btn').forEach(b => { b.classList.remove('bg-indigo-100', 'text-indigo-700'); b.classList.add('text-gray-500', 'hover:bg-gray-50'); });
        btn.classList.remove('text-gray-500', 'hover:bg-gray-50'); btn.classList.add('bg-indigo-100', 'text-indigo-700');
        App.User.render(role);
      },
      save: function(e) {
        e.preventDefault(); const btn = document.getElementById('btnSimpanUser'); App.UI.setLoading(btn, true, 'Simpan');
        const data = { id: document.getElementById('u-id').value, role: document.getElementById('u-role').value, nama: document.getElementById('u-nama').value, username: document.getElementById('u-username').value, password: document.getElementById('u-password').value, kelas: document.getElementById('u-kelas').value, status: document.getElementById('u-status').value };
        google.script.run.withSuccessHandler(res => { 
            App.UI.setLoading(btn, false, 'Simpan'); 
            if(res.status === 'success') { 
                App.UI.closeModal('modal-user'); Swal.fire('Sukses', res.message, 'success'); 
                App.Cache.remove('users'); App.Cache.remove('stats'); App.User.loadAll(true); 
            } else Swal.fire('Gagal', res.message, 'error'); 
        }).simpanUser(data);
      },

      edit: function(enc) {
        const u = JSON.parse(decodeURIComponent(enc));
        App.UI.openModal('modal-user'); document.getElementById('modal-title').innerText = "Edit User";
        document.getElementById('u-id').value = u.id; document.getElementById('u-role').value = u.role.toLowerCase(); document.getElementById('u-nama').value = u.nama; document.getElementById('u-username').value = u.username; document.getElementById('u-password').value = u.password; document.getElementById('u-kelas').value = u.kelas; document.getElementById('u-status').value = u.status || 'Aktif';
        App.User.toggleKelasInput();
      },

      hapus: function(id, nama) { 
          Swal.fire({ 
              title: 'Hapus User?', 
              text: `Yakin menghapus "${nama}"? Data tidak bisa kembali.`, 
              icon: 'warning', 
              showCancelButton: true, 
              confirmButtonColor: '#d33',
              confirmButtonText: 'Ya, Hapus',
              cancelButtonText: 'Batal',
              showLoaderOnConfirm: true, // Fitur bawaan Swal untuk loading spinner
              preConfirm: () => {
                  // Membungkus google.script.run dalam Promise agar Swal menunggu
                  return new Promise((resolve, reject) => {
                      google.script.run
                        .withSuccessHandler((res) => {
                            if(res.status === 'success') {
                                resolve(res); // Lanjut ke .then()
                            } else {
                                Swal.showValidationMessage(res.message); // Tampilkan error di modal
                                resolve(false); // Batalkan tutup modal (opsional) atau reject
                            }
                        })
                        .withFailureHandler((err) => {
                            Swal.showValidationMessage(err.message);
                        })
                        .hapusUser(id);
                  });
              },
              allowOutsideClick: () => !Swal.isLoading() // Cegah klik luar saat loading
          })
          .then((result) => { 
              // Blok ini hanya jalan jika preConfirm berhasil (resolve)
              if (result.isConfirmed && result.value) { 
                  Swal.fire({
                      title: 'Terhapus!',
                      text: result.value.message,
                      icon: 'success',
                      timer: 1500,
                      showConfirmButton: false
                  });
                  App.Cache.remove('users'); 
                  App.Cache.remove('stats'); 
                  App.User.loadAll(true); 
              }
          }); 
      },

      modalOpen: function() { App.UI.openModal('modal-user'); document.getElementById('modal-title').innerText = "Tambah User"; document.getElementById('u-id').value = ""; document.getElementById('u-role').value = "siswa"; document.getElementById('u-nama').value = ""; document.getElementById('u-username').value = ""; document.getElementById('u-password').value = ""; document.getElementById('u-kelas').value = ""; App.User.toggleKelasInput(); },
      toggleKelasInput: function() { const r = document.getElementById('u-role').value; const div = document.getElementById('div-kelas'); if(r === 'siswa') div.classList.remove('hidden'); else div.classList.add('hidden'); }
    },

    // --- Module 5: Mapel Management ---
    Mapel: {
      load: function(forceRefresh = false) {
        const tbody = document.getElementById('tbody-mapel'); 
        const btnRefresh = document.getElementById('btn-refresh-mapel');
        if(forceRefresh && btnRefresh) btnRefresh.classList.add('fa-spin');
        if (!forceRefresh && App.Cache.get('mapel')) { App.Mapel.render(App.Cache.get('mapel')); return; }
        tbody.innerHTML = '<tr><td colspan="4" class="p-6 text-center">Loading...</td></tr>';
        google.script.run.withSuccessHandler(data => {
           if(btnRefresh) btnRefresh.classList.remove('fa-spin');
           App.Cache.set('mapel', data); App.Cache.set('mapel_opts', data); App.Mapel.render(data);
        }).getAllMapel();
      },
      render: function(data) {
        const tbody = document.getElementById('tbody-mapel'); tbody.innerHTML = ''; 
        if(data.length===0) { tbody.innerHTML = '<tr><td colspan="4" class="p-6 text-center text-gray-400">Kosong.</td></tr>'; return; }
        data.forEach(m => { tbody.insertAdjacentHTML('beforeend', `<tr class="hover:bg-slate-50 transition border-b border-gray-100"><td class="p-4 font-mono font-bold text-indigo-600">${m.kode}</td><td class="p-4 font-semibold text-gray-700">${m.nama}</td><td class="p-4 text-gray-600">${m.guru || '-'}</td><td class="p-4 text-right"><button onclick="App.Mapel.edit('${encodeURIComponent(JSON.stringify(m))}')" class="text-indigo-600 mr-3"><i class="fas fa-edit"></i></button><button onclick="App.Mapel.hapus('${m.id}', '${m.kode}')" class="text-red-500"><i class="fas fa-trash"></i></button></td></tr>`); });
      },
      save: function(e) {
        e.preventDefault(); const btn = document.getElementById('btnSimpanMapel'); App.UI.setLoading(btn, true, 'Simpan');
        const data = { id: document.getElementById('m-id').value, kode: document.getElementById('m-kode').value.toUpperCase(), nama: document.getElementById('m-nama').value, guru: document.getElementById('m-guru').value };
        google.script.run.withSuccessHandler(res => { 
            App.UI.setLoading(btn, false, 'Simpan'); 
            if(res.status === 'success') { App.UI.closeModal('modal-mapel'); Swal.fire('Sukses', res.message, 'success'); App.Cache.remove('mapel'); App.Mapel.load(true); } 
            else Swal.fire('Gagal', res.message, 'error'); 
        }).simpanMapel(data);
      },
      edit: function(enc) {
        const m = JSON.parse(decodeURIComponent(enc)); App.UI.openModal('modal-mapel'); document.getElementById('modal-mapel-title').innerText = "Edit Mapel"; document.getElementById('m-id').value = m.id; document.getElementById('m-kode').value = m.kode; document.getElementById('m-nama').value = m.nama;
        const selGuru = document.getElementById('m-guru'); selGuru.innerHTML = '<option>Loading...</option>';
        google.script.run.withSuccessHandler(gurus => { selGuru.innerHTML = '<option value="-">- Pilih Guru -</option>'; gurus.forEach(g => { selGuru.insertAdjacentHTML('beforeend', `<option value="${g}" ${g===m.guru?'selected':''}>${g}</option>`); }); }).getListGuru();
      },
      hapus: function(id, kode) { 
          Swal.fire({ title: 'Hapus?', text: kode, icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33' })
          .then(r => { if(r.isConfirmed) { google.script.run.withSuccessHandler(res => { if(res.status==='success') { App.Cache.remove('mapel'); App.Mapel.load(true); Swal.fire('Deleted','','success'); } else Swal.fire('Gagal', res.message, 'error'); }).hapusMapel(id); }}); 
      },
      modalOpen: function() { App.UI.openModal('modal-mapel'); document.getElementById('modal-mapel-title').innerText = "Tambah Mapel"; document.getElementById('m-id').value = ""; document.getElementById('m-kode').value = ""; document.getElementById('m-nama').value = ""; const selGuru = document.getElementById('m-guru'); selGuru.innerHTML = '<option value="-">Loading...</option>'; google.script.run.withSuccessHandler(gs => { selGuru.innerHTML = '<option value="-">- Pilih Guru -</option>'; gs.forEach(g => selGuru.insertAdjacentHTML('beforeend', `<option value="${g}">${g}</option>`)); }).getListGuru(); }
    },

    // ===========================================
    // MODULE 8: KELOLA UJIAN (BARU !!!)
    // ===========================================
    Ujian: {
      // A. Load Data
      loadJenis: function(force=false) {
        const tb = document.getElementById('tbody-jenis-ujian');
        const btn = document.getElementById('btn-refresh-ujian');
        if(force && btn) btn.classList.add('fa-spin');
        
        if(!force && App.Cache.get('jenis_ujian')) return App.Ujian.renderJenis(App.Cache.get('jenis_ujian'));

        tb.innerHTML = '<tr><td colspan="4" class="p-4 text-center">Loading...</td></tr>';
        google.script.run.withSuccessHandler(data => {
           if(btn) btn.classList.remove('fa-spin');
           App.Cache.set('jenis_ujian', data);
           App.data.jenisUjianList = data; // Simpan untuk dropdown jadwal
           App.Ujian.renderJenis(data);
           // Jika Jenis berubah, dropdown jadwal harus update
           App.Ujian.loadJadwal(true); 
        }).getJenisUjian();
      },

      loadJadwal: function(force=false) {
        const tb = document.getElementById('tbody-jadwal');
        if(!force && App.Cache.get('jadwal')) return App.Ujian.renderJadwal(App.Cache.get('jadwal'));

        tb.innerHTML = '<tr><td colspan="6" class="p-4 text-center">Loading...</td></tr>';
        google.script.run.withSuccessHandler(data => {
           App.Cache.set('jadwal', data);
           App.Ujian.renderJadwal(data);
        }).getJadwalUjian();
      },

      // B. Render Tables
      renderJenis: function(data) {
        const tb = document.getElementById('tbody-jenis-ujian'); 
        tb.innerHTML = '';
        
        if(data.length === 0) { 
            tb.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-400">Belum ada Nama Ujian.</td></tr>'; 
            return; 
        }
        
        data.forEach((item, i) => {
           const badge = item.status === 'Aktif' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
           // encodeURIComponent agar aman saat dipassing ke fungsi edit
           const json = encodeURIComponent(JSON.stringify(item));
           
           // LOGIKA DISABLE TOMBOL HAPUS
           let btnHapus = '';
           if (item.isUsed) {
              // Jika sedang dipakai: Tampilkan ikon gembok/sampah abu-abu, cursor not-allowed, dan tooltip
              btnHapus = `
                <button class="text-gray-300 cursor-not-allowed" title="Sedang digunakan di Jadwal. Tidak bisa dihapus." disabled>
                    <i class="fas fa-trash"></i>
                </button>
              `;
           } else {
              // Jika aman: Tombol merah normal
              btnHapus = `
                <button onclick="App.Ujian.hapusJenis('${item.id}')" class="text-red-500 hover:text-red-700 transition" title="Hapus">
                    <i class="fas fa-trash"></i>
                </button>
              `;
           }

           tb.insertAdjacentHTML('beforeend', `
             <tr class="border-b hover:bg-slate-50 transition">
               <td class="p-3 font-semibold text-gray-700">${item.nama}</td>
               <td class="p-3 text-sm text-gray-500">${item.ket || '-'}</td>
               <td class="p-3"><span class="px-2 py-1 rounded text-xs font-bold ${badge}">${item.status}</span></td>
               <td class="p-3 text-right">
                 <button onclick="App.Ujian.editJenis('${json}')" class="text-indigo-600 mr-3 hover:text-indigo-800 transition" title="Edit">
                    <i class="fas fa-edit"></i>
                 </button>
                 ${btnHapus}
               </td>
             </tr>
           `);
        });
      },

      // A. RENDER TABEL JADWAL (Tambah kolom Pengawas)
      // 1. UPDATE: Render Tabel Jadwal (Menampilkan Info Kelas)
      renderJadwal: function(data) {
        const tb = document.getElementById('tbody-jadwal'); tb.innerHTML = '';
        if(data.length===0) { tb.innerHTML='<tr><td colspan="6" class="p-4 text-center text-gray-400">Belum ada Jadwal.</td></tr>'; return; } // Colspan update jadi 6

        data.forEach((item, i) => {
           const badge = item.status === 'Aktif' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500';
           const fmt = { dateStyle: 'medium', timeStyle: 'short' };
           const mulai = new Date(item.mulai).toLocaleString('id-ID', fmt);
           const selesai = new Date(item.selesai).toLocaleString('id-ID', fmt);
           const json = encodeURIComponent(JSON.stringify(item));
           
           // Display Kelas
           const kelasDisplay = item.target_kelas === 'Semua' 
              ? '<span class="px-2 py-0.5 bg-gray-100 text-gray-600 rounded text-xs font-bold">Semua Kelas</span>' 
              : `<span class="px-2 py-0.5 bg-yellow-100 text-yellow-700 rounded text-xs font-bold"><i class="fas fa-users"></i> ${item.target_kelas}</span>`;

           // Display Pengawas
           let pengawasDisplay = '<span class="text-gray-400 italic">Semua</span>';
           if(item.pengawas && item.pengawas.toLowerCase() !== 'semua') {
              pengawasDisplay = `<span class="bg-purple-100 text-purple-700 px-2 py-0.5 rounded text-xs font-bold"><i class="fas fa-user-shield"></i> ${item.pengawas}</span>`;
           }
           
           tb.insertAdjacentHTML('beforeend', `
             <tr class="border-b hover:bg-slate-50">
               <td class="p-3">
                 <div class="font-bold text-gray-700">${item.nama_ujian}</div>
                 <div class="text-xs text-indigo-600 font-mono">${item.nama_mapel}</div>
               </td>
               <td class="p-3 text-xs">
                 <div class="text-gray-600"><i class="fas fa-play text-green-500 w-4"></i> ${mulai}</div>
                 <div class="text-gray-600 mt-1"><i class="fas fa-stop text-red-500 w-4"></i> ${selesai}</div>
               </td>
               <td class="p-3 text-xs">${pengawasDisplay}</td>
               <td class="p-3 text-xs">${kelasDisplay}</td> <td class="p-3"><span class="px-2 py-1 rounded text-xs font-bold ${badge}">${item.status}</span></td>
               <td class="p-3 text-right">
                 <button onclick="App.Ujian.editJadwal('${json}')" class="text-indigo-600 mr-2"><i class="fas fa-edit"></i></button>
                 <button onclick="App.Ujian.hapusJadwal('${item.id}')" class="text-red-500"><i class="fas fa-trash"></i></button>
               </td>
             </tr>
           `);
        });
      },

      // C. CRUD Operations (Jenis)
      saveJenis: function(e) {
        e.preventDefault(); const btn=document.getElementById('btnSimpanJenis'); App.UI.setLoading(btn,true,'Simpan');
        const d = { id: document.getElementById('j-id').value, nama: document.getElementById('j-nama').value, ket: document.getElementById('j-ket').value, status: document.getElementById('j-status').value };
        google.script.run.withSuccessHandler(r=>{
           App.UI.setLoading(btn,false,'Simpan'); 
           if(r.status==='success') { App.UI.closeModal('modal-jenis'); App.Cache.remove('jenis_ujian'); App.Ujian.loadJenis(true); Swal.fire('Sukses',r.message,'success'); }
        }).simpanJenisUjian(d);
      },
      editJenis: function(str) {
        const d=JSON.parse(decodeURIComponent(str)); App.UI.openModal('modal-jenis'); document.getElementById('modal-jenis-title').innerText="Edit Nama Ujian";
        document.getElementById('j-id').value=d.id; document.getElementById('j-nama').value=d.nama; document.getElementById('j-ket').value=d.ket; document.getElementById('j-status').value=d.status;
      },
      hapusJenis: function(id) { Swal.fire({title:'Hapus?',text:'Jadwal terkait mungkin error',icon:'warning',showCancelButton:true,confirmButtonColor:'#d33'}).then(r=>{ if(r.isConfirmed) google.script.run.withSuccessHandler(()=>{ App.Cache.remove('jenis_ujian'); App.Ujian.loadJenis(true); }).hapusJenisUjian(id); }); },
      openModalJenis: function() { App.UI.openModal('modal-jenis'); document.getElementById('modal-jenis-title').innerText="Tambah Nama Ujian"; document.getElementById('formJenis').reset(); document.getElementById('j-id').value=""; },

      // B. SAVE JADWAL (Kirim data Pengawas)
      saveJadwal: function(e) {
        e.preventDefault(); 
        const btn = document.getElementById('btnSimpanJadwal'); 
        App.UI.setLoading(btn, true, 'Simpan');
        
        const m = document.getElementById('sch-mulai').value;
        const s = document.getElementById('sch-selesai').value;
        
        const d = { 
          id: document.getElementById('sch-id').value, 
          id_jenis: document.getElementById('sch-jenis').value,
          kode_mapel: document.getElementById('sch-mapel').value,
          mulai: m, 
          selesai: s, 
          status: document.getElementById('sch-status').value,
          pengawas: document.getElementById('sch-pengawas').value,
          target_kelas: document.getElementById('sch-kelas').value,
          // DATA BARU
          durasi: document.getElementById('sch-durasi').value,
          acak_soal: document.getElementById('sch-acak-soal').checked,
          acak_opsi: document.getElementById('sch-acak-opsi').checked
        };
        
        google.script.run.withSuccessHandler(r=>{
          App.UI.setLoading(btn,false,'Simpan'); 
          if(r.status==='success') { App.UI.closeModal('modal-jadwal'); App.Cache.remove('jadwal'); App.Ujian.loadJadwal(true); Swal.fire('Sukses',r.message,'success'); }
          else Swal.fire('Error', r.message, 'error');
        }).simpanJadwal(d);
      },

      editJadwal: function(str) {
        const d = JSON.parse(decodeURIComponent(str)); 
        App.Ujian.openModalJadwal(true, d.pengawas || 'semua', d.kode_mapel, d.target_kelas || 'Semua'); 
        
        document.getElementById('modal-jadwal-title').innerText = "Edit Set Ujian";
        document.getElementById('sch-id').value = d.id;
        
        setTimeout(() => {
          document.getElementById('sch-jenis').value = d.id_jenis;
          document.getElementById('sch-status').value = d.status;
          document.getElementById('sch-mulai').value = d.mulai;
          document.getElementById('sch-selesai').value = d.selesai;
          // DATA BARU
          document.getElementById('sch-durasi').value = d.durasi || 60;
          document.getElementById('sch-acak-soal').checked = d.acak_soal;
          document.getElementById('sch-acak-opsi').checked = d.acak_opsi;
        }, 500); 
      },

      hapusJadwal: function(id) { Swal.fire({title:'Hapus Jadwal?',icon:'warning',showCancelButton:true,confirmButtonColor:'#d33'}).then(r=>{ if(r.isConfirmed) google.script.run.withSuccessHandler(()=>{ App.Cache.remove('jadwal'); App.Ujian.loadJadwal(true); }).hapusJadwal(id); }); },
      
      // Tambahkan parameter 'selectedVal' (default null)
      // 3. UPDATE: Open Modal (Load Dropdown Kelas)
      // Tambahkan parameter 'selectedKelas'
      openModalJadwal: function(isEdit=false, selectedPengawas=null, selectedMapel=null, selectedKelas=null) {
        App.UI.openModal('modal-jadwal'); 
        
        if(!isEdit) {
          document.getElementById('modal-jadwal-title').innerText = "Set Ujian Baru";
          document.getElementById('formJadwal').reset(); 
          document.getElementById('sch-id').value = "";
          // RESET FIELD BARU
          document.getElementById('sch-durasi').value = "60"; 
          document.getElementById('sch-acak-soal').checked = false;
          document.getElementById('sch-acak-opsi').checked = false;

          selectedPengawas = 'semua';
          selectedMapel = "";
          selectedKelas = "Semua"; // Default
        }
        
        // --- LOGIKA JENIS UJIAN ---
        const selJenis = document.getElementById('sch-jenis');
        if(selJenis.options.length <= 1) {
            selJenis.innerHTML = '<option value="">- Pilih Ujian -</option>';
            (App.data.jenisUjianList || []).forEach(j => {
              if(j.status === 'Aktif') selJenis.insertAdjacentHTML('beforeend', `<option value="${j.id}">${j.nama}</option>`);
            });
        }
        
        // --- LOGIKA MAPEL ---
        const selMapel = document.getElementById('sch-mapel');
        const renderMapelOpts = (data) => {
            selMapel.innerHTML = '<option value="">- Pilih Mapel/Bank Soal -</option>';
            data.forEach(m => selMapel.insertAdjacentHTML('beforeend', `<option value="${m.kode}">${m.kode} - ${m.nama}</option>`));
            if(selectedMapel) selMapel.value = selectedMapel;
        };
        if(selMapel.options.length <= 1) {
            if(App.Cache.get('mapel')) renderMapelOpts(App.Cache.get('mapel'));
            else google.script.run.withSuccessHandler(d => { App.Cache.set('mapel',d); renderMapelOpts(d); }).getAllMapel();
        } else {
            if(selectedMapel) selMapel.value = selectedMapel;
        }

        // --- LOGIKA PENGAWAS ---
        const selPengawas = document.getElementById('sch-pengawas');
        selPengawas.innerHTML = '<option value="">Loading...</option>';
        google.script.run.withSuccessHandler(users => {
            selPengawas.innerHTML = '<option value="semua">Semua Pengawas</option>';
            users.forEach(u => selPengawas.insertAdjacentHTML('beforeend', `<option value="${u.username}">${u.nama} (${u.username})</option>`));
            if(selectedPengawas) selPengawas.value = selectedPengawas;
        }).getListPengawas();

        // --- TAMBAHAN: LOGIKA DROP DOWN KELAS ---
        const selKelas = document.getElementById('sch-kelas');
        selKelas.innerHTML = '<option value="Semua">Loading...</option>';
        google.script.run.withSuccessHandler(kelasList => {
           selKelas.innerHTML = '<option value="Semua">Semua Kelas</option>';
           kelasList.forEach(k => {
               selKelas.insertAdjacentHTML('beforeend', `<option value="${k}">${k}</option>`);
           });
           if(selectedKelas) selKelas.value = selectedKelas;
        }).getListKelasUnik();
      }
    },

    // --- Module 9: Attendance (BARU) ---
    Attendance: {
       canvas: null,
       ctx: null,
       isDrawing: false,
       examConfig: null, // Menyimpan config ujian sementara
       examMeta: null,   // Menyimpan metadata ujian (id, mapel)
       timerInterval: null,
       hasSigned: false, // Flag apakah sudah corat-coret

       init: function(kodeMapel, idJadwal, config) {
           App.Attendance.examMeta = { kode: kodeMapel, id: idJadwal };
           App.Attendance.examConfig = config;
           
           // Tampilkan Halaman
           document.getElementById('dashboard-container').classList.add('hidden');
           document.getElementById('page-attendance').classList.remove('hidden');
           
           document.getElementById('att-subtitle').innerText = "Mapel: " + kodeMapel;
           
           // Init Clock
           App.Attendance.startClock();
           
           // Init Canvas (Delay sedikit agar render size benar)
           setTimeout(() => {
              App.Attendance.setupCanvas();
           }, 300);
       },

       startClock: function() {
           const update = () => {
              const now = new Date();
              document.getElementById('att-clock').innerText = now.toLocaleTimeString('id-ID', {hour12:false});
              document.getElementById('att-date').innerText = now.toLocaleDateString('id-ID', {weekday:'long', day:'numeric', month:'long', year:'numeric'});
           };
           update();
           if(App.Attendance.timerInterval) clearInterval(App.Attendance.timerInterval);
           App.Attendance.timerInterval = setInterval(update, 1000);
       },

       setupCanvas: function() {
           const canvas = document.getElementById('signature-pad');
           const container = document.getElementById('canvas-container');
           
           // Set resolusi canvas sesuai ukuran CSS
           canvas.width = container.offsetWidth;
           canvas.height = container.offsetHeight;
           
           const ctx = canvas.getContext('2d');
           ctx.lineWidth = 2;
           ctx.lineCap = 'round';
           ctx.strokeStyle = '#000';
           
           App.Attendance.canvas = canvas;
           App.Attendance.ctx = ctx;
           App.Attendance.hasSigned = false;
           document.getElementById('sign-placeholder').classList.remove('hidden');

           // Event Listeners (Mouse & Touch)
           const startDraw = (e) => {
               App.Attendance.isDrawing = true;
               App.Attendance.hasSigned = true;
               document.getElementById('sign-placeholder').classList.add('hidden');
               ctx.beginPath();
               
               const {x, y} = App.Attendance.getPos(e);
               ctx.moveTo(x, y);
           };

           const draw = (e) => {
               if (!App.Attendance.isDrawing) return;
               e.preventDefault(); // Mencegah scroll saat tanda tangan di HP
               const {x, y} = App.Attendance.getPos(e);
               ctx.lineTo(x, y);
               ctx.stroke();
           };

           const stopDraw = () => {
               App.Attendance.isDrawing = false;
               ctx.beginPath();
           };

           // Mouse Events
           canvas.onmousedown = startDraw;
           canvas.onmousemove = draw;
           canvas.onmouseup = stopDraw;
           canvas.onmouseleave = stopDraw;

           // Touch Events
           canvas.ontouchstart = startDraw;
           canvas.ontouchmove = draw;
           canvas.ontouchend = stopDraw;
       },

       getPos: function(e) {
           const rect = App.Attendance.canvas.getBoundingClientRect();
           let clientX, clientY;
           
           if(e.touches && e.touches.length > 0) {
               clientX = e.touches[0].clientX;
               clientY = e.touches[0].clientY;
           } else {
               clientX = e.clientX;
               clientY = e.clientY;
           }
           
           return {
               x: clientX - rect.left,
               y: clientY - rect.top
           };
       },

       clearCanvas: function() {
           const canvas = App.Attendance.canvas;
           App.Attendance.ctx.clearRect(0, 0, canvas.width, canvas.height);
           App.Attendance.hasSigned = false;
           document.getElementById('sign-placeholder').classList.remove('hidden');
       },

       submit: function() {
           if(!App.Attendance.hasSigned) {
               Swal.fire('Belum Tanda Tangan', 'Silakan tanda tangan terlebih dahulu pada kotak yang disediakan.', 'warning');
               return;
           }

           const btn = document.getElementById('btn-submit-att');
           App.UI.setLoading(btn, true, 'Menyimpan Absensi...');

           // Ambil data
           const base64Img = App.Attendance.canvas.toDataURL("image/png");
           const user = App.data.user || JSON.parse(sessionStorage.getItem('cbt_session')).data;
           
           const payload = {
               username: user.username,
               nama: user.nama,
               idJadwal: App.Attendance.examMeta.id,
               mapel: App.Attendance.examMeta.kode,
               signature: base64Img
           };

           google.script.run.withSuccessHandler(res => {
               App.UI.setLoading(btn, false, 'SUBMIT & MULAI');
               
               if(res.status === 'success') {
                   // Tutup halaman absensi
                   document.getElementById('page-attendance').classList.add('hidden');
                   clearInterval(App.Attendance.timerInterval);
                   
                   // LANJUT KE UJIAN (Panggil fungsi asli)
                   // Kita set dulu activeJadwalId karena App.Exam.start membutuhkannya
                   App.data.activeJadwalId = payload.idJadwal;
                   
                   // Jalankan logika start session & load soal
                   // Panggil logic yang sebelumnya ada di actionMulai bagian executeStart
                   google.script.run.startExamSession(payload.username, payload.idJadwal);
                   App.Exam.start(payload.mapel, App.Attendance.examConfig);

               } else {
                   Swal.fire('Gagal', res.message, 'error');
               }
           }).simpanAbsensi(payload);
       },

       close: function() {
           document.getElementById('page-attendance').classList.add('hidden');
           document.getElementById('dashboard-container').classList.remove('hidden');
           clearInterval(App.Attendance.timerInterval);
       }
    },

    // --- Module 6: Exam Logic ---
    Exam: {
      initSiswa: function(user) { /* Deprecated by Dashboard logic but kept for safety */ },

      shuffleArray: function(array) {
          for (let i = array.length - 1; i > 0; i--) {
              const j = Math.floor(Math.random() * (i + 1));
              [array[i], array[j]] = [array[j], array[i]];
          }
          return array;
      },

      start: function(kodeMapel, config) {
          const idJadwal = App.data.activeJadwalId; 
          const username = App.data.user ? App.data.user.username : JSON.parse(sessionStorage.getItem('cbt_session')).data.username;

          Swal.fire({title: 'Memuat Ujian...', didOpen: () => Swal.showLoading()});
          
          google.script.run.withSuccessHandler(res => {
              Swal.close();

              if (res.status === 'locked') {
                 App.Security.triggerLock("Status Terkunci. Masukkan Token.");
                 return;
              }

              App.data.examRunning = true; 
              
              document.getElementById('dashboard-container').classList.add('hidden');
              document.getElementById('page-siswa').classList.remove('hidden');
              document.getElementById('header-mapel').innerText = kodeMapel;
              
              document.getElementById('exam-loading').classList.remove('hidden');
              document.getElementById('soal-container').classList.add('hidden');
              document.getElementById('nav-buttons').classList.add('hidden');
              document.getElementById('disp-pertanyaan').innerHTML = "";

              // --- PERBAIKAN: AKTIFKAN SECURITY FEATURES ---
              App.Security.enterFullscreen(); 
              App.Security.enableWakeLock(); // <--- TAMBAHAN WAKE LOCK DISINI
              // ---------------------------------------------

              App.Exam.timerStart(res.remainingSeconds); 
              App.Exam.loadSoal(kodeMapel, config);

          }).startExamSession(username, idJadwal);
      },

      loadSoal: function(kode, config) {
          const username = App.data.user ? App.data.user.username : JSON.parse(sessionStorage.getItem('cbt_session')).data.username;
          const idJadwal = App.data.activeJadwalId;

          google.script.run.withSuccessHandler(res => {
            if(res.status === 'success') {
              let rawSoal = res.data;
              if(config && config.acakSoal) rawSoal = App.Exam.shuffleArray(rawSoal);
              
              rawSoal.forEach(s => {
                  let keys = ['A','B','C','D','E'];
                  if(config && config.acakOpsi && s.tipe === 'PG') s.shuffledKeys = App.Exam.shuffleArray([...keys]);
                  else s.shuffledKeys = keys;
              });

              App.data.soalList = rawSoal; 
              
              // === FITUR LOAD PROGRESS ===
              // Panggil DB Progress untuk mengembalikan jawaban siswa
              google.script.run.withSuccessHandler(savedJson => {
                  if (savedJson && savedJson !== "{}") {
                      try {
                          const savedJawaban = JSON.parse(savedJson);
                          App.data.jawabanSiswa = savedJawaban;
                          
                          // Optional: Toast notifikasi
                          Swal.fire({
                              toast: true, position: 'top-end', icon: 'info', 
                              title: 'Jawaban tersimpan dimuat kembali', 
                              timer: 3000, showConfirmButton: false
                          });
                      } catch(e) { console.log("Error parse progress", e); }
                  }

                  // Tampilkan UI setelah data siap
                  document.getElementById('exam-loading').classList.add('hidden'); 
                  document.getElementById('soal-container').classList.remove('hidden'); 
                  document.getElementById('nav-buttons').classList.remove('hidden'); 
                  document.getElementById('nav-buttons').classList.add('flex'); 
                  
                  App.Exam.render(0);
                  App.Exam.renderGrid();

              }).getProgressSiswa(username, idJadwal);
              // ============================

            } else { 
              Swal.fire('Gagal', res.message, 'error').then(() => window.location.reload());
            }
          }).getSoalUjian(kode);
      },

      // 1. Fungsi Baru: Toggle Sidebar Mobile
      toggleNavMobile: function() {
          const sidebar = document.getElementById('exam-sidebar');
          // Cek apakah sedang hidden
          if (sidebar.classList.contains('hidden')) {
              // BUKA: Hapus hidden, pastikan styling fixed overlay
              sidebar.classList.remove('hidden');
              sidebar.classList.add('flex', 'fixed', 'inset-0', 'z-50');
          } else {
              // TUTUP: Kembalikan ke hidden (untuk mobile)
              sidebar.classList.add('hidden');
              sidebar.classList.remove('fixed', 'inset-0', 'z-50');
          }
      },

      // 2. Update Fungsi Render (Agar Icon Status Muncul)
      render: function(idx) {
            App.data.currentSoalIdx = idx; 
            const s = App.data.soalList[idx];
            const totalSoal = App.data.soalList.length;
            
            document.getElementById('disp-no').innerText = idx + 1;
            const fixedPertanyaan = App.Util.fixMediaTags(s.pertanyaan);
            document.getElementById('disp-pertanyaan').innerHTML = fixedPertanyaan;

            // --- UPDATE LOGIKA ICON STATUS (KUNING/HIJAU) ---
            const iconContainer = document.getElementById('soal-status-icon');
            iconContainer.innerHTML = ''; // Reset

            // Cek Ragu
            if (App.data.raguSiswa[s.id]) {
                iconContainer.innerHTML += `<span class="flex items-center gap-1 text-yellow-600 bg-yellow-100 px-2 py-1 rounded text-xs font-bold border border-yellow-200 animate-pulse"><i class="fas fa-bookmark"></i> Ragu-ragu</span>`;
            } 
            // Cek Sudah Dijawab (dan tidak ragu)
            // Fix: Cek juga jika tipe object (Pencocokan) minimal punya 1 key
            else if (
                App.data.jawabanSiswa[s.id] && 
                (typeof App.data.jawabanSiswa[s.id] !== 'object' || Object.keys(App.data.jawabanSiswa[s.id]).length > 0)
            ) {
                 iconContainer.innerHTML += `<span class="flex items-center gap-1 text-green-600 bg-green-100 px-2 py-1 rounded text-xs font-bold border border-green-200"><i class="fas fa-check-circle"></i> Terjawab</span>`;
            } else {
                 iconContainer.innerHTML += `<span class="text-gray-400 text-xs italic">Belum dijawab</span>`;
            }
            // ------------------------------------------------

            const imgCont = document.getElementById('disp-gambar-container'); 
            const img = document.getElementById('disp-gambar');
            if(s.gambar) { imgCont.classList.remove('hidden'); img.src = s.gambar; } else { imgCont.classList.add('hidden'); }
            
            const ops = document.getElementById('disp-opsi'); 
            ops.innerHTML = '';

            // RENDER OPSI (Sama seperti sebelumnya, tapi dipercantik sedikit CSS-nya)
            const labelUrut = ['A','B','C','D','E'];
            if(s.tipe === 'PG') {
                let visualIndex = 0; 
                s.shuffledKeys.forEach((realKey) => {
                  // Cek Opsi Teks
                  const textVal = s.opsi[realKey];
                  // Cek Opsi Media (Legacy 'img_' atau Baru 'media_')
                  const mediaVal = s.opsi['media_'+realKey] || s.opsi['img_'+realKey];

                  // Tampilkan jika ada Teks ATAU Media
                  if(textVal || mediaVal) {
                    const visualLabel = labelUrut[visualIndex]; 
                    visualIndex++; 

                    const isSelected = App.data.jawabanSiswa[s.id] === realKey;
                    
                    // Styling
                    const baseClass = "cursor-pointer border-2 rounded-xl p-3 flex gap-4 items-start transition-all duration-200 shadow-sm mb-3 group bg-white";
                    const activeClass = isSelected 
                        ? 'bg-indigo-50 border-indigo-600 ring-1 ring-indigo-500' 
                        : 'border-gray-200 hover:border-indigo-300 hover:bg-gray-50';
                    
                    const circleClass = isSelected
                        ? 'bg-indigo-600 text-white border-indigo-600'
                        : 'bg-gray-100 text-gray-500 border-gray-200 group-hover:border-indigo-300 group-hover:text-indigo-600';

                    // HTML Media Opsi (TAMPILAN SISWA)
                    let htmlMedia = '';
                    if(mediaVal) {
                        // Gunakan Helper App.Util yang sudah diperbarui
                        // Class gambar di parameter kedua bisa disesuaikan
                        const rendered = App.Util.renderMediaHtml(mediaVal, "h-40 w-auto rounded-lg border shadow-sm bg-white object-contain");
                        
                        // Bungkus agar rapi
                        htmlMedia = `<div class="mt-3 w-full">${rendered}</div>`;
                    }

                    ops.insertAdjacentHTML('beforeend', `
                      <div onclick="App.Exam.pilih('${s.id}','${realKey}')" class="${baseClass} ${activeClass}">
                          <div class="w-10 h-10 flex items-center justify-center rounded-full font-bold border-2 text-lg shrink-0 transition-colors mt-1 ${circleClass}">
                              ${visualLabel}
                          </div>
                          <div class="flex-1 min-w-0">
                              <div class="text-gray-700 text-sm md:text-base leading-snug pt-2">
                                  ${textVal || ''}
                              </div>
                              ${htmlMedia}
                          </div>
                          ${isSelected ? '<div class="text-indigo-600 mt-2"><i class="fas fa-check-circle text-xl"></i></div>' : ''}
                      </div>
                    `);
                  }
                });
            } else if (s.tipe === 'BS') {
                ['A','B'].forEach(h => {
                    const val = h==='A'?'BENAR':'SALAH';
                    const isSel = App.data.jawabanSiswa[s.id] === val;
                    const theme = val === 'BENAR' ? 'green' : 'red';
                    const active = isSel 
                        ? `bg-${theme}-600 text-white border-${theme}-600 shadow-lg transform scale-[1.02]` 
                        : `bg-white text-gray-600 hover:bg-${theme}-50 border-gray-200`;
                    
                    ops.insertAdjacentHTML('beforeend', `<div onclick="App.Exam.pilih('${s.id}','${val}')" class="cursor-pointer border-2 rounded-lg p-4 font-bold text-center transition-all ${active}">${val}</div>`);
                });
            } 
            // ==========================================
            // FIX MASALAH DISINI: TAMBAHKAN TIPE COCOK
            // ==========================================
            else if (s.tipe === 'COCOK') {
                const pairs = s.opsi; // Array of objects {k, v, s}
                let userAns = App.data.jawabanSiswa[s.id] || {}; // Object { "Kiri": "Kanan" }
                
                // 1. Siapkan Daftar Jawaban (Kanan) untuk Dropdown & Acak urutannya
                let rightOptions = pairs.map(p => p.v);
                rightOptions = App.Exam.shuffleArray([...rightOptions]); // Shuffle agar tidak sejajar
                
                let htmlTable = `<div class="bg-gray-50 p-4 rounded-lg border border-gray-200"><p class="text-xs font-bold text-gray-500 mb-3 uppercase">Pasangkan pernyataan berikut:</p><div class="space-y-3">`;

                // 2. Render Baris Kiri (Tetap) + Dropdown Kanan
                pairs.forEach((p, idx) => {
                    const currentVal = userAns[p.k] || ""; // Jawaban user untuk baris ini
                    
                    let optionsHtml = `<option value="">- Pilih Pasangan -</option>`;
                    rightOptions.forEach(opt => {
                        const selected = (opt === currentVal) ? "selected" : "";
                        optionsHtml += `<option value="${opt}" ${selected}>${opt}</option>`;
                    });

                    htmlTable += `
                      <div class="flex flex-col md:flex-row gap-2 items-center bg-white p-3 rounded border shadow-sm">
                          <div class="flex-1 font-medium text-gray-700 w-full md:w-auto text-sm">${p.k}</div>
                          <div class="hidden md:block text-gray-400"><i class="fas fa-arrow-right"></i></div>
                          <div class="md:hidden text-gray-400 text-center"><i class="fas fa-arrow-down"></i></div>
                          <div class="flex-1 w-full md:w-auto">
                              <select onchange="App.Exam.pilihCocok('${s.id}', '${p.k}', this.value)" class="w-full p-2 border rounded bg-indigo-50 border-indigo-200 font-semibold text-indigo-700 outline-none focus:ring-2 ring-indigo-500 text-sm">
                                  ${optionsHtml}
                              </select>
                          </div>
                      </div>
                    `;
                });
                
                htmlTable += `</div></div>`;
                ops.innerHTML = htmlTable;
            }
            else {
                // Tipe ESSAY / ISIAN (Default)
                const val = App.data.jawabanSiswa[s.id] || '';
                ops.innerHTML = `<textarea onkeyup="App.Exam.pilih('${s.id}', this.value)" class="w-full border-2 border-gray-300 rounded-lg p-3 h-40 focus:ring-4 ring-indigo-100 focus:border-indigo-500 outline-none transition text-gray-700" placeholder="Ketik jawaban Anda di sini...">${val}</textarea>`;
            }

            App.Exam.renderGrid();

            // Update Tombol Next
            const btnNext = document.getElementById('btn-next-soal'); // Gunakan ID spesifik
            if (btnNext) {
              if (idx === totalSoal - 1) {
                    btnNext.innerHTML = 'Selesai <i class="fas fa-check-circle"></i>';
                    btnNext.className = "px-4 py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-bold w-28 flex items-center justify-center gap-2 shadow-md transition";
                    btnNext.onclick = function() { App.Exam.finish(); }; 
              } else {
                    btnNext.innerHTML = 'Next <i class="fas fa-arrow-right"></i>';
                    btnNext.className = "px-4 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-bold w-28 flex items-center justify-center gap-2 shadow-md transition";
                    btnNext.onclick = function() { App.Exam.next(); }; 
              }
            }
      },

      // 3. Update Fungsi Pilih (Partial Update untuk Essay agar status berubah realtime)
      pilih: function(id, val) { 
            App.data.jawabanSiswa[id] = val; 
            const currentSoal = App.data.soalList[App.data.currentSoalIdx];

            // --- HELPER: Update Tampilan Status Tanpa Reload Halaman (Agar Focus Tidak Hilang) ---
            const updateUI_Partial = () => {
                 const isAnswered = val && val.trim().length > 0;
                 
                 // A. Update Icon Status di Header Soal
                 const iconContainer = document.getElementById('soal-status-icon');
                 if(iconContainer) {
                     iconContainer.innerHTML = '';
                     if (App.data.raguSiswa[id]) {
                         iconContainer.innerHTML = `<span class="flex items-center gap-1 text-yellow-600 bg-yellow-100 px-2 py-1 rounded text-xs font-bold border border-yellow-200 animate-pulse"><i class="fas fa-bookmark"></i> Ragu-ragu</span>`;
                     } else if (isAnswered) {
                         iconContainer.innerHTML = `<span class="flex items-center gap-1 text-green-600 bg-green-100 px-2 py-1 rounded text-xs font-bold border border-green-200"><i class="fas fa-check-circle"></i> Terjawab</span>`;
                     } else {
                         iconContainer.innerHTML = `<span class="text-gray-400 text-xs italic">Belum dijawab</span>`;
                     }
                 }

                 // B. Update Warna Tombol Nomor di Sidebar
                 const gridContainer = document.getElementById('grid-nomor');
                 // Pastikan elemen ada dan index valid
                 if(gridContainer && gridContainer.children[App.data.currentSoalIdx]) {
                     const btn = gridContainer.children[App.data.currentSoalIdx];
                     
                     // 1. Reset class dasar
                     let cls = 'h-10 w-full rounded font-bold text-sm transition-all shadow-sm '; 
                     
                     // 2. Tentukan Warna berdasarkan Status
                     if(App.data.raguSiswa[id]) {
                         cls += 'bg-yellow-400 text-white border-yellow-400';
                     } else if(isAnswered) {
                         cls += 'bg-indigo-600 text-white border-indigo-600';
                     } else {
                         cls += 'bg-white border text-gray-600 hover:bg-gray-100';
                     }

                     // 3. Tambahkan Efek "Sedang Aktif" (Karena siswa sedang di nomor ini)
                     cls += ' ring-4 ring-indigo-200 transform scale-105 font-black';

                     btn.className = cls;
                 }
            };

            // --- AUTO SAVE LOGIC ---
            const username = App.data.user ? App.data.user.username : JSON.parse(sessionStorage.getItem('cbt_session')).data.username;
            const idJadwal = App.data.activeJadwalId;

            const executeSave = () => {
                const jawabanJson = JSON.stringify(App.data.jawabanSiswa);
                // Kirim ke server (silent)
                google.script.run.withFailureHandler(e => console.error(e)).simpanProgressSiswa(username, idJadwal, jawabanJson);
                
                // FITUR BARU: Update Status UI setelah data dianggap masuk (saat timer habis)
                if(currentSoal.tipe === 'ESSAY' || currentSoal.tipe === 'ISIAN') {
                    updateUI_Partial();
                }
            };

            // --- PENGATURAN RENDER & TIMEOUT ---
            if(currentSoal.tipe !== 'ESSAY' && currentSoal.tipe !== 'ISIAN') {
                // Untuk PG/BS: Render full langsung (karena klik opsi tidak butuh fokus keyboard)
                App.Exam.render(App.data.currentSoalIdx);
                executeSave(); 
            } else {
                // Untuk Essay/Isian: Jangan Render Full! Gunakan Partial Update via Timeout.
                if (App.data.saveTimeout) clearTimeout(App.data.saveTimeout);
                
                // Tunggu 1 detik setelah berhenti mengetik
                App.data.saveTimeout = setTimeout(() => { 
                    executeSave(); 
                }, 1000); 
            }
      },

      // Helper khusus untuk input tipe COCOK (UPDATE FIX STATUS)
      pilihCocok: function(idSoal, keyKiri, valKanan) {
          // 1. Ambil data jawaban lama atau inisialisasi object baru
          let currentAns = App.data.jawabanSiswa[idSoal];
          if (typeof currentAns !== 'object' || currentAns === null) {
              currentAns = {};
          }
          
          // 2. Update pasangan key-value
          if (valKanan === "") {
              delete currentAns[keyKiri]; // Hapus jika pilih default
          } else {
              currentAns[keyKiri] = valKanan;
          }
          
          // 3. Simpan ke state global
          App.data.jawabanSiswa[idSoal] = currentAns;

          // 4. Cek Status Terjawab (Minimal 1 pasang terisi)
          const isAnswered = Object.keys(currentAns).length > 0;
          const isRagu = App.data.raguSiswa[idSoal];

          // --- UPDATE UI REALTIME (HEADER STATUS) ---
          const iconContainer = document.getElementById('soal-status-icon');
          if(iconContainer) {
             iconContainer.innerHTML = '';
             if (isRagu) {
                 iconContainer.innerHTML = `<span class="flex items-center gap-1 text-yellow-600 bg-yellow-100 px-2 py-1 rounded text-xs font-bold border border-yellow-200 animate-pulse"><i class="fas fa-bookmark"></i> Ragu-ragu</span>`;
             } else if (isAnswered) {
                 iconContainer.innerHTML = `<span class="flex items-center gap-1 text-green-600 bg-green-100 px-2 py-1 rounded text-xs font-bold border border-green-200"><i class="fas fa-check-circle"></i> Terjawab</span>`;
             } else {
                 iconContainer.innerHTML = `<span class="text-gray-400 text-xs italic">Belum dijawab</span>`;
             }
          }

          // --- UPDATE UI REALTIME (TOMBOL NAVIGASI) ---
          const gridContainer = document.getElementById('grid-nomor');
          if(gridContainer && gridContainer.children[App.data.currentSoalIdx]) {
               const btn = gridContainer.children[App.data.currentSoalIdx];
               
               // Reset class dasar
               let cls = 'h-10 w-full rounded font-bold text-sm transition-all shadow-sm ';
               
               if(isRagu) {
                   cls += 'bg-yellow-400 text-white border-yellow-400';
               } else if(isAnswered) {
                   cls += 'bg-indigo-600 text-white border-indigo-600';
               } else {
                   cls += 'bg-white border text-gray-600 hover:bg-gray-100';
               }
               
               // Tambahkan efek aktif karena sedang di halaman ini
               cls += ' ring-4 ring-indigo-200 transform scale-105 font-black';
               
               btn.className = cls;
          }

          // 5. Kirim ke server (Silent Save)
          const username = App.data.user ? App.data.user.username : JSON.parse(sessionStorage.getItem('cbt_session')).data.username;
          const idJadwal = App.data.activeJadwalId;
          google.script.run.withFailureHandler(e=>console.log(e)).simpanProgressSiswa(username, idJadwal, JSON.stringify(App.data.jawabanSiswa));
      },
      
      next: function() { 
          // 1. AUTO SAVE KE DATABASE CADANGAN
          const username = App.data.user ? App.data.user.username : JSON.parse(sessionStorage.getItem('cbt_session')).data.username;
          const idJadwal = App.data.activeJadwalId;
          const jawabanJson = JSON.stringify(App.data.jawabanSiswa);

          // Kirim ke backend secara "Silent" (tanpa loading spinner agar tidak mengganggu)
          google.script.run.withFailureHandler(err => console.log("Gagal AutoSave", err))
                           .simpanProgressSiswa(username, idJadwal, jawabanJson);

          // 2. PINDAH SOAL
          if(App.data.currentSoalIdx < App.data.soalList.length-1) {
              App.Exam.render(App.data.currentSoalIdx+1);
          }
      },

      prev: function() { if(App.data.currentSoalIdx > 0) App.Exam.render(App.data.currentSoalIdx-1); },

      // 4. Update Toggle Ragu (Refresh Icon)
      toggleRagu: function() { 
            const id = App.data.soalList[App.data.currentSoalIdx].id; 
            if(App.data.raguSiswa[id]) delete App.data.raguSiswa[id]; else App.data.raguSiswa[id] = true; 
            
            // Render ulang halaman saat ini untuk update icon kuning
            App.Exam.render(App.data.currentSoalIdx); 
      },
      
      // Update Render Grid (Nomor Soal)
      renderGrid: function() {
        const g = document.getElementById('grid-nomor'); 
        g.innerHTML='';
        App.data.soalList.forEach((s,i) => {
           let c = 'bg-white border text-gray-600 hover:bg-gray-100'; // Default
           
           // Jika sudah dijawab
           if(App.data.jawabanSiswa[s.id]) c = 'bg-indigo-600 text-white border-indigo-600'; 
           
           // Jika ragu-ragu (Overwrite warna jawab)
           if(App.data.raguSiswa[s.id]) c = 'bg-yellow-400 text-white border-yellow-400'; 
           
           // Jika soal yang sedang aktif
           if(i === App.data.currentSoalIdx) {
               c += ' ring-4 ring-indigo-200 transform scale-105 font-black'; // Highlight current
           }
           
           g.insertAdjacentHTML('beforeend', `<button onclick="App.Exam.render(${i})" class="h-10 w-full rounded font-bold text-sm ${c} transition-all shadow-sm">${i+1}</button>`);
        });
      },

      // 1. UPDATE: Validasi Tombol Selesai
      finish: function() {
          // A. Cek Soal Kosong & Ragu-ragu
          let kosong = [];
          let ragu = [];

          App.data.soalList.forEach((s, i) => {
              const nomor = i + 1;
              // Cek Kosong (undefined, null, atau string kosong)
              if (!App.data.jawabanSiswa[s.id] || App.data.jawabanSiswa[s.id] === "") {
                  kosong.push(nomor);
              }
              // Cek Ragu (harus true)
              if (App.data.raguSiswa[s.id] === true) {
                  ragu.push(nomor);
              }
          });

          // B. Jika Ada Masalah -> Tolak Submit
          if (kosong.length > 0 || ragu.length > 0) {
              let htmlMsg = '<div class="text-left text-sm bg-red-50 p-4 rounded border border-red-100">';
              if (kosong.length > 0) htmlMsg += `<p class="mb-2"><strong class="text-red-600">Belum dijawab:</strong><br>No. ${kosong.join(", ")}</p>`;
              if (ragu.length > 0) htmlMsg += `<p><strong class="text-yellow-600">Masih Ragu-ragu:</strong><br>No. ${ragu.join(", ")}</p>`;
              htmlMsg += '</div>';

              Swal.fire({
                  title: 'Tidak Bisa Mengirim!',
                  html: htmlMsg + '<p class="mt-3 text-xs text-gray-500">Silakan lengkapi atau hilangkan tanda ragu-ragu.</p>',
                  icon: 'warning',
                  confirmButtonText: 'Periksa Kembali'
              });
              return; // STOP PROSES
          }

          // C. Jika Bersih -> Konfirmasi Akhir
          Swal.fire({ 
              title: 'Kumpulkan Jawaban?', 
              text: 'Yakin semua jawaban sudah benar? Anda tidak bisa mengubahnya lagi.', 
              icon: 'question', 
              showCancelButton: true, 
              confirmButtonText: 'Ya, Kumpulkan', 
              confirmButtonColor: '#059669',
              cancelButtonText: 'Batal' 
          }).then(r => { 
              if (r.isConfirmed) App.Exam.submit(false); // False = Manual Submit
          }); 
      },
      
      // 2. UPDATE: Fungsi Submit (Handle Manual vs Auto) dengan FIX RELOAD
      submit: function(isAutoSubmit) {
         // Hentikan semua timer
         App.data.examRunning = false; 
         clearInterval(App.data.timer); 
         if (App.data.saveTimeout) clearTimeout(App.data.saveTimeout);

         // Tampilan Loading
         let titleMsg = isAutoSubmit ? 'Waktu Habis!' : 'Menyimpan Jawaban...';
         let textMsg = isAutoSubmit ? 'Mengirim jawaban otomatis...' : 'Mohon tunggu sebentar.';

         Swal.fire({ 
             title: titleMsg, 
             text: textMsg, 
             icon: isAutoSubmit ? 'warning' : 'info',
             allowOutsideClick: false, 
             allowEscapeKey: false,
             didOpen: () => { Swal.showLoading(); } 
         });
         
         const username = App.data.user ? App.data.user.username : JSON.parse(sessionStorage.getItem('cbt_session')).data.username;

         const p = { 
             nama: document.getElementById('header-nama').innerText, 
             mapel: document.getElementById('header-mapel').innerText, 
             jawaban: App.data.jawabanSiswa,
             username: username,
             idJadwal: App.data.activeJadwalId,
             sisaWaktu: App.data.timeLeft
         };
         
         google.script.run.withSuccessHandler(res => { 
             if(res.status === 'success') {
                 // Berhasil
                 Swal.fire({
                     title: 'Ujian Selesai!', 
                     text: 'Jawaban Anda telah tersimpan ke sistem. Terima kasih.', 
                     icon: 'success',
                     confirmButtonText: 'Kembali ke Dashboard',
                     allowOutsideClick: false
                 }).then(() => {
                     // === FIX: MEKANISME RELOAD YANG LEBIH KUAT ===
                     
                     // 1. Reset variabel global agar bersih
                     App.Util.resetGlobals();
                     
                     try {
                        // OPSI UTAMA: Coba Hard Reload (Refresh Halaman)
                        if(App.data.scriptUrl) {
                           window.top.location.href = App.data.scriptUrl;
                        } else {
                           window.top.location.reload();
                        }
                     } catch(e) {
                        // OPSI CADANGAN (FALLBACK): Jika Reload diblokir browser, lakukan Soft Refresh (Ganti Tampilan Manual)
                        console.warn("Hard reload blocked, switching to SPA mode.");
                        
                        // Sembunyikan Halaman Ujian, Tampilkan Dashboard
                        document.getElementById('page-siswa').classList.add('hidden');
                        document.getElementById('dashboard-container').classList.remove('hidden');
                        
                        // Restore session data untuk memastikan dashboard bisa load
                        const sess = JSON.parse(sessionStorage.getItem('cbt_session'));
                        if(sess) {
                             App.data.user = sess.data;
                             App.data.role = sess.role;
                             // Init ulang dashboard (akan otomatis load jadwal siswa)
                             App.Dashboard.init(sess.data);
                        }
                     }
                     // ===============================================
                 });
             } else { 
                 Swal.fire('Gagal Menyimpan', res.message + '. Silakan lapor pengawas.', 'error'); 
             }
         }).submitUjian(p);
      },

      // 3. UPDATE: Timer (Update UI Header & Lock Screen)
      timerStart: function(secondsLeft) {
         if(App.data.timer) clearInterval(App.data.timer);
         App.data.timeLeft = secondsLeft;

         App.data.timer = setInterval(() => {
            App.data.timeLeft--;
            
            // Format Waktu
            const hours = Math.floor(App.data.timeLeft / 3600);
            const minutes = Math.floor((App.data.timeLeft % 3600) / 60);
            const seconds = App.data.timeLeft % 60;
            const timerStr = hours > 0 
                ? `${hours}:${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}` 
                : `${minutes}:${seconds.toString().padStart(2,'0')}`;

            // 1. Update Timer di Header Utama
            const timerEl = document.getElementById('timer-display');
            if(timerEl) timerEl.innerText = timerStr;

            // 2. UPDATE BARU: Update Timer di Layar Terkunci (Lock Screen)
            const lockTimerEl = document.getElementById('lock-timer');
            if(lockTimerEl) lockTimerEl.innerText = timerStr;
            
            // Warning 5 menit
            if(App.data.timeLeft === 300) {
                Swal.fire({ toast: true, position: 'top-end', icon: 'warning', title: 'Waktu tinggal 5 menit!', timer: 3000, showConfirmButton: false });
            }

            // AUTO SUBMIT SAAT WAKTU HABIS (0 DETIK)
            if(App.data.timeLeft <= 0) { 
                clearInterval(App.data.timer); 
                App.Exam.submit(true); 
            }
         }, 1000);
      }
    },

    // --- Module Pengawas (REVISED) ---
    Pengawas: {
       // A. DASHBOARD: JADWAL SEMUA KELAS (Read Only)
       loadJadwalGlobal: function() {
          // Sembunyikan elemen admin di view-ujian
          document.querySelectorAll('#view-ujian button').forEach(b => b.classList.add('hidden')); // Sembunyikan tombol tambah
          document.querySelectorAll('#view-ujian h3').forEach(h => {
              if(h.innerText.includes('1. Nama Ujian')) h.parentElement.parentElement.classList.add('hidden'); // Sembunyikan tabel master jenis
          });
          
          document.getElementById('page-title').innerText = "Jadwal Ujian Sekolah";
          const tbody = document.getElementById('tbody-jadwal');
          tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center"><i class="fas fa-spinner fa-spin"></i> Memuat Jadwal...</td></tr>';
          
          google.script.run.withSuccessHandler(data => {
             App.Ujian.renderJadwal(data); // Reuse render admin
             // Hapus kolom aksi (Edit/Delete) setelah render
             setTimeout(() => {
                 const rows = tbody.querySelectorAll('tr');
                 rows.forEach(r => { 
                     if(r.lastElementChild) r.lastElementChild.innerHTML = '<span class="text-gray-400 text-xs italic">Read Only</span>'; 
                 });
             }, 100);
          }).getJadwalUjian();
       },

       // B. HALAMAN TOKEN
       loadPageToken: function() {
          document.getElementById('page-title').innerText = "Manajemen Token";
          const container = document.getElementById('list-token-pengawas');
          container.innerHTML = '<div class="text-center p-10"><i class="fas fa-circle-notch fa-spin text-indigo-500 text-2xl"></i><p class="mt-2 text-gray-500">Mengambil Jadwal Anda...</p></div>';

          const user = JSON.parse(sessionStorage.getItem('cbt_session')).data;
          
          google.script.run.withSuccessHandler(res => {
             container.innerHTML = '';
             const jadwal = res.jadwal; // List jadwal yang ditugaskan ke pengawas ini
             
             if(jadwal.length === 0) {
                 container.innerHTML = '<div class="p-8 text-center border-2 border-dashed border-gray-300 rounded-xl"><i class="fas fa-coffee text-gray-300 text-4xl mb-3"></i><p class="text-gray-500 font-bold">Tidak ada jadwal ujian aktif untuk Anda saat ini.</p></div>';
                 return;
             }

             const now = new Date();

             jadwal.forEach(j => {
                 const start = new Date(j.mulai);
                 const end = new Date(j.selesai);
                 
                 // Logika Tombol Aktif/Tidak
                 let btnState = 'disabled class="w-full py-3 bg-gray-200 text-gray-400 rounded-lg font-bold cursor-not-allowed"';
                 let btnText = 'BELUM MULAI';
                 let cardBorder = 'border-l-4 border-gray-300';
                 let statusText = `<span class="text-xs font-bold text-gray-500 bg-gray-100 px-2 py-1 rounded">MENUNGGU</span>`;

                 if (now >= start && now <= end) {
                     // AKTIF
                     btnState = `onclick="App.Pengawas.lihatToken('${j.id}', '${j.mapel}')" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold shadow-lg transform active:scale-95 transition"`;
                     btnText = '<i class="fas fa-eye"></i> LIHAT TOKEN';
                     cardBorder = 'border-l-4 border-indigo-500 shadow-md ring-1 ring-indigo-50';
                     statusText = `<span class="text-xs font-bold text-green-700 bg-green-100 px-2 py-1 rounded animate-pulse">BERLANGSUNG</span>`;
                 } else if (now > end) {
                     // SELESAI
                     btnState = 'disabled class="w-full py-3 bg-red-50 text-red-300 rounded-lg font-bold cursor-not-allowed"';
                     btnText = 'UJIAN DITUTUP';
                     cardBorder = 'border-l-4 border-red-200 opacity-70';
                     statusText = `<span class="text-xs font-bold text-red-500 bg-red-50 px-2 py-1 rounded">SELESAI</span>`;
                 }

                 const tgl = start.toLocaleDateString('id-ID', { weekday:'long', day:'numeric', month:'short' });
                 const jam = start.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'}) + ' - ' + end.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});

                 container.insertAdjacentHTML('beforeend', `
                    <div class="bg-white p-5 rounded-xl border border-gray-100 ${cardBorder} flex flex-col justify-between">
                       <div class="mb-4">
                          <div class="flex justify-between items-start mb-2">
                             <h4 class="font-bold text-lg text-gray-800 leading-tight">${j.mapel}</h4>
                             ${statusText}
                          </div>
                          <div class="text-sm text-gray-500 space-y-1">
                             <div class="flex items-center gap-2"><i class="far fa-calendar text-indigo-400 w-5"></i> ${tgl}</div>
                             <div class="flex items-center gap-2"><i class="far fa-clock text-indigo-400 w-5"></i> ${jam}</div>
                          </div>
                       </div>
                       <button ${btnState}>${btnText}</button>
                    </div>
                 `);
             });

          }).getPengawasDashboard(user.username);
       },

       lihatToken: function(idJadwal, mapelName) {
           Swal.fire({
               title: 'Mengambil Token...',
               allowOutsideClick: false,
               didOpen: () => { Swal.showLoading(); }
           });
           
           google.script.run.withSuccessHandler(res => {
               Swal.close();
               if(res.token && res.token !== 'ERROR') {
                   Swal.fire({
                       title: mapelName,
                       html: `<div class="bg-indigo-50 p-4 rounded-lg border border-indigo-100 mb-2">
                                <p class="text-xs text-gray-500 uppercase font-bold mb-1">Token Ujian</p>
                                <h1 class="text-5xl font-mono font-black text-indigo-700 tracking-widest">${res.token}</h1>
                              </div>
                              <p class="text-sm text-gray-400">Berikan token ini kepada siswa.</p>`,
                       showConfirmButton: true,
                       confirmButtonText: 'Tutup'
                   });
               } else {
                   Swal.fire('Gagal', 'Token tidak tersedia atau waktu ujian habis.', 'error');
               }
           }).getMonitoringSiswa(idJadwal); // Kita reuse fungsi ini karena dia return {token, students}
       },

       loadPageKehadiran: function() {
          document.getElementById('page-title').innerText = "Data Kehadiran Siswa";
          const sel = document.getElementById('hadir-list-ujian');
          const tbody = document.getElementById('tbody-hadir-pgw');
          
          sel.innerHTML = '<option value="">Loading...</option>';
          tbody.innerHTML = '<tr><td colspan="3" class="p-8 text-center text-gray-400">Silakan pilih ujian di atas.</td></tr>';

          const user = JSON.parse(sessionStorage.getItem('cbt_session')).data;

          // Load Dropdown Jadwal (Menggunakan fungsi yang sama dengan Monitoring)
          google.script.run.withSuccessHandler(res => {
              sel.innerHTML = '<option value="">- Pilih Ujian -</option>';
              if(res.jadwal.length === 0) {
                  sel.innerHTML = '<option value="">(Tidak ada ujian aktif)</option>';
                  return;
              }
              res.jadwal.forEach(j => {
                  sel.insertAdjacentHTML('beforeend', `<option value="${j.id}">${j.mapel} (${new Date(j.mulai).toLocaleTimeString()})</option>`);
              });
          }).getPengawasDashboard(user.username);
       },

       refreshKehadiran: function() {
           const idJadwal = document.getElementById('hadir-list-ujian').value;
           const tbody = document.getElementById('tbody-hadir-pgw');
           
           if(!idJadwal) {
               tbody.innerHTML = '<tr><td colspan="3" class="p-8 text-center text-gray-400">Silakan pilih ujian.</td></tr>';
               return;
           }

           tbody.innerHTML = '<tr><td colspan="3" class="p-8 text-center"><i class="fas fa-spinner fa-spin"></i> Memuat Data Absensi...</td></tr>';
           
           google.script.run.withSuccessHandler(data => {
               tbody.innerHTML = '';

               if(data.length === 0) {
                   tbody.innerHTML = '<tr><td colspan="3" class="p-10 text-center"><div class="text-gray-300 text-4xl mb-2"><i class="fas fa-clipboard-list"></i></div><p class="text-gray-500 font-bold">Belum ada data absensi masuk.</p></td></tr>';
                   return;
               }

               data.forEach(r => {
                   // Render Gambar TTD (Base64) dengan fitur Zoom
                   const imgHtml = r.signature ? 
                       `<img src="${r.signature}" class="h-12 border rounded bg-white p-1 hover:scale-150 transition shadow-sm cursor-zoom-in origin-left" onclick="App.UI.zoomImg(this)" title="Klik untuk memperbesar">` 
                       : '<span class="text-xs text-red-400 italic">Tidak ada TTD</span>';

                   tbody.insertAdjacentHTML('beforeend', `
                       <tr class="border-b hover:bg-slate-50 transition">
                           <td class="p-4 font-bold text-gray-700">${r.nama} <br> <span class="text-xs font-normal text-gray-500 font-mono">${r.username}</span></td>
                           <td class="p-4 text-sm text-gray-600 font-mono">${r.waktu}</td>
                           <td class="p-4 text-center">${imgHtml}</td>
                       </tr>
                   `);
               });
           }).getDataAbsensi(idJadwal);
       },

       // C. HALAMAN MONITORING
       loadPageMonitoring: function() {
          document.getElementById('page-title').innerText = "Monitoring Ujian";
          const sel = document.getElementById('mon-list-ujian');
          const tbody = document.getElementById('tbody-mon-pgw');
          const panelInfo = document.getElementById('mon-info-panel');
          
          // Reset UI
          sel.innerHTML = '<option value="">Loading...</option>';
          tbody.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-gray-400">Silakan pilih ujian di atas.</td></tr>';
          panelInfo.classList.add('hidden');

          const user = JSON.parse(sessionStorage.getItem('cbt_session')).data;

          // 1. Load Dropdown Jadwal (Khusus Pengawas Ini)
          google.script.run.withSuccessHandler(res => {
              sel.innerHTML = '<option value="">- Pilih Ujian untuk Dimonitor -</option>';
              if(res.jadwal.length === 0) {
                  sel.innerHTML = '<option value="">(Tidak ada ujian aktif)</option>';
                  return;
              }
              res.jadwal.forEach(j => {
                  sel.insertAdjacentHTML('beforeend', `<option value="${j.id}">${j.mapel} (${new Date(j.mulai).toLocaleTimeString()})</option>`);
              });
          }).getPengawasDashboard(user.username);
       },

       refreshMonitoring: function() {
           const idJadwal = document.getElementById('mon-list-ujian').value;
           const tbody = document.getElementById('tbody-mon-pgw');
           const panelInfo = document.getElementById('mon-info-panel');
           
           if(!idJadwal) {
               // colspan 3 karena kolom aksi sudah dihapus
               tbody.innerHTML = '<tr><td colspan="3" class="p-8 text-center text-gray-400">Silakan pilih ujian.</td></tr>';
               panelInfo.classList.add('hidden');
               return;
           }

           tbody.innerHTML = '<tr><td colspan="3" class="p-8 text-center"><i class="fas fa-spinner fa-spin"></i> Loading data siswa...</td></tr>';
           
           google.script.run.withSuccessHandler(res => {
               panelInfo.classList.remove('hidden');
               document.getElementById('mon-token-small').innerText = res.token;
               
               tbody.innerHTML = '';
               if(res.students.length === 0) {
                   tbody.innerHTML = '<tr><td colspan="3" class="p-8 text-center text-gray-400 italic">Belum ada siswa terdaftar.</td></tr>';
                   return;
               }

               res.students.forEach(s => {
                   let badge = "";
                   let statusTxt = s.status;

                   // --- UPDATE WARNA STATUS ---
                   if(s.status === 'SEDANG MENGERJAKAN') {
                       // KUNING
                       badge = "bg-yellow-100 text-yellow-800 border border-yellow-200 animate-pulse";
                       statusTxt = `<i class="fas fa-pen"></i> SEDANG MENGERJAKAN`;
                   } 
                   else if(s.status === 'SELESAI') {
                       // HIJAU
                       badge = "bg-green-100 text-green-700 border border-green-200";
                       statusTxt = `<i class="fas fa-check"></i> SELESAI`;
                   } 
                   else if(s.status === 'TERKUNCI' || s.isLocked) {
                       // MERAH
                       badge = "bg-red-600 text-white font-bold animate-bounce shadow";
                       statusTxt = `<i class="fas fa-lock"></i> TERKUNCI`;
                   } 
                   else {
                       // ABU-ABU (Default)
                       badge = "bg-gray-200 text-gray-600 border border-gray-300";
                       statusTxt = "BELUM MENGERJAKAN";
                   }

                   // Render Baris (TANPA KOLOM AKSI)
                   tbody.insertAdjacentHTML('beforeend', `
                       <tr class="border-b hover:bg-slate-50 transition">
                           <td class="p-3">
                               <div class="font-bold text-gray-700 text-sm">${s.nama}</div>
                               <div class="text-[10px] text-gray-400 font-mono">${s.username}</div>
                           </td>
                           <td class="p-3 text-center text-xs text-gray-600">${s.kelas || '-'}</td>
                           <td class="p-3 text-center">
                                <span class="px-3 py-1.5 rounded text-[10px] uppercase font-bold tracking-wide border ${badge}">
                                    ${statusTxt}
                                </span>
                           </td>
                       </tr>
                   `);
               });

           }).getMonitoringSiswa(idJadwal);
       },

       // D. HALAMAN PELANGGARAN SISWA
       loadPagePelanggaran: function() {
          document.getElementById('page-title').innerText = "Daftar Pelanggaran Siswa";
          const sel = document.getElementById('pel-list-ujian');
          const tbody = document.getElementById('tbody-pel-pgw');
          
          // Reset UI
          sel.innerHTML = '<option value="">Loading...</option>';
          tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-400">Silakan pilih ujian di atas.</td></tr>';

          const user = JSON.parse(sessionStorage.getItem('cbt_session')).data;

          // Load Dropdown Jadwal (Sama seperti monitoring)
          google.script.run.withSuccessHandler(res => {
              sel.innerHTML = '<option value="">- Pilih Ujian -</option>';
              if(res.jadwal.length === 0) {
                  sel.innerHTML = '<option value="">(Tidak ada ujian aktif)</option>';
                  return;
              }
              res.jadwal.forEach(j => {
                  sel.insertAdjacentHTML('beforeend', `<option value="${j.id}">${j.mapel} (${new Date(j.mulai).toLocaleTimeString()})</option>`);
              });
          }).getPengawasDashboard(user.username);
       },

       refreshPelanggaran: function() {
           const idJadwal = document.getElementById('pel-list-ujian').value;
           const tbody = document.getElementById('tbody-pel-pgw');
           
           if(!idJadwal) {
               tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-400">Silakan pilih ujian.</td></tr>';
               return;
           }

           tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center"><i class="fas fa-spinner fa-spin"></i> Memeriksa pelanggaran...</td></tr>';
           
           google.script.run.withSuccessHandler(res => {
               tbody.innerHTML = '';
               const violators = res.students.filter(s => s.status === 'TERKUNCI' || s.isLocked);

               if(violators.length === 0) {
                   tbody.innerHTML = '<tr><td colspan="5" class="p-10 text-center"><div class="text-green-500 text-4xl mb-2"><i class="fas fa-check-circle"></i></div><p class="text-gray-500 font-bold">Aman. Tidak ada pelanggaran saat ini.</p></td></tr>';
                   return;
               }

               violators.forEach(s => {
                   // AMBIL ALASAN DARI SERVER
                   const violationDetail = s.violationReason || "Terkunci Sistem";

                   tbody.insertAdjacentHTML('beforeend', `
                       <tr class="border-b bg-red-50 hover:bg-red-100 transition">
                           <td class="p-4 font-bold text-gray-700">${s.nama} <br> <span class="text-xs font-normal text-gray-500 font-mono">${s.username}</span></td>
                           <td class="p-4 text-center text-sm">${s.kelas}</td>
                           <td class="p-4 text-center"><span class="bg-red-600 text-white px-3 py-1 rounded-full text-xs font-bold animate-pulse">TERKUNCI</span></td>
                           <td class="p-4 text-sm text-red-700 font-medium"><i class="fas fa-exclamation-circle"></i> ${violationDetail}</td>
                           <td class="p-4 text-center">
                               <button onclick="App.Pengawas.bukaKunci('${s.username}', '${s.nama}')" class="px-4 py-2 bg-white border border-red-300 text-red-600 rounded-lg text-sm font-bold hover:bg-red-600 hover:text-white shadow-sm transition">
                                 <i class="fas fa-key"></i> Buka
                               </button>
                           </td>
                       </tr>
                   `);
               });
           }).getMonitoringSiswa(idJadwal);
       },

       bukaKunci: function(username, nama) {
          Swal.fire({
             title: 'Buka Kunci Siswa?', 
             text: `Siswa: ${nama}. Pastikan siswa melapor kepada Anda.`, 
             icon: 'warning',
             showCancelButton:true, 
             confirmButtonText:'Generate Token',
             confirmButtonColor: '#d33'
          }).then(r => {
             if(r.isConfirmed) {
                google.script.run.withSuccessHandler(token => {
                   Swal.fire({
                     title: 'TOKEN BUKA KUNCI',
                     html: `<h1 class="text-4xl font-bold text-red-600 mt-2 tracking-widest bg-red-50 p-4 rounded border border-red-100">${token}</h1><p class="text-sm text-gray-500 mt-3">Berikan token ini ke siswa untuk membuka kunci layar.</p>`,
                   });
                }).generateUnlockToken(username);
             }
          });
       }
    },

    // --- Module Siswa (Dashboard Logic - LIVE UPDATE & AUTO START) ---
    Siswa: {
       dashboardTimer: null, 

       loadDashboard: function() {
          const div = document.getElementById('list-ujian-siswa');
          div.innerHTML = '<div class="text-center py-10"><i class="fas fa-spinner fa-spin text-3xl text-indigo-500"></i><p class="mt-2 text-gray-400">Memuat Jadwal & Status...</p></div>';
          
          if (App.Siswa.dashboardTimer) {
              clearInterval(App.Siswa.dashboardTimer);
              App.Siswa.dashboardTimer = null;
          }

          const session = JSON.parse(sessionStorage.getItem('cbt_session'));
          const user = session ? session.data : null;

          if (!user) {
             div.innerHTML = '<p class="text-center text-red-500">Sesi error. Silakan logout dan login ulang.</p>';
             return;
          }
          
          google.script.run.withSuccessHandler(data => {
             div.innerHTML = '';
             
             if(!data || data.length === 0) { 
                 div.innerHTML = '<div class="text-center p-8 bg-white rounded-xl shadow-sm border border-gray-100"><img src="https://img.icons8.com/fluency/96/null/nothing-found.png" class="mx-auto mb-3 h-16"><h3 class="font-bold text-gray-700">Tidak ada jadwal ujian.</h3><p class="text-xs text-gray-400">Jadwal untuk kelas Anda belum tersedia saat ini.</p></div>'; 
                 return; 
             }
             
             let liveTimers = [];
             let upcomingExams = [];

             data.forEach(j => {
                const dMulai = new Date(j.mulai);
                const dSelesai = new Date(j.selesai);
                const now = new Date();

                // --- [UPDATE] Format Waktu Lengkap ---
                const opts = { day: 'numeric', month: 'short', hour: '2-digit', minute:'2-digit' };
                // Contoh: 10 Jan 08:00 s.d. 10 Jan 10:00
                const waktuLengkap = dMulai.toLocaleString('id-ID', opts) + ' s.d. ' + dSelesai.toLocaleString('id-ID', opts);

                let cardColor = "border-l-4 border-gray-400";
                let statusBadge = '<span class="bg-gray-100 text-gray-500 px-2 py-1 rounded text-xs font-bold">BELUM MENGERJAKAN</span>';
                let btnAction = '';

                // Encode config
                const configStr = encodeURIComponent(JSON.stringify({ durasi: j.durasi, acakSoal: j.acak_soal, acakOpsi: j.acak_opsi }));

                if (j.status_personal === 'SELESAI') {
                    cardColor = "border-l-4 border-green-500 bg-green-50/30";
                    statusBadge = '<span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold"><i class="fas fa-check-circle"></i> SELESAI MENGERJAKAN</span>';
                    btnAction = '<button disabled class="px-4 py-2 bg-green-200 text-green-700 rounded-lg font-bold cursor-not-allowed text-sm">SELESAI</button>';
                } 
                else if (j.status_personal === 'SEDANG') {
                    cardColor = "border-l-4 border-yellow-500 ring-1 ring-yellow-200";
                    let timerHtml = " | WAKTU HABIS";
                    if (j.sisa_detik > 0) {
                        const targetTime = Date.now() + (j.sisa_detik * 1000);
                        liveTimers.push({ id: j.id, target: targetTime });
                        timerHtml = ` | SISA: <span id="dash-time-${j.id}" class="font-mono">...</span>`;
                    }
                    statusBadge = `<span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-xs font-bold animate-pulse"><i class="fas fa-clock"></i> SEDANG${timerHtml}</span>`;
                    btnAction = `<button onclick="App.Siswa.actionMulai('${j.kode_mapel}', '${j.id}', '${configStr}', false)" class="px-5 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg font-bold shadow text-sm transition">LANJUT MENGERJAKAN <i class="fas fa-arrow-right"></i></button>`;
                }
                else if (j.status_personal === 'TERKUNCI') {
                    cardColor = "border-l-4 border-red-600 bg-red-50";
                    let timerHtml = " | WAKTU HABIS";
                    if (j.sisa_detik > 0) {
                        const targetTime = Date.now() + (j.sisa_detik * 1000);
                        liveTimers.push({ id: j.id, target: targetTime });
                        timerHtml = ` | <i class="fas fa-hourglass-half"></i> SISA: <span id="dash-time-${j.id}" class="font-mono">...</span>`;
                    }
                    statusBadge = `<span class="bg-red-600 text-white px-2 py-1 rounded text-xs font-bold"><i class="fas fa-lock"></i> TERKUNCI${timerHtml}</span>`;
                    btnAction = `<button onclick="App.Siswa.actionUnlock('${j.kode_mapel}', '${j.id}', '${configStr}')" class="px-5 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-bold shadow text-sm transition"><i class="fas fa-key"></i> MASUKKAN TOKEN BUKA KUNCI</button>`;
                }
                else {
                    // --- STATUS: BELUM (Normal) ---
                    if (now < dMulai) {
                        // KASUS 1: BELUM MULAI (Akan di-update LIVE)
                        cardColor = "border-l-4 border-gray-400"; // Warna Abu
                        btnAction = `<button disabled class="px-4 py-2 bg-gray-200 text-gray-400 rounded-lg font-bold cursor-not-allowed text-sm w-full md:w-auto"><i class="far fa-clock"></i> Menunggu Jadwal...</button>`;
                        
                        // Masukkan ke daftar pantau (Upcoming)
                        upcomingExams.push({
                            id: j.id,
                            start: dMulai.getTime(),
                            kode: j.kode_mapel,
                            config: configStr
                        });
                    } else if (now > dSelesai) {
                        // KASUS 2: SUDAH LEWAT
                        cardColor = "border-l-4 border-red-300 opacity-80";
                        btnAction = `<button disabled class="px-4 py-2 bg-red-100 text-red-400 rounded-lg font-bold cursor-not-allowed text-sm">Waktu Habis</button>`;
                    } else {
                        // KASUS 3: SUDAH AKTIF SAAT LOAD
                        cardColor = "border-l-4 border-indigo-500 hover:shadow-md transition";
                        btnAction = `<button onclick="App.Siswa.actionMulai('${j.kode_mapel}', '${j.id}', '${configStr}', true)" class="px-5 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold shadow text-sm transition animate-pulse">MULAI MENGERJAKAN</button>`;
                    }
                }

                // Tambahkan ID unik ke Card dan Wrapper Tombol untuk Update Live
                div.insertAdjacentHTML('beforeend', `
                  <div id="card-ujian-${j.id}" class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 ${cardColor} mb-4 flex flex-col md:flex-row justify-between items-start md:items-center gap-4 transition-colors duration-500">
                     <div class="space-y-2 flex-1">
                        <div class="flex items-center gap-2 mb-1">
                           <span class="text-[10px] font-bold uppercase tracking-wider bg-gray-100 text-gray-600 px-2 py-0.5 rounded">${j.jenis}</span>
                           ${statusBadge}
                        </div>
                        <h4 class="font-bold text-xl text-gray-800">${j.nama_mapel} <span class="text-sm font-normal text-gray-500">(${j.kode_mapel})</span></h4>
                        
                        <div class="grid grid-cols-1 md:flex md:gap-6 text-sm text-gray-600 mt-2">
                            <div class="flex items-center gap-2 md:col-span-2">
                                <i class="far fa-clock text-indigo-400"></i> 
                                <span class="font-medium">${waktuLengkap}</span>
                            </div>
                            
                            <div class="flex items-center gap-2"><i class="fas fa-hourglass-half text-indigo-400"></i> ${j.durasi} Menit</div>
                            <div class="flex items-center gap-2"><i class="fas fa-user-tie text-indigo-400"></i> ${j.pengawas}</div>
                        </div>
                     </div>
                     <div id="btn-wrap-${j.id}" class="w-full md:w-auto flex justify-end">${btnAction}</div>
                  </div>
                `);
             });

             // Jalankan Timer (Gabungan Sisa Waktu & Jadwal Mulai)
             if (liveTimers.length > 0 || upcomingExams.length > 0) {
                 App.Siswa.startDashboardTimer(liveTimers, upcomingExams);
             }

          }).getStudentDashboardData(user.username, user.kelas); 
       },

       // --- SINGLE INTERVAL FOR ALL TIMERS (UPDATED) ---
       startDashboardTimer: function(liveTimers, upcomingExams) {
           const update = () => {
               const now = Date.now();

               // 1. Update Sisa Waktu (SEDANG / TERKUNCI)
               // (Bagian ini tidak berubah, hanya render sisa waktu pengerjaan)
               liveTimers.forEach(t => {
                   const el = document.getElementById(`dash-time-${t.id}`);
                   if (el) {
                       let diff = Math.floor((t.target - now) / 1000);
                       if (diff <= 0) {
                           el.innerHTML = "00m 00s";
                           el.parentElement.innerHTML = " | WAKTU HABIS";
                       } else {
                           const h = Math.floor(diff / 3600);
                           const m = Math.floor((diff % 3600) / 60);
                           const s = diff % 60;
                           el.innerText = (h > 0 ? `${h}j ` : '') + `${m}m ${s}d`;
                       }
                   }
               });

               // 2. Update Jadwal Masuk (BELUM MULAI -> MULAI) & COUNTDOWN 30 DETIK
               // Loop reverse agar aman saat splice (hapus array)
               for (let i = upcomingExams.length - 1; i >= 0; i--) {
                   const u = upcomingExams[i];
                   
                   // Hitung selisih waktu (detik) menuju jam mulai
                   // Math.ceil agar hitungannya: 30, 29, ..., 1 (bukan desimal)
                   const diffSeconds = Math.ceil((u.start - now) / 1000);
                   const btnWrap = document.getElementById(`btn-wrap-${u.id}`);

                   // KONDISI A: WAKTU SUDAH MASUK (Start)
                   if (now >= u.start) {
                       // Update Tombol jadi "MULAI"
                       if(btnWrap) {
                           // Efek animasi bounce agar menarik perhatian
                           btnWrap.innerHTML = `<button onclick="App.Siswa.actionMulai('${u.kode}', '${u.id}', '${u.config}', true)" class="px-5 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold shadow text-sm transition animate-bounce">MULAI MENGERJAKAN</button>`;
                       }

                       // Ganti Warna Kartu (Abu -> Indigo)
                       const card = document.getElementById(`card-ujian-${u.id}`);
                       if(card) {
                           card.classList.remove('border-gray-400');
                           card.classList.add('border-indigo-500', 'shadow-md');
                       }

                       // Notifikasi Kecil
                       const Toast = Swal.mixin({toast: true, position: 'top-end', showConfirmButton: false, timer: 3000});
                       Toast.fire({icon: 'info', title: `Ujian ${u.kode} telah dimulai!`});

                       // Hapus dari daftar pantau agar tidak dieksekusi terus menerus
                       upcomingExams.splice(i, 1);
                   } 
                   // KONDISI B: HITUNG MUNDUR 30 DETIK TERAKHIR
                   else if (diffSeconds <= 30 && diffSeconds > 0) {
                       if (btnWrap) {
                           // Update Teks Tombol menjadi Countdown (Warna Orange)
                           btnWrap.innerHTML = `<button disabled class="px-4 py-2 bg-orange-100 text-orange-600 border border-orange-200 rounded-lg font-bold cursor-not-allowed text-sm w-full md:w-auto transition-all duration-200"><i class="fas fa-stopwatch animate-pulse"></i> Ujian Dimulai Dalam ${diffSeconds} detik</button>`;
                       }
                   }
                   // (Opsional) Jika masih > 30 detik, biarkan teks default "Menunggu Jadwal..." dari loadDashboard
               }
           };

           update(); // Run immediately
           App.Siswa.dashboardTimer = setInterval(update, 1000);
       },

       actionMulai: function(kodeMapel, idJadwal, configStr, needToken) {
           App.data.activeJadwalId = idJadwal;
           if(App.Siswa.dashboardTimer) clearInterval(App.Siswa.dashboardTimer);
           
           const config = JSON.parse(decodeURIComponent(configStr));
           const username = App.data.user ? App.data.user.username : JSON.parse(sessionStorage.getItem('cbt_session')).data.username;

           // LOGIKA BARU: STEP-BY-STEP
           const processEntry = () => {
               Swal.fire({title: 'Memeriksa Data...', didOpen: () => Swal.showLoading()});
               
               // 1. Cek Status Absensi di Server
               google.script.run.withSuccessHandler(res => {
                   Swal.close();
                   
                   if (res.status === 'sudah') {
                       // Jika sudah absen, langsung masuk ujian
                       google.script.run.startExamSession(username, idJadwal);
                       App.Exam.start(kodeMapel, config);
                   } else {
                       // Jika belum absen, arahkan ke halaman Tanda Tangan
                       App.Attendance.init(kodeMapel, idJadwal, config);
                   }
               }).cekStatusAbsensi(username, idJadwal);
           };

           // CEK TOKEN DULU (JIKA DIPERLUKAN)
           if(!needToken) { 
               processEntry(); 
               return; 
           }

           Swal.fire({
            title: 'Token Ujian', text: 'Minta token kepada Pengawas',
            input: 'text', inputAttributes: { autocapitalize: 'off', autocomplete: 'off' },
            showCancelButton: true, confirmButtonText: 'Lanjut', confirmButtonColor: '#4f46e5',
            showLoaderOnConfirm: true,
            preConfirm: (token) => {
               return new Promise((resolve) => {
                  google.script.run.withSuccessHandler(res => {
                     if(res.status === 'success') resolve(true);
                     else { Swal.showValidationMessage(res.message); resolve(); }
                  }).withFailureHandler(err => { Swal.showValidationMessage("Error Koneksi"); resolve(); }).verifikasiTokenUjian(token.toUpperCase(), idJadwal);
               });
            }
          }).then((result) => { 
              if (result.isConfirmed && result.value === true) {
                  processEntry(); // Lanjut ke cek absensi
              }
          });
       },

       actionUnlock: function(kodeMapel, idJadwal, configStr) {
           App.data.activeJadwalId = idJadwal;
           if(App.Siswa.dashboardTimer) clearInterval(App.Siswa.dashboardTimer);
           const username = App.data.user ? App.data.user.username : JSON.parse(sessionStorage.getItem('cbt_session')).data.username;
           Swal.fire({
            title: 'TERKUNCI', text: 'Masukkan Token Buka Kunci',
            input: 'text', inputAttributes: { autocapitalize: 'off' },
            showCancelButton: true, confirmButtonText: 'Buka & Lanjut', confirmButtonColor: '#dc2626',
            showLoaderOnConfirm: true,
            preConfirm: (token) => {
               return new Promise((resolve) => {
                  google.script.run.withSuccessHandler(res => {
                     if(res.status === 'success') resolve(true);
                     else { Swal.showValidationMessage(res.message); resolve(false); }
                  }).verifikasiTokenUnlock(token, username);
               });
            }
          }).then((result) => {
             if (result.isConfirmed && result.value === true) {
                const config = JSON.parse(decodeURIComponent(configStr));
                Swal.fire({title: 'Membuka Kunci...', didOpen: () => Swal.showLoading()});
                google.script.run.withSuccessHandler(() => {
                    Swal.close();
                    App.Exam.start(kodeMapel, config);
                }).unlockSiswa(username, idJadwal);
             }
          });
       },

       // [UPDATE] LOAD HASIL / RIWAYAT
       loadHasil: function() {
           const tbody = document.getElementById('tbody-hasil-siswa');
           tbody.innerHTML = '<tr><td colspan="7" class="p-8 text-center"><i class="fas fa-spinner fa-spin text-indigo-500 text-2xl"></i><p class="mt-2 text-gray-500">Memuat Riwayat...</p></td></tr>';
           
           const sess = JSON.parse(sessionStorage.getItem('cbt_session'));
           if(!sess) return;

           google.script.run.withSuccessHandler(data => {
               tbody.innerHTML = '';
               
               if(!data || data.length === 0) { 
                   tbody.innerHTML = '<tr><td colspan="7" class="p-8 text-center text-gray-400 border-2 border-dashed rounded m-4">Belum ada riwayat ujian.</td></tr>'; 
                   return; 
               }

               data.forEach(r => {
                   // A. Logika Tombol Detail
                   let btnLihat = '';
                   if (r.isPublished) {
                       btnLihat = `<button onclick="App.Siswa.lihatDetail('${r.idJadwal}')" class="px-3 py-1.5 bg-indigo-50 text-indigo-600 rounded hover:bg-indigo-600 hover:text-white transition border border-indigo-100"><i class="fas fa-eye"></i></button>`;
                   } else {
                       btnLihat = `<button disabled class="px-3 py-1.5 bg-gray-100 text-gray-300 rounded cursor-not-allowed"><i class="fas fa-eye-slash"></i></button>`;
                   }

                   // B. LOGIKA TAMPILAN NILAI (KUNCI UTAMA)
                   // Jika Nilai Akhir TERISI (Tidak null/empty), maka Nilai Sementara DIHAPUS (Hidden/-).
                   
                   let displaySementara = '';
                   let displayAkhir = '';

                   // Cek apakah ada Nilai Akhir
                   if (r.nilaiAkhir !== "" && r.nilaiAkhir !== null && r.nilaiAkhir !== undefined) {
                       // KASUS: SUDAH DINILAI GURU
                       displaySementara = '<span class="text-gray-300">-</span>'; 
                       
                       let color = 'text-gray-800';
                       if(r.nilaiAkhir < 70) color = 'text-red-600';
                       if(r.nilaiAkhir >= 85) color = 'text-green-600';
                       
                       // [PERUBAHAN DISINI] Ubah jadi Tombol Link
                       displayAkhir = `
                         <button onclick="App.Nilai.showDetail('${r.idJadwal}', '${sess.data.username}')" 
                                 class="text-lg font-black ${color} hover:underline decoration-dotted underline-offset-4" 
                                 title="Klik untuk lihat perhitungan">
                             ${r.nilaiAkhir}
                         </button>`;
                   } else {
                       // KASUS: BELUM DINILAI GURU (Tampilkan Sementara)
                       displaySementara = `<span class="text-base font-bold text-gray-600 bg-gray-100 px-2 py-1 rounded">${r.nilaiSementara}</span>`;
                       
                       displayAkhir = `<span class="text-[10px] text-orange-400 italic bg-orange-50 px-2 py-0.5 rounded border border-orange-100">Menunggu</span>`;
                   }

                   // C. Render Baris
                   const row = `
                       <tr class="hover:bg-slate-50 border-b transition">
                           <td class="p-4 text-sm text-gray-600 font-medium"><i class="far fa-calendar-alt text-gray-400 mr-2"></i>${r.tgl}</td>
                           <td class="p-4 text-sm text-gray-600 font-mono">${r.jam}</td>
                           <td class="p-4 text-sm font-bold text-indigo-600 bg-indigo-50/30"><i class="fas fa-hourglass-end mr-1 text-indigo-400"></i> ${r.sisaWaktuStr || '-'}</td>
                           <td class="p-4 font-bold text-gray-700">${r.mapel}</td>
                           
                           <td class="p-4 text-center">
                               ${displaySementara}
                           </td>

                           <td class="p-4 text-center">
                               ${displayAkhir}
                           </td>

                           <td class="p-4 text-center">${btnLihat}</td>
                       </tr>`;
                   
                   tbody.insertAdjacentHTML('beforeend', row);
               });
           }).getRiwayatNilaiSiswa(sess.data.username); 
       },

       // [UPDATE] FUNGSI LIHAT DETAIL JAWABAN (Support Guru & Siswa)
       lihatDetail: function(idJadwal, usernameOverride = null) {
           App.UI.openModal('modal-detail-jawaban');
           const container = document.getElementById('container-detail-soal');
           container.innerHTML = '<div class="text-center py-20"><i class="fas fa-circle-notch fa-spin text-4xl text-indigo-500"></i><p class="mt-4 text-gray-500 font-medium">Mengambil lembar jawaban...</p></div>';

           const sess = JSON.parse(sessionStorage.getItem('cbt_session'));
           // Jika override ada (dari Guru), pakai itu. Jika tidak, pakai session (Siswa lihat diri sendiri)
           const targetUser = usernameOverride || sess.data.username;

           google.script.run.withSuccessHandler(res => {
               if(res.status === 'error') {
                   container.innerHTML = `<div class="p-10 text-center text-red-500"><i class="fas fa-exclamation-triangle text-4xl mb-3"></i><p>${res.message}</p></div>`;
                   return;
               }
               
               container.innerHTML = '';
               const data = res.data;

               if(data.length === 0) {
                   container.innerHTML = `<div class="p-10 text-center text-gray-500">Data soal tidak ditemukan.</div>`;
                   return;
               }

               data.forEach((item, idx) => {
                   let statusBadge = '';
                   let cardBorder = '';
                   let kunciDisplay = '';

                   // --- 1. LOGIKA BADGE STATUS ---
                   if (item.tipe === 'PG' || item.tipe === 'BS') {
                       if (item.isCorrect) {
                           statusBadge = '<span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold border border-green-200"><i class="fas fa-check"></i> BENAR</span>';
                           cardBorder = 'border-l-4 border-green-500';
                       } else {
                           statusBadge = '<span class="bg-red-100 text-red-700 px-2 py-1 rounded text-xs font-bold border border-red-200"><i class="fas fa-times"></i> SALAH</span>';
                           cardBorder = 'border-l-4 border-red-500';
                       }
                       kunciDisplay = `<div class="mt-3 p-3 bg-yellow-50 rounded-lg border border-yellow-200 text-sm flex gap-2 items-center"><i class="fas fa-key text-yellow-600"></i><span class="font-bold text-yellow-800">Kunci Jawaban:</span> <span class="font-mono font-bold text-gray-900 bg-white px-2 rounded border">${item.kunci}</span></div>`;
                   
                   } else if (item.tipe === 'COCOK') {
                       statusBadge = '<span class="bg-purple-100 text-purple-700 px-2 py-1 rounded text-xs font-bold border border-purple-200"><i class="fas fa-random"></i> PENCOCOKAN</span>';
                       cardBorder = 'border-l-4 border-purple-500';
                       
                       // Render Kunci Cocok
                       let pairs = [];
                       try { pairs = Array.isArray(item.opsi) ? item.opsi : JSON.parse(item.opsi); } catch(e){}
                       let listKunci = '<ul class="list-disc pl-4 text-xs mt-1 space-y-1">';
                       if(Array.isArray(pairs)) pairs.forEach(p => listKunci += `<li>${p.k} &rarr; <b>${p.v}</b></li>`);
                       listKunci += '</ul>';
                       
                       kunciDisplay = `<div class="mt-3 p-3 bg-purple-50 rounded-lg border border-purple-100 text-sm"><div class="font-bold text-purple-800 mb-1"><i class="fas fa-key"></i> Kunci Pasangan:</div>${listKunci}</div>`;

                   } else {
                       // Essay
                       statusBadge = '<span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs font-bold border border-blue-200"><i class="fas fa-user-edit"></i> URAIAN/ISIAN</span>';
                       cardBorder = 'border-l-4 border-blue-500';
                       kunciDisplay = `<div class="mt-3 p-3 bg-blue-50 rounded-lg border border-blue-100 text-xs italic text-blue-600">Jawaban dikoreksi manual oleh Guru.</div>`;
                   }

                   // --- 2. RENDER JAWABAN SISWA ---
                   let jawabanHtml = '';
                   if (item.tipe === 'COCOK') {
                        if (item.jawabanSiswa && typeof item.jawabanSiswa === 'object') {
                            jawabanHtml = '<div class="space-y-1">';
                            for (const [k, v] of Object.entries(item.jawabanSiswa)) {
                                jawabanHtml += `<div class="flex items-center text-sm gap-2"><span class="bg-white px-2 py-1 rounded border text-gray-700">${k}</span> <i class="fas fa-arrow-right text-gray-400 text-xs"></i> <span class="bg-indigo-50 px-2 py-1 rounded border border-indigo-100 text-indigo-700 font-bold">${v}</span></div>`;
                            }
                            jawabanHtml += '</div>';
                        } else {
                            jawabanHtml = '<span class="italic text-gray-400">Tidak ada pasangan dipilih</span>';
                        }
                   } else {
                        jawabanHtml = item.jawabanSiswa || '<span class="italic text-gray-400">Tidak Dijawab</span>';
                   }

                   // --- 3. RENDER OPSI PG ---
                   let opsiHtml = '';
                   if(item.tipe === 'PG' && item.opsi) {
                       opsiHtml = '<div class="mt-3 space-y-1">';
                       ['A','B','C','D','E'].forEach(k => {
                           const txt = item.opsi[k];
                           const img = item.opsi['media_'+k] || item.opsi['img_'+k];
                           
                           if(txt || img) {
                               let cls = 'p-2 rounded border border-gray-200 text-sm text-gray-600 bg-white flex flex-col gap-1';
                               let icon = '';

                               if(k === item.jawabanSiswa) {
                                   if(item.isCorrect) {
                                      cls = 'p-2 rounded border border-green-300 bg-green-50 text-green-800 font-bold ring-1 ring-green-400';
                                      icon = '<i class="fas fa-check-circle text-green-600 float-right"></i>';
                                   } else {
                                      cls = 'p-2 rounded border border-red-300 bg-red-50 text-red-800 font-bold ring-1 ring-red-400';
                                      icon = '<i class="fas fa-times-circle text-red-600 float-right"></i>';
                                   }
                               } else if(!item.isCorrect && k === item.kunci) {
                                   cls = 'p-2 rounded border border-green-300 bg-green-50 text-green-800 font-bold ring-1 ring-green-400 opacity-75';
                                   icon = '<i class="fas fa-check text-green-600 float-right"></i>';
                               }
                               
                               let mediaHtml = img ? `<div class="mt-1">${App.Util.renderMediaHtml(img, "h-20")}</div>` : '';

                               opsiHtml += `<div class="${cls}">
                                   <div class="flex justify-between"><div><span class="w-5 inline-block font-bold">${k}.</span> ${txt || ''}</div> ${icon}</div>
                                   ${mediaHtml}
                               </div>`;
                           }
                       });
                       opsiHtml += '</div>';
                   }

                   // Render Soal Image Fix
                   let soalContent = item.pertanyaan.replace(/<img /g, '<img class="block max-w-full h-auto rounded border border-gray-200 my-4 shadow-sm clear-both" ');

                   const html = `
                       <div class="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-gray-200 mb-6 ${cardBorder}">
                           <div class="flex justify-between items-start mb-3 border-b pb-2 border-gray-100">
                               <span class="bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-xs font-bold tracking-wide">SOAL NO. ${idx+1}</span>
                               ${statusBadge}
                           </div>
                           
                           <div class="text-gray-800 font-medium text-base mb-6 leading-loose w-full overflow-hidden">
                               ${soalContent}
                           </div>
                           
                           <div class="bg-slate-50 p-4 rounded-lg border border-slate-200 mt-4 clear-both">
                               <div class="flex flex-col gap-1 mb-2">
                                   <span class="text-xs font-bold text-gray-500 uppercase tracking-wider">Jawaban Kamu:</span>
                                   <div class="font-bold text-gray-800 p-3 bg-white rounded border border-gray-300 shadow-sm min-h-[40px]">
                                      ${jawabanHtml}
                                   </div>
                               </div>
                               ${opsiHtml}
                               ${kunciDisplay}
                           </div>
                       </div>
                   `;
                   container.insertAdjacentHTML('beforeend', html);
               });

           }).getDetailJawabanSiswa(idJadwal, targetUser);
       }
    },

    // --- MODULE MONITORING ADMIN (UPDATED) ---
    AdminMonitor: {
       currentExamId: null,
       listCache: [],

       loadSummary: function() {
          const listDiv = document.getElementById('adm-list-exams');
          listDiv.innerHTML = '<div class="text-center mt-10 text-gray-400"><i class="fas fa-circle-notch fa-spin text-2xl"></i><p class="text-xs mt-2">Memuat Data...</p></div>';
          
          google.script.run.withSuccessHandler(res => {
             App.AdminMonitor.listCache = res.exams || []; 
             App.AdminMonitor.renderList(); 
          }).getAdminMonitoringSummary();
       },

       // 1. UPDATE: RENDER LIST (SIDEBAR KIRI)
       renderList: function() {
          const listDiv = document.getElementById('adm-list-exams');
          listDiv.innerHTML = '';
          
          const exams = App.AdminMonitor.listCache; 

          if (exams.length === 0) {
             listDiv.innerHTML = '<div class="text-center p-6 bg-white rounded-lg border border-gray-200"><i class="fas fa-coffee text-gray-300 text-3xl mb-2"></i><p class="text-gray-500 text-sm font-bold">Tidak ada ujian aktif.</p></div>';
             return;
          }

          exams.forEach(ex => {
              const dMulai = new Date(ex.mulai);
              const dSelesai = new Date(ex.selesai);
              const optsDate = { weekday: 'long', day: 'numeric', month: 'short' }; 
              const optsTime = { hour: '2-digit', minute: '2-digit' };
              const tanggalStr = dMulai.toLocaleDateString('id-ID', optsDate);
              const jamStr = dMulai.toLocaleTimeString('id-ID', optsTime) + ' - ' + dSelesai.toLocaleTimeString('id-ID', optsTime);

              const isActive = (App.AdminMonitor.currentExamId === ex.id) ? 'border-indigo-500 ring-1 ring-indigo-500 bg-indigo-50' : 'border-gray-200 bg-white hover:border-indigo-400';
              
              // LOGIKA WARNA BADGE TOKEN DI LIST
              let badgeClass = "bg-indigo-100 text-indigo-700";
              let icon = "fa-key";
              
              if(ex.statusWaktu === 'waiting') {
                  badgeClass = "bg-yellow-100 text-yellow-700"; // Kuning untuk Belum Mulai
                  icon = "fa-clock";
              } else if (ex.statusWaktu === 'done') {
                  badgeClass = "bg-gray-200 text-gray-600"; // Abu untuk Selesai
                  icon = "fa-check-circle";
              } else {
                  badgeClass = "bg-green-100 text-green-700 animate-pulse"; // Hijau untuk Aktif
              }

              const item = document.createElement('div');
              item.className = `cursor-pointer p-4 rounded-xl border transition group relative overflow-hidden ${isActive}`;
              item.onclick = () => App.AdminMonitor.loadDetail(ex.id, ex.mapel, ex.jenis, ex.token, ex.statusWaktu); // Pass statusWaktu
              
              item.innerHTML = `
                 <div class="flex justify-between items-start mb-2 relative z-10">
                    <span class="text-[10px] font-bold uppercase tracking-wider text-gray-500 bg-gray-100 px-2 py-0.5 rounded">${ex.jenis}</span>
                    <span class="text-[10px] font-bold px-2 py-0.5 rounded flex items-center gap-1 ${badgeClass}">
                        <i class="fas ${icon}"></i> ${ex.token}
                    </span>
                 </div>
                 <h4 class="font-bold text-gray-800 text-base mb-1 leading-tight group-hover:text-indigo-700">${ex.mapel}</h4>
                 <div class="mt-3 pt-3 border-t border-dashed border-gray-200 text-xs text-gray-600 space-y-1">
                    <div class="flex items-center gap-2"><i class="far fa-calendar-alt w-4 text-center text-gray-400"></i> <span>${tanggalStr}</span></div>
                    <div class="flex items-center gap-2"><i class="far fa-clock w-4 text-center text-gray-400"></i> <span class="font-mono font-bold">${jamStr}</span></div>
                 </div>
              `;
              listDiv.appendChild(item);
          });
       },

       // 2. UPDATE: LOAD DETAIL (HEADER KANAN)
       loadDetail: function(idJadwal, mapelName, jenisName, initialToken, statusWaktu) {
          App.AdminMonitor.currentExamId = idJadwal;
          App.AdminMonitor.renderList(); // Refresh highlight kiri

          document.getElementById('adm-mon-title').innerText = mapelName;
          document.getElementById('adm-mon-subtitle').innerText = jenisName;
          
          // Update Header Token
          const elToken = document.getElementById('adm-mon-token');
          const elHeader = document.querySelector('#adm-mon-title').parentElement.parentElement; // Header Container (bg-indigo-600)
          
          elToken.innerText = initialToken;
          
          // LOGIKA WARNA HEADER DETAIL
          // Default Class Header: p-4 border-b bg-indigo-600 text-white ...
          
          if(statusWaktu === 'waiting' || initialToken === 'BELUM MULAI') {
             elHeader.className = "p-4 border-b bg-yellow-500 text-white flex justify-between items-center z-10 shrink-0 transition-colors";
             elToken.className = "block text-xl font-bold tracking-tight text-white";
          } 
          else if (statusWaktu === 'done' || initialToken === 'SELESAI') {
             elHeader.className = "p-4 border-b bg-gray-600 text-white flex justify-between items-center z-10 shrink-0 transition-colors";
             elToken.className = "block text-xl font-bold tracking-tight text-gray-300";
          } 
          else {
             // AKTIF
             elHeader.className = "p-4 border-b bg-indigo-600 text-white flex justify-between items-center z-10 shrink-0 transition-colors";
             elToken.className = "block text-2xl font-mono font-black tracking-widest text-yellow-300";
          }

          document.getElementById('adm-header-stats').classList.remove('hidden');
          
          const tbody = document.getElementById('tbody-adm-monitoring');
          const listLocked = document.getElementById('list-adm-locked');
          const badgeLocked = document.getElementById('badge-locked-count');
          
          tbody.innerHTML = '<tr><td colspan="4" class="p-10 text-center"><i class="fas fa-spinner fa-spin text-indigo-500 text-2xl"></i><p class="mt-2 text-gray-500">Mengambil data realtime...</p></td></tr>';
          
          // Panggil Data Realtime
          google.script.run.withSuccessHandler(res => {
             // Update Token (Siapa tau berubah realtime)
             elToken.innerText = res.token;

             const data = res.students;
             tbody.innerHTML = '';
             listLocked.innerHTML = '';
             let lockedCount = 0;

             if(data.length === 0) {
                 tbody.innerHTML = '<tr><td colspan="4" class="p-10 text-center text-gray-400 bg-gray-50 italic">Belum ada siswa yang login pada ujian ini.</td></tr>';
                 listLocked.innerHTML = '<p class="text-xs text-gray-400 italic w-full text-center col-span-full mt-4">Tidak ada data.</p>';
                 badgeLocked.classList.add('hidden');
                 return;
             }

             data.forEach(s => {
                let badge = "bg-gray-100 text-gray-500";
                let statusText = s.status;
                if(s.status === 'SEDANG MENGERJAKAN') { badge = "bg-blue-100 text-blue-700 border border-blue-200 animate-pulse"; statusText = "MENGERJAKAN"; }
                if(s.status === 'SELESAI') { badge = "bg-emerald-100 text-emerald-700 border border-emerald-200"; }
                
                let actionBtn = '<span class="text-gray-300">-</span>';
                if(s.status === 'TERKUNCI' || s.isLocked) {
                    badge = "bg-red-600 text-white font-bold shadow-sm animate-bounce"; statusText = "TERKUNCI"; lockedCount++;
                    actionBtn = `<button onclick="App.Pengawas.bukaKunci('${s.username}', '${s.nama}')" class="px-3 py-1 bg-white border border-red-200 text-red-600 rounded text-xs font-bold hover:bg-red-50 shadow-sm transition"><i class="fas fa-unlock"></i> Buka</button>`;
                    listLocked.insertAdjacentHTML('beforeend', `<div class="flex justify-between items-center bg-white p-3 rounded-lg border-l-4 border-red-500 shadow-sm hover:shadow-md transition"><div class="overflow-hidden mr-2"><p class="text-sm font-bold text-gray-800 truncate">${s.nama}</p><p class="text-[10px] text-gray-500 font-mono">${s.username}</p><p class="text-[10px] text-red-500 font-bold mt-1"><i class="fas fa-lock"></i> TERKUNCI</p></div><button onclick="App.Pengawas.bukaKunci('${s.username}', '${s.nama}')" class="shrink-0 px-4 py-2 bg-red-600 text-white text-xs font-bold rounded hover:bg-red-700 shadow flex items-center gap-2"><i class="fas fa-key"></i> Buka</button></div>`);
                }

                tbody.insertAdjacentHTML('beforeend', `<tr class="hover:bg-slate-50 border-b transition"><td class="p-3"><div class="font-bold text-gray-700 text-sm">${s.nama}</div><div class="text-[10px] text-gray-400 font-mono">${s.username}</div></td><td class="p-3 text-center text-xs font-medium text-gray-600">${s.kelas}</td><td class="p-3 text-center"><span class="px-2 py-1 rounded text-[10px] uppercase font-bold tracking-wide ${badge}">${statusText}</span></td><td class="p-3 text-center">${actionBtn}</td></tr>`);
             });

             if(lockedCount === 0) { listLocked.innerHTML = `<div class="col-span-full flex flex-col items-center justify-center text-gray-400 py-4 opacity-70"><i class="fas fa-check-circle text-4xl mb-2 text-green-200"></i><p class="text-xs font-bold">Aman. Tidak ada pelanggaran.</p></div>`; badgeLocked.classList.add('hidden'); } 
             else { badgeLocked.innerText = lockedCount; badgeLocked.classList.remove('hidden'); }

          }).getMonitoringSiswa(idJadwal);
       }
    },

    // --- MODULE HASIL UJIAN ADMIN ---
    AdminHasil: {
       load: function(force=false) {
          const tbody = document.getElementById('tbody-hasil-admin');
          const filter = document.getElementById('filter-hasil-admin').value;
          
          if(App.Cache.get('mapel_opts')) {
             // Populate dropdown filter mapel admin jika kosong
             const sel = document.getElementById('filter-hasil-admin');
             if(sel.options.length <= 1) {
                App.Cache.get('mapel_opts').forEach(m => sel.insertAdjacentHTML('beforeend', `<option value="${m.kode}">${m.kode}</option>`));
             }
          }

          tbody.innerHTML = '<tr><td colspan="5" class="p-6 text-center"><i class="fas fa-spinner fa-spin"></i> Memuat Hasil...</td></tr>';
          
          google.script.run.withSuccessHandler(data => {
             tbody.innerHTML = '';
             if(data.length === 0) { tbody.innerHTML = '<tr><td colspan="5" class="p-6 text-center text-gray-400">Belum ada data nilai masuk.</td></tr>'; return; }
             
             data.forEach(r => {
                const w = new Date(r.waktu).toLocaleString('id-ID');
                let color = 'text-gray-700';
                if(r.nilai < 60) color = 'text-red-600 font-bold';
                if(r.nilai >= 85) color = 'text-green-600 font-bold';
                
                tbody.insertAdjacentHTML('beforeend', `
                   <tr class="hover:bg-slate-50 border-b">
                      <td class="p-4 text-xs text-gray-500">${w}</td>
                      <td class="p-4 font-semibold text-gray-700">${r.nama}</td>
                      <td class="p-4"><span class="bg-indigo-50 text-indigo-700 px-2 py-1 rounded text-xs font-bold">${r.mapel}</span></td>
                      <td class="p-4 text-center font-mono text-xs">${r.detail}</td>
                      <td class="p-4 text-center text-lg ${color}">${r.nilai}</td>
                   </tr>
                `);
             });
          }).getHasilUjianAdmin(filter);
       }
    },

    // --- MODULE: GURU HASIL & KOREKSI ---
    GuruHasil: {
       load: function(force=false) {
          const tbody = document.getElementById('tbody-hasil-guru');
          tbody.innerHTML = '<tr><td colspan="7" class="p-10 text-center"><i class="fas fa-spinner fa-spin text-2xl text-indigo-500"></i><p class="mt-2 text-gray-500">Memuat Data Ujian Siswa...</p></td></tr>';

          google.script.run.withSuccessHandler(data => {
             tbody.innerHTML = '';
             if(data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="p-10 text-center text-gray-400 italic">Belum ada siswa yang mengumpulkan ujian.</td></tr>';
                return;
             }

             data.forEach(r => {
                // Tampilan Nilai Akhir
                let labelAkhir = '<span class="text-xs text-gray-400 italic">Belum Dikirim</span>';
                let rowClass = "";
                
                if (r.nilaiAkhir !== "" && r.nilaiAkhir !== null) {
                    const val = parseFloat(r.nilaiAkhir);
                    const color = val < 70 ? 'text-red-600' : 'text-green-600';
                    
                    // [PERUBAHAN DISINI]
                    labelAkhir = `
                        <button onclick="App.Nilai.showDetail('${r.idJadwal}', '${r.username}')" 
                                class="text-lg font-bold ${color} hover:underline decoration-dotted underline-offset-4" 
                                title="Lihat detail perhitungan">
                           ${val}
                        </button>`;
                    
                    rowClass = "bg-green-50/30"; 
                }

                tbody.insertAdjacentHTML('beforeend', `
                   <tr class="hover:bg-slate-50 border-b transition ${rowClass}">
                      <td class="p-4">
                         <div class="font-bold text-gray-700">${r.nama}</div>
                         <div class="text-[10px] text-gray-400 font-mono">${r.username}</div>
                      </td>
                      <td class="p-4 text-sm text-gray-600">${r.waktu}</td>
                      <td class="p-4"><span class="bg-indigo-50 text-indigo-700 px-2 py-1 rounded text-xs font-bold border border-indigo-100">${r.mapel}</span></td>
                      <td class="p-4 text-center text-xs font-mono text-gray-500">${r.sisaWaktu}</td>
                      <td class="p-4 text-center">
                         <span class="bg-gray-100 text-gray-600 px-2 py-1 rounded font-bold text-sm">${r.nilaiSementara}</span>
                      </td>
                      <td class="p-4 text-center border-l border-r border-gray-100 bg-white">
                         ${labelAkhir}
                      </td>
                      <td class="p-4 text-center">
                         <div class="flex justify-center gap-2">
                             <button onclick="App.Siswa.lihatDetail('${r.idJadwal}', '${r.username}')" class="p-2 text-gray-500 hover:text-indigo-600 hover:bg-gray-100 rounded transition" title="Lihat Detail Jawaban">
                                 <i class="fas fa-eye"></i>
                             </button>
                             <button onclick="App.GuruKoreksi.bukaKoreksi('${r.idJadwal}', '${r.username}', '${r.rowIndex}', '${r.nama}', '${r.mapel}')" class="px-3 py-1.5 bg-indigo-600 text-white rounded shadow hover:bg-indigo-700 transition font-bold text-xs flex items-center gap-2">
                                 <i class="fas fa-pen-nib"></i> Koreksi
                             </button>
                         </div>
                      </td>
                   </tr>
                `);
             });
          }).getHasilUjianGuru();
       }
    },

    GuruKoreksi: {
       currentData: null,
       currentRowIndex: null,

       bukaKoreksi: function(idJadwal, username, rowIndex, namaSiswa, mapel) {
           App.GuruKoreksi.currentRowIndex = rowIndex;
           App.UI.openModal('modal-koreksi');
           
           document.getElementById('kor-subtitle').innerText = `Siswa: ${namaSiswa} | Mapel: ${mapel}`;
           document.getElementById('container-koreksi-soal').innerHTML = '<div class="text-center py-20"><i class="fas fa-spinner fa-spin text-4xl text-indigo-500"></i><p class="mt-4 text-gray-500">Mengambil Lembar Jawaban...</p></div>';
           
           // Reset Stats
           document.getElementById('kor-total-bobot').innerText = "0";
           document.getElementById('kor-total-skor').innerText = "0";
           document.getElementById('kor-nilai-akhir').innerText = "0";
           document.getElementById('btn-batal-publish').classList.add('hidden');

           google.script.run.withSuccessHandler(res => {
               if(res.status === 'error') {
                   Swal.fire('Error', res.message, 'error');
                   App.UI.closeModal('modal-koreksi');
                   return;
               }
               
               App.GuruKoreksi.currentData = res;
               App.GuruKoreksi.renderSoal(res.soal);
               App.GuruKoreksi.hitungTotal();

               // Tampilkan tombol batal jika sudah publish
               if (res.nilaiAkhir !== "" && res.nilaiAkhir !== null) {
                   document.getElementById('btn-batal-publish').classList.remove('hidden');
               }

           }).getDataKoreksi(idJadwal, username, rowIndex);
       },

       renderSoal: function(listSoal) {
           const container = document.getElementById('container-koreksi-soal');
           container.innerHTML = '';
           
           listSoal.forEach((s, idx) => {
               // 1. SETUP HEADER BADGE
               let headerBadge = `<span class="bg-gray-200 text-gray-600 px-2 py-0.5 rounded text-[10px] font-bold uppercase">${s.tipe}</span>`;
               if (s.tipe === 'ESSAY' || s.tipe === 'ISIAN') headerBadge = `<span class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-[10px] font-bold uppercase border border-blue-200"><i class="fas fa-pen"></i> ${s.tipe}</span>`;
               if (s.tipe === 'COCOK') headerBadge = `<span class="bg-purple-100 text-purple-700 px-2 py-0.5 rounded text-[10px] font-bold uppercase border border-purple-200"><i class="fas fa-random"></i> COCOK</span>`;

               // 2. FIX MEDIA TAGS
               let fixedSoal = App.Util.fixMediaTags(s.soal);
               fixedSoal = fixedSoal.replace(/<img /g, '<img class="block max-w-full h-auto rounded border my-2 shadow-sm" ');

               // 3. RENDER JAWABAN SISWA (HANDLE OBJECT OBJECT)
               let jawabanDisplay = '';
               
               if (s.tipe === 'COCOK') {
                   // Handle Object {Kiri: Kanan}
                   if (typeof s.jawabanSiswa === 'object' && s.jawabanSiswa !== null) {
                       let htmlList = '<div class="space-y-1">';
                       for (const [key, val] of Object.entries(s.jawabanSiswa)) {
                           htmlList += `
                             <div class="flex items-center text-sm gap-2">
                                <span class="bg-gray-100 px-2 py-1 rounded border text-gray-700 font-medium">${key}</span>
                                <i class="fas fa-arrow-right text-gray-400 text-xs"></i>
                                <span class="bg-indigo-50 px-2 py-1 rounded border border-indigo-100 text-indigo-700 font-bold">${val}</span>
                             </div>`;
                       }
                       htmlList += '</div>';
                       jawabanDisplay = htmlList;
                   } else {
                       jawabanDisplay = '<em class="text-gray-400">Tidak ada pasangan yang dipilih.</em>';
                   }
               } else {
                   // Handle String Biasa (PG, ESSAY, ISIAN)
                   const jwbTeks = s.jawabanSiswa || '<em class="text-gray-400">Tidak dijawab</em>';
                   jawabanDisplay = `<div class="p-3 bg-white border rounded text-gray-800 font-medium min-h-[40px]">${jwbTeks}</div>`;
               }

               // 4. RENDER OPSI JIKA PG (Guru perlu lihat opsi)
               let opsiHtml = '';
               if (s.tipe === 'PG' && s.opsi) {
                   opsiHtml = '<div class="mt-3 grid grid-cols-1 gap-2">';
                   ['A','B','C','D','E'].forEach(k => {
                       const txt = s.opsi[k] || '';
                       const img = s.opsi['media_'+k] || s.opsi['img_'+k] || ''; // Handle media
                       
                       if(txt || img) {
                           // Highlight Jawaban Siswa & Kunci
                           let cls = "border-gray-200 bg-gray-50 text-gray-500";
                           let icon = "";
                           
                           // Jika ini Kunci
                           if (k === s.kunci) { cls = "border-green-400 bg-green-50 text-green-700 font-bold ring-1 ring-green-300"; icon = '<i class="fas fa-check float-right"></i>'; }
                           
                           // Jika ini Jawaban Siswa
                           if (k === s.jawabanSiswa) {
                               if (k === s.kunci) { cls = "border-green-500 bg-green-100 text-green-800 font-bold ring-2 ring-green-500"; icon = '<i class="fas fa-check-circle float-right"></i>'; }
                               else { cls = "border-red-400 bg-red-50 text-red-800 font-bold ring-1 ring-red-300"; icon = '<i class="fas fa-times-circle float-right"></i>'; }
                           }

                           let mediaHtml = img ? `<div class="mt-1">${App.Util.renderMediaHtml(img, "h-16")}</div>` : '';
                           
                           opsiHtml += `<div class="p-2 border rounded text-xs ${cls}">
                               <span class="font-bold w-4 inline-block">${k}.</span> ${txt} ${mediaHtml} ${icon}
                           </div>`;
                       }
                   });
                   opsiHtml += '</div>';
               }

               // 5. INPUT SCORE AREA
               let inputArea = '';
               if (s.tipe === 'ESSAY' || s.tipe === 'ISIAN') {
                   inputArea = `
                     <div class="mt-4 p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                        <label class="text-xs font-bold text-yellow-800 uppercase mb-1 block">Input Skor (Max: ${s.bobot})</label>
                        <input type="number" id="skor-${s.id}" value="${s.skor}" max="${s.bobot}" min="0" step="0.1" 
                               class="w-full p-2 text-lg font-bold text-gray-800 border-2 border-yellow-300 rounded focus:border-yellow-500 outline-none"
                               oninput="App.GuruKoreksi.updateSkor('${s.id}', this.value, ${s.bobot})">
                     </div>`;
               } else {
                   // PG / COCOK / BS -> Read Only
                   // LOGIKA BARU UNTUK STATUS WARNA
                   let statusClass = "";
                   let msg = "";
                   let icon = "";

                   if (s.skor >= s.bobot) {
                       // BENAR SEMPURNA (Hijau)
                       statusClass = "bg-green-100 text-green-700 border-green-200";
                       msg = "BENAR";
                       icon = "check-circle";
                   } else if (s.skor > 0) {
                       // SEBAGIAN BENAR (Kuning/Orange) - KHUSUS COCOK
                       statusClass = "bg-orange-100 text-orange-700 border-orange-200";
                       msg = "SEBAGIAN BENAR";
                       icon = "exclamation-circle";
                   } else {
                       // SALAH (Merah)
                       statusClass = "bg-red-100 text-red-700 border-red-200";
                       msg = "SALAH";
                       icon = "times-circle";
                   }
                   
                   inputArea = `
                     <div class="mt-4 p-3 ${statusClass} rounded border flex justify-between items-center transition-colors">
                        <span class="text-xs font-bold uppercase flex items-center gap-2">
                            <i class="fas fa-${icon}"></i> ${msg}
                        </span>
                        <span class="font-bold text-lg">${s.skor} <span class="text-xs font-normal opacity-70">/ ${s.bobot}</span></span>
                        <input type="hidden" id="skor-${s.id}" value="${s.skor}">
                     </div>`;
               }

               // 6. RENDER KUNCI
               let kunciDisplay = '';
               if (s.tipe !== 'PG') { // PG sudah ada di opsi
                   if (s.tipe === 'COCOK') {
                       // Render Kunci Cocok (Array of Objects)
                       let pairs = [];
                       try { pairs = typeof s.opsi === 'string' ? JSON.parse(s.opsi) : s.opsi; } catch(e){}
                       
                       let listKunci = '<ul class="list-disc pl-4 text-xs mt-1 space-y-1">';
                       if(Array.isArray(pairs)) {
                           pairs.forEach(p => listKunci += `<li>${p.k} &rarr; <b>${p.v}</b></li>`);
                       }
                       listKunci += '</ul>';
                       kunciDisplay = `<div class="mt-3 p-2 bg-gray-100 rounded border border-gray-200 text-gray-600"><span class="text-[10px] font-bold uppercase">Kunci Jawaban:</span>${listKunci}</div>`;

                   } else {
                       kunciDisplay = `<div class="mt-2 text-xs text-gray-500"><strong>Kunci:</strong> <span class="font-mono bg-gray-200 px-1 rounded">${s.kunci}</span></div>`;
                   }
               }

               // COMBINE HTML
               const html = `
                   <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                       <div class="flex justify-between items-start mb-3 border-b pb-2">
                           <div class="flex items-center gap-2">
                               <span class="font-bold text-gray-400">#${idx+1}</span>
                               ${headerBadge}
                           </div>
                           <span class="text-xs font-bold text-gray-400">Bobot: ${s.bobot}</span>
                       </div>
                       
                       <div class="mb-4 text-gray-800 leading-relaxed">${fixedSoal}</div>
                       ${opsiHtml}
                       
                       <div class="bg-slate-50 p-3 rounded-lg border border-slate-200 mt-2">
                           <div class="text-[10px] uppercase font-bold text-slate-400 mb-1">Jawaban Siswa</div>
                           ${jawabanDisplay}
                           ${kunciDisplay}
                       </div>

                       ${inputArea}
                   </div>
               `;
               container.insertAdjacentHTML('beforeend', html);
           });
       },

       updateSkor: function(idSoal, val, maxBobot) {
           let num = parseFloat(val);
           if (isNaN(num)) num = 0;
           if (num > maxBobot) {
               num = maxBobot; // Cap at max
               document.getElementById(`skor-${idSoal}`).value = num;
           }
           if (num < 0) num = 0;

           // Update local data
           const target = App.GuruKoreksi.currentData.soal.find(s => s.id === idSoal);
           if(target) target.skor = num;

           App.GuruKoreksi.hitungTotal();
       },

       hitungTotal: function() {
           const data = App.GuruKoreksi.currentData;
           let totalSkor = 0;
           
           data.soal.forEach(s => {
               totalSkor += parseFloat(s.skor || 0);
           });

           // Hitung Nilai Akhir Skala 100
           // Rumus: (Total Skor / Total Bobot) * 100
           let nilaiAkhir = 0;
           if (data.totalBobot > 0) {
               nilaiAkhir = (totalSkor / data.totalBobot) * 100;
           }
           
           // Rounding
           nilaiAkhir = Math.round(nilaiAkhir * 100) / 100; // 2 decimal

           // Update UI Sidebar
           document.getElementById('kor-total-bobot').innerText = data.totalBobot;
           document.getElementById('kor-total-skor').innerText = parseFloat(totalSkor.toFixed(2)); // Fix floating point
           document.getElementById('kor-nilai-akhir').innerText = nilaiAkhir;
       },

       simpan: function(action) {
           const data = App.GuruKoreksi.currentData;
           if (!data) return;

           // 1. Prepare JSON Draft (ID Soal : Skor)
           let draftJson = {};
           let totalSkor = 0;
           data.soal.forEach(s => {
               draftJson[s.id] = s.skor;
               totalSkor += s.skor;
           });

           // 2. Hitung Nilai Akhir
           let nilaiAkhir = 0;
           if (data.totalBobot > 0) nilaiAkhir = (totalSkor / data.totalBobot) * 100;
           nilaiAkhir = Math.round(nilaiAkhir * 100) / 100;

           // 3. Konfirmasi jika Publish
           if (action === 'publish') {
               Swal.fire({
                   title: 'Kirim Nilai Akhir?',
                   text: `Nilai ${nilaiAkhir} akan ditampilkan ke siswa di menu Riwayat.`,
                   icon: 'question',
                   showCancelButton: true,
                   confirmButtonText: 'Ya, Kirim',
                   confirmButtonColor: '#059669'
               }).then(r => {
                   if(r.isConfirmed) App.GuruKoreksi.executeSave(action, JSON.stringify(draftJson), nilaiAkhir);
               });
           } else {
               App.GuruKoreksi.executeSave(action, JSON.stringify(draftJson), nilaiAkhir);
           }
       },

       executeSave: function(action, jsonStr, nilaiVal) {
           const btnText = action === 'publish' ? 'Mengirim...' : 'Menyimpan...';
           Swal.fire({title: btnText, didOpen: () => Swal.showLoading()});
           
           const payload = {
               rowIndex: App.GuruKoreksi.currentRowIndex,
               skorJson: jsonStr,
               nilaiAkhir: nilaiVal,
               action: action
           };

           google.script.run.withSuccessHandler(res => {
               Swal.close();
               if(res.status === 'success') {
                   Swal.fire('Sukses', res.message, 'success');
                   App.UI.closeModal('modal-koreksi');
                   App.GuruHasil.load(true); // Refresh tabel utama
               } else {
                   Swal.fire('Gagal', res.message, 'error');
               }
           }).simpanNilaiGuru(payload);
       },

       batal: function() {
           Swal.fire({
               title: 'Batalkan Nilai Akhir?',
               text: "Status akan kembali menjadi Draft. Siswa tidak akan melihat nilai akhir.",
               icon: 'warning',
               showCancelButton: true,
               confirmButtonColor: '#d33',
               confirmButtonText: 'Ya, Batalkan'
           }).then(r => {
               if(r.isConfirmed) {
                   Swal.fire({didOpen: () => Swal.showLoading()});
                   google.script.run.withSuccessHandler(res => {
                       Swal.fire('Info', res.message, 'success');
                       App.UI.closeModal('modal-koreksi');
                       App.GuruHasil.load(true);
                   }).batalkanNilaiAkhir(App.GuruKoreksi.currentRowIndex);
               }
           });
       }
    },

    // --- Module 7: UI Utilities ---
    UI: {
      setLoading: function(btn, isLoading, text) {
        if(btn) {
            btn.disabled = isLoading;
            btn.innerHTML = isLoading ? `<i class="fas fa-circle-notch fa-spin"></i> ${text}` : text;
        }
      },

      switchView: function(viewId, btn) {
        // 1. Mobile Sidebar Toggle
        if(window.innerWidth < 768) App.UI.toggleSidebar(false);
        
        // 2. Active State Styling (Navigasi)
        document.querySelectorAll('.nav-item').forEach(el => el.className = 'nav-item w-full flex items-center gap-3 px-6 py-3 transition text-left hover:bg-slate-800 text-gray-400 hover:text-white');
        if(btn) btn.className = 'nav-item w-full flex items-center gap-3 px-6 py-3 transition text-left bg-slate-800 border-l-4 border-indigo-500 text-white';
        
        // 3. Sembunyikan Semua View
        const allViews = [
            'view-dashboard', 'view-bank-soal', 'view-akun', 'view-mapel', 'view-ujian',
            'view-jadwal-siswa', 'view-hasil-ujian', 
            'view-admin-monitoring', 'view-admin-hasil', 'view-hasil-siswa',
            'view-pengawas-token', 'view-pengawas-monitor', 'view-pengawas-pelanggaran', 'view-pengawas-kehadiran',
            'view-placeholder'
        ];

        allViews.forEach(id => { 
            const el = document.getElementById(id); 
            if(el) el.classList.add('hidden'); 
        });

        // Reset UI States (Kembalikan tampilan admin mode jika sebelumnya diubah pengawas)
        const viewUjian = document.getElementById('view-ujian');
        if (viewUjian) {
            viewUjian.querySelectorAll('button').forEach(b => b.classList.remove('hidden'));
            viewUjian.querySelectorAll('h3').forEach(h => {
                if(h.innerText.includes('1. Nama Ujian')) h.parentElement.parentElement.classList.remove('hidden');
            });
            viewUjian.querySelectorAll('.read-only-label').forEach(el => el.remove());
        }

        // 4. Set Judul Halaman
        const pageTitle = document.getElementById('page-title');
        if(pageTitle) pageTitle.innerText = viewId.replace(/-/g, ' ').toUpperCase();

        // 5. Logika Percabangan View
        
        // --- LOGIC SISWA ---
        if (App.data.role === 'siswa') {
            if (viewId === 'dashboard') {
                document.getElementById('view-jadwal-siswa').classList.remove('hidden');
                App.Siswa.loadDashboard();
                if(pageTitle) pageTitle.innerText = "Jadwal Ujian Kelas Anda";
                return; 
            }
            if (viewId === 'hasil-siswa') {
                document.getElementById('view-hasil-siswa').classList.remove('hidden');
                App.Siswa.loadHasil();
                return;
            }
        }

        // --- LOGIC PENGAWAS ---
        if (App.data.role === 'pengawas') {
            if (viewId === 'dashboard') {
                document.getElementById('view-ujian').classList.remove('hidden'); 
                App.Pengawas.loadJadwalGlobal();
                return;
            }
            if (viewId === 'pengawas-token') {
                document.getElementById('view-pengawas-token').classList.remove('hidden');
                App.Pengawas.loadPageToken();
                return;
            }
            if (viewId === 'pengawas-monitor') {
                document.getElementById('view-pengawas-monitor').classList.remove('hidden');
                App.Pengawas.loadPageMonitoring();
                return;
            }
            if (viewId === 'pengawas-pelanggaran') {
                document.getElementById('view-pengawas-pelanggaran').classList.remove('hidden');
                App.Pengawas.loadPagePelanggaran();
                return;
            }
            if (viewId === 'pengawas-kehadiran') {
                const el = document.getElementById('view-pengawas-kehadiran');
                if(el) {
                    el.classList.remove('hidden');
                    if(App.Pengawas.loadPageKehadiran) App.Pengawas.loadPageKehadiran();
                }
                return;
            }
        }

        // --- DEFAULT VIEWS (ADMIN/GURU) ---
        if (viewId === 'hasil') {
            document.getElementById('view-hasil-ujian').classList.remove('hidden');
            App.GuruHasil.load(); 
        }
        else if (viewId === 'bank-soal') {
            document.getElementById('view-bank-soal').classList.remove('hidden');
            App.BankSoal.loadOptionsMapel();
        }
        else if (viewId === 'admin-monitoring') {
             document.getElementById('view-admin-monitoring').classList.remove('hidden');
             App.AdminMonitor.loadSummary();
        }
        else if (viewId === 'admin-hasil') {
             document.getElementById('view-admin-hasil').classList.remove('hidden');
             App.AdminHasil.load();
        }
        else if (viewId === 'dashboard') { 
            document.getElementById('view-dashboard').classList.remove('hidden'); 
            App.Dashboard.loadStats(); 
        }
        else if (viewId === 'akun') { 
            document.getElementById('view-akun').classList.remove('hidden'); 
            App.User.loadAll(); 
        }
        else if (viewId === 'mapel') { 
            document.getElementById('view-mapel').classList.remove('hidden'); 
            App.Mapel.load(); 
        }
        else if (viewId === 'ujian') { 
            document.getElementById('view-ujian').classList.remove('hidden'); 
            App.Ujian.loadJenis(); 
            App.Ujian.loadJadwal(); 
        }
        else {
            const ph = document.getElementById('view-placeholder');
            if(ph) ph.classList.remove('hidden');
        }
      },

      toggleSidebar: function(forceState) {
        const sidebar = document.getElementById('sidebar-panel');
        const backdrop = document.getElementById('sidebar-backdrop');
        if(!sidebar || !backdrop) return;
        
        const isClosed = sidebar.classList.contains('-translate-x-full');
        const shouldOpen = forceState !== undefined ? forceState : isClosed;
        if (shouldOpen) { sidebar.classList.remove('-translate-x-full'); backdrop.classList.remove('hidden'); } 
        else { sidebar.classList.add('-translate-x-full'); backdrop.classList.add('hidden'); }
      },

      zoomImg: function(el) { 
        // Versi Terbaru (HD & Close Button)
        Swal.fire({ 
            imageUrl: el.src, 
            width: 'auto', padding: '1em', background: 'transparent', backdrop: 'rgba(0,0,0, 0.9)',
            showCloseButton: true, showConfirmButton: true, confirmButtonText: '<i class="fas fa-times"></i> Tutup Gambar', confirmButtonColor: '#d33',
            customClass: { image: 'max-h-[75vh] object-contain rounded-lg shadow-2xl bg-white', closeButton: 'text-white text-xl focus:outline-none hover:text-red-500' }
        }); 
      },

      openModal: function(id) { const el=document.getElementById(id); if(el) el.classList.remove('hidden'); },
      closeModal: function(id) { const el=document.getElementById(id); if(el) el.classList.add('hidden'); },

      // FUNGSI UTAMA YANG SEBELUMNYA ERROR
      showLoginOnly: function() {
        // Hide All Screens
        const dash = document.getElementById('dashboard-container');
        const pageSiswa = document.getElementById('page-siswa');
        const lock = document.getElementById('lock-screen');
        const att = document.getElementById('page-attendance');
        const login = document.getElementById('login-container');

        if(dash) dash.classList.add('hidden');
        if(pageSiswa) pageSiswa.classList.add('hidden');
        if(lock) lock.classList.add('hidden');
        if(att) att.classList.add('hidden');
        
        // Show Login
        if(login) {
            login.classList.remove('hidden');
            login.classList.add('flex');
        }
      }
    },

    // --- Module Baru: Detail Nilai ---
    Nilai: {
        showDetail: function(idJadwal, username) {
            App.UI.openModal('modal-kalkulasi');
            const tbody = document.getElementById('tbody-kalkulasi');
            tbody.innerHTML = '<tr><td colspan="4" class="p-6 text-center"><i class="fas fa-spinner fa-spin text-indigo-500"></i> Menghitung...</td></tr>';
            
            // Reset Angka
            document.getElementById('calc-tot-bobot').innerText = "-";
            document.getElementById('calc-tot-skor').innerText = "-";
            document.getElementById('rumus-skor').innerText = "-";
            document.getElementById('rumus-bobot').innerText = "-";
            document.getElementById('rumus-hasil').innerText = "-";

            google.script.run.withSuccessHandler(res => {
                if(res.status === 'error') {
                    tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-red-500">${res.message}</td></tr>`;
                    return;
                }

                const d = res.data;
                document.getElementById('calc-subtitle').innerText = `Siswa: ${d.nama} | Mapel: ${d.mapel}`;
                tbody.innerHTML = '';

                d.details.forEach(item => {
                    // Warna skor: Hijau jika full, Kuning jika sebagian, Merah jika 0
                    let color = 'text-red-600';
                    if (item.skor === item.bobot) color = 'text-green-600';
                    else if (item.skor > 0) color = 'text-yellow-600';

                    tbody.insertAdjacentHTML('beforeend', `
                        <tr class="border-b hover:bg-slate-50">
                            <td class="p-3 text-center text-gray-500 text-xs font-mono">${item.no}</td>
                            <td class="p-3">
                                <span class="bg-gray-100 text-gray-600 px-2 py-0.5 rounded text-[10px] font-bold uppercase border">${item.tipe}</span>
                            </td>
                            <td class="p-3 text-right font-mono font-medium text-gray-500">${item.bobot}</td>
                            <td class="p-3 text-right font-mono font-bold ${color}">${item.skor}</td>
                        </tr>
                    `);
                });

                // Update Footer & Rumus
                document.getElementById('calc-tot-bobot').innerText = d.totalBobot;
                document.getElementById('calc-tot-skor').innerText = d.totalSkor;
                
                document.getElementById('rumus-skor').innerText = d.totalSkor;
                document.getElementById('rumus-bobot').innerText = d.totalBobot;
                document.getElementById('rumus-hasil').innerText = d.nilaiAkhir || "0";

            }).getDetailPerhitungan(idJadwal, username);
        }
    },

    // --- Module 8: Security (REFINED) ---
    Security: {
      wakeLockSentinel: null,
      isReloading: false, // Flag untuk mendeteksi reload

      // 1. Fungsi Menjaga Layar Tetap Hidup
      enableWakeLock: async function() {
         if ('wakeLock' in navigator) {
             try {
                 App.Security.wakeLockSentinel = await navigator.wakeLock.request('screen');
                 // Re-acquire lock jika terlepas (misal karena switch app sebentar)
                 App.Security.wakeLockSentinel.addEventListener('release', () => {
                     // console.log('Screen Wake Lock: RELEASED');
                 });
             } catch (err) {
                 console.error(`Wake Lock Error: ${err.name}, ${err.message}`);
             }
         }
      },

      // 2. Fungsi Restore (Panggil saat visible kembali)
      restoreWakeLock: async function() {
         if (App.Security.wakeLockSentinel !== null && document.visibilityState === 'visible') {
             await App.Security.enableWakeLock();
         }
      },

      enterFullscreen: function() { 
          try {
              if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen().catch(()=>{});
              }
          } catch(e) {}
      },
      
      // 3. Logic Pelanggaran (Cerdas)
      checkViolation: function(reason) {
         // A. Jangan kunci jika ujian belum mulai / sudah selesai
         if(!App.data.examRunning) return;

         // B. Jangan kunci jika sedang proses Reload Halaman
         if(App.Security.isReloading) return;

         // C. Jangan kunci jika Internet Mati (Offline)
         if(!navigator.onLine) {
             // Opsional: Tampilkan Toast peringatan internet, tapi jangan kunci
             Swal.fire({
                 toast: true, position: 'bottom', icon: 'warning', 
                 title: 'Koneksi Terputus. Jangan tutup halaman!', 
                 showConfirmButton: false, timer: 3000
             });
             return;
         }

         // D. Jika Lolos Filter di atas, barulah KUNCI
         App.Security.triggerLock(reason);
      },

      triggerLock: function(msg) { 
         // Double check status ujian
         if(!App.data.examRunning && msg !== "Status Terkunci. Masukkan Token.") return;

         document.getElementById('lock-screen').classList.remove('hidden'); 
         document.getElementById('lock-reason').innerText = msg; 
         
         const username = App.data.user ? App.data.user.username : JSON.parse(sessionStorage.getItem('cbt_session')).data.username;
         const idJadwal = App.data.activeJadwalId;

         if (idJadwal) {
             google.script.run.setSiswaViolation(username, idJadwal, msg);
         }
      },
      
      unlock: function() {
         const t = document.getElementById('token-unlock').value;
         const btn = document.getElementById('btnUnlock');
         
         const sess = JSON.parse(sessionStorage.getItem('cbt_session'));
         const username = App.data.user ? App.data.user.username : (sess ? sess.data.username : '');
         const idJadwal = App.data.activeJadwalId;

         if(!username) { Swal.fire('Error', 'Sesi invalid. Silakan login ulang.', 'error'); return; }

         App.UI.setLoading(btn, true, 'Memeriksa...');

         google.script.run.withSuccessHandler(r => {
            App.UI.setLoading(btn, false, 'BUKA KUNCI');
            
            if(r.status === 'success') { 
                google.script.run.withSuccessHandler(() => {
                    document.getElementById('lock-screen').classList.add('hidden'); 
                    document.getElementById('token-unlock').value = "";
                    
                    // Aktifkan kembali pengaman
                    App.Security.enterFullscreen();
                    App.Security.enableWakeLock();

                }).unlockSiswa(username, idJadwal);

            } else {
                Swal.fire('Token Salah', 'Minta token baru ke Pengawas.', 'error');
            }
         }).verifikasiTokenUnlock(t, username); 
      },

      // 4. Anti Copy Paste (Event Handler) - UPDATED
      preventCopyPaste: function() {
          // Helper: Cek apakah sedang di halaman ujian siswa (Halaman Ujian AKTIF)
          const isExamMode = () => {
              const pageSiswa = document.getElementById('page-siswa');
              // Blokir hanya jika elemen page-siswa ada dan TIDAK memiliki class 'hidden'
              return pageSiswa && !pageSiswa.classList.contains('hidden');
          };

          // Blokir Klik Kanan (Hanya saat ujian)
          document.addEventListener('contextmenu', event => {
              if (isExamMode()) {
                  event.preventDefault();
              }
          });
          
          // Blokir Tombol Keyboard (Ctrl+C, V, U, F12, PrintScreen) - Hanya saat ujian
          document.addEventListener('keydown', function(e) {
              // Jika TIDAK sedang ujian, biarkan fungsi normal (agar guru bisa edit/paste)
              if (!isExamMode()) return;

              if (
                  (e.ctrlKey && (e.key === 'c' || e.key === 'v' || e.key === 'u' || e.key === 'p')) || 
                  e.key === 'F12' || 
                  e.key === 'PrintScreen'
              ) {
                  e.preventDefault();
                  e.stopPropagation();
                  return false;
              }
          });

          // Blokir Event Copy/Cut/Paste/Drag/Drop di level DOM - Hanya saat ujian
          ['copy', 'cut', 'paste', 'dragstart', 'drop'].forEach(evt => {
              document.addEventListener(evt, e => {
                  if (isExamMode()) {
                      e.preventDefault();
                      return false;
                  }
              });
          });
      }
    },

    Util: {
      // [BARU] Fungsi untuk mematikan semua timer yang mungkin berjalan
      stopAllTimers: function() {
         if (App.data.timer) { clearInterval(App.data.timer); App.data.timer = null; }
         if (App.data.saveTimeout) { clearTimeout(App.data.saveTimeout); App.data.saveTimeout = null; }
         if (App.Siswa && App.Siswa.dashboardTimer) { clearInterval(App.Siswa.dashboardTimer); App.Siswa.dashboardTimer = null; }
         if (App.Attendance && App.Attendance.timerInterval) { clearInterval(App.Attendance.timerInterval); App.Attendance.timerInterval = null; }
         // Matikan WakeLock jika aktif
         if (App.Security && App.Security.wakeLockSentinel) {
             try { App.Security.wakeLockSentinel.release(); } catch(e){}
             App.Security.wakeLockSentinel = null;
         }
      },

      resetGlobals: function() {
        // 1. Reset Variabel Data Utama
        App.data = {
          role: '', user: null, scriptUrl: App.data.scriptUrl, // Keep URL
          soalList: [], userList: [], mapelList: [], jenisUjianList: [], jadwalList: [],
          jawabanSiswa: {}, raguSiswa: {},
          opsiImages: { A:null, B:null, C:null, D:null, E:null },
          examRunning: false, timer: null, timeLeft: 0, currentSoalIdx: 0, 
          quill: null, saveTimeout: null, activeJadwalId: null
        };

        // 2. Kosongkan Semua Container HTML (Pembersihan Tampilan)
        const idsToClear = [
            'sidebar-menu',       // Menu Sidebar
            'tbody-users',        // Tabel User
            'tbody-mapel',        // Tabel Mapel
            'tbody-soal',         // Tabel Bank Soal
            'tbody-jenis-ujian',  // Tabel Jenis Ujian
            'tbody-jadwal',       // Tabel Jadwal Admin/Pengawas
            'list-ujian-siswa',   // Card Dashboard Siswa
            'tbody-hasil-siswa',  // Tabel Nilai Siswa
            'tbody-hasil-guru',   // Tabel Nilai Guru
            'tbody-hasil-admin',  // Tabel Nilai Admin
            'tbody-mon-pgw',      // Tabel Monitoring Pengawas
            'tbody-pel-pgw',      // Tabel Pelanggaran
            'tbody-hadir-pgw',    // Tabel Kehadiran
            'adm-list-exams',     // List Monitoring Admin
            'tbody-adm-monitoring'// Tabel Monitoring Admin
        ];

        idsToClear.forEach(id => {
            const el = document.getElementById(id);
            if(el) el.innerHTML = '';
        });

        // 3. Reset Info Dashboard Header
        const dashNama = document.getElementById('dash-nama');
        const dashRole = document.getElementById('dash-role');
        const dashInit = document.getElementById('dash-initial');
        
        if(dashNama) dashNama.innerText = "User";
        if(dashRole) dashRole.innerText = "Role";
        if(dashInit) dashInit.innerText = "?";

        // 4. Reset Editor Quill jika ada
        if (App.data.quill) {
            try { App.data.quill.setContents([]); } catch(e){}
        }

        // 5. Sembunyikan elemen fixed/modal yang mungkin terbuka
        document.querySelectorAll('.fixed.z-50').forEach(el => el.classList.add('hidden'));
        document.getElementById('lock-screen').classList.add('hidden');
      },

      // [UPDATE] Fungsi untuk Memperbaiki Video/Audio Google Drive menjadi Iframe
      fixMediaTags: function(htmlContent) {
         if (!htmlContent) return "";

         // 1. Ubah <video> atau <audio> yang src-nya mengandung '/preview' menjadi <iframe>
         // Regex ini menangkap tag audio/video yang src-nya adalah link preview Google Drive
         
         const regex = /<(?:audio|video)[^>]+src="([^"]+)"[^>]*>.*?<\/(?:audio|video)>/g;
         
         htmlContent = htmlContent.replace(regex, function(match, url) {
             // Bersihkan URL dari encode HTML entity jika ada (misal &amp;)
             url = url.replace(/&amp;/g, '&');

             if (url.includes('drive.google.com') && url.includes('/preview')) {
                 // Player Audio/Video Drive via Iframe
                 // Height 54px cukup untuk player audio saja, 56.25% padding-top untuk video aspect ratio
                 
                 const isAudio = url.includes('#audio_preview');
                 
                 if (isAudio) {
                    // Tampilan Player Audio Minimalis
                    return `
                     <div class="w-full max-w-md mt-2 mb-2 mx-auto bg-gray-100 rounded-full border border-gray-300 overflow-hidden shadow-sm flex items-center justify-center relative" style="height: 54px;">
                        <iframe src="${url}" 
                                style="width: 100%; height: 100%; border: none;" 
                                frameborder="0"
                                scrolling="no" 
                                allow="autoplay"
                                sandbox="allow-scripts allow-same-origin allow-popups allow-forms">
                        </iframe>
                     </div>`;
                 } else {
                    // Tampilan Video Responsif
                    return `
                     <div class="w-full max-w-lg mt-3 mb-3 mx-auto">
                        <div class="relative w-full overflow-hidden rounded-xl shadow-lg border border-gray-200 bg-black" style="padding-top: 56.25%;">
                            <iframe src="${url}" 
                                    class="absolute top-0 left-0 w-full h-full" 
                                    frameborder="0" 
                                    allow="autoplay; fullscreen" 
                                    sandbox="allow-scripts allow-same-origin allow-popups allow-forms">
                            </iframe>
                        </div>
                     </div>`;
                 }
             }
             return match;
         });

         return htmlContent;
      },

      // Helper Render Media untuk Opsi Jawaban (Updated)
      renderMediaHtml: function(urlRaw, styleClass = "") {
        if (!urlRaw) return "";
        
        let url = urlRaw.split('#')[0]; 
        
        // Deteksi apakah ini Audio (dari tanda #audio_preview atau format file)
        const isAudioTag = urlRaw.includes('#audio_preview') || urlRaw.toLowerCase().endsWith('.mp3');
        const isDrivePreview = urlRaw.includes('drive.google.com') && urlRaw.includes('/preview');
        
        if (isAudioTag || (isDrivePreview && !urlRaw.includes('image'))) {
            // Jika link adalah Preview Drive, gunakan Iframe
            if (isDrivePreview) {
                 return `
                  <div class="w-full mt-2 mb-2 h-[54px] bg-gray-50 rounded border border-gray-200 overflow-hidden">
                      <iframe src="${urlRaw}" class="w-full h-full border-none" scrolling="no" frameborder="0"></iframe>
                  </div>`;
            } 
            // Jika link download langsung (Legacy/Lama), coba pakai Audio Tag
            else {
                return `
                  <div class="w-full mt-2 mb-2 p-1 bg-gray-50 rounded border border-gray-200">
                      <audio controls preload="metadata" class="w-full h-10">
                        <source src="${url}" type="audio/mpeg">
                        Browser tidak support audio.
                      </audio>
                  </div>`;
            }
        } 
        // Render Gambar
        else {
            return `<img src="${url}" class="${styleClass} rounded-lg shadow-sm border border-gray-200 cursor-zoom-in hover:opacity-95 transition" onclick="App.UI.zoomImg(this)" onerror="this.style.display='none';">`;
        }
      }
    }
  };

  // --- [TAMBAHAN] REGISTER CUSTOM BLOTS UNTUK AUDIO & VIDEO ---
  // Letakkan kode ini DI LUAR object App, di bagian atas script

  // Cek apakah Quill sudah dimuat
  if (typeof Quill !== 'undefined') {
    const BlockEmbed = Quill.import('blots/block/embed');

    class AudioBlot extends BlockEmbed {
      static create(value) {
        let node = super.create();
        node.setAttribute('src', value);
        node.setAttribute('controls', '');
        // Style agar bar panjang
        node.setAttribute('style', 'width: 100%; height: 40px; margin: 10px 0; display: block;');
        node.setAttribute('preload', 'auto');
        return node;
      }
      static value(node) { return node.getAttribute('src'); }
    }
    AudioBlot.blotName = 'audio';
    AudioBlot.tagName = 'audio';

    Quill.register(AudioBlot);
    // VideoBlot DIHAPUS
  }

  // ===========================================
  // INITIALIZATION & EVENT LISTENERS
  // ===========================================
  document.getElementById('current-date').innerText = new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
  
  // 1. Deteksi Pindah Tab / Minimize (Visibility Change)
  // Ini adalah deteksi utama untuk "Berpindah Tab" atau "Tutup Aplikasi"
  document.addEventListener("visibilitychange", () => { 
      if(document.hidden) {
          // Cek pelanggaran dengan logika cerdas (cek internet/reload)
          App.Security.checkViolation("Keluar Aplikasi / Pindah Tab");
      } else {
          // Saat kembali, restore Wake Lock agar layar tidak mati lagi
          App.Security.restoreWakeLock();
      }
  });

  // 2. Deteksi Reload (Before Unload)
  // Set flag isReloading agar saat halaman tertutup tidak dianggap pelanggaran
  window.addEventListener("beforeunload", () => {
      App.Security.isReloading = true;
  });

  // 3. Deteksi Blur (Window Focus Lost) - HANYA MONITORING, TIDAK LOCK
  // Kita hapus trigger lock pada 'blur' karena terlalu sensitif (misal: tarik notifikasi bar)
  // window.addEventListener("blur", () => { ... }); // DIHAPUS agar HP tidak terkunci saat layar mati/notif

  // 4. Deteksi Offline/Online (Monitoring Koneksi)
  window.addEventListener('offline', () => {
       Swal.fire({
           toast: true, position: 'bottom', icon: 'error', 
           title: 'Tidak ada internet! Jawaban mungkin tidak tersimpan.', 
           showConfirmButton: false, timer: 5000
       });
       // Kita TIDAK memanggil triggerLock disini, sesuai request.
  });

  window.addEventListener('online', () => {
       Swal.fire({
           toast: true, position: 'bottom', icon: 'success', 
           title: 'Internet Terhubung Kembali.', 
           showConfirmButton: false, timer: 3000
       });
  });

  // 5. Inisialisasi Anti Copy Paste
  App.Security.preventCopyPaste();

  // 6. Session Timeout
  let activityTimer;
  // Reset timer aktivitas pada event user
  ['click', 'mousemove', 'keypress', 'scroll', 'touchstart'].forEach(evt => 
      document.addEventListener(evt, () => sessionStorage.setItem('last_activity', Date.now()), false)
  );

  setInterval(() => {
     const lastAct = sessionStorage.getItem('last_activity');
     // Cek jika last activity ada DAN sudah lewat 60 menit (60 * 60 * 1000)
     if (lastAct && (Date.now() - parseInt(lastAct) > 60 * 60 * 1000)) { 
        
        // Hapus session storage dulu agar tidak loop alert
        sessionStorage.removeItem('last_activity'); 
        sessionStorage.removeItem('cbt_session');

        Swal.fire({
            title: 'Sesi Habis', 
            text: 'Anda tidak aktif terlalu lama. Silakan login kembali.', 
            icon: 'warning', 
            confirmButtonText: 'OK',
            allowOutsideClick: false
        }).then(() => { 
            // Panggil fungsi Force Logout yang sudah diperbarui (termasuk Reload)
            App.Auth.forceLogout(); 
        });
     }
  }, 60 * 1000); // Cek setiap 1 menit

  window.addEventListener('load', () => {
      App.Auth.checkSession();
      google.script.run.withSuccessHandler(url => { App.data.scriptUrl = url; }).getScriptUrl();
  });
</script>
