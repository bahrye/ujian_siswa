// ==========================================
// KONFIGURASI
// ==========================================
const SS_ID = '1L2NpLGZlnVA_gRvEshCQoXeCaYlsPXXEsBdAfkqXOSg'; 

// ==========================================
// 0. SETUP AWAL (Jalankan sekali manual untuk Izin)
// ==========================================
function setupIzinAwal() {
  const ss = SpreadsheetApp.openById(SS_ID);
  console.log("Akses DB OK: " + ss.getName());
  
  const folderName = "CBT_Assets";
  const folders = DriveApp.getFoldersByName(folderName);
  if (folders.hasNext()) {
    console.log("Folder Drive OK.");
  } else {
    DriveApp.createFolder(folderName);
    console.log("Folder Drive Dibuat.");
  }
}

// ==========================================
// ROUTING & HTML
// ==========================================
function doGet(e) {
  return HtmlService.createTemplateFromFile('index')
      .evaluate()
      .setTitle('CBT Ujian Online')
      .addMetaTag('viewport', 'width=device-width, initial-scale=1')
      .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

// ==========================================
// HELPER: INCLUDE FILE HTML LAIN
// ==========================================
function include(filename) {
  return HtmlService.createHtmlOutputFromFile(filename)
      .getContent();
}

// ==========================================
// API 1: LOGIN (Update Logic Role)
// ==========================================
function loginUser(username, password) {
  try {
    const ss = SpreadsheetApp.openById(SS_ID);
    const sheet = ss.getSheetByName("Users");
    if (!sheet) return { status: 'error', message: 'DB Users tidak ditemukan!' };

    const data = sheet.getDataRange().getValues();
    data.shift(); // Skip Header

    for (let i = 0; i < data.length; i++) {
      let row = data[i];
      // [0:id, 1:username, 2:password, 3:role, 4:nama, 5:kelas, 6:status]
      if (row[1] == username && row[2] == password) {
        if(row[6] && row[6].toString().toLowerCase() !== 'aktif') {
          return { status: 'error', message: 'Akun dinonaktifkan.' };
        }
        
        // Normalisasi role ke lowercase agar konsisten
        const role = row[3].toString().toLowerCase();
        
        return { 
          status: 'success', 
          role: role, 
          nama: row[4], 
          kelas: row[5],
          username: row[1] // <--- PENTING: TAMBAHKAN INI
        };
      }
    }
    return { status: 'error', message: 'Username/Password salah.' };
  } catch (e) {
    return { status: 'error', message: 'Server Error: ' + e.toString() };
  }
}

// ==========================================
// API BARU: DASHBOARD STATS
// ==========================================
function getDashboardStats() {
  const ss = SpreadsheetApp.openById(SS_ID);
  
  // Hitung User
  const sheetUser = ss.getSheetByName("Users");
  const users = sheetUser ? sheetUser.getLastRow() - 1 : 0;
  
  // Hitung Soal
  const sheetSoal = ss.getSheetByName("DB_Soal");
  const soals = sheetSoal ? sheetSoal.getLastRow() - 1 : 0;
  
  // Hitung Ujian Masuk
  const sheetNilai = ss.getSheetByName("DB_Nilai");
  const nilais = sheetNilai ? sheetNilai.getLastRow() - 1 : 0;

  return { users, soals, nilais };
}

// ==========================================
// API 2: ADMIN - SIMPAN SOAL (UPDATE: BOBOT)
// ==========================================
function simpanSoal(data) {
  try {
    const ss = SpreadsheetApp.openById(SS_ID);
    const sheet = ss.getSheetByName("DB_Soal");
    
    // Proses Gambar HTML & Opsi (Sama seperti sebelumnya)
    let processedSoal = processHtmlImages(data.soal);
    let opsis = {};
    try { opsis = JSON.parse(data.opsiJson); } catch(e) {}
    // Proses Opsi (Gambar / Audio / Video)
    for (let key in opsis) {
      // Mendeteksi awalan 'img_' (legacy) atau 'media_' (baru)
      if ((key.startsWith('img_') || key.startsWith('media_')) && opsis[key] && opsis[key].toString().includes('base64,')) {
        // saveBase64ToDrive sudah otomatis mendeteksi mime-type (image/audio/video) dari header base64
        opsis[key] = saveBase64ToDrive(opsis[key], "MEDIA-" + key);
      }
    }
    const processedOpsi = JSON.stringify(opsis);

    // Default Bobot jika kosong = 1 (atau biarkan kosong jika murni opsional visual)
    // Disini kita simpan apa adanya, tapi pastikan numerik jika diisi
    const bobot = data.bobot ? data.bobot : ""; 

    const idSoal = data.id ? data.id : "Q-" + Date.now();
    
    // Mode EDIT
    if (data.id) {
       const allData = sheet.getDataRange().getValues();
       for (let i = 1; i < allData.length; i++) {
         if (allData[i][0].toString() === data.id.toString()) {
            // Update Row [ID, Mapel, Tipe, Soal, Img(Legacy), Opsi, Kunci, Bobot]
            // Perhatikan: getRange kolomnya sekarang 8
            sheet.getRange(i + 1, 1, 1, 8).setValues([[
               data.id, data.mapel, data.tipe, 
               processedSoal, 
               "", 
               processedOpsi, 
               data.kunci,
               bobot // <--- KOLOM BARU (Index 7)
            ]]);
            return { status: 'success', message: 'Soal & Bobot Diupdate!' };
         }
       }
       return { status: 'error', message: 'ID Soal tidak ditemukan saat update.' };
    } 

    // Mode TAMBAH BARU
    sheet.appendRow([
      idSoal, 
      data.mapel, 
      data.tipe, 
      processedSoal, 
      "", 
      processedOpsi, 
      data.kunci,
      bobot // <--- KOLOM BARU
    ]);

    return { status: 'success', message: 'Soal Tersimpan!' };

  } catch (e) {
    return { status: 'error', message: 'Server Error: ' + e.toString() };
  }
}

// --- FUNGSI BANTUAN (HELPER) ---

function saveBase64ToDrive(base64Str, namePrefix) {
  try {
    const folderName = "CBT_Assets";
    const folders = DriveApp.getFoldersByName(folderName);
    let folder = folders.hasNext() ? folders.next() : DriveApp.createFolder(folderName);
    
    // Deteksi MIME Type
    const mimeType = base64Str.substring(5, base64Str.indexOf(';'));
    
    // VALIDASI: HANYA GAMBAR
    if (!mimeType.includes("image")) {
      return base64Str; // Kembalikan string asli jika bukan gambar (abaikan upload)
    }

    const cleanBase64 = base64Str.substring(base64Str.indexOf(',') + 1);
    const decoded = Utilities.base64Decode(cleanBase64);
    
    // Extensi default jpg, jika png sesuaikan (tapi jpg aman untuk umum)
    let ext = ".jpg"; 
    if(mimeType.includes("png")) ext = ".png";
    
    const fileName = namePrefix + "_" + Date.now() + ext;
    const blob = Utilities.newBlob(decoded, mimeType, fileName);
    
    const file = folder.createFile(blob);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    
    const fileId = file.getId();

    // OUTPUT URL GAMBAR
    return "https://lh3.googleusercontent.com/d/" + fileId;
    
  } catch(e) {
    return base64Str; 
  }
}

function processHtmlImages(htmlContent) {
  if (!htmlContent) return "";
  
  // HAPUS 'audio' dari regex, HANYA PROSES IMAGE
  const regex = /src="(data:image\/[a-zA-Z0-9.-]+;base64,[^"]+)"/g;
  
  return htmlContent.replace(regex, function(match, fullBase64) {
    let prefix = "SOAL-IMG";
    const newUrl = saveBase64ToDrive(fullBase64, prefix);
    return 'src="' + newUrl + '"';
  });
}

// ==========================================
// API 2: ADMIN - UPDATE BANK SOAL
// ==========================================

// A. AMBIL DATA SOAL (UPDATE: AMBIL BOBOT)
function getSoalAdmin(filterMapel) {
  const ss = SpreadsheetApp.openById(SS_ID);
  const sheet = ss.getSheetByName("DB_Soal");
  if (!sheet) return [];
  
  const data = sheet.getDataRange().getValues();
  data.shift(); // Skip Header
  
  // [0:id, 1:mapel, 2:tipe, 3:soal, 4:img, 5:opsi, 6:kunci, 7:bobot]
  let result = [];
  
  for (let i = data.length - 1; i >= 0; i--) {
    let row = data[i];
    if (!filterMapel || (row[1] && row[1].toString() === filterMapel)) {
      result.push({
        id: row[0],
        mapel: row[1],
        tipe: row[2],
        soal: row[3],
        opsi: row[5],
        kunci: row[6],
        bobot: row[7] || "" // <--- AMBIL BOBOT
      });
    }
  }
  return result;
}

// B. HAPUS SOAL
function hapusSoalDb(idSoal) {
  const ss = SpreadsheetApp.openById(SS_ID);
  const sheet = ss.getSheetByName("DB_Soal");
  const data = sheet.getDataRange().getValues();
  
  for (let i = 1; i < data.length; i++) {
    if (data[i][0].toString() === idSoal.toString()) {
      sheet.deleteRow(i + 1);
      return { status: 'success', message: 'Soal berhasil dihapus.' };
    }
  }
  return { status: 'error', message: 'ID Soal tidak ditemukan.' };
}

// ==========================================
// API 3: SISWA - AMBIL SOAL (DIPERBAIKI)
// ==========================================
function getSoalUjian(kodeMapel) {
  try {
    const ss = SpreadsheetApp.openById(SS_ID);
    const sheet = ss.getSheetByName("DB_Soal");
    
    // Validasi jika sheet tidak ada
    if (!sheet) {
      return { status: 'error', message: 'Database Soal (DB_Soal) tidak ditemukan!' };
    }

    const data = sheet.getDataRange().getValues();
    data.shift(); // Hapus Header

    let soalList = [];
    
    // Normalisasi input mapel (hilangkan spasi, jadikan huruf kecil)
    const targetMapel = kodeMapel ? kodeMapel.toString().trim().toLowerCase() : "";

    for (let i = 0; i < data.length; i++) {
      let row = data[i];
      
      // Ambil kode mapel dari Database dan normalisasi
      let dbMapel = row[1] ? row[1].toString().trim().toLowerCase() : "";

      // Cek Kesamaan Kode Mapel
      if (dbMapel === targetMapel) {
        
        // Parse JSON Opsi dengan aman
        let opsiObj = {};
        try { 
          opsiObj = JSON.parse(row[5]); 
        } catch (e) {
          // Jika opsi bukan JSON valid, biarkan kosong atau handle manual
          console.log("Error parsing opsi soal ID: " + row[0]);
        }

        soalList.push({
          id: row[0],
          tipe: row[2],
          pertanyaan: row[3],
          gambar: row[4],
          opsi: opsiObj 
          // PENTING: Kunci jawaban (row[6]) TIDAK dikirim ke frontend
        });
      }
    }

    // Jika tidak ada soal yang cocok
    if (soalList.length === 0) {
      return { status: 'error', message: 'Soal tidak ditemukan untuk Mapel: ' + kodeMapel + '. Pastikan Kode Mapel di "Bank Soal" sama persis dengan di "Jadwal Ujian".' };
    }

    return { status: 'success', data: soalList };

  } catch (e) {
    return { status: 'error', message: 'Server Error: ' + e.toString() };
  }
}

// ==========================================
// TAMBAHKAN FUNGSI INI DI PALING BAWAH ATAU ATAS (Agar reload jalan)
// ==========================================
function getScriptUrl() {
  return ScriptApp.getService().getUrl();
}

// ==========================================
// [UPDATE] API 4: SUBMIT UJIAN (Auto Grade PG, BS & COCOK)
// ==========================================
function submitUjian(payload) {
  try {
    const ss = SpreadsheetApp.openById(SS_ID);
    
    // 1. Ambil Soal & Kunci Jawaban
    const sheetSoal = ss.getSheetByName("DB_Soal");
    const dataSoal = sheetSoal.getDataRange().getValues();
    dataSoal.shift(); 
    
    let mapSoal = {};
    let totalBobotUjian = 0; // Total skor maksimal seluruh ujian
    let skorPerolehan = 0;   // Skor yang didapat siswa
    
    // Filter soal berdasarkan Mapel
    for (let i = 0; i < dataSoal.length; i++) {
      let row = dataSoal[i]; 
      // row[1] = Mapel, row[2] = Tipe, row[5] = Opsi(JSON), row[6] = Kunci, row[7] = Bobot
      
      if (row[1].toString().toLowerCase() === payload.mapel.toLowerCase()) {
        const idSoal = row[0];
        const tipe = row[2];
        const opsiRaw = row[5];
        const kunci = row[6];
        let bobotSoal = (row[7] && !isNaN(row[7])) ? parseFloat(row[7]) : 1;

        // PARSING OPSI UNTUK COCOK
        let opsiObj = {};
        try { opsiObj = JSON.parse(opsiRaw); } catch(e){}

        if (tipe === "PG" || tipe === "BS") {
           totalBobotUjian += bobotSoal;
           mapSoal[idSoal] = { tipe: tipe, kunci: kunci, bobot: bobotSoal };
        } 
        else if (tipe === "COCOK") {
           // Untuk COCOK, bobot total adalah jumlah bobot semua pasangan
           let maxScoreCocok = 0;
           if(Array.isArray(opsiObj)) {
              opsiObj.forEach(pair => {
                 // pair.s adalah score/bobot per pasang
                 let w = (pair.s && !isNaN(pair.s)) ? parseFloat(pair.s) : 0;
                 maxScoreCocok += w;
              });
           }
           // Jika user lupa isi bobot per pasang, pakai bobot global dibagi rata (fallback)
           if (maxScoreCocok === 0) maxScoreCocok = bobotSoal;

           totalBobotUjian += maxScoreCocok;
           mapSoal[idSoal] = { tipe: tipe, dataPairs: opsiObj, bobotTotal: bobotSoal };
        }
      }
    }

    // 2. Hitung Nilai
    let detailBenar = 0;
    
    for (let idSoal in payload.jawaban) {
      const jwbSiswa = payload.jawaban[idSoal]; // String (PG/BS) atau Object (COCOK)
      const dataS = mapSoal[idSoal];
      
      if (dataS) {
         if (dataS.tipe === "PG" || dataS.tipe === "BS") {
             // Cek Jawaban Biasa
             if (String(jwbSiswa).trim().toUpperCase() === String(dataS.kunci).trim().toUpperCase()) {
                 skorPerolehan += dataS.bobot;
                 detailBenar++;
             }
         } 
         else if (dataS.tipe === "COCOK") {
             // Cek Jawaban Pencocokan (Looping per pasang)
             // jwbSiswa formatnya: { "Kiri1": "Kanan1", "Kiri2": "Kanan2" }
             let pairsConfig = dataS.dataPairs; // Array [{k:'A', v:'B', s:2}, ...]
             
             if(Array.isArray(pairsConfig)) {
                let benarCount = 0;
                pairsConfig.forEach(p => {
                    const kunciKiri = p.k; 
                    const kunciKanan = p.v;
                    const skorItem = (p.s && !isNaN(p.s)) ? parseFloat(p.s) : 0;
                    
                    // Cek apakah siswa menjawab pasangan ini dengan benar
                    // Kita trim dan lowercase agar tidak sensitif spasi/huruf besar kecil
                    if(jwbSiswa[kunciKiri] && 
                       String(jwbSiswa[kunciKiri]).trim().toLowerCase() === String(kunciKanan).trim().toLowerCase()) {
                          skorPerolehan += skorItem;
                          benarCount++;
                    }
                });
                if(benarCount === pairsConfig.length) detailBenar++; // Anggap benar penuh jika semua pasang benar
             }
         }
      }
    }

    // Hitung Skala 0-100
    let nilaiSementara = 0;
    if (totalBobotUjian > 0) {
      nilaiSementara = Math.round((skorPerolehan / totalBobotUjian) * 100);
    }

    // 3. Simpan ke DB_Nilai
    const sheetNilai = ss.getSheetByName("DB_Nilai");
    if (!sheetNilai) return { status: 'error', message: 'Sheet DB_Nilai belum dibuat!' };

    sheetNilai.appendRow([
      new Date(),           
      payload.idJadwal,     
      payload.username,     
      payload.nama,         
      payload.mapel,        
      nilaiSementara,       
      detailBenar + " Soal Full Benar", 
      JSON.stringify(payload.jawaban),
      payload.sisaWaktu || 0, 
      ""                     
    ]);

    // 4. Update Status & Hapus Progress
    if(payload.username && payload.idJadwal) {
        hapusProgressSiswa(payload.username, payload.idJadwal);
        const props = PropertiesService.getScriptProperties();
        props.setProperty(`STATUS_${payload.username}_${payload.idJadwal}`, 'SELESAI');
    }

    return { 
      status: 'success', 
      nilai: nilaiSementara, 
      message: 'Ujian Selesai! Nilai Sementara Anda: ' + nilaiSementara 
    };

  } catch (e) {
    return { status: 'error', message: 'Gagal Submit: ' + e.toString() };
  }
}

// ==========================================
// API 5: VERIFIKASI TOKEN PENGAWAS (FIXED)
// ==========================================
function verifikasiTokenUnlock(tokenInput, username) {
  const props = PropertiesService.getScriptProperties();
  const storedToken = props.getProperty(`UNLOCK_${username}`);
  const MASTER_TOKEN = "ADMIN123"; 
  
  // Pastikan input menjadi string dan hilangkan spasi (trim)
  const inputClean = String(tokenInput).trim();
  const storedClean = storedToken ? String(storedToken).trim() : "";
  
  if (inputClean === storedClean || inputClean === MASTER_TOKEN) {
    // Opsional: Hapus token setelah dipakai agar tidak bisa dipakai ulang (uncomment jika perlu)
    // props.deleteProperty(`UNLOCK_${username}`);
    return { status: 'success' };
  } else {
    return { status: 'error', message: 'Token Salah!' };
  }
}

// ==========================================
// API 6: KELOLA AKUN (CRUD USERS)
// ==========================================

// A. AMBIL SEMUA DATA USER (UPDATE: Cek Status Pengawas di Jadwal)
function getAllUsers() {
  const ss = SpreadsheetApp.openById(SS_ID);
  
  // 1. Cek User yang sedang bertugas di Jadwal AKTIF
  let activePengawas = new Set(); // Menggunakan Set agar pencarian cepat
  
  const sheetJadwal = ss.getSheetByName("DB_Jadwal");
  if (sheetJadwal) {
    const dataJadwal = sheetJadwal.getDataRange().getValues();
    // Loop mulai baris 1 (skip header)
    for (let i = 1; i < dataJadwal.length; i++) {
       const row = dataJadwal[i];
       // row[5] = Status, row[6] = Pengawas
       // Jika Jadwal AKTIF dan Pengawas bukan "semua"
       if (row[5] === 'Aktif' && row[6] && row[6].toString().toLowerCase() !== 'semua') {
          activePengawas.add(row[6].toString());
       }
    }
  }

  // 2. Ambil Data User
  const sheet = ss.getSheetByName("Users");
  if (!sheet) return [];
  
  const data = sheet.getDataRange().getValues();
  data.shift(); // Hapus Header
  
  // Mapping array ke object
  return data.map(row => ({
    id: row[0],
    username: row[1],
    password: row[2],
    role: row[3],
    nama: row[4],
    kelas: row[5],
    status: row[6],
    // Tambahkan flag isUsed: true jika username ada di daftar activePengawas
    isUsed: activePengawas.has(row[1].toString())
  }));
}

// B. TAMBAH / EDIT USER
function simpanUser(data) {
  try {
    const ss = SpreadsheetApp.openById(SS_ID);
    const sheet = ss.getSheetByName("Users");
    
    // Validasi sederhana
    if (!data.username || !data.password || !data.nama) {
      return { status: 'error', message: 'Data tidak lengkap!' };
    }

    // Jika Mode EDIT (ada ID)
    if (data.id) {
      const allData = sheet.getDataRange().getValues();
      // Cari baris berdasarkan ID (Kolom A / Index 0)
      let rowIndex = -1;
      for (let i = 1; i < allData.length; i++) {
        if (allData[i][0].toString() === data.id.toString()) {
          rowIndex = i + 1; // Row di sheet mulai dari 1
          
          // CEK KEAMANAN: Jangan edit jika role target adalah ADMIN (kecuali via sheet)
          if (allData[i][3].toString().toLowerCase() === 'admin') {
             return { status: 'error', message: 'Akun ADMIN hanya bisa diedit lewat Spreadsheet!' };
          }
          break;
        }
      }

      if (rowIndex !== -1) {
        // Update Baris
        sheet.getRange(rowIndex, 2, 1, 6).setValues([[
          data.username, data.password, data.role, data.nama, data.kelas || '-', data.status
        ]]);
        return { status: 'success', message: 'User berhasil diperbarui!' };
      } else {
        return { status: 'error', message: 'ID User tidak ditemukan.' };
      }

    } else {
      // Mode TAMBAH BARU
      const newId = "U-" + Date.now();
      sheet.appendRow([
        newId, data.username, data.password, data.role, data.nama, data.kelas || '-', 'Aktif'
      ]);
      return { status: 'success', message: 'User baru ditambahkan!' };
    }

  } catch (e) {
    return { status: 'error', message: 'DB Error: ' + e.toString() };
  }
}

// C. HAPUS USER
function hapusUser(id) {
  try {
    const ss = SpreadsheetApp.openById(SS_ID);
    const sheet = ss.getSheetByName("Users");
    const data = sheet.getDataRange().getValues();
    
    for (let i = 1; i < data.length; i++) {
      if (data[i][0].toString() === id.toString()) {
        // CEK KEAMANAN: Jangan hapus ADMIN
        if (data[i][3].toString().toLowerCase() === 'admin') {
           return { status: 'error', message: 'Akun ADMIN tidak boleh dihapus!' };
        }
        
        sheet.deleteRow(i + 1);
        return { status: 'success', message: 'User dihapus.' };
      }
    }
    return { status: 'error', message: 'User tidak ditemukan.' };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

// ==========================================
// API 7: KELOLA MAPEL
// ==========================================

// A. AMBIL DATA MAPEL
function getAllMapel() {
  const ss = SpreadsheetApp.openById(SS_ID);
  let sheet = ss.getSheetByName("DB_Mapel");
  
  // Buat sheet jika belum ada
  if (!sheet) {
    sheet = ss.insertSheet("DB_Mapel");
    sheet.appendRow(["ID", "Kode Mapel", "Nama Mapel", "Guru Pengampu"]); // Header
    return [];
  }
  
  const data = sheet.getDataRange().getValues();
  data.shift(); // Hapus Header
  
  return data.map(row => ({
    id: row[0],
    kode: row[1],
    nama: row[2],
    guru: row[3]
  }));
}

// B. SIMPAN MAPEL (BARU / EDIT)
function simpanMapel(data) {
  try {
    const ss = SpreadsheetApp.openById(SS_ID);
    let sheet = ss.getSheetByName("DB_Mapel");
    if (!sheet) return { status: 'error', message: 'Sheet DB_Mapel tidak ditemukan' };
    
    // Validasi
    if (!data.kode || !data.nama) return { status: 'error', message: 'Kode dan Nama Mapel wajib diisi!' };
    
    // Pastikan Kode Mapel Unik (untuk tambah baru)
    const allData = sheet.getDataRange().getValues();
    if (!data.id) {
       for(let i=1; i<allData.length; i++) {
         if(allData[i][1].toString().toLowerCase() === data.kode.toString().toLowerCase()) {
           return { status: 'error', message: 'Kode Mapel sudah ada!' };
         }
       }
    }

    if (data.id) {
      // EDIT
      let rowIndex = -1;
      for (let i = 1; i < allData.length; i++) {
        if (allData[i][0].toString() === data.id.toString()) {
          rowIndex = i + 1;
          break;
        }
      }
      if (rowIndex !== -1) {
        sheet.getRange(rowIndex, 2, 1, 3).setValues([[ data.kode, data.nama, data.guru ]]);
        return { status: 'success', message: 'Mapel diperbarui!' };
      }
    } else {
      // TAMBAH BARU
      const newId = "M-" + Date.now();
      sheet.appendRow([ newId, data.kode, data.nama, data.guru ]);
      return { status: 'success', message: 'Mapel ditambahkan!' };
    }
    return { status: 'error', message: 'Gagal menyimpan.' };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

// C. HAPUS MAPEL
function hapusMapel(id) {
  try {
    const ss = SpreadsheetApp.openById(SS_ID);
    const sheet = ss.getSheetByName("DB_Mapel");
    const data = sheet.getDataRange().getValues();
    
    for (let i = 1; i < data.length; i++) {
      if (data[i][0].toString() === id.toString()) {
        sheet.deleteRow(i + 1);
        return { status: 'success', message: 'Mapel dihapus.' };
      }
    }
    return { status: 'error', message: 'Mapel tidak ditemukan.' };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

// D. AMBIL LIST GURU (Untuk Dropdown)
function getListGuru() {
  const ss = SpreadsheetApp.openById(SS_ID);
  const sheet = ss.getSheetByName("Users");
  const data = sheet.getDataRange().getValues();
  data.shift();
  
  // Filter hanya role 'guru'
  let gurus = [];
  data.forEach(row => {
    // row[3] adalah Role, row[4] adalah Nama
    if (row[3] && row[3].toString().toLowerCase() === 'guru') {
      gurus.push(row[4]);
    }
  });
  return gurus;
}

// ==========================================
// API 8: KELOLA UJIAN (UPDATE: CEK KETERPAKAIAN)
// ==========================================

function getJenisUjian() {
  const ss = SpreadsheetApp.openById(SS_ID);
  
  // 1. Cek Data Jadwal untuk melihat ID mana yang sedang dipakai
  const sheetJadwal = ss.getSheetByName("DB_Jadwal");
  let usedIds = new Set();
  
  if (sheetJadwal) {
    const dataJadwal = sheetJadwal.getDataRange().getValues();
    // Loop dari baris 1 (skip header)
    // Asumsi: Kolom index 1 adalah 'ID_Jenis' (lihat fungsi getJadwalUjian)
    for (let i = 1; i < dataJadwal.length; i++) {
       if (dataJadwal[i][1]) {
         usedIds.add(dataJadwal[i][1].toString());
       }
    }
  }

  // 2. Ambil Data Jenis Ujian
  let sheet = ss.getSheetByName("DB_JenisUjian");
  if (!sheet) {
    sheet = ss.insertSheet("DB_JenisUjian");
    sheet.appendRow(["ID", "Nama Ujian", "Keterangan", "Status"]); 
    return [];
  }
  
  const data = sheet.getDataRange().getValues();
  data.shift(); // Skip Header
  
  // Map data dan tambahkan flag 'isUsed'
  return data.map(r => ({ 
    id: r[0], 
    nama: r[1], 
    ket: r[2], 
    status: r[3],
    isUsed: usedIds.has(r[0].toString()) // TRUE jika ID ada di jadwal
  }));
}

function simpanJenisUjian(data) {
  const ss = SpreadsheetApp.openById(SS_ID);
  let sheet = ss.getSheetByName("DB_JenisUjian");
  const allData = sheet.getDataRange().getValues();

  if (data.id) { // Edit
    for (let i = 1; i < allData.length; i++) {
      if (allData[i][0].toString() === data.id.toString()) {
        sheet.getRange(i + 1, 2, 1, 3).setValues([[data.nama, data.ket, data.status]]);
        return { status: 'success', message: 'Jenis Ujian diupdate!' };
      }
    }
  } else { // Baru
    const newId = "UJ-" + Date.now();
    sheet.appendRow([newId, data.nama, data.ket, data.status]);
    return { status: 'success', message: 'Jenis Ujian dibuat!' };
  }
  return { status: 'error', message: 'Gagal menyimpan.' };
}

function hapusJenisUjian(id) {
  return hapusDataUmum(id, "DB_JenisUjian");
}

function hapusJadwal(id) {
  return hapusDataUmum(id, "DB_Jadwal");
}

// Helper Hapus Global
function hapusDataUmum(id, sheetName) {
  const ss = SpreadsheetApp.openById(SS_ID);
  const sheet = ss.getSheetByName(sheetName);
  const data = sheet.getDataRange().getValues();
  for (let i = 1; i < data.length; i++) {
    if (data[i][0].toString() === id.toString()) {
      sheet.deleteRow(i + 1);
      return { status: 'success', message: 'Data dihapus.' };
    }
  }
  return { status: 'error', message: 'Data tidak ditemukan.' };
}

// ==========================================
// API BARU: PENGAWAS
// ==========================================

// 3. Generate Token Buka Kunci (Perorangan)
function generateUnlockToken(username) {
  // Token random 4 digit
  const token = Math.floor(1000 + Math.random() * 9000).toString();
  // Simpan di properties sementara (valid 5 menit idealnya, tapi disini kita simpan static)
  const props = PropertiesService.getScriptProperties();
  props.setProperty(`UNLOCK_${username}`, token);
  return token;
}

// Helper: Token Berubah tiap 15 Menit
function generateTimeBasedToken() {
  const secret = "RAHASIA_SEKOLAH"; // Ganti string ini
  const epoch = Math.floor(Date.now() / (15 * 60 * 1000)); // Berubah tiap 15 menit
  const hash = Utilities.computeDigest(Utilities.DigestAlgorithm.MD5, secret + epoch);
  // Ambil 6 karakter hex dari hash, uppercase
  let token = "";
  for (let i = 0; i < hash.length; i++) {
    let byte = hash[i];
    if (byte < 0) byte += 256;
    let byteStr = byte.toString(16);
    if (byteStr.length == 1) byteStr = "0" + byteStr;
    token += byteStr;
    if (token.length >= 6) break;
  }
  return token.toUpperCase();
}

// ==========================================
// LOGIKA WAKTU & STATUS UJIAN (UPDATE BESAR)
// ==========================================

// 1. Memulai Ujian & Menghitung Waktu Selesai (Server Authority)
function startExamSession(username, idJadwal) {
  const props = PropertiesService.getScriptProperties();
  const statusKey = `STATUS_${username}_${idJadwal}`;
  const endKey = `ENDTIME_${username}_${idJadwal}`;
  
  // Cek jika sedang terkunci
  const currentStatus = props.getProperty(statusKey);
  if (currentStatus === 'LOCKED') {
     return { status: 'locked', message: 'Ujian Terkunci' };
  }

  // Update status jadi STARTED
  if (currentStatus !== 'SELESAI') {
    props.setProperty(statusKey, 'STARTED');
  }

  // Hitung Timer Server-Side
  let endTimeStr = props.getProperty(endKey);
  
  if (!endTimeStr) {
    const durasiMenit = getDurasiFromJadwal(idJadwal); // <-- Ini sekarang aman
    const now = new Date();
    const endTime = new Date(now.getTime() + (durasiMenit * 60 * 1000));
    
    props.setProperty(endKey, endTime.toISOString());
    endTimeStr = endTime.toISOString();
  }
  
  const now = new Date();
  const end = new Date(endTimeStr);
  const remainingSeconds = Math.floor((end.getTime() - now.getTime()) / 1000);

  return { 
    status: 'success', 
    remainingSeconds: remainingSeconds > 0 ? remainingSeconds : 0
  };
}

// Helper: Ambil Durasi Jadwal
function getDurasiFromJadwal(idJadwal) {
  // Jika ID kosong, kembalikan default 60 menit
  if (!idJadwal) return 60; 

  const ss = SpreadsheetApp.openById(SS_ID);
  const sheet = ss.getSheetByName("DB_Jadwal");
  if (!sheet) return 60; // Safety check jika sheet hilang

  const data = sheet.getDataRange().getValues();
  
  // Loop cari ID
  for(let i=1; i<data.length; i++) {
    // Gunakan String() untuk membungkus nilai agar tidak error jika cell kosong/null
    if(String(data[i][0]) === String(idJadwal)) {
      return parseInt(data[i][8]) || 60; // Ambil kolom durasi (index 8), default 60
    }
  }
  return 60; // Default jika ID tidak ketemu
}

// 2. Mencatat Pelanggaran (LOCK PERSISTENT)
function setSiswaViolation(username, idJadwal, reason) {
  const props = PropertiesService.getScriptProperties();
  const statusKey = `STATUS_${username}_${idJadwal}`;
  const reasonKey = `REASON_${username}_${idJadwal}`; // Simpan alasan
  
  props.setProperty(statusKey, 'LOCKED');
  props.setProperty(reasonKey, reason);
  
  return { status: 'success' };
}

// ==========================================
// API TAMBAHAN: MONITORING ADMIN & HASIL
// ==========================================

// 1. Ambil Data Hasil Ujian (Semua / Filter)
function getHasilUjianAdmin(filterMapel) {
  const ss = SpreadsheetApp.openById(SS_ID);
  const sheet = ss.getSheetByName("DB_Nilai");
  if (!sheet) return [];
  
  const data = sheet.getDataRange().getValues();
  data.shift(); // Skip Header
  // [0:Timestamp, 1:ID_Ujian, 2:Nama, 3:Mapel, 4:Nilai, 5:Benar, 6:JawabanJSON]
  
  let result = [];
  // Loop dari bawah (terbaru)
  for (let i = data.length - 1; i >= 0; i--) {
    let row = data[i];
    // Filter Mapel jika ada
    if (!filterMapel || (row[3] && row[3].toString() === filterMapel)) {
      result.push({
        waktu: row[0],
        nama: row[2],
        mapel: row[3],
        nilai: row[4],
        detail: row[5]
      });
    }
  }
  return result;
}

// ==========================================
// UPDATE: TOKEN & MONITORING PER UJIAN
// ==========================================

// 1. Generate Token Unik per Jadwal (Bukan Global)
function generateTokenForExam(idJadwal) {
  const secret = "RAHASIA_SEKOLAH_SECURE"; 
  // Token berubah tiap 15 menit
  const epoch = Math.floor(Date.now() / (15 * 60 * 1000)); 
  
  // Gabungkan Secret + ID Jadwal + Waktu agar unik per ujian
  const raw = secret + idJadwal + epoch;
  const hash = Utilities.computeDigest(Utilities.DigestAlgorithm.MD5, raw);
  
  // Ambil 6 karakter hex
  let token = "";
  for (let i = 0; i < hash.length; i++) {
    let byte = hash[i];
    if (byte < 0) byte += 256;
    let byteStr = byte.toString(16);
    if (byteStr.length == 1) byteStr = "0" + byteStr;
    token += byteStr;
    if (token.length >= 6) break;
  }
  return token.toUpperCase();
}

// 2. Update Verifikasi Token (Terima parameter idJadwal)
function verifikasiTokenUjian(inputToken, idJadwal) {
  const ss = SpreadsheetApp.openById(SS_ID);
  const sheetJadwal = ss.getSheetByName("DB_Jadwal");
  const dataJadwal = sheetJadwal.getDataRange().getValues();
  
  let jadwalData = null;
  for(let i=1; i<dataJadwal.length; i++) {
     if(dataJadwal[i][0].toString() === idJadwal.toString()) {
        jadwalData = { 
           mulai: new Date(dataJadwal[i][3]), 
           selesai: new Date(dataJadwal[i][4]),
           status: dataJadwal[i][5]
        };
        break;
     }
  }

  if (!jadwalData) return { status: 'error', message: 'Jadwal tidak ditemukan.' };
  
  // 1. Cek Status Manual
  if (jadwalData.status !== 'Aktif') return { status: 'error', message: 'Ujian sedang dinonaktifkan oleh Admin.' };

  // 2. Cek Waktu Realtime
  const now = new Date();
  if (now < jadwalData.mulai) {
     const jamMulai = Utilities.formatDate(jadwalData.mulai, "Asia/Makassar", "HH:mm");
     return { status: 'error', message: `Ujian belum dimulai. Harap tunggu hingga pukul ${jamMulai}.` };
  }
  if (now > jadwalData.selesai) {
     return { status: 'error', message: 'Waktu ujian telah berakhir.' };
  }

  // 3. Cek Token
  const validToken = generateTokenForExam(idJadwal);
  if (inputToken === validToken) {
    return { status: 'success' };
  } else {
    return { status: 'error', message: 'Token Salah!' };
  }
}

// ==========================================
// FIX: MONITORING SISWA (UPDATE LOGIKA STATUS)
// ==========================================
function getMonitoringSiswa(idJadwal) {
  const ss = SpreadsheetApp.openById(SS_ID);

  // 1. Cek Jadwal & Token (Bagian ini tidak berubah, hanya persiapan data)
  const sheetJadwal = ss.getSheetByName("DB_Jadwal");
  const dataJadwal = sheetJadwal.getDataRange().getValues();
  let jadwalData = null;
  
  // Konversi idJadwal ke String agar aman saat compare
  const targetId = String(idJadwal).trim();

  for(let i=1; i<dataJadwal.length; i++) {
     if(String(dataJadwal[i][0]).trim() === targetId) {
        jadwalData = { mulai: new Date(dataJadwal[i][3]), selesai: new Date(dataJadwal[i][4]) };
        break;
     }
  }
  
  let currentToken = "ERROR";
  const now = new Date();
  if (jadwalData) {
     if (now < jadwalData.mulai) currentToken = "BELUM MULAI";
     else if (now > jadwalData.selesai) currentToken = "SELESAI";
     else currentToken = generateTokenForExam(targetId);
  }

  // 2. Ambil Semua Siswa
  const sheetUser = ss.getSheetByName("Users");
  const users = sheetUser.getDataRange().getValues().filter(r => r[3].toString().toLowerCase() === 'siswa');
  
  // 3. Ambil DB Nilai (Untuk cek siapa yang sudah submit dan punya nilai)
  const sheetNilai = ss.getSheetByName("DB_Nilai");
  const dataNilai = sheetNilai ? sheetNilai.getDataRange().getValues() : [];
  
  // 4. Properties Service (Untuk cek status Realtime: STARTED, LOCKED, SELESAI)
  const props = PropertiesService.getScriptProperties();
  
  let result = [];
  
  users.forEach(u => {
    const username = u[1]; // Username Siswa
    const nama = u[4];     // Nama Siswa
    const kelas = u[5];    // Kelas
    
    // Default Status
    let status = "BELUM MENGERJAKAN"; 
    let nilai = "-";
    let isLocked = false;
    let violationReason = "";

    // --- LOGIKA PERBAIKAN DI SINI ---
    
    // A. Ambil Status Realtime dari Properties
    const stateKey = `STATUS_${username}_${targetId}`;
    const reasonKey = `REASON_${username}_${targetId}`;
    const stateVal = props.getProperty(stateKey); // Bisa: 'STARTED', 'LOCKED', 'SELESAI', atau null

    // B. Cek Apakah Ada di DB_Nilai (Pencocokan Kuat)
    // Mencocokkan ID Jadwal (Col 1) dan Nama (Col 2)
    const entryNilai = dataNilai.find(n => 
       String(n[1]).trim() === targetId &&  // Match ID Jadwal
       String(n[2]).trim() === String(nama).trim() // Match Nama
    );

    // C. Penentuan Prioritas Status
    
    // 1. Jika Data ditemukan di DB Nilai -> Sudah Pasti SELESAI (Hijau)
    if (entryNilai) {
      status = "SELESAI";
      nilai = entryNilai[4]; // Ambil nilai
    } 
    // 2. Jika di DB belum masuk, tapi status realtime 'SELESAI' -> Tetap anggap SELESAI (Hijau)
    else if (stateVal === 'SELESAI') {
      status = "SELESAI";
      nilai = "Proses"; // Nilai sedang diproses/disimpan
    }
    // 3. Jika status realtime 'LOCKED' -> TERKUNCI (Merah)
    else if (stateVal === 'LOCKED') {
      status = "TERKUNCI";
      isLocked = true;
      violationReason = props.getProperty(reasonKey) || "Terkunci Sistem";
    }
    // 4. Jika status realtime 'STARTED' -> SEDANG MENGERJAKAN (Kuning)
    else if (stateVal === 'STARTED') {
      status = "SEDANG MENGERJAKAN";
    }

    result.push({ nama, kelas, status, nilai, isLocked, violationReason, username });
  });
  
  return { students: result, token: currentToken };
}

// 4. Buka Kunci (Reset Status ke STARTED)
function unlockSiswa(username, idJadwal) {
   const props = PropertiesService.getScriptProperties();
   // Kembalikan status ke STARTED agar siswa bisa lanjut
   props.setProperty(`STATUS_${username}_${idJadwal}`, 'STARTED');
   // Hapus alasan pelanggaran
   props.deleteProperty(`REASON_${username}_${idJadwal}`);
   
   return { status: 'success' };
}

// ==========================================
// UPDATE: ADMIN MONITORING SUMMARY
// ==========================================
function getAdminMonitoringSummary() {
  try {
    const ss = SpreadsheetApp.openById(SS_ID);
    const sheetJadwal = ss.getSheetByName("DB_Jadwal");
    if (!sheetJadwal) return { exams: [] };
    
    const dataJadwal = sheetJadwal.getDataRange().getValues();
    if (dataJadwal.length <= 1) return { exams: [] };

    dataJadwal.shift(); // Hapus Header
    
    // Ambil Jenis Ujian
    let listJenis = [];
    try {
      const sheetJenis = ss.getSheetByName("DB_JenisUjian");
      if (sheetJenis) {
        const dataJenis = sheetJenis.getDataRange().getValues();
        dataJenis.shift();
        listJenis = dataJenis.map(r => ({ id: r[0].toString(), nama: r[1] }));
      }
    } catch (err) {}
  
    const formatTime = (dateObj) => {
      if (!dateObj) return "";
      try { return Utilities.formatDate(new Date(dateObj), "Asia/Makassar", "yyyy-MM-dd'T'HH:mm"); } catch (e) { return ""; }
    };

    let activeExams = [];
    const now = new Date(); // Waktu Server Saat Ini

    dataJadwal.forEach((r) => {
      const rawStatus = r[5] ? r[5].toString() : "";
      
      // Hanya ambil yang statusnya AKTIF
      if (rawStatus.trim().toLowerCase() === 'aktif') {
        const idJadwal = r[0];
        const idJenis = r[1] ? r[1].toString() : "";
        const objJenis = listJenis.find(j => j.id === idJenis);
        
        const tMulai = new Date(r[3]);
        const tSelesai = new Date(r[4]);

        // LOGIKA TOKEN ADMIN (SAMA DENGAN PENGAWAS)
        let thisToken = "";
        let statusWaktu = ""; // Helper untuk frontend

        if (now < tMulai) {
           thisToken = "BELUM MULAI";
           statusWaktu = "waiting";
        } else if (now > tSelesai) {
           thisToken = "SELESAI";
           statusWaktu = "done";
        } else {
           thisToken = generateTokenForExam(idJadwal);
           statusWaktu = "active";
        }
        
        activeExams.push({
          id: idJadwal,
          jenis: objJenis ? objJenis.nama : idJenis,
          mapel: r[2],               
          mulai: formatTime(r[3]),   
          selesai: formatTime(r[4]), 
          token: thisToken,
          statusWaktu: statusWaktu // Kirim status waktu untuk pewarnaan di frontend
        });
      }
    });

    return { exams: activeExams };

  } catch (e) {
    console.log("CRITICAL ERROR getAdminMonitoringSummary: " + e.toString());
    return { exams: [] };
  }
}

// ==========================================
// UPDATE: FILTER PENGAWAS & CRUD JADWAL
// ==========================================

// 1. Ambil List User Role Pengawas (Untuk Dropdown)
function getListPengawas() {
  const ss = SpreadsheetApp.openById(SS_ID);
  const sheet = ss.getSheetByName("Users");
  const data = sheet.getDataRange().getValues();
  data.shift();
  
  // Filter role = 'pengawas'
  let list = [];
  data.forEach(r => {
    if(r[3].toString().toLowerCase() === 'pengawas') {
      list.push({ username: r[1], nama: r[4] });
    }
  });
  return list;
}

// ==========================================
// TAMBAHAN: MODIFIKASI UNTUK FITUR KELAS
// ==========================================

// 1. Fungsi Baru: Ambil Daftar Kelas Unik dari Data User
function getListKelasUnik() {
  const ss = SpreadsheetApp.openById(SS_ID);
  const sheet = ss.getSheetByName("Users");
  const data = sheet.getDataRange().getValues();
  data.shift(); // Skip Header
  
  let kelasSet = new Set();
  
  data.forEach(row => {
    // row[3] = Role, row[5] = Kelas
    if (row[3] && row[3].toString().toLowerCase() === 'siswa' && row[5]) {
      kelasSet.add(row[5].toString().trim());
    }
  });
  
  // Return array diurutkan
  return Array.from(kelasSet).sort();
}

// 2. UPDATE: getJadwalUjian (Tambahkan kolom Durasi, AcakSoal, AcakOpsi)
function getJadwalUjian() {
  const ss = SpreadsheetApp.openById(SS_ID);
  let sheet = ss.getSheetByName("DB_Jadwal");
  if (!sheet) {
    sheet = ss.insertSheet("DB_Jadwal");
    // Header diperbarui (Col 1-8 Lama, 9-11 Baru)
    sheet.appendRow(["ID", "ID_Jenis", "Kode_Mapel", "Mulai", "Selesai", "Status", "Pengawas", "Kelas", "Durasi", "Acak_Soal", "Acak_Opsi"]);
    return [];
  }
  const data = sheet.getDataRange().getValues();
  data.shift();
  
  const jenis = getJenisUjian(); 
  const mapel = getAllMapel(); 
  
  const formatTime = (dateObj) => {
      if (!dateObj) return "";
      try { return Utilities.formatDate(new Date(dateObj), "Asia/Makassar", "yyyy-MM-dd'T'HH:mm"); } catch (e) { return ""; }
  };

  return data.map(r => {
    const j = jenis.find(x => x.id === r[1]);
    const m = mapel.find(x => x.kode === r[2]);
    
    return {
      id: r[0],
      id_jenis: r[1],
      nama_ujian: j ? j.nama : r[1], 
      kode_mapel: r[2],
      nama_mapel: m ? m.nama : r[2],
      mulai: formatTime(r[3]),   
      selesai: formatTime(r[4]), 
      status: r[5],
      pengawas: r[6] || '',
      target_kelas: r[7] || 'Semua',
      durasi: r[8] || 60,         // Default 60 menit
      acak_soal: r[9] === true || r[9] === 'true', // Boolean
      acak_opsi: r[10] === true || r[10] === 'true' // Boolean
    };
  });
}

// 3. UPDATE: simpanJadwal (Simpan kolom baru)
function simpanJadwal(data) {
  const ss = SpreadsheetApp.openById(SS_ID);
  let sheet = ss.getSheetByName("DB_Jadwal");
  
  if (!sheet) { 
    sheet = ss.insertSheet("DB_Jadwal"); 
    sheet.appendRow(["ID", "ID_Jenis", "Kode_Mapel", "Mulai", "Selesai", "Status", "Pengawas", "Kelas", "Durasi", "Acak_Soal", "Acak_Opsi"]); 
  }
  
  const allData = sheet.getDataRange().getValues();
  
  if(new Date(data.mulai) >= new Date(data.selesai)) {
     return { status: 'error', message: 'Waktu Selesai harus lebih akhir dari Mulai.' };
  }

  // Data yang akan disimpan (11 Kolom)
  // Pastikan urutan sesuai Header: ID(skip), Jenis, Mapel, Mulai, Selesai, Status, Pengawas, Kelas, Durasi, AcakSoal, AcakOpsi
  const rowData = [
    data.id_jenis, 
    data.kode_mapel, 
    data.mulai, 
    data.selesai, 
    data.status, 
    data.pengawas, 
    data.target_kelas,
    data.durasi,
    data.acak_soal,
    data.acak_opsi
  ];

  if (data.id) { // Edit
    for (let i = 1; i < allData.length; i++) {
      if (allData[i][0].toString() === data.id.toString()) {
        // Update range kolom 2 sampai 11 (sebanyak 10 kolom data)
        sheet.getRange(i + 1, 2, 1, 10).setValues([rowData]);
        return { status: 'success', message: 'Jadwal diperbarui!' };
      }
    }
  } else { // Baru
    const newId = "SCH-" + Date.now();
    sheet.appendRow([newId, ...rowData]);
    return { status: 'success', message: 'Jadwal ditambahkan!' };
  }
  return { status: 'error', message: 'Error DB.' };
}

// 4. Update Dashboard Pengawas (FILTER JADWAL)
// Menerima parameter usernamePengawas dari Frontend
function getPengawasDashboard(usernamePengawas) {
  const ss = SpreadsheetApp.openById(SS_ID);
  const sheetJadwal = ss.getSheetByName("DB_Jadwal");
  
  if(!sheetJadwal) return { jadwal: [] };

  const dataJadwal = sheetJadwal.getDataRange().getValues();
  dataJadwal.shift();
  
  // Pastikan input username aman
  const myUser = usernamePengawas ? usernamePengawas.toString().trim().toLowerCase() : "";

  let jadwalAktif = [];
  dataJadwal.forEach(r => {
    // r[5] = Status, r[6] = Pengawas Assigned
    const status = r[5];
    const assignedTo = r[6] ? r[6].toString().trim().toLowerCase() : "";

    // Logika Filter:
    // 1. Status harus Aktif
    // 2. Kolom Pengawas cocok dengan username login, ATAU 'semua'
    if (status === 'Aktif') {
       if (assignedTo === "" || assignedTo === 'semua' || assignedTo === myUser) {
          
          // Konversi waktu agar aman dikirim ke client
          const tMulai = r[3] instanceof Date ? r[3].toISOString() : r[3];
          const tSelesai = r[4] instanceof Date ? r[4].toISOString() : r[4];

          jadwalAktif.push({ 
            id: r[0], 
            mapel: r[2], // Kode mapel atau Nama Mapel (sesuai selera tampilan)
            mulai: tMulai, 
            selesai: tSelesai 
          });
       }
    }
  });

  return { jadwal: jadwalAktif };
}

// ==========================================
// API 8: IMPORT BANK SOAL (XLSX / EXCEL SUPPORT)
// ==========================================

function downloadTemplateImport() {
  try {
    // 1. Buat Spreadsheet Sementara
    const tempSS = SpreadsheetApp.create("Template_Soal_CBT_Temp");
    const sheet = tempSS.getActiveSheet();
    
    // 2. Isi Header & Contoh Data
    const headers = [["Tipe", "Soal", "OpsiA", "OpsiB", "OpsiC", "OpsiD", "OpsiE", "Kunci", "Bobot"]];
    const sampleData = [
      ["PG", "Siapakah penemu lampu? [img:lampu.jpg]", "Thomas Edison", "Einstein", "Tesla", "Newton", "Habibie", "A", 2.5],
      ["ISIAN", "Dengarkan suara ini [audio:kucing.mp3]. Hewan apakah itu?", "", "", "", "", "", "Kucing", 2],
      ["BS", "Bumi itu datar. [img:bumi.png]", "", "", "", "", "", "SALAH", 2],
      ["ESSAY", "Jelaskan proses terjadinya hujan! [video:hujan.mp4]", "", "", "", "", "", "MANUAL", 5]
    ];
    
    // Set Style Header
    const rangeHeader = sheet.getRange(1, 1, 1, 9);
    rangeHeader.setValues(headers);
    rangeHeader.setFontWeight("bold").setBackground("#f3f4f6");
    
    // Set Data
    sheet.getRange(2, 1, sampleData.length, 9).setValues(sampleData);
    
    // Auto Resize Column agar rapi
    sheet.autoResizeColumns(1, 9);
    
    // Simpan perubahan
    SpreadsheetApp.flush();
    
    // 3. Export ke Blob XLSX (Menggunakan UrlFetchApp ke API Google)
    const url = "https://docs.google.com/spreadsheets/d/" + tempSS.getId() + "/export?format=xlsx";
    const token = ScriptApp.getOAuthToken();
    const params = { headers: { Authorization: "Bearer " + token } };
    const blobXlsx = UrlFetchApp.fetch(url, params).getBlob().setName("Template_Soal_CBT.xlsx");
    
    // 4. Hapus Spreadsheet Sementara (Agar sampah tidak menumpuk)
    DriveApp.getFileById(tempSS.getId()).setTrashed(true);

    // 5. Buat Petunjuk HTML
    const htmlPetunjuk = `
    <html>
    <head><style>body{font-family:sans-serif;line-height:1.6} .tag{background:#eee;padding:2px 5px;font-family:monospace;font-weight:bold;color:#c02e2e}</style></head>
    <body>
      <h1>Panduan Import Soal (Excel & ZIP)</h1>
      <p>Fitur ini memungkinkan Anda mengupload soal beserta media (Gambar/Audio/Video) sekaligus.</p>
      
      <h3>Langkah-langkah:</h3>
      <ol>
        <li>Isi file <b>Template_Soal_CBT.xlsx</b>.</li>
        <li>Siapkan file gambar/audio/video yang diperlukan.</li>
        <li>Seleksi file Excel dan semua file media, lalu klik kanan > <b>Send to Compressed (zipped) folder</b>.</li>
        <li>Upload file ZIP tersebut ke aplikasi.</li>
      </ol>

      <h3>Format Tabel Excel</h3>
      <ul>
        <li><b>Tipe</b>: PG, ISIAN, ESSAY, BS.</li>
        <li><b>Soal</b>: Tulis pertanyaan. Gunakan tag media jika perlu.</li>
        <li><b>OpsiA - E</b>: Pilihan jawaban (Wajib untuk PG).</li>
        <li><b>Kunci</b>: Kunci jawaban (A/B/C/D/E untuk PG).</li>
      </ul>

      <h3>Cara Menyisipkan Media</h3>
      <p>Tulis tag ini di dalam sel Excel (Soal atau Opsi). Pastikan nama file sama persis dengan file di dalam ZIP.</p>
      <ul>
        <li>Gambar: <span class="tag">[img:namafile.jpg]</span></li>
        <li>Audio: <span class="tag">[audio:suara.mp3]</span></li>
        <li>Video: <span class="tag">[video:film.mp4]</span></li>
      </ul>
    </body>
    </html>
    `;
    const blobHtml = Utilities.newBlob(htmlPetunjuk, 'text/html', 'Panduan_Import.html');

    // 6. Zip Hasilnya
    const zip = Utilities.zip([blobXlsx, blobHtml], 'Template_Soal_CBT.zip');
    
    return {
      filename: 'Template_Soal_CBT.zip',
      base64: Utilities.base64Encode(zip.getBytes())
    };

  } catch (e) {
    // Error handling jika Drive API belum aktif
    throw new Error("Gagal Download: " + e.toString() + ". Pastikan Service Drive API aktif.");
  }
}

function processImportZip(base64Zip, mapel) {
  try {
    const ss = SpreadsheetApp.openById(SS_ID);
    const sheetDb = ss.getSheetByName("DB_Soal");
    
    // 1. Unzip
    const decoded = Utilities.base64Decode(base64Zip);
    const blob = Utilities.newBlob(decoded, 'application/zip');
    const files = Utilities.unzip(blob);
    
    let excelBlob = null;
    let mediaFiles = {}; 
    
    // 2. Pilah File
    files.forEach(f => {
      const name = f.getName().toLowerCase();
      if (name.endsWith('.xlsx') || name.endsWith('.xls')) {
        excelBlob = f;
      } else {
        mediaFiles[name] = f; // Simpan blob media
      }
    });

    if (!excelBlob) return { status: 'error', message: 'File Excel (.xlsx) tidak ditemukan dalam ZIP.' };

    // 3. Konversi Excel ke Google Sheet (Perlu DRIVE API)
    // Resource config untuk convert
    const resource = {
      title: "Temp_Import_" + Date.now(),
      mimeType: MimeType.GOOGLE_SHEETS
    };
    
    // Gunakan Drive.Files.insert (Advanced Service) untuk convert otomatis
    // Jika error disini, berarti User belum enable Drive API di Services
    let tempFile;
    try {
       tempFile = Drive.Files.insert(resource, excelBlob); 
    } catch(err) {
       return { status: 'error', message: 'Harap aktifkan "Drive API" di menu Services editor Apps Script.' };
    }
    
    // 4. Baca Data dari Sheet Sementara
    const tempSS = SpreadsheetApp.openById(tempFile.id);
    const dataRows = tempSS.getSheets()[0].getDataRange().getValues();
    
    // Hapus file temp setelah dibaca
    Drive.Files.remove(tempFile.id); 

    // 5. Setup Folder Upload Media
    const folderName = "CBT_Assets";
    const folders = DriveApp.getFoldersByName(folderName);
    let folder = folders.hasNext() ? folders.next() : DriveApp.createFolder(folderName);

    // Helper Upload Media
    const uploadAndGetUrl = (fileNameTag) => {
      const cleanName = fileNameTag.trim().toLowerCase();
      if (mediaFiles[cleanName]) {
        const file = folder.createFile(mediaFiles[cleanName]);
        file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
        
        // URL Hack agar bisa diakses langsung sebagai image/audio
        const id = file.getId();
        const urlView = "https://lh3.googleusercontent.com/d/" + id; // URL Image hosting friendly
        const urlDown = "https://docs.google.com/uc?export=download&id=" + id; // URL Download friendly

        if (cleanName.match(/\.(mp3|wav|ogg|m4a)$/)) {
            return `<br><audio controls controlsList="nodownload"><source src="${urlDown}" type="audio/mpeg">Browser tidak support audio.</audio><br>`;
        } else if (cleanName.match(/\.(mp4|webm)$/)) {
            return `<br><video width="320" height="240" controls controlsList="nodownload"><source src="${urlDown}" type="video/mp4">Browser tidak support video.</video><br>`;
        } else {
            // Gambar
            return `<img src="${urlView}=s1000" style="max-width:100%; height:auto; border-radius:8px; margin: 10px 0;">`;
        }
      }
      return ` <span style="color:red; font-weight:bold;">[FILE NOT FOUND: ${fileNameTag}]</span> `;
    };

    // Helper Replace Tag
    const processText = (text) => {
      if (!text) return "";
      const str = text.toString();
      // Regex cari [tipe:namafile.ext]
      return str.replace(/\[(img|audio|video):([^\]]+)\]/gi, (match, type, filename) => {
         return uploadAndGetUrl(filename);
      });
    };

    // 6. Loop Simpan ke Database
    // Data Row 0 adalah Header, mulai dari Row 1
    let countSuccess = 0;
    
    // Mapping Index Kolom Excel (Sesuaikan dengan template download)
    // 0:Tipe, 1:Soal, 2:A, 3:B, 4:C, 5:D, 6:E, 7:Kunci, 8:Bobot
    
    for (let i = 1; i < dataRows.length; i++) {
      const row = dataRows[i];
      // Skip jika Soal kosong
      if (!row[1]) continue; 

      const idSoal = "Q-" + Date.now() + "-" + i;
      const tipe = row[0] ? row[0].toString().toUpperCase().trim() : "PG";
      
      const soalHtml = processText(row[1]);
      
      // Proses Opsi
      let opsiObj = {};
      if (tipe === 'PG') {
        opsiObj = {
          A: processText(row[2]),
          B: processText(row[3]),
          C: processText(row[4]),
          D: processText(row[5]),
          E: processText(row[6])
        };
      } else if (tipe === 'BS') {
        opsiObj = { A: 'BENAR', B: 'SALAH' };
      }
      
      const kunci = row[7] ? row[7].toString().trim() : "";
      const bobot = row[8] ? row[8] : "";

      sheetDb.appendRow([
        idSoal,
        mapel,
        tipe,
        soalHtml,
        "", // Kolom Img (Legacy)
        JSON.stringify(opsiObj),
        kunci,
        bobot
      ]);
      countSuccess++;
    }

    return { status: 'success', message: `Berhasil import ${countSuccess} soal dari Excel.` };

  } catch (e) {
    return { status: 'error', message: 'Import Gagal: ' + e.toString() };
  }
}

// ==========================================
// FUNGSI PANCINGAN IZIN (Jalankan Manual Sekali)
// ==========================================
function pancingIzin() {
  // Memancing izin External Request (UrlFetchApp)
  UrlFetchApp.fetch("https://www.google.com");
  
  // Memancing izin Drive (DriveApp & Drive Advanced Service)
  DriveApp.getFiles();
  
  // Memancing izin Spreadsheet
  SpreadsheetApp.getActiveSpreadsheet();
  
  console.log("Izin berhasil dipancing. Silakan deploy ulang.");
}

// ==========================================
// UPDATE FUNGSI: getStudentDashboardData (Dengan Nama Lengkap Pengawas)
// ==========================================
function getStudentDashboardData(username, kelasSiswa) {
  try {
    const ss = SpreadsheetApp.openById(SS_ID);
    const sheetJadwal = ss.getSheetByName("DB_Jadwal");
    const sheetNilai = ss.getSheetByName("DB_Nilai");
    
    // 1. [BARU] Ambil Data User untuk Mapping Username -> Nama Lengkap
    const sheetUser = ss.getSheetByName("Users");
    let mapPengawas = {};
    
    if (sheetUser) {
       const dataUser = sheetUser.getDataRange().getValues();
       dataUser.shift(); // Skip Header
       // Loop untuk buat kamus: { "username1": "Budi Santoso", "username2": "Siti Aminah" }
       dataUser.forEach(u => {
          const uName = u[1] ? u[1].toString().trim() : "";
          const uFull = u[4] ? u[4].toString().trim() : "";
          if(uName) mapPengawas[uName] = uFull;
       });
    }
    
    let jadwalList = [];
    
    if (sheetJadwal && sheetJadwal.getLastRow() > 1) {
      const data = sheetJadwal.getDataRange().getValues();
      data.shift(); 
      
      const mapelList = getAllMapel(); 
      const jenisList = getJenisUjian();
  
      data.forEach(row => {
        const statusJadwal = row[5];
        const targetKelas = row[7] ? row[7].toString().trim() : "Semua";
        
        if (statusJadwal === 'Aktif') {
          if (targetKelas.toLowerCase() === 'semua' || (kelasSiswa && targetKelas === kelasSiswa)) {
             const m = mapelList.find(x => x.kode === row[2]);
             const j = jenisList.find(x => x.id === row[1]);
             
             const tMulai = row[3] instanceof Date ? row[3].toISOString() : row[3];
             const tSelesai = row[4] instanceof Date ? row[4].toISOString() : row[4];
  
             // 2. [BARU] Logika Ganti Username ke Nama Lengkap
             let pengawasRaw = row[6] ? row[6].toString().trim() : "";
             let pengawasDisplay = "-";

             if (pengawasRaw.toLowerCase() === 'semua') {
                 pengawasDisplay = "Semua Pengawas";
             } else if (mapPengawas[pengawasRaw]) {
                 pengawasDisplay = mapPengawas[pengawasRaw]; // Pakai Nama Lengkap
             } else {
                 pengawasDisplay = pengawasRaw; // Fallback ke username jika nama tidak ketemu
             }
  
             jadwalList.push({
               id: row[0],
               jenis: j ? j.nama : row[1],
               kode_mapel: row[2],
               nama_mapel: m ? m.nama : row[2],
               mulai: tMulai,
               selesai: tSelesai,
               pengawas: pengawasDisplay, // <--- Ini sekarang berisi Nama Lengkap
               durasi: row[8] || 60,
               acak_soal: row[9],
               acak_opsi: row[10]
             });
          }
        }
      });
    }
  
    // B. Cek Status Personal Siswa (Kode Lama - Tidak Berubah)
    const dataNilai = sheetNilai ? sheetNilai.getDataRange().getValues() : [];
    const props = PropertiesService.getScriptProperties();
  
    let namaSiswa = "";
    // Cari nama siswa login untuk pencocokan nilai (fallback)
    if(sheetUser) {
       const dataUser = sheetUser.getDataRange().getValues();
       for(let u of dataUser) { 
         if(u[1] == username) { namaSiswa = u[4]; break; } 
       }
    }
  
    const finalResult = jadwalList.map(j => {
        // Cek Nilai berdasarkan Username (Prioritas) atau Nama
        const isFinishedDB = dataNilai.some(n => 
            (n[2] && n[2].toString() === username && n[1].toString() === j.id.toString()) || // Cek Username
            (n[2] && n[2].toString() === namaSiswa && n[1].toString() === j.id.toString())   // Cek Nama (Legacy)
        );
        
        const stateKey = `STATUS_${username}_${j.id}`;
        const stateVal = props.getProperty(stateKey);
        
        let personalStatus = 'BELUM';
        let sisaDetik = 0; 

        const hitungSisa = () => {
           const endKey = `ENDTIME_${username}_${j.id}`;
           const endTimeStr = props.getProperty(endKey);
           if(endTimeStr) {
               const now = new Date();
               const end = new Date(endTimeStr);
               let s = Math.floor((end.getTime() - now.getTime()) / 1000);
               return s < 0 ? 0 : s;
           }
           return 0;
        };
        
        if (isFinishedDB || stateVal === 'SELESAI') {
           personalStatus = 'SELESAI';
        } else if (stateVal === 'LOCKED') {
           personalStatus = 'TERKUNCI';
           sisaDetik = hitungSisa(); 
        } else if (stateVal === 'STARTED') {
           personalStatus = 'SEDANG';
           sisaDetik = hitungSisa(); 
        }
  
        return {
           ...j,
           status_personal: personalStatus,
           sisa_detik: sisaDetik 
        };
    });
  
    return finalResult;
    
  } catch (e) {
    Logger.log("ERROR getStudentDashboardData: " + e.toString());
    return []; 
  }
}

// ==========================================
// [UPDATE & FIX] API 9: RIWAYAT NILAI & DETAIL
// ==========================================

// [UPDATE] API: AMBIL RIWAYAT (Baca Kolom Nilai Akhir)
function getRiwayatNilaiSiswa(username) {
  const ss = SpreadsheetApp.openById(SS_ID);
  
  const sheetNilai = ss.getSheetByName("DB_Nilai");
  if (!sheetNilai) return [];
  const dataNilai = sheetNilai.getDataRange().getValues();
  dataNilai.shift(); 
  
  const sheetJadwal = ss.getSheetByName("DB_Jadwal");
  let jadwalMap = {};
  if (sheetJadwal) {
     const dataJ = sheetJadwal.getDataRange().getValues();
     dataJ.shift();
     for(let j of dataJ) { jadwalMap[j[0]] = j[4] ? new Date(j[4]) : new Date(); }
  }

  let result = [];
  const now = new Date();

  // Helper Format Detik
  const formatSisa = (detik) => {
      if(!detik || detik <= 0) return "0m 0d";
      const m = Math.floor(detik / 60);
      const s = detik % 60;
      return `${m}m ${s}d`;
  };

  // Loop Data Nilai
  for (let i = dataNilai.length - 1; i >= 0; i--) {
    let row = dataNilai[i]; 
    
    if (row[2] && row[2].toString() === username) {
      const idJadwal = row[1];
      const waktuSelesaiJadwal = jadwalMap[idJadwal];
      
      let isPublished = false;
      if (waktuSelesaiJadwal && now > waktuSelesaiJadwal) { isPublished = true; }

      let tglSubmit = ""; let jamSubmit = "";
      try {
         tglSubmit = Utilities.formatDate(new Date(row[0]), "Asia/Makassar", "dd MMM yyyy");
         jamSubmit = Utilities.formatDate(new Date(row[0]), "Asia/Makassar", "HH:mm") + " WIB";
      } catch(e) {}

      // Mapping Kolom Baru
      const sisaDetik = row[8] ? parseInt(row[8]) : 0;
      const nilaiSementara = row[5];
      const nilaiAkhir = row[9]; // Kolom ke-10 (Index 9) adalah Nilai Akhir

      result.push({
        idJadwal: idJadwal,
        tgl: tglSubmit,
        jam: jamSubmit, 
        sisaWaktuStr: formatSisa(sisaDetik),
        mapel: row[4],
        nilaiSementara: nilaiSementara,
        nilaiAkhir: nilaiAkhir, // Kirim Nilai Akhir
        isPublished: isPublished
      });
    }
  }
  return result;
}

// 2. [UPDATE] Ambil Detail Jawaban (Fix COCOK vs ESSAY)
function getDetailJawabanSiswa(idJadwal, username) {
  const ss = SpreadsheetApp.openById(SS_ID);
  
  // Validasi Waktu dll (kode lama tetap sama)...
  // Langsung ke logic pengambilan data:
  
  const sheetNilai = ss.getSheetByName("DB_Nilai");
  const dataNilai = sheetNilai.getDataRange().getValues();
  let jawabanSiswa = {};
  
  for(let i=dataNilai.length-1; i>=1; i--) {
     if(String(dataNilai[i][1]) === String(idJadwal) && String(dataNilai[i][2]) === String(username)) {
        try { jawabanSiswa = JSON.parse(dataNilai[i][7]); } catch(e){}
        break;
     }
  }

  // Ambil Mapel
  const sheetJadwal = ss.getSheetByName("DB_Jadwal");
  const dataJadwal = sheetJadwal.getDataRange().getValues();
  let targetMapelKode = "";
  for(let i=1; i<dataJadwal.length; i++) {
     if(String(dataJadwal[i][0]) === String(idJadwal)) { targetMapelKode = dataJadwal[i][2]; break; }
  }

  const sheetSoal = ss.getSheetByName("DB_Soal");
  const dataSoal = sheetSoal.getDataRange().getValues();
  dataSoal.shift();

  let detail = [];
  
  for(let row of dataSoal) {
     if(row[1].toString().toLowerCase() === targetMapelKode.toLowerCase()) {
        const idSoal = row[0];
        const tipe = row[2];
        const pertanyaan = row[3];
        const opsiRaw = row[5];
        const kunci = row[6];
        
        let opsiObj = {};
        try { opsiObj = JSON.parse(opsiRaw); } catch(e){}

        const jawab = jawabanSiswa[idSoal]; // Jangan default "-" disini, biar frontend handle null
        
        let isCorrect = false;
        
        // Logika Status Benar/Salah untuk Badge
        if (tipe === 'PG' || tipe === 'BS') {
           isCorrect = (String(jawab) === String(kunci));
        } else if (tipe === 'COCOK') {
           // Untuk cocok, kita anggap "Correct" jika ada minimal 1 jawaban benar (opsional, hanya untuk visual badge)
           // Atau biarkan false, nanti frontend menampilkan badge khusus "Pencocokan"
           isCorrect = false; 
        }

        detail.push({
           tipe: tipe,
           pertanyaan: pertanyaan,
           opsi: opsiObj,
           kunci: kunci,
           jawabanSiswa: jawab,
           isCorrect: isCorrect
        });
     }
  }

  return { status: 'success', data: detail };
}

// ==========================================
// FITUR AUTO-SAVE & PROGRESS (DATABASE CADANGAN)
// ==========================================

// 1. Simpan Progress Jawaban (Dipanggil saat klik Next)
function simpanProgressSiswa(username, idJadwal, jawabanJson) {
  const ss = SpreadsheetApp.openById(SS_ID);
  let sheet = ss.getSheetByName("DB_Progress");
  
  // Buat sheet jika belum ada
  if (!sheet) {
    sheet = ss.insertSheet("DB_Progress");
    sheet.appendRow(["ID_Sesi", "Username", "ID_Jadwal", "Jawaban_JSON", "Last_Update"]);
  }
  
  const idSesi = username + "_" + idJadwal;
  const timestamp = new Date();
  
  // Cek apakah data user sudah ada? (Update vs Insert)
  // Kita pakai TextFinder untuk performa cepat
  const textFinder = sheet.createTextFinder(idSesi).matchEntireCell(true);
  const result = textFinder.findNext();
  
  if (result) {
    // UPDATE: Jika sudah ada, update kolom Jawaban (Kolom 4) & Waktu (Kolom 5)
    const row = result.getRow();
    sheet.getRange(row, 4).setValue(jawabanJson);
    sheet.getRange(row, 5).setValue(timestamp);
  } else {
    // INSERT: Jika belum ada, buat baris baru
    sheet.appendRow([idSesi, username, idJadwal, jawabanJson, timestamp]);
  }
}

// 2. Ambil Progress Jawaban (Dipanggil saat Ujian Dimulai/Reload)
function getProgressSiswa(username, idJadwal) {
  const ss = SpreadsheetApp.openById(SS_ID);
  const sheet = ss.getSheetByName("DB_Progress");
  if (!sheet) return "{}"; // Return JSON kosong jika sheet belum ada

  const idSesi = username + "_" + idJadwal;
  const textFinder = sheet.createTextFinder(idSesi).matchEntireCell(true);
  const result = textFinder.findNext();

  if (result) {
    // Ambil JSON jawaban dari kolom 4
    return sheet.getRange(result.getRow(), 4).getValue();
  }
  return "{}";
}

// 3. (Opsional) Hapus Progress setelah Submit Sukses
function hapusProgressSiswa(username, idJadwal) {
  const ss = SpreadsheetApp.openById(SS_ID);
  const sheet = ss.getSheetByName("DB_Progress");
  if (!sheet) return;
  
  const idSesi = username + "_" + idJadwal;
  const textFinder = sheet.createTextFinder(idSesi).matchEntireCell(true);
  const result = textFinder.findNext();
  
  if (result) {
    sheet.deleteRow(result.getRow());
  }
}

// ==========================================
// TAMBAHAN: API KHUSUS GURU
// ==========================================

// Ambil Mapel Khusus Guru Tertentu (Berdasarkan Nama)
function getMapelByGuru(namaGuru) {
  const ss = SpreadsheetApp.openById(SS_ID);
  const sheet = ss.getSheetByName("DB_Mapel");
  if (!sheet) return [];
  
  const data = sheet.getDataRange().getValues();
  data.shift(); // Skip Header
  
  // Normalisasi nama guru (trim & lowercase) untuk pencocokan
  const targetName = namaGuru ? namaGuru.toString().trim().toLowerCase() : "";
  
  let result = [];
  data.forEach(row => {
    // row[0]:ID, row[1]:Kode, row[2]:Nama, row[3]:Guru
    const guruDiDb = row[3] ? row[3].toString().trim().toLowerCase() : "";
    
    // Pencocokan: Jika nama guru sama persis
    if (guruDiDb === targetName) {
      result.push({
        id: row[0],
        kode: row[1],
        nama: row[2],
        guru: row[3]
      });
    }
  });
  
  return result;
}

// ==========================================
// API KHUSUS GURU: HASIL & KOREKSI
// ==========================================

// 1. Ambil Daftar Hasil Ujian (Format Baru untuk Guru)
function getHasilUjianGuru() {
  const ss = SpreadsheetApp.openById(SS_ID);
  const sheet = ss.getSheetByName("DB_Nilai");
  if (!sheet) return [];
  
  const data = sheet.getDataRange().getValues();
  data.shift(); // Skip Header
  
  // [0:Time, 1:ID_Jadwal, 2:Username, 3:Nama, 4:Mapel, 5:NilaiSmt, 6:Detail, 7:Jawaban, 8:Sisa, 9:NilaiAkhir]
  
  // Format Tanggal
  const formatTgl = (d) => {
      try { return Utilities.formatDate(new Date(d), "Asia/Makassar", "dd MMM yyyy HH:mm"); } catch(e){return "-";}
  };
  
  // Helper Format Sisa Waktu
  const formatSisa = (detik) => {
      if(!detik || detik <= 0) return "0m 0d";
      const m = Math.floor(detik / 60);
      const s = detik % 60;
      return `${m}m ${s}d`;
  };

  return data.map((row, i) => ({
    rowIndex: i + 2, // Simpan index baris (Excel row) untuk update cepat
    waktu: formatTgl(row[0]),
    idJadwal: row[1],
    username: row[2],
    nama: row[3],
    mapel: row[4],
    nilaiSementara: row[5], // Nilai Sistem (PG/Otomatis)
    sisaWaktu: formatSisa(row[8]),
    nilaiAkhir: row[9], // Nilai Rapor (Bisa kosong)
    status: (row[9] !== "" && row[9] !== null) ? "Published" : "Draft"
  })).reverse(); // Urutkan dari yang terbaru
}

// ==========================================
// FIX: KOREKSI GURU (LOGIKA COCOK & BOBOT DINAMIS)
// ==========================================
function getDataKoreksi(idJadwal, username, rowIndex) {
  const ss = SpreadsheetApp.openById(SS_ID);
  
  // A. Ambil Data Nilai Siswa
  const sheetNilai = ss.getSheetByName("DB_Nilai");
  const rowData = sheetNilai.getRange(rowIndex, 1, 1, 11).getValues()[0];
  
  // Validasi data sinkron
  if (String(rowData[1]) !== String(idJadwal) || String(rowData[2]) !== String(username)) {
     return { status: 'error', message: 'Data tidak sinkron. Refresh halaman.' };
  }

  let jawabanSiswa = {};
  try { jawabanSiswa = JSON.parse(rowData[7]); } catch(e) {}
  
  let draftSkor = {};
  try { draftSkor = JSON.parse(rowData[10]); } catch(e) {}

  // B. Ambil Mapel & Soal
  const sheetJadwal = ss.getSheetByName("DB_Jadwal");
  const dataJadwal = sheetJadwal.getDataRange().getValues();
  let kodeMapel = "";
  for(let j=1; j<dataJadwal.length; j++) {
     if(String(dataJadwal[j][0]) === String(idJadwal)) { kodeMapel = dataJadwal[j][2]; break; }
  }

  const sheetSoal = ss.getSheetByName("DB_Soal");
  const dataSoal = sheetSoal.getDataRange().getValues();
  dataSoal.shift();

  let listSoal = [];
  let totalBobotSeluruhSoal = 0; // Akumulasi bobot semua soal

  dataSoal.forEach(r => {
     if(String(r[1]).toLowerCase() === String(kodeMapel).toLowerCase()) {
        const idSoal = r[0];
        const tipe = r[2];
        const opsiRaw = r[5]; 
        const kunci = r[6];
        
        // Bobot Default dari Database (Global)
        let bobotGlobal = (r[7] && !isNaN(r[7])) ? parseFloat(r[7]) : 1;
        let finalBobotSoal = bobotGlobal; // Ini yang akan dipakai sebagai penyebut (denominator)

        // --- LOGIKA SKOR ---
        let skorItem = 0;
        
        // 1. Cek Draft Manual Guru (Jika sudah pernah dikoreksi dan disimpan)
        if (draftSkor[idSoal] !== undefined) {
            skorItem = parseFloat(draftSkor[idSoal]);
            
            // Khusus COCOK: Kita perlu hitung ulang Total Bobot jika guru pakai bobot item
            if (tipe === 'COCOK') {
                let pairsConfig = [];
                try { pairsConfig = JSON.parse(opsiRaw); } catch(e){}
                let totalDefinedWeight = 0;
                if(Array.isArray(pairsConfig)) {
                    pairsConfig.forEach(p => {
                       if(p.s && !isNaN(p.s)) totalDefinedWeight += parseFloat(p.s);
                    });
                }
                // Jika total bobot item > 0, gunakan itu sebagai Final Bobot
                if(totalDefinedWeight > 0) finalBobotSoal = totalDefinedWeight;
            }

        } 
        else {
            // 2. Hitung Otomatis (Belum ada draft)
            const jwb = jawabanSiswa[idSoal];

            if (tipe === 'PG' || tipe === 'BS') {
               if(String(jwb).trim().toUpperCase() === String(kunci).trim().toUpperCase()) {
                   skorItem = bobotGlobal;
               }
            } 
            else if (tipe === 'COCOK') {
               // --- PERBAIKAN LOGIKA COCOK (ROBUST MATCHING) ---
               let pairsConfig = [];
               try { pairsConfig = JSON.parse(opsiRaw); } catch(e){} 

               if(Array.isArray(pairsConfig)) {
                  
                  // 1. Hitung Total Bobot Item (Jika guru mengisi bobot per pasang)
                  let totalDefinedWeight = 0;
                  pairsConfig.forEach(p => {
                      if(p.s && !isNaN(p.s)) totalDefinedWeight += parseFloat(p.s);
                  });

                  // Tentukan Bobot Akhir Soal & Bobot Per Item
                  const useItemWeight = totalDefinedWeight > 0;
                  finalBobotSoal = useItemWeight ? totalDefinedWeight : bobotGlobal;
                  const weightPerItem = useItemWeight ? 0 : (bobotGlobal / pairsConfig.length);

                  let currentScore = 0;
                  
                  // 2. LOGIKA PENCOCOKAN: ABAIKAN URUTAN
                  if (typeof jwb === 'object' && jwb !== null) {
                      
                      // Langkah A: Buat Kamus Jawaban Siswa yang Dinormalisasi
                      // Format: { "kunci_huruf_kecil": "nilai_huruf_kecil" }
                      let studentMap = {};
                      Object.keys(jwb).forEach(studentKey => {
                          const cleanKey = String(studentKey).trim().toLowerCase();
                          const cleanVal = String(jwb[studentKey]).trim().toLowerCase();
                          studentMap[cleanKey] = cleanVal;
                      });

                      // Langkah B: Loop Kunci Jawaban (Database)
                      pairsConfig.forEach(p => {
                          // Ambil pasangan Benar dari DB
                          const dbKey = String(p.k).trim().toLowerCase(); 
                          const dbValRight = String(p.v).trim().toLowerCase();
                          const itemScore = useItemWeight ? parseFloat(p.s || 0) : weightPerItem;

                          // Cek apakah siswa punya jawaban untuk Kunci Kiri ini?
                          if (studentMap.hasOwnProperty(dbKey)) {
                              // Cek apakah Nilai Kanannya cocok?
                              if (studentMap[dbKey] === dbValRight) {
                                  // BENAR (Match!)
                                  currentScore += itemScore;
                              }
                          }
                      });
                  }
                  
                  // Pembulatan score agar rapi (2 desimal)
                  skorItem = parseFloat(currentScore.toFixed(2));
                  
                  // Safety: Skor tidak boleh melebihi bobot total soal (misal karena pembulatan)
                  if(skorItem > finalBobotSoal) skorItem = finalBobotSoal;
               }
            }
        }
        
        // Akumulasi Bobot Total Seluruh Ujian (Untuk penyebut nilai akhir)
        totalBobotSeluruhSoal += finalBobotSoal;

        let opsiParsed = {};
        try { opsiParsed = JSON.parse(opsiRaw); } catch(e){}

        listSoal.push({
           id: idSoal,
           tipe: tipe,
           soal: r[3],
           opsi: opsiParsed,
           kunci: kunci,
           bobot: finalBobotSoal, // Kirim bobot yang sudah diperbaiki (Total Item atau Global)
           jawabanSiswa: jawabanSiswa[idSoal], 
           skor: parseFloat(skorItem)
        });
     }
  });

  return { 
     status: 'success', 
     soal: listSoal, 
     totalBobot: parseFloat(totalBobotSeluruhSoal.toFixed(2)),
     nilaiAkhir: rowData[9],
     rowIndex: rowIndex
  };
}

// 3. Simpan Nilai Koreksi (Draft / Publish)
function simpanNilaiGuru(payload) {
  try {
     const ss = SpreadsheetApp.openById(SS_ID);
     const sheet = ss.getSheetByName("DB_Nilai");
     const rowIndex = parseInt(payload.rowIndex);
     
     // Payload: { rowIndex, skorJson (String), nilaiAkhir (Number/Null), action: 'save'|'publish' }

     // 1. Simpan Draft Skor Per Soal (Kolom 11 / Index 10)
     // Jika kolom belum ada, sheet akan otomatis handle set value di range
     sheet.getRange(rowIndex, 11).setValue(payload.skorJson);

     // 2. Simpan Nilai Akhir (Kolom 10 / Index 9)
     if (payload.action === 'publish') {
        sheet.getRange(rowIndex, 10).setValue(payload.nilaiAkhir);
        return { status: 'success', message: 'Nilai berhasil dipublikasikan ke siswa!' };
     } else {
        return { status: 'success', message: 'Koreksi disimpan sementara.' };
     }

  } catch(e) {
     return { status: 'error', message: e.toString() };
  }
}

// 4. Batalkan Kirim (Hapus Nilai Akhir)
function batalkanNilaiAkhir(rowIndex) {
   try {
     const ss = SpreadsheetApp.openById(SS_ID);
     const sheet = ss.getSheetByName("DB_Nilai");
     // Kosongkan Kolom 10 (Nilai Akhir)
     sheet.getRange(rowIndex, 10).setValue(""); 
     return { status: 'success', message: 'Nilai Akhir dibatalkan. Status kembali ke Draft.' };
   } catch(e) {
     return { status: 'error', message: e.toString() };
   }
}

// ==========================================
// API BARU: DETAIL PERHITUNGAN NILAI (TRANSPARANSI)
// ==========================================
function getDetailPerhitungan(idJadwal, username) {
  const ss = SpreadsheetApp.openById(SS_ID);
  
  // 1. Ambil Data Nilai dari DB_Nilai
  const sheetNilai = ss.getSheetByName("DB_Nilai");
  const dataNilai = sheetNilai.getDataRange().getValues();
  let rowNilai = null;
  
  // Cari baris berdasarkan ID Jadwal & Username
  for(let i=1; i<dataNilai.length; i++) {
     if(String(dataNilai[i][1]) === String(idJadwal) && String(dataNilai[i][2]) === String(username)) {
        rowNilai = dataNilai[i];
        break;
     }
  }
  
  if(!rowNilai) return { status: 'error', message: 'Data nilai tidak ditemukan.' };

  // Ambil Data Jawaban & Skor Manual (jika ada)
  let jawabanSiswa = {};
  try { jawabanSiswa = JSON.parse(rowNilai[7]); } catch(e){} // Kolom 8: Jawaban JSON
  
  let skorManual = {}; 
  try { skorManual = JSON.parse(rowNilai[10]); } catch(e){} // Kolom 11: Skor JSON (Hasil Koreksi Guru)

  const nilaiAkhirDb = rowNilai[9]; // Kolom 10: Nilai Akhir

  // 2. Ambil Data Mapel & Soal
  const sheetJadwal = ss.getSheetByName("DB_Jadwal");
  const dataJadwal = sheetJadwal.getDataRange().getValues();
  let kodeMapel = "";
  for(let j=1; j<dataJadwal.length; j++) {
     if(String(dataJadwal[j][0]) === String(idJadwal)) { kodeMapel = dataJadwal[j][2]; break; }
  }

  const sheetSoal = ss.getSheetByName("DB_Soal");
  const dataSoal = sheetSoal.getDataRange().getValues();
  dataSoal.shift();

  let details = [];
  let totalBobot = 0;
  let totalSkor = 0;

  dataSoal.forEach((r, idx) => {
     if(String(r[1]).toLowerCase() === String(kodeMapel).toLowerCase()) {
        const idSoal = r[0];
        const tipe = r[2];
        const kunci = r[6];
        const opsiRaw = r[5];
        
        // --- 1. Tentukan Bobot Maksimal Soal ---
        let bobotMaks = (r[7] && !isNaN(r[7])) ? parseFloat(r[7]) : 1;
        
        // Khusus COCOK: Jika guru set bobot per item di JSON Opsi, hitung totalnya
        if (tipe === 'COCOK') {
            let pairs = []; try { pairs = JSON.parse(opsiRaw); } catch(e){}
            let sumItemWeight = 0;
            if(Array.isArray(pairs)) {
               pairs.forEach(p => { if(p.s && !isNaN(p.s)) sumItemWeight += parseFloat(p.s); });
            }
            if(sumItemWeight > 0) bobotMaks = sumItemWeight; 
        }

        totalBobot += bobotMaks;

        // --- 2. Tentukan Skor Perolehan Siswa ---
        let skorSiswa = 0;

        // A. Jika ada Skor Manual dari Guru (Prioritas Utama untuk Essay/Koreksi)
        if (skorManual[idSoal] !== undefined) {
            skorSiswa = parseFloat(skorManual[idSoal]);
        } 
        // B. Jika tidak ada manual, hitung otomatis (Logika PG/BS/COCOK)
        else {
            const jwb = jawabanSiswa[idSoal];
            
            if (tipe === 'PG' || tipe === 'BS') {
               if (String(jwb).trim().toUpperCase() === String(kunci).trim().toUpperCase()) {
                   skorSiswa = bobotMaks;
               }
            }
            else if (tipe === 'COCOK') {
               // Hitung parsial untuk cocok
               let pairs = []; try { pairs = JSON.parse(opsiRaw); } catch(e){}
               if(Array.isArray(pairs) && typeof jwb === 'object' && jwb !== null) {
                  // Normalisasi jawaban siswa
                  let mapJwb = {};
                  Object.keys(jwb).forEach(k => mapJwb[k.trim().toLowerCase()] = String(jwb[k]).trim().toLowerCase());
                  
                  // Hitung per item
                  const weightPerItem = (bobotMaks / pairs.length); // Default rata
                  
                  pairs.forEach(p => {
                     let itemW = (p.s && !isNaN(p.s)) ? parseFloat(p.s) : weightPerItem;
                     // Jika bobot total diambil dari item (sumItemWeight > 0), maka p.s pasti ada.
                     // Jika tidak, pakai rata-rata.
                     
                     const dbKey = String(p.k).trim().toLowerCase();
                     const dbVal = String(p.v).trim().toLowerCase();
                     
                     if (mapJwb[dbKey] === dbVal) {
                        skorSiswa += itemW;
                     }
                  });
               }
            }
        }
        
        // Pembulatan Skor Siswa agar rapi
        skorSiswa = parseFloat(skorSiswa.toFixed(2));
        totalSkor += skorSiswa;

        details.push({
           no: details.length + 1,
           tipe: tipe,
           bobot: parseFloat(bobotMaks.toFixed(2)),
           skor: skorSiswa
        });
     }
  });

  return {
     status: 'success',
     data: {
        nama: rowNilai[3],
        mapel: rowNilai[4],
        details: details,
        totalBobot: parseFloat(totalBobot.toFixed(2)),
        totalSkor: parseFloat(totalSkor.toFixed(2)),
        nilaiAkhir: nilaiAkhirDb
     }
  };
}

// ==========================================
// API 10: FITUR ABSENSI (BARU)
// ==========================================

// Cek apakah siswa sudah absen di ujian ini
function cekStatusAbsensi(username, idJadwal) {
  const ss = SpreadsheetApp.openById(SS_ID);
  const sheet = ss.getSheetByName("DB_Absensi");
  
  if (!sheet) return { status: 'belum', message: 'Sheet belum ada' };

  // Gunakan TextFinder untuk pencarian cepat (Format ID Unik: username_idJadwal)
  const idUnik = username + "_" + idJadwal;
  const finder = sheet.createTextFinder(idUnik).matchEntireCell(true);
  const result = finder.findNext();

  if (result) {
    return { status: 'sudah' };
  }
  return { status: 'belum' };
}

// Simpan Absensi
function simpanAbsensi(payload) {
  try {
    const ss = SpreadsheetApp.openById(SS_ID);
    let sheet = ss.getSheetByName("DB_Absensi");
    
    // Buat sheet jika belum ada
    if (!sheet) {
      sheet = ss.insertSheet("DB_Absensi");
      sheet.appendRow(["ID_Unik", "Waktu", "Username", "Nama", "ID_Jadwal", "Mapel", "Tanda_Tangan"]);
    }

    const idUnik = payload.username + "_" + payload.idJadwal;
    
    // Cek duplikasi (Double Submit Prevention)
    const finder = sheet.createTextFinder(idUnik).matchEntireCell(true);
    if (finder.findNext()) return { status: 'success', message: 'Data sudah ada' };

    // Simpan Tanda Tangan (Bisa base64 string panjang, sheet mampu menampung 50k karakter per cell)
    // Jika ingin disimpan ke Drive sebagai file gambar, gunakan fungsi saveBase64ToDrive yang sudah ada di kode Anda.
    // Di sini saya simpan string base64-nya langsung agar cepat.
    
    sheet.appendRow([
      idUnik,
      new Date(),
      payload.username,
      payload.nama,
      payload.idJadwal,
      payload.mapel,
      payload.signature // Base64 String
    ]);

    return { status: 'success' };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

// ==========================================
// API: AMBIL DATA ABSENSI SISWA (FIXED TIMEZONE WITA)
// ==========================================
function getDataAbsensi(idJadwal) {
  const ss = SpreadsheetApp.openById(SS_ID);
  const sheet = ss.getSheetByName("DB_Absensi");
  if (!sheet) return [];
  
  const data = sheet.getDataRange().getValues();
  data.shift(); // Lewati Header
  
  // PERBAIKAN DI SINI:
  // Ubah "Asia/Jakarta" menjadi "Asia/Makassar" agar sesuai WITA
  const formatTgl = (d) => {
      try { 
          return Utilities.formatDate(new Date(d), "Asia/Makassar", "dd MMM yyyy HH:mm:ss"); 
      } catch(e) { return "-"; }
  };

  let result = [];
  // Loop dari bawah (data terbaru)
  for (let i = data.length - 1; i >= 0; i--) {
     let r = data[i];
     // Struktur DB_Absensi: [0:ID, 1:Waktu, 2:User, 3:Nama, 4:IdJadwal, 5:Mapel, 6:TTD]
     
     if (String(r[4]) === String(idJadwal)) {
        result.push({
           waktu: formatTgl(r[1]), // Ini sekarang akan menghasilkan jam WITA
           nama: r[3],
           username: r[2],
           signature: r[6]
        });
     }
  }
  return result;
}
