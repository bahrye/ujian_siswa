// ==========================================
// KONFIGURASI
// ==========================================
const SS_ID = '1L2NpLGZlnVA_gRvEshCQoXeCaYlsPXXEsBdAfkqXOSg'; 

// ==========================================
// 0. SETUP AWAL (Jalankan sekali manual untuk Izin)
// ==========================================
function setupIzinAwal() {
  const ss = SpreadsheetApp.openById(SS_ID);
  console.log("Akses DB OK: " + ss.getName());
  
  const folderName = "CBT_Assets";
  const folders = DriveApp.getFoldersByName(folderName);
  if (folders.hasNext()) {
    console.log("Folder Drive OK.");
  } else {
    DriveApp.createFolder(folderName);
    console.log("Folder Drive Dibuat.");
  }
}

// ==========================================
// ROUTING & HTML
// ==========================================
function doGet(e) {
  return HtmlService.createTemplateFromFile('index')
      .evaluate()
      .setTitle('CBT Ujian Online')
      .addMetaTag('viewport', 'width=device-width, initial-scale=1')
      .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

// ==========================================
// HELPER: INCLUDE FILE HTML LAIN
// ==========================================
function include(filename) {
  return HtmlService.createHtmlOutputFromFile(filename)
      .getContent();
}

// ==========================================
// API 1: LOGIN (Update Logic Role)
// ==========================================
function loginUser(username, password) {
  try {
    const ss = SpreadsheetApp.openById(SS_ID);
    const sheet = ss.getSheetByName("Users");
    if (!sheet) return { status: 'error', message: 'DB Users tidak ditemukan!' };

    const data = sheet.getDataRange().getValues();
    data.shift(); // Skip Header

    for (let i = 0; i < data.length; i++) {
      let row = data[i];
      // [0:id, 1:username, 2:password, 3:role, 4:nama, 5:kelas, 6:status]
      if (row[1] == username && row[2] == password) {
        if(row[6] && row[6].toString().toLowerCase() !== 'aktif') {
          return { status: 'error', message: 'Akun dinonaktifkan.' };
        }
        
        // Normalisasi role ke lowercase agar konsisten
        const role = row[3].toString().toLowerCase();
        
        return { 
          status: 'success', 
          role: role, 
          nama: row[4], 
          kelas: row[5] 
        };
      }
    }
    return { status: 'error', message: 'Username/Password salah.' };
  } catch (e) {
    return { status: 'error', message: 'Server Error: ' + e.toString() };
  }
}

// ==========================================
// API BARU: DASHBOARD STATS
// ==========================================
function getDashboardStats() {
  const ss = SpreadsheetApp.openById(SS_ID);
  
  // Hitung User
  const sheetUser = ss.getSheetByName("Users");
  const users = sheetUser ? sheetUser.getLastRow() - 1 : 0;
  
  // Hitung Soal
  const sheetSoal = ss.getSheetByName("DB_Soal");
  const soals = sheetSoal ? sheetSoal.getLastRow() - 1 : 0;
  
  // Hitung Ujian Masuk
  const sheetNilai = ss.getSheetByName("DB_Nilai");
  const nilais = sheetNilai ? sheetNilai.getLastRow() - 1 : 0;

  return { users, soals, nilais };
}

// ==========================================
// API 2: ADMIN - SIMPAN SOAL (AUTO UPLOAD IMAGE)
// ==========================================

function simpanSoal(data) {
  try {
    const ss = SpreadsheetApp.openById(SS_ID);
    const sheet = ss.getSheetByName("DB_Soal");
    
    // 1. PROSES GAMBAR DALAM EDITOR SOAL (HTML)
    // Cari tag <img src="data:image..."> dan upload ke Drive otomatis
    let processedSoal = processHtmlImages(data.soal);

    // 2. PROSES GAMBAR DALAM OPSI JAWABAN (JSON)
    let opsis = {};
    try { opsis = JSON.parse(data.opsiJson); } catch(e) {}
    
    // Loop keys (img_A, img_B, dst)
    for (let key in opsis) {
      if (key.startsWith('img_') && opsis[key] && opsis[key].toString().startsWith('data:image/')) {
        // Upload Base64 Opsi ke Drive, ganti value dengan URL
        opsis[key] = saveBase64ToDrive(opsis[key], "OPSI-" + key);
      }
    }
    const processedOpsi = JSON.stringify(opsis);

    // 3. SIMPAN DATA KE SPREADSHEET
    const idSoal = data.id ? data.id : "Q-" + Date.now();
    
    // Cek Mode Edit
    if (data.id) {
       const allData = sheet.getDataRange().getValues();
       for (let i = 1; i < allData.length; i++) {
         if (allData[i][0].toString() === data.id.toString()) {
            // Update Row [ID, Mapel, Tipe, Soal, Img(Legacy), Opsi, Kunci]
            sheet.getRange(i + 1, 1, 1, 7).setValues([[
               data.id, data.mapel, data.tipe, 
               processedSoal, // HTML yang src-nya sudah jadi Link Drive
               "", // Kolom Image Legacy dikosongkan saja (karena gambar sudah masuk HTML/Opsi)
               processedOpsi, // JSON yang img-nya sudah jadi Link Drive
               data.kunci
            ]]);
            return { status: 'success', message: 'Soal Berhasil Diupdate!' };
         }
       }
       return { status: 'error', message: 'ID Soal tidak ditemukan saat update.' };
    } 

    // Mode Tambah Baru
    sheet.appendRow([
      idSoal, 
      data.mapel, 
      data.tipe, 
      processedSoal, 
      "", // Legacy Image Column (Empty)
      processedOpsi, 
      data.kunci
    ]);

    return { status: 'success', message: 'Soal Tersimpan!' };

  } catch (e) {
    return { status: 'error', message: 'Server Error: ' + e.toString() };
  }
}

// --- FUNGSI BANTUAN (HELPER) ---

// A. Fungsi Upload Base64 ke Drive
function saveBase64ToDrive(base64Str, namePrefix) {
  try {
    // Cek folder
    const folderName = "CBT_Assets";
    const folders = DriveApp.getFoldersByName(folderName);
    let folder = folders.hasNext() ? folders.next() : DriveApp.createFolder(folderName);
    
    // Decode Base64
    const contentType = base64Str.substring(5, base64Str.indexOf(';'));
    const cleanBase64 = base64Str.substring(base64Str.indexOf(',') + 1);
    const decoded = Utilities.base64Decode(cleanBase64);
    const blob = Utilities.newBlob(decoded, contentType, namePrefix + "_" + Date.now());
    
    // Create File & Set Permission
    const file = folder.createFile(blob);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    
    // Return Download URL (agar bisa tampil di HTML <img src="...">)
    // Menggunakan 'https://lh3.googleusercontent.com/d/ID' lebih cepat loadingnya dibanding getDownloadUrl standar
    return "https://lh3.googleusercontent.com/d/" + file.getId();
    
  } catch(e) {
    // Jika gagal upload, kembalikan string asli (resiko error 50k char tetap ada, tapi minimal tidak crash script)
    return base64Str; 
  }
}

// B. Fungsi Scan & Replace Image di HTML Quill
function processHtmlImages(htmlContent) {
  if (!htmlContent) return "";
  
  // Regex untuk mencari src="data:image/..."
  // Pola: src="(data:image/[^;]+;base64,[^"]+)"
  const regex = /src="(data:image\/[^;]+;base64,[^"]+)"/g;
  
  return htmlContent.replace(regex, function(match, base64Data) {
    // Setiap ketemu gambar base64, upload ke drive
    const newUrl = saveBase64ToDrive(base64Data, "SOAL-IMG");
    return 'src="' + newUrl + '"'; // Ganti src dengan URL Drive
  });
}

// ==========================================
// API 2: ADMIN - UPDATE BANK SOAL
// ==========================================

// A. AMBIL DATA SOAL (Bisa Filter Mapel)
function getSoalAdmin(filterMapel) {
  const ss = SpreadsheetApp.openById(SS_ID);
  const sheet = ss.getSheetByName("DB_Soal");
  if (!sheet) return [];
  
  const data = sheet.getDataRange().getValues();
  data.shift(); // Skip Header
  
  // [0:id, 1:mapel, 2:tipe, 3:soal, 4:img, 5:opsi_json, 6:kunci]
  let result = [];
  
  // Balik urutan agar yang terbaru di atas (loop dari bawah)
  for (let i = data.length - 1; i >= 0; i--) {
    let row = data[i];
    // Jika filterMapel kosong, ambil semua. Jika ada, cocokan.
    if (!filterMapel || (row[1] && row[1].toString() === filterMapel)) {
      result.push({
        id: row[0],
        mapel: row[1],
        tipe: row[2],
        soal: row[3], // HTML Soal
        opsi: row[5], // JSON String
        kunci: row[6]
      });
    }
  }
  return result;
}

// B. HAPUS SOAL
function hapusSoalDb(idSoal) {
  const ss = SpreadsheetApp.openById(SS_ID);
  const sheet = ss.getSheetByName("DB_Soal");
  const data = sheet.getDataRange().getValues();
  
  for (let i = 1; i < data.length; i++) {
    if (data[i][0].toString() === idSoal.toString()) {
      sheet.deleteRow(i + 1);
      return { status: 'success', message: 'Soal berhasil dihapus.' };
    }
  }
  return { status: 'error', message: 'ID Soal tidak ditemukan.' };
}

// ==========================================
// API 3: SISWA - AMBIL SOAL
// ==========================================
function getSoalUjian(kodeMapel) {
  try {
    const ss = SpreadsheetApp.openById(SS_ID);
    const sheet = ss.getSheetByName("DB_Soal");
    const data = sheet.getDataRange().getValues();
    data.shift(); 

    let soalList = [];
    
    for (let i = 0; i < data.length; i++) {
      let row = data[i];
      // Cek Kode Mapel (Case Insensitive)
      if (row[1].toString().toLowerCase() === kodeMapel.toLowerCase()) {
        
        // Parse JSON Opsi
        let opsiObj = {};
        try { opsiObj = JSON.parse(row[5]); } catch (e) {}

        soalList.push({
          id: row[0],
          tipe: row[2],
          pertanyaan: row[3],
          gambar: row[4],
          opsi: opsiObj 
          // Kunci jawaban TIDAK dikirim ke frontend demi keamanan
        });
      }
    }

    if (soalList.length === 0) {
      return { status: 'error', message: 'Soal tidak ditemukan untuk Mapel: ' + kodeMapel };
    }

    return { status: 'success', data: soalList };

  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

// ==========================================
// API 4: SUBMIT & KOREKSI UJIAN
// ==========================================
function submitUjian(payload) {
  try {
    const ss = SpreadsheetApp.openById(SS_ID);
    
    // 1. Ambil Kunci Jawaban dari DB_Soal
    const sheetSoal = ss.getSheetByName("DB_Soal");
    const dataSoal = sheetSoal.getDataRange().getValues();
    dataSoal.shift(); // Hapus Header
    
    let kunciJawaban = {}; // { "Q-123": "A", "Q-456": "C" }
    let totalSoalPG = 0;
    
    // Filter soal sesuai Mapel
    for (let i = 0; i < dataSoal.length; i++) {
      let row = dataSoal[i]; // [0:id, 1:mapel, ..., 6:kunci]
      if (row[1].toString().toLowerCase() === payload.mapel.toLowerCase()) {
        // Hanya ambil kunci jika tipe PG
        if (row[2] === "PG") {
          kunciJawaban[row[0]] = row[6]; 
          totalSoalPG++;
        }
      }
    }

    // 2. Hitung Nilai
    let benar = 0;
    let detailKoreksi = {}; // Untuk debug/riwayat
    
    // Loop jawaban siswa
    for (let idSoal in payload.jawaban) {
      const jwbSiswa = payload.jawaban[idSoal];
      const jwbKunci = kunciJawaban[idSoal];
      
      // Cek Benar/Salah
      if (jwbKunci && jwbSiswa === jwbKunci) {
        benar++;
        detailKoreksi[idSoal] = "BENAR";
      } else {
        detailKoreksi[idSoal] = "SALAH";
      }
    }

    // Rumus Nilai (Skala 100)
    // Jika soal essay, nilai sementara hanya dari PG
    let nilaiAkhir = 0;
    if (totalSoalPG > 0) {
      nilaiAkhir = Math.round((benar / totalSoalPG) * 100);
    }

    // 3. Simpan ke DB_Nilai
    const sheetNilai = ss.getSheetByName("DB_Nilai");
    if (!sheetNilai) return { status: 'error', message: 'Sheet DB_Nilai belum dibuat!' };

    sheetNilai.appendRow([
      new Date(),           // Timestamp
      "UJIAN-" + Date.now(),// ID Ujian (Dummy)
      payload.nama,         // Nama Siswa
      payload.mapel,        // Mapel
      nilaiAkhir,           // Nilai
      benar + " / " + totalSoalPG, // Jumlah Benar
      JSON.stringify(payload.jawaban) // Simpan JSON jawaban mentah
    ]);

    return { 
      status: 'success', 
      nilai: nilaiAkhir, 
      benar: benar, 
      total: totalSoalPG,
      message: 'Ujian Selesai! Nilai Anda: ' + nilaiAkhir 
    };

  } catch (e) {
    return { status: 'error', message: 'Gagal Submit: ' + e.toString() };
  }
}

// ==========================================
// API 5: VERIFIKASI TOKEN PENGAWAS (UNLOCK)
// ==========================================
function verifikasiTokenUnlock(tokenInput) {
  // Disini kita set Token Statis dulu: "ADMIN123"
  // Nanti bisa diambil dari Sheet "Users" role Pengawas
  const TOKEN_RAHASIA = "ADMIN123";
  
  if (tokenInput === TOKEN_RAHASIA) {
    return { status: 'success' };
  } else {
    return { status: 'error', message: 'Token Salah!' };
  }
}

// ==========================================
// API 6: KELOLA AKUN (CRUD USERS)
// ==========================================

// A. AMBIL SEMUA DATA USER
function getAllUsers() {
  const ss = SpreadsheetApp.openById(SS_ID);
  const sheet = ss.getSheetByName("Users");
  if (!sheet) return [];
  
  const data = sheet.getDataRange().getValues();
  data.shift(); // Hapus Header
  
  // Mapping array ke object biar rapi di JS
  return data.map(row => ({
    id: row[0],
    username: row[1],
    password: row[2],
    role: row[3],
    nama: row[4],
    kelas: row[5],
    status: row[6]
  }));
}

// B. TAMBAH / EDIT USER
function simpanUser(data) {
  try {
    const ss = SpreadsheetApp.openById(SS_ID);
    const sheet = ss.getSheetByName("Users");
    
    // Validasi sederhana
    if (!data.username || !data.password || !data.nama) {
      return { status: 'error', message: 'Data tidak lengkap!' };
    }

    // Jika Mode EDIT (ada ID)
    if (data.id) {
      const allData = sheet.getDataRange().getValues();
      // Cari baris berdasarkan ID (Kolom A / Index 0)
      let rowIndex = -1;
      for (let i = 1; i < allData.length; i++) {
        if (allData[i][0].toString() === data.id.toString()) {
          rowIndex = i + 1; // Row di sheet mulai dari 1
          
          // CEK KEAMANAN: Jangan edit jika role target adalah ADMIN (kecuali via sheet)
          if (allData[i][3].toString().toLowerCase() === 'admin') {
             return { status: 'error', message: 'Akun ADMIN hanya bisa diedit lewat Spreadsheet!' };
          }
          break;
        }
      }

      if (rowIndex !== -1) {
        // Update Baris
        sheet.getRange(rowIndex, 2, 1, 6).setValues([[
          data.username, data.password, data.role, data.nama, data.kelas || '-', data.status
        ]]);
        return { status: 'success', message: 'User berhasil diperbarui!' };
      } else {
        return { status: 'error', message: 'ID User tidak ditemukan.' };
      }

    } else {
      // Mode TAMBAH BARU
      const newId = "U-" + Date.now();
      sheet.appendRow([
        newId, data.username, data.password, data.role, data.nama, data.kelas || '-', 'Aktif'
      ]);
      return { status: 'success', message: 'User baru ditambahkan!' };
    }

  } catch (e) {
    return { status: 'error', message: 'DB Error: ' + e.toString() };
  }
}

// C. HAPUS USER
function hapusUser(id) {
  try {
    const ss = SpreadsheetApp.openById(SS_ID);
    const sheet = ss.getSheetByName("Users");
    const data = sheet.getDataRange().getValues();
    
    for (let i = 1; i < data.length; i++) {
      if (data[i][0].toString() === id.toString()) {
        // CEK KEAMANAN: Jangan hapus ADMIN
        if (data[i][3].toString().toLowerCase() === 'admin') {
           return { status: 'error', message: 'Akun ADMIN tidak boleh dihapus!' };
        }
        
        sheet.deleteRow(i + 1);
        return { status: 'success', message: 'User dihapus.' };
      }
    }
    return { status: 'error', message: 'User tidak ditemukan.' };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

// ==========================================
// API 7: KELOLA MAPEL
// ==========================================

// A. AMBIL DATA MAPEL
function getAllMapel() {
  const ss = SpreadsheetApp.openById(SS_ID);
  let sheet = ss.getSheetByName("DB_Mapel");
  
  // Buat sheet jika belum ada
  if (!sheet) {
    sheet = ss.insertSheet("DB_Mapel");
    sheet.appendRow(["ID", "Kode Mapel", "Nama Mapel", "Guru Pengampu"]); // Header
    return [];
  }
  
  const data = sheet.getDataRange().getValues();
  data.shift(); // Hapus Header
  
  return data.map(row => ({
    id: row[0],
    kode: row[1],
    nama: row[2],
    guru: row[3]
  }));
}

// B. SIMPAN MAPEL (BARU / EDIT)
function simpanMapel(data) {
  try {
    const ss = SpreadsheetApp.openById(SS_ID);
    let sheet = ss.getSheetByName("DB_Mapel");
    if (!sheet) return { status: 'error', message: 'Sheet DB_Mapel tidak ditemukan' };
    
    // Validasi
    if (!data.kode || !data.nama) return { status: 'error', message: 'Kode dan Nama Mapel wajib diisi!' };
    
    // Pastikan Kode Mapel Unik (untuk tambah baru)
    const allData = sheet.getDataRange().getValues();
    if (!data.id) {
       for(let i=1; i<allData.length; i++) {
         if(allData[i][1].toString().toLowerCase() === data.kode.toString().toLowerCase()) {
           return { status: 'error', message: 'Kode Mapel sudah ada!' };
         }
       }
    }

    if (data.id) {
      // EDIT
      let rowIndex = -1;
      for (let i = 1; i < allData.length; i++) {
        if (allData[i][0].toString() === data.id.toString()) {
          rowIndex = i + 1;
          break;
        }
      }
      if (rowIndex !== -1) {
        sheet.getRange(rowIndex, 2, 1, 3).setValues([[ data.kode, data.nama, data.guru ]]);
        return { status: 'success', message: 'Mapel diperbarui!' };
      }
    } else {
      // TAMBAH BARU
      const newId = "M-" + Date.now();
      sheet.appendRow([ newId, data.kode, data.nama, data.guru ]);
      return { status: 'success', message: 'Mapel ditambahkan!' };
    }
    return { status: 'error', message: 'Gagal menyimpan.' };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

// C. HAPUS MAPEL
function hapusMapel(id) {
  try {
    const ss = SpreadsheetApp.openById(SS_ID);
    const sheet = ss.getSheetByName("DB_Mapel");
    const data = sheet.getDataRange().getValues();
    
    for (let i = 1; i < data.length; i++) {
      if (data[i][0].toString() === id.toString()) {
        sheet.deleteRow(i + 1);
        return { status: 'success', message: 'Mapel dihapus.' };
      }
    }
    return { status: 'error', message: 'Mapel tidak ditemukan.' };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

// D. AMBIL LIST GURU (Untuk Dropdown)
function getListGuru() {
  const ss = SpreadsheetApp.openById(SS_ID);
  const sheet = ss.getSheetByName("Users");
  const data = sheet.getDataRange().getValues();
  data.shift();
  
  // Filter hanya role 'guru'
  let gurus = [];
  data.forEach(row => {
    // row[3] adalah Role, row[4] adalah Nama
    if (row[3] && row[3].toString().toLowerCase() === 'guru') {
      gurus.push(row[4]);
    }
  });
  return gurus;
}

// ==========================================
// API 8: KELOLA UJIAN (JENIS & JADWAL)
// ==========================================

// A. JENIS UJIAN (Master Nama Ujian)
function getJenisUjian() {
  const ss = SpreadsheetApp.openById(SS_ID);
  let sheet = ss.getSheetByName("DB_JenisUjian");
  if (!sheet) {
    sheet = ss.insertSheet("DB_JenisUjian");
    sheet.appendRow(["ID", "Nama Ujian", "Keterangan", "Status"]); 
    return [];
  }
  const data = sheet.getDataRange().getValues();
  data.shift();
  return data.map(r => ({ id: r[0], nama: r[1], ket: r[2], status: r[3] }));
}

function simpanJenisUjian(data) {
  const ss = SpreadsheetApp.openById(SS_ID);
  let sheet = ss.getSheetByName("DB_JenisUjian");
  const allData = sheet.getDataRange().getValues();

  if (data.id) { // Edit
    for (let i = 1; i < allData.length; i++) {
      if (allData[i][0].toString() === data.id.toString()) {
        sheet.getRange(i + 1, 2, 1, 3).setValues([[data.nama, data.ket, data.status]]);
        return { status: 'success', message: 'Jenis Ujian diupdate!' };
      }
    }
  } else { // Baru
    const newId = "UJ-" + Date.now();
    sheet.appendRow([newId, data.nama, data.ket, data.status]);
    return { status: 'success', message: 'Jenis Ujian dibuat!' };
  }
  return { status: 'error', message: 'Gagal menyimpan.' };
}

function hapusJenisUjian(id) {
  return hapusDataUmum(id, "DB_JenisUjian");
}

function hapusJadwal(id) {
  return hapusDataUmum(id, "DB_Jadwal");
}

// Helper Hapus Global
function hapusDataUmum(id, sheetName) {
  const ss = SpreadsheetApp.openById(SS_ID);
  const sheet = ss.getSheetByName(sheetName);
  const data = sheet.getDataRange().getValues();
  for (let i = 1; i < data.length; i++) {
    if (data[i][0].toString() === id.toString()) {
      sheet.deleteRow(i + 1);
      return { status: 'success', message: 'Data dihapus.' };
    }
  }
  return { status: 'error', message: 'Data tidak ditemukan.' };
}

// ==========================================
// API BARU: PENGAWAS
// ==========================================

// 3. Generate Token Buka Kunci (Perorangan)
function generateUnlockToken(username) {
  // Token random 4 digit
  const token = Math.floor(1000 + Math.random() * 9000).toString();
  // Simpan di properties sementara (valid 5 menit idealnya, tapi disini kita simpan static)
  const props = PropertiesService.getScriptProperties();
  props.setProperty(`UNLOCK_${username}`, token);
  return token;
}

// Helper: Token Berubah tiap 15 Menit
function generateTimeBasedToken() {
  const secret = "RAHASIA_SEKOLAH"; // Ganti string ini
  const epoch = Math.floor(Date.now() / (15 * 60 * 1000)); // Berubah tiap 15 menit
  const hash = Utilities.computeDigest(Utilities.DigestAlgorithm.MD5, secret + epoch);
  // Ambil 6 karakter hex dari hash, uppercase
  let token = "";
  for (let i = 0; i < hash.length; i++) {
    let byte = hash[i];
    if (byte < 0) byte += 256;
    let byteStr = byte.toString(16);
    if (byteStr.length == 1) byteStr = "0" + byteStr;
    token += byteStr;
    if (token.length >= 6) break;
  }
  return token.toUpperCase();
}

// Update Start Exam untuk set status
function startExamSession(username, idJadwal) {
   const props = PropertiesService.getScriptProperties();
   props.setProperty(`STATUS_${username}_${idJadwal}`, 'STARTED');
}

// ==========================================
// API TAMBAHAN: MONITORING ADMIN & HASIL
// ==========================================

// 1. Ambil Data Hasil Ujian (Semua / Filter)
function getHasilUjianAdmin(filterMapel) {
  const ss = SpreadsheetApp.openById(SS_ID);
  const sheet = ss.getSheetByName("DB_Nilai");
  if (!sheet) return [];
  
  const data = sheet.getDataRange().getValues();
  data.shift(); // Skip Header
  // [0:Timestamp, 1:ID_Ujian, 2:Nama, 3:Mapel, 4:Nilai, 5:Benar, 6:JawabanJSON]
  
  let result = [];
  // Loop dari bawah (terbaru)
  for (let i = data.length - 1; i >= 0; i--) {
    let row = data[i];
    // Filter Mapel jika ada
    if (!filterMapel || (row[3] && row[3].toString() === filterMapel)) {
      result.push({
        waktu: row[0],
        nama: row[2],
        mapel: row[3],
        nilai: row[4],
        detail: row[5]
      });
    }
  }
  return result;
}

// ==========================================
// UPDATE: TOKEN & MONITORING PER UJIAN
// ==========================================

// 1. Generate Token Unik per Jadwal (Bukan Global)
function generateTokenForExam(idJadwal) {
  const secret = "RAHASIA_SEKOLAH_SECURE"; 
  // Token berubah tiap 15 menit
  const epoch = Math.floor(Date.now() / (15 * 60 * 1000)); 
  
  // Gabungkan Secret + ID Jadwal + Waktu agar unik per ujian
  const raw = secret + idJadwal + epoch;
  const hash = Utilities.computeDigest(Utilities.DigestAlgorithm.MD5, raw);
  
  // Ambil 6 karakter hex
  let token = "";
  for (let i = 0; i < hash.length; i++) {
    let byte = hash[i];
    if (byte < 0) byte += 256;
    let byteStr = byte.toString(16);
    if (byteStr.length == 1) byteStr = "0" + byteStr;
    token += byteStr;
    if (token.length >= 6) break;
  }
  return token.toUpperCase();
}

// 2. Update Verifikasi Token (Terima parameter idJadwal)
function verifikasiTokenUjian(inputToken, idJadwal) {
  // Generate token yang seharusnya untuk jadwal tersebut
  const validToken = generateTokenForExam(idJadwal);
  
  if (inputToken === validToken) {
    return { status: 'success' };
  } else {
    return { status: 'error', message: 'Token Salah atau Kadaluarsa!' };
  }
}

// 4. Update Monitoring Siswa (Return Data Siswa + Token Ujian Tersebut)
function getMonitoringSiswa(idJadwal) {
  const ss = SpreadsheetApp.openById(SS_ID);
  
  // Generate Token untuk ujian ini saat ini juga
  const currentToken = generateTokenForExam(idJadwal);
  
  // Ambil User Siswa
  const sheetUser = ss.getSheetByName("Users");
  const users = sheetUser.getDataRange().getValues().filter(r => r[3].toLowerCase() === 'siswa');
  
  // Ambil Data Nilai (Selesai)
  const sheetNilai = ss.getSheetByName("DB_Nilai");
  const dataNilai = sheetNilai ? sheetNilai.getDataRange().getValues() : [];
  
  const props = PropertiesService.getScriptProperties();
  
  let result = [];
  users.forEach(u => {
    const username = u[1];
    const nama = u[4];
    const kelas = u[5];
    
    let status = "BELUM";
    let nilai = "-";
    let isLocked = false;

    // Cek Selesai (Berdasarkan ID Jadwal di kolom mapel/refensi nilai jika ada, 
    // atau sementara berdasarkan kode mapel jika DB Nilai belum simpan ID Jadwal)
    // Note: Agar akurat, pastikan DB_Nilai menyimpan ID Jadwal. 
    // Untuk kode ini kita asumsikan check sederhana dulu:
    const selesai = dataNilai.find(n => n[2] === nama && n[3].toString().includes(idJadwal)); 
    // *Tips: Sebaiknya saat submit ujian, simpan ID Jadwal juga.

    const stateKey = `STATUS_${username}_${idJadwal}`;
    const stateVal = props.getProperty(stateKey);

    if (selesai) {
      status = "SELESAI";
      nilai = selesai[4];
    } else if (stateVal === 'STARTED') {
      status = "SEDANG MENGERJAKAN";
    } else if (stateVal === 'LOCKED') {
      status = "TERKUNCI";
      isLocked = true;
    }

    result.push({ nama, kelas, status, nilai, isLocked, username });
  });
  
  // Return Object berisi Siswa dan Token
  return { 
    students: result, 
    token: currentToken 
  };
}

// 5. Update Monitoring Admin (List Ujian + Token masing-masing)
function getAdminMonitoringSummary() {
  try {
    const ss = SpreadsheetApp.openById(SS_ID);
    const sheetJadwal = ss.getSheetByName("DB_Jadwal");
    
    // Validasi Sheet
    if (!sheetJadwal) {
      console.log("Error: Sheet DB_Jadwal tidak ditemukan.");
      return { exams: [] }; 
    }
    
    const dataJadwal = sheetJadwal.getDataRange().getValues();
    
    // Validasi Data Kosong (Hanya header atau kosong)
    if (dataJadwal.length <= 1) {
      console.log("Info: DB_Jadwal kosong (hanya header).");
      return { exams: [] };
    }

    dataJadwal.shift(); // Hapus Header
    
    // Ambil jenis ujian dengan aman
    let jenisUjian = [];
    try {
      jenisUjian = getJenisUjian();
    } catch (err) {
      console.log("Warning: Gagal ambil Jenis Ujian. " + err.toString());
    }
  
    let activeExams = [];
    
    // Loop Data
    dataJadwal.forEach((r, index) => {
      // Ambil kolom Status (Index 5)
      // Gunakan toString() dan trim() untuk membersihkan spasi tidak terlihat
      const rawStatus = r[5] ? r[5].toString() : "";
      const status = rawStatus.trim().toLowerCase(); // ubah ke huruf kecil semua
      
      // Cek Status (case-insensitive: 'aktif', 'Aktif', 'AKTIF' semua diterima)
      if (status === 'aktif') {
        const idJadwal = r[0];
        
        // Cari Nama Jenis Ujian (Index 1)
        const idJenis = r[1];
        const objJenis = jenisUjian.find(j => j.id === idJenis);
        const namaJenis = objJenis ? objJenis.nama : idJenis;

        // Generate Token
        let thisToken = "ERROR";
        try {
          thisToken = generateTokenForExam(idJadwal);
        } catch (errToken) {
          console.log("Error Token untuk " + idJadwal + ": " + errToken.toString());
        }
        
        activeExams.push({
          id: idJadwal,
          jenis: namaJenis,
          mapel: r[2], // Nama Mapel/Kode Mapel
          mulai: r[3],
          selesai: r[4],
          token: thisToken
        });
      } else {
        // Log untuk debug baris yang tidak aktif (Bisa dicek di Executions Log)
        console.log(`Baris ${index + 2} dilewati. Status: '${rawStatus}'`);
      }
    });

    console.log(`Ditemukan ${activeExams.length} ujian aktif.`);
    return { exams: activeExams };

  } catch (e) {
    console.log("CRITICAL ERROR getAdminMonitoringSummary: " + e.toString());
    return { exams: [] };
  }
}

// ==========================================
// UPDATE: FILTER PENGAWAS & CRUD JADWAL
// ==========================================

// 1. Ambil List User Role Pengawas (Untuk Dropdown)
function getListPengawas() {
  const ss = SpreadsheetApp.openById(SS_ID);
  const sheet = ss.getSheetByName("Users");
  const data = sheet.getDataRange().getValues();
  data.shift();
  
  // Filter role = 'pengawas'
  let list = [];
  data.forEach(r => {
    if(r[3].toString().toLowerCase() === 'pengawas') {
      list.push({ username: r[1], nama: r[4] });
    }
  });
  return list;
}

// 2. Update Get Jadwal (Baca Kolom Pengawas)
function getJadwalUjian() {
  const ss = SpreadsheetApp.openById(SS_ID);
  let sheet = ss.getSheetByName("DB_Jadwal");
  if (!sheet) {
    sheet = ss.insertSheet("DB_Jadwal");
    sheet.appendRow(["ID", "ID_Jenis", "Kode_Mapel", "Mulai", "Selesai", "Status", "Pengawas"]);
    return [];
  }
  const data = sheet.getDataRange().getValues();
  data.shift();
  
  const jenis = getJenisUjian(); 
  const mapel = getAllMapel(); 
  
  return data.map(r => {
    const j = jenis.find(x => x.id === r[1]);
    const m = mapel.find(x => x.kode === r[2]);
    
    // --- TAMBAHAN KODE PERBAIKAN TANGGAL ---
    // Fungsi kecil untuk format tanggal sesuai input HTML (datetime-local)
    // Menggunakan Asia/Jakarta agar tidak lari ke UTC
    const formatTime = (dateObj) => {
      if (!dateObj) return "";
      try {
        return Utilities.formatDate(new Date(dateObj), "Asia/Jakarta", "yyyy-MM-dd'T'HH:mm");
      } catch (e) {
        return "";
      }
    };
    // ----------------------------------------

    return {
      id: r[0],
      id_jenis: r[1],
      nama_ujian: j ? j.nama : r[1], 
      kode_mapel: r[2],
      nama_mapel: m ? m.nama : r[2],
      
      // Gunakan fungsi formatTime di sini
      mulai: formatTime(r[3]),   
      selesai: formatTime(r[4]), 
      
      status: r[5],
      pengawas: r[6] || '' 
    };
  });
}

// 3. Update Simpan Jadwal (Simpan Kolom Pengawas)
function simpanJadwal(data) {
  const ss = SpreadsheetApp.openById(SS_ID);
  let sheet = ss.getSheetByName("DB_Jadwal");
  // Pastikan header ada 7 kolom jika sheet baru dibuat
  if (!sheet) { sheet = ss.insertSheet("DB_Jadwal"); sheet.appendRow(["ID", "ID_Jenis", "Kode_Mapel", "Mulai", "Selesai", "Status", "Pengawas"]); }
  
  const allData = sheet.getDataRange().getValues();
  
  if(new Date(data.mulai) >= new Date(data.selesai)) {
     return { status: 'error', message: 'Waktu Selesai harus lebih akhir dari Mulai.' };
  }

  // Data yang akan disimpan (7 Kolom)
  // [ID, Jenis, Mapel, Mulai, Selesai, Status, Pengawas]
  const rowData = [data.id_jenis, data.kode_mapel, data.mulai, data.selesai, data.status, data.pengawas];

  if (data.id) { // Edit
    for (let i = 1; i < allData.length; i++) {
      if (allData[i][0].toString() === data.id.toString()) {
        // Update range kolom 2 sampai 7
        sheet.getRange(i + 1, 2, 1, 6).setValues([rowData]);
        return { status: 'success', message: 'Jadwal diperbarui!' };
      }
    }
  } else { // Baru
    const newId = "SCH-" + Date.now();
    sheet.appendRow([newId, ...rowData]);
    return { status: 'success', message: 'Jadwal ditambahkan!' };
  }
  return { status: 'error', message: 'Error DB.' };
}

// 4. Update Dashboard Pengawas (FILTER JADWAL)
// Menerima parameter usernamePengawas dari Frontend
function getPengawasDashboard(usernamePengawas) {
  const ss = SpreadsheetApp.openById(SS_ID);
  const sheetJadwal = ss.getSheetByName("DB_Jadwal");
  
  // Handle jika sheet belum ada
  if(!sheetJadwal) return { jadwal: [] };

  const dataJadwal = sheetJadwal.getDataRange().getValues();
  dataJadwal.shift();
  
  let jadwalAktif = [];
  dataJadwal.forEach(r => {
    // r[5] = Status, r[6] = Pengawas Assigned
    const status = r[5];
    const assignedTo = r[6] ? r[6].toString() : "";

    // Logika Filter:
    // 1. Status harus Aktif
    // 2. Kolom Pengawas harus cocok dengan username yg login, ATAU kosong (Semua), ATAU 'semua'
    if (status === 'Aktif') {
       if (assignedTo === "" || assignedTo.toLowerCase() === 'semua' || assignedTo === usernamePengawas) {
          jadwalAktif.push({ 
            id: r[0], 
            mapel: r[2], 
            mulai: r[3], 
            selesai: r[4] 
          });
       }
    }
  });

  return { jadwal: jadwalAktif };
}
