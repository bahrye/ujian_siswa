<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="UTF-8">
    <title>CBT EXAM SYSTEM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <style>
      body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; overflow-x: hidden; }
      
      /* Utilities */
      .glass-panel {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
      }
      .input-std {
        width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem;
        outline: none; transition: all 0.2s;
      }
      .input-std:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
      
      /* Hide Scrollbar but allow scroll */
      .no-scrollbar::-webkit-scrollbar { display: none; }
      .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
  </head>
  <body>

    <div id="login-container" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-900 to-indigo-900 p-4">
      <div class="glass-panel w-full max-w-md p-8 rounded-2xl animate__animated animate__zoomIn">
        <div class="text-center mb-8">
          <h1 class="text-3xl font-extrabold text-slate-800">CBT EXAM</h1>
          <p class="text-gray-500 text-sm mt-1">Computer Based Test System</p>
        </div>
        
        <form onsubmit="doLogin(event)" class="space-y-5">
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">Username</label>
            <input type="text" id="user" class="input-std" placeholder="NIS / NIP" required>
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">Password</label>
            <input type="password" id="pass" class="input-std" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
          </div>
          <button type="submit" id="btnLogin" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg shadow-lg transition transform hover:-translate-y-1">
            MASUK APLIKASI
          </button>
        </form>
        <p class="text-center text-xs text-gray-400 mt-6">Ver 1.2 Beta &copy; 2024</p>
      </div>
    </div>

    <div id="admin-container" class="hidden min-h-screen flex flex-col bg-gray-50">
      <nav class="bg-slate-900 text-white px-6 py-4 flex justify-between items-center shadow-lg sticky top-0 z-50">
        <span class="font-bold text-xl tracking-wide">ADMIN PANEL</span>
        <button onclick="logout()" class="text-sm bg-red-600 px-4 py-2 rounded hover:bg-red-700 transition">Logout</button>
      </nav>

      <div class="flex-1 container mx-auto p-6 max-w-5xl">
        <div class="bg-white rounded-xl shadow-md p-8 animate__animated animate__fadeIn">
          <h2 class="text-2xl font-bold text-gray-800 border-b pb-4 mb-6">üìù Input Bank Soal</h2>
          
          <form id="formSoal" onsubmit="submitSoal(event)" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block font-semibold mb-1">Kode Mapel</label>
                <input type="text" name="mapel" class="input-std" placeholder="Contoh: MTK-X" required>
              </div>
              <div>
                <label class="block font-semibold mb-1">Tipe Soal</label>
                <select name="tipe" class="input-std bg-white">
                  <option value="PG">Pilihan Ganda</option>
                  <option value="ESSAY">Uraian / Essay</option>
                </select>
              </div>
            </div>

            <div>
              <label class="block font-semibold mb-1">Pertanyaan</label>
              <textarea name="soal" rows="3" class="input-std" placeholder="Tulis isi soal..." required></textarea>
            </div>

            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:bg-indigo-50 transition cursor-pointer relative group">
              <input type="file" accept="image/*" onchange="handleFile(this)" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
              <div id="upload-placeholder">
                <p class="text-gray-500 font-medium group-hover:text-indigo-600">Klik untuk upload gambar (Opsional)</p>
                <p class="text-xs text-gray-400">Max 2MB</p>
              </div>
              <img id="preview" class="hidden max-h-48 mx-auto rounded shadow relative z-10 pointer-events-none">
            </div>

            <div class="bg-gray-50 p-5 rounded-lg border space-y-3">
              <p class="text-sm font-bold text-gray-700 mb-2">Pilihan Jawaban (Isi yang diperlukan saja)</p>
              <div class="flex gap-2 items-center"><span class="w-6 font-bold text-center">A</span><input type="text" name="opsiA" class="input-std" placeholder="Opsi A"></div>
              <div class="flex gap-2 items-center"><span class="w-6 font-bold text-center">B</span><input type="text" name="opsiB" class="input-std" placeholder="Opsi B"></div>
              <div class="flex gap-2 items-center"><span class="w-6 font-bold text-center">C</span><input type="text" name="opsiC" class="input-std" placeholder="Opsi C"></div>
              <div class="flex gap-2 items-center"><span class="w-6 font-bold text-center">D</span><input type="text" name="opsiD" class="input-std" placeholder="Opsi D"></div>
              <div class="flex gap-2 items-center"><span class="w-6 font-bold text-center text-gray-400">E</span><input type="text" name="opsiE" class="input-std border-dashed" placeholder="(Opsional)"></div>
            </div>

            <div>
              <label class="block font-semibold mb-1">Kunci Jawaban</label>
              <select name="kunci" class="input-std bg-white" required>
                <option value="">-- Pilih --</option>
                <option value="A">A</option> <option value="B">B</option> <option value="C">C</option> <option value="D">D</option> <option value="E">E</option>
                <option value="ESSAY">ESSAY</option>
              </select>
            </div>

            <button type="submit" id="btnSave" class="w-full py-3 bg-emerald-600 hover:bg-emerald-700 text-white font-bold rounded-lg shadow-lg">SIMPAN SOAL</button>
          </form>
        </div>
      </div>
    </div>

    <div id="page-siswa" class="hidden fixed inset-0 z-50 bg-gray-100 flex flex-col font-sans">
      
      <header class="bg-slate-900 text-white px-4 py-3 shadow-md flex justify-between items-center z-20 shrink-0">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-indigo-600 rounded-full flex items-center justify-center font-bold text-lg border-2 border-indigo-400">S</div>
          <div class="leading-tight">
            <h1 class="font-bold text-sm md:text-base" id="header-nama">Nama Siswa</h1>
            <p class="text-xs text-gray-400" id="header-mapel">Mapel</p>
          </div>
        </div>
        <div class="bg-slate-800 px-3 py-1.5 rounded border border-slate-700 flex items-center gap-2">
          <span class="text-lg">‚è±Ô∏è</span>
          <span id="timer-display" class="font-mono text-lg font-bold text-yellow-400">--:--</span>
        </div>
      </header>

      <div class="flex-1 flex flex-col md:flex-row overflow-hidden relative">
        
        <main class="flex-1 overflow-y-auto p-4 md:p-6 relative bg-gray-100" id="main-exam-area">
          
          <div id="exam-loading" class="hidden flex flex-col items-center justify-center h-full text-gray-500">
            <svg class="animate-spin h-12 w-12 text-indigo-600 mb-3" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <p>Mengunduh Soal...</p>
          </div>

          <div id="soal-container" class="hidden max-w-4xl mx-auto bg-white rounded-2xl shadow-sm border border-gray-200 p-6 md:p-8 min-h-[500px]">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
              <span class="bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full text-sm font-bold">No. <span id="disp-no">1</span></span>
              <div class="flex gap-1 text-sm">
                <button onclick="resizeFont(-2)" class="px-2 border rounded hover:bg-gray-100">A-</button>
                <button onclick="resizeFont(2)" class="px-2 border rounded hover:bg-gray-100">A+</button>
              </div>
            </div>

            <div id="disp-pertanyaan" class="text-gray-800 text-lg leading-relaxed mb-6 font-medium"></div>

            <div id="disp-gambar-container" class="hidden mb-6">
              <img id="disp-gambar" src="" class="max-h-64 rounded-lg border border-gray-300 shadow-sm cursor-zoom-in hover:opacity-95" onclick="zoomImage(this)">
            </div>

            <div id="disp-opsi" class="space-y-3">
              </div>
          </div>

          <div id="nav-buttons" class="hidden max-w-4xl mx-auto mt-6 flex justify-between gap-2 pb-10">
            <button onclick="prevSoal()" class="px-4 py-3 bg-white border text-gray-700 rounded-lg hover:bg-gray-50 font-semibold shadow-sm">‚¨Ö Prev</button>
            <button onclick="toggleRagu()" id="btn-ragu" class="px-4 py-3 bg-yellow-100 text-yellow-700 border border-yellow-300 rounded-lg hover:bg-yellow-200 font-semibold shadow-sm">Ragu</button>
            <button onclick="nextSoal()" class="px-4 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold shadow-md">Next ‚û°</button>
          </div>
        </main>

        <aside class="w-full md:w-72 bg-white border-l border-gray-200 flex flex-col shadow-xl z-30" id="sidebar-nav">
          <div class="p-3 bg-gray-50 border-b font-bold text-gray-700 text-center">Navigasi Soal</div>
          <div class="flex-1 overflow-y-auto p-4">
            <div id="grid-nomor" class="grid grid-cols-5 gap-2">
              </div>
          </div>
          <div class="p-4 border-t bg-gray-50">
            <button onclick="selesaiUjian()" class="w-full py-3 bg-gradient-to-r from-green-600 to-emerald-600 text-white font-bold rounded-lg shadow hover:shadow-lg transition">SELESAI ‚úÖ</button>
          </div>
        </aside>

      </div>
    </div>

    <div id="lock-screen" class="hidden fixed inset-0 z-[100] bg-red-900 flex items-center justify-center text-white text-center p-6">
      <div class="max-w-lg w-full animate__animated animate__shakeX">
        <div class="text-6xl mb-4">‚ö†Ô∏è</div>
        <h2 class="text-3xl font-bold mb-2">UJIAN TERKUNCI!</h2>
        <p class="text-red-200 mb-6 text-lg" id="lock-reason">Anda terdeteksi meninggalkan halaman ujian.</p>
        
        <div class="bg-red-800 p-6 rounded-xl border border-red-700 shadow-2xl">
          <p class="text-sm mb-4 font-semibold">Panggil Pengawas untuk membuka kunci.</p>
          <input type="password" id="token-unlock" class="w-full p-3 rounded text-slate-900 text-center font-bold text-xl tracking-widest outline-none mb-4" placeholder="TOKEN PENGAWAS">
          <button onclick="bukaKunci()" id="btnUnlock" class="w-full py-3 bg-white text-red-900 font-bold rounded hover:bg-gray-200 transition">BUKA KUNCI</button>
        </div>
      </div>
    </div>

    <script>
      // --- GLOBALS ---
      let filePayload = null; let fileName = ""; // Admin Upload
      let daftarSoal = []; let jawabanSiswa = {}; let raguSiswa = {}; // Siswa Exam
      let currentIdx = 0; let fontSize = 18;
      let timerInterval = null;
      let sisaWaktuDetik = 0;
      let isExamRunning = false; // Penanda apakah ujian sedang berjalan

      // --- 1. LOGIN ---
      function doLogin(e) {
        e.preventDefault();
        const u = document.getElementById('user').value;
        const p = document.getElementById('pass').value;
        const btn = document.getElementById('btnLogin');

        btn.innerText = "Memproses..."; btn.disabled = true;

        google.script.run
          .withSuccessHandler((res) => {
            btn.innerText = "MASUK APLIKASI"; btn.disabled = false;
            
            if (res.status === 'success') {
              document.getElementById('login-container').classList.add('hidden');
              
              if (res.role === 'admin') {
                document.getElementById('admin-container').classList.remove('hidden');
              } 
              else if (res.role === 'siswa') {
                document.getElementById('header-nama').innerText = res.nama;
                
                // Minta Kode Mapel untuk Test
                Swal.fire({
                  title: 'Masukkan Kode Mapel',
                  input: 'text',
                  inputLabel: 'Sesuai yang diinput Admin (ex: MTK-X)',
                  inputPlaceholder: 'Kode Mapel',
                  allowOutsideClick: false,
                  inputValidator: (value) => {
                    if (!value) return 'Anda harus memasukkan kode mapel!'
                  }
                }).then((result) => {
                  if (result.isConfirmed) {
                    startExam(result.value);
                  }
                });
              }
            } else {
              Swal.fire('Login Gagal', res.message, 'error');
            }
          })
          .withFailureHandler((err) => {
             btn.disabled = false; Swal.fire('Error', err.message, 'error');
          })
          .loginUser(u, p);
      }

      function logout() { location.reload(); }

      // --- 2. ADMIN FUNCTIONS ---
      function handleFile(input) {
        if (input.files && input.files[0]) {
          const f = input.files[0];
          if(f.size > 2 * 1024 * 1024) { Swal.fire('Warning', 'Max 2MB', 'warning'); return; }
          const reader = new FileReader();
          reader.onload = (e) => {
            document.getElementById('preview').src = e.target.result;
            document.getElementById('preview').classList.remove('hidden');
            document.getElementById('upload-placeholder').classList.add('hidden');
            filePayload = e.target.result; fileName = f.name;
          }
          reader.readAsDataURL(f);
        }
      }

      function submitSoal(e) {
        e.preventDefault();
        const f = document.getElementById('formSoal');
        const btn = document.getElementById('btnSave');
        btn.innerText = "MENGUPLOAD..."; btn.disabled = true;

        const data = {
          mapel: f.mapel.value, tipe: f.tipe.value, soal: f.soal.value,
          opsiA: f.opsiA.value, opsiB: f.opsiB.value, opsiC: f.opsiC.value, opsiD: f.opsiD.value, opsiE: f.opsiE.value,
          kunci: f.kunci.value, fileData: filePayload, fileName: fileName
        };

        google.script.run
          .withSuccessHandler((res) => {
            btn.innerText = "SIMPAN SOAL"; btn.disabled = false;
            if(res.status === 'success') {
              Swal.fire('Sukses', 'Soal tersimpan', 'success');
              f.reset(); 
              document.getElementById('preview').classList.add('hidden');
              document.getElementById('upload-placeholder').classList.remove('hidden');
              filePayload = null;
            } else { Swal.fire('Gagal', res.message, 'error'); }
          })
          .withFailureHandler((err) => { btn.disabled = false; Swal.fire('Error', err.message, 'error'); })
          .simpanSoal(data);
      }

      // --- 3. SISWA EXAM LOGIC ---
      function startExam(kodeMapel) {
        isExamRunning = true; // <--- PENTING: Mulai deteksi
        enterFullscreen();    // <--- Paksa Fullscreen

        document.getElementById('page-siswa').classList.remove('hidden');
        document.getElementById('exam-loading').classList.remove('hidden');
        document.getElementById('header-mapel').innerText = kodeMapel;

        // SETTING DURASI UJIAN DISINI (Contoh: 60 Menit)
        // Nanti bisa diambil dari database
        startTimer(60); 

        google.script.run
          .withSuccessHandler(onSoalLoaded)
          .withFailureHandler(err => Swal.fire('Koneksi Error', err.message, 'error'))
          .getSoalUjian(kodeMapel);
      }

      function onSoalLoaded(res) {
        document.getElementById('exam-loading').classList.add('hidden');
        if (res.status === 'success') {
          daftarSoal = res.data;
          document.getElementById('soal-container').classList.remove('hidden');
          document.getElementById('nav-buttons').classList.remove('hidden');
          currentIdx = 0;
          renderGridNomor();
          renderSoal(0);
        } else {
          Swal.fire('Info', res.message, 'warning').then(() => location.reload());
        }
      }

      function renderSoal(idx) {
        currentIdx = idx;
        const soal = daftarSoal[idx];
        
        // Update UI Text
        document.getElementById('disp-no').innerText = idx + 1;
        const divTeks = document.getElementById('disp-pertanyaan');
        divTeks.innerText = soal.pertanyaan;
        divTeks.style.fontSize = fontSize + "px";

        // Image Handling
        const divImg = document.getElementById('disp-gambar-container');
        const img = document.getElementById('disp-gambar');
        if (soal.gambar) {
          divImg.classList.remove('hidden'); img.src = soal.gambar;
        } else { divImg.classList.add('hidden'); }

        // Opsi Handling
        const containerOpsi = document.getElementById('disp-opsi');
        containerOpsi.innerHTML = "";
        ['A', 'B', 'C', 'D', 'E'].forEach(huruf => {
          if (soal.opsi[huruf]) {
            const isSelected = (jawabanSiswa[soal.id] === huruf);
            const style = isSelected 
              ? "bg-indigo-600 text-white border-indigo-600" 
              : "bg-white hover:bg-gray-50 border-gray-300 text-gray-700";
            
            const html = `
              <div onclick="pilih('${soal.id}', '${huruf}')" class="cursor-pointer border rounded-lg p-3 flex gap-3 items-start transition ${style}">
                <div class="w-7 h-7 flex items-center justify-center rounded-full border border-current font-bold text-sm shrink-0">${huruf}</div>
                <div class="flex-1 pt-0.5 text-sm md:text-base">${soal.opsi[huruf]}</div>
              </div>`;
            containerOpsi.insertAdjacentHTML('beforeend', html);
          }
        });

        // Update Ragu Button
        const btnRagu = document.getElementById('btn-ragu');
        if(raguSiswa[soal.id]) {
          btnRagu.className = "px-4 py-3 bg-yellow-500 text-white border border-yellow-600 rounded-lg font-semibold shadow-sm";
        } else {
          btnRagu.className = "px-4 py-3 bg-yellow-100 text-yellow-700 border border-yellow-300 rounded-lg hover:bg-yellow-200 font-semibold shadow-sm";
        }

        renderGridNomor(); // Refresh Grid Highlights
      }

      function pilih(id, huruf) {
        jawabanSiswa[id] = huruf;
        renderSoal(currentIdx);
      }

      function renderGridNomor() {
        const grid = document.getElementById('grid-nomor');
        grid.innerHTML = "";
        daftarSoal.forEach((soal, i) => {
          let cls = "bg-white border-gray-300 text-gray-600";
          if (jawabanSiswa[soal.id]) cls = "bg-indigo-600 border-indigo-600 text-white";
          if (raguSiswa[soal.id]) cls = "bg-yellow-400 border-yellow-400 text-white";
          const active = (i === currentIdx) ? "ring-2 ring-indigo-400 ring-offset-1" : "";
          
          grid.insertAdjacentHTML('beforeend', 
            `<button onclick="renderSoal(${i})" class="w-9 h-9 rounded text-sm font-bold border ${cls} ${active}">${i+1}</button>`
          );
        });
      }

      function nextSoal() { if(currentIdx < daftarSoal.length-1) renderSoal(currentIdx+1); }
      function prevSoal() { if(currentIdx > 0) renderSoal(currentIdx-1); }
      
      function toggleRagu() {
        const id = daftarSoal[currentIdx].id;
        if(raguSiswa[id]) delete raguSiswa[id]; else raguSiswa[id] = true;
        renderSoal(currentIdx);
      }

      function resizeFont(d) { fontSize += d; renderSoal(currentIdx); }
      function zoomImage(img) {
        Swal.fire({ imageUrl: img.src, width: '95%', showConfirmButton: false, background: 'transparent' });
      }
      
      // Tombol Selesai ditekan Siswa
      function selesaiUjian() {
        // Hitung soal belum diisi
        const totalSoal = daftarSoal.length;
        const dijawab = Object.keys(jawabanSiswa).length;
        const belum = totalSoal - dijawab;
        
        let pesan = `Anda sudah menjawab ${dijawab} dari ${totalSoal} soal.`;
        if (belum > 0) pesan += ` <br><b style="color:red">Masih ada ${belum} soal kosong!</b>`;

        Swal.fire({ 
          title: 'Selesai Ujian?', 
          html: pesan, 
          icon: 'question', 
          showCancelButton: true,
          confirmButtonText: 'Ya, Kirim Jawaban',
          cancelButtonText: 'Cek Lagi'
        }).then(res => {
           if(res.isConfirmed) {
             kirimJawabanKeServer(false);
           }
        });
      }

      // Fungsi Inti Submit
      function kirimJawabanKeServer(isAuto) {
        isExamRunning = false; // <--- Matikan deteksi agar tidak terkunci saat selesai
        // Stop Timer
        clearInterval(timerInterval);
        
        // UI Loading
        Swal.fire({
          title: 'Menyimpan Jawaban...',
          text: 'Mohon tunggu, sedang menghitung nilai.',
          allowOutsideClick: false,
          didOpen: () => { Swal.showLoading() }
        });

        // Siapkan Data
        const payload = {
          nama: document.getElementById('header-nama').innerText,
          mapel: document.getElementById('header-mapel').innerText,
          jawaban: jawabanSiswa
        };

        // Kirim
        google.script.run
          .withSuccessHandler((res) => {
             if (res.status === 'success') {
               // Tampilkan Nilai
               let htmlHasil = `
                 <div class="text-center">
                   <h1 class="text-6xl font-bold text-blue-600 mb-2">${res.nilai}</h1>
                   <p class="text-gray-600">Benar: ${res.benar} dari ${res.total} Soal</p>
                 </div>
               `;
               
               Swal.fire({
                 title: 'Ujian Selesai!',
                 html: htmlHasil,
                 icon: 'success',
                 confirmButtonText: 'Logout / Keluar',
                 allowOutsideClick: false
               }).then(() => {
                 logout();
               });
             } else {
               Swal.fire('Gagal Menyimpan', res.message, 'error');
             }
          })
          .withFailureHandler((err) => {
             Swal.fire('Error Koneksi', 'Gagal mengirim jawaban. Coba lagi.\n' + err.message, 'error');
          })
          .submitUjian(payload);
      }

      function startTimer(menit) {
        sisaWaktuDetik = menit * 60;
        
        // Hentikan timer lama jika ada
        if (timerInterval) clearInterval(timerInterval);

        timerInterval = setInterval(() => {
          sisaWaktuDetik--;
          
          // Konversi ke format MM:SS
          const m = Math.floor(sisaWaktuDetik / 60);
          const s = sisaWaktuDetik % 60;
          
          // Tampilkan di Header (Tambahkan 0 di depan jika < 10)
          document.getElementById('timer-display').innerText = 
            `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            
          // Ubah warna jadi merah jika < 5 menit
          if (sisaWaktuDetik < 300) {
            document.getElementById('timer-display').classList.replace('text-yellow-400', 'text-red-500');
            document.getElementById('timer-display').classList.add('animate-pulse');
          }

          // Waktu Habis
          if (sisaWaktuDetik <= 0) {
            clearInterval(timerInterval);
            Swal.fire({
              icon: 'warning',
              title: 'WAKTU HABIS!',
              text: 'Jawaban Anda akan dikirim otomatis.',
              allowOutsideClick: false,
              timer: 3000,
              showConfirmButton: false
            }).then(() => {
              kirimJawabanKeServer(true); // Force Submit
            });
          }
        }, 1000);
      }

      // --- LOGIKA ANTI CURANG ---

      // 1. Deteksi Pindah Tab (Visibility Change)
      document.addEventListener("visibilitychange", () => {
        if (isExamRunning && document.hidden) {
          triggerLock("Terdeteksi Membuka Tab Lain");
        }
      });

      // 2. Deteksi Blur (Klik aplikasi lain / minimize)
      window.addEventListener("blur", () => {
        if (isExamRunning) {
          triggerLock("Terdeteksi Meninggalkan Aplikasi");
        }
      });

      // Fungsi Mengunci Layar
      function triggerLock(alasan) {
        document.getElementById('lock-screen').classList.remove('hidden');
        document.getElementById('lock-reason').innerText = alasan;
      }

      // Fungsi Meminta Fullscreen
      function enterFullscreen() {
        const elem = document.documentElement;
        if (elem.requestFullscreen) {
          elem.requestFullscreen().catch(err => console.log(err));
        }
      }

      // Fungsi Buka Kunci (Dipanggil tombol Token)
      function bukaKunci() {
        const token = document.getElementById('token-unlock').value;
        const btn = document.getElementById('btnUnlock');
        
        if(!token) return Swal.fire('Error', 'Masukkan Token!', 'error');

        btn.innerText = "MEMERIKSA..."; btn.disabled = true;

        google.script.run
          .withSuccessHandler((res) => {
             btn.innerText = "BUKA KUNCI"; btn.disabled = false;
             if (res.status === 'success') {
               // Berhasil Buka
               document.getElementById('lock-screen').classList.add('hidden');
               document.getElementById('token-unlock').value = ""; // Reset input
               enterFullscreen(); // Balik fullscreen lagi
               
               Swal.fire({
                 icon: 'success', 
                 title: 'Terbuka!', 
                 text: 'Jangan ulangi atau ujian akan dihentikan.',
                 timer: 2000, showConfirmButton: false
               });
             } else {
               Swal.fire('Gagal', 'Token Pengawas Salah!', 'error');
             }
          })
          .verifikasiTokenUnlock(token);
      }

    </script>
  </body>
</html>
