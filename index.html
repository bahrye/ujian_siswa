<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="UTF-8">
    <title>CBT SYSTEM PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
      body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
      .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1); }
      .input-std { width: 100%; padding: 0.6rem; border: 1px solid #d1d5db; border-radius: 0.4rem; outline: none; }
      .input-std:focus { border-color: #4f46e5; ring: 2px; }
      
      /* Sidebar Active State */
      .nav-item.active { background-color: #3730a3; border-left: 4px solid #818cf8; }
    </style>
  </head>
  <body>

    <div id="login-container" class="min-h-screen flex items-center justify-center bg-slate-900 p-4">
      <div class="glass-panel w-full max-w-sm p-8 rounded-xl shadow-2xl">
        <div class="text-center mb-6">
          <div class="w-16 h-16 bg-indigo-600 rounded-lg mx-auto flex items-center justify-center mb-3">
            <i class="fas fa-laptop-code text-white text-3xl"></i>
          </div>
          <h1 class="text-2xl font-bold text-slate-800">CBT LOGIN</h1>
          <p class="text-gray-500 text-xs">Admin ‚Ä¢ Guru ‚Ä¢ Pengawas ‚Ä¢ Siswa</p>
        </div>
        
        <form onsubmit="doLogin(event)" class="space-y-4">
          <input type="text" id="user" class="input-std" placeholder="Username" required>
          <input type="password" id="pass" class="input-std" placeholder="Password" required>
          <button type="submit" id="btnLogin" class="w-full py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded transition">
            MASUK
          </button>
        </form>
      </div>
    </div>

    <div id="dashboard-container" class="hidden flex h-screen overflow-hidden bg-gray-100">
      
      <aside class="w-64 bg-slate-900 text-white flex flex-col shadow-xl z-20">
        <div class="h-16 flex items-center gap-3 px-6 border-b border-slate-700 font-bold text-lg tracking-wider">
          <i class="fas fa-graduation-cap text-indigo-400"></i> CBT ADMIN
        </div>

        <div class="p-4 border-b border-slate-800">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-indigo-500 flex items-center justify-center font-bold text-lg">
              <span id="dash-initial">A</span>
            </div>
            <div>
              <p class="text-sm font-semibold" id="dash-nama">User Name</p>
              <p class="text-xs text-indigo-300 uppercase" id="dash-role">Role</p>
            </div>
          </div>
        </div>

        <nav class="flex-1 overflow-y-auto py-4 space-y-1" id="sidebar-menu">
          </nav>

        <div class="p-4 border-t border-slate-800">
          <button onclick="logout()" class="flex items-center gap-3 w-full px-4 py-2 text-red-400 hover:bg-slate-800 rounded transition">
            <i class="fas fa-sign-out-alt"></i> Logout
          </button>
        </div>
      </aside>

      <main class="flex-1 flex flex-col overflow-hidden relative">
        <header class="h-16 bg-white shadow-sm flex items-center justify-between px-6 z-10">
          <h2 class="text-xl font-bold text-gray-700" id="page-title">Dashboard</h2>
          <div class="text-sm text-gray-500" id="current-date"></div>
        </header>

        <div class="flex-1 overflow-y-auto p-6" id="main-view-area">
          
          <div id="view-dashboard" class="space-y-6 animate__animated animate__fadeIn">
             <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
               <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-blue-500">
                 <div class="flex justify-between items-start">
                   <div>
                     <p class="text-gray-500 text-sm">Total Pengguna</p>
                     <h3 class="text-3xl font-bold text-gray-800 mt-1" id="stat-user">-</h3>
                   </div>
                   <div class="p-3 bg-blue-50 text-blue-600 rounded-lg"><i class="fas fa-users text-xl"></i></div>
                 </div>
               </div>
               <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-green-500">
                 <div class="flex justify-between items-start">
                   <div>
                     <p class="text-gray-500 text-sm">Bank Soal</p>
                     <h3 class="text-3xl font-bold text-gray-800 mt-1" id="stat-soal">-</h3>
                   </div>
                   <div class="p-3 bg-green-50 text-green-600 rounded-lg"><i class="fas fa-book text-xl"></i></div>
                 </div>
               </div>
               <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-purple-500">
                 <div class="flex justify-between items-start">
                   <div>
                     <p class="text-gray-500 text-sm">Ujian Masuk</p>
                     <h3 class="text-3xl font-bold text-gray-800 mt-1" id="stat-nilai">-</h3>
                   </div>
                   <div class="p-3 bg-purple-50 text-purple-600 rounded-lg"><i class="fas fa-file-signature text-xl"></i></div>
                 </div>
               </div>
             </div>

             <div class="bg-blue-50 border border-blue-200 rounded-xl p-6">
               <h3 class="font-bold text-blue-800 text-lg mb-2">Selamat Datang!</h3>
               <p class="text-blue-700">Silakan pilih menu di samping untuk mengelola aplikasi Computer Based Test ini. Pastikan Anda logout setelah selesai menggunakan sistem.</p>
             </div>
          </div>

          <div id="view-bank-soal" class="hidden animate__animated animate__fadeIn">
            <div class="bg-white rounded-xl shadow-md p-8 max-w-4xl mx-auto">
              <h2 class="text-xl font-bold text-gray-800 border-b pb-4 mb-6">üìù Input Soal Baru</h2>
              <form id="formSoal" onsubmit="submitSoal(event)" class="space-y-5">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                  <div>
                    <label class="block text-sm font-semibold mb-1">Kode Mapel</label>
                    <input type="text" name="mapel" class="input-std" placeholder="Contoh: MTK-X" required>
                  </div>
                  <div>
                    <label class="block text-sm font-semibold mb-1">Tipe Soal</label>
                    <select name="tipe" class="input-std bg-white">
                      <option value="PG">Pilihan Ganda</option>
                      <option value="ESSAY">Essay</option>
                    </select>
                  </div>
                </div>

                <div>
                  <label class="block text-sm font-semibold mb-1">Pertanyaan</label>
                  <textarea name="soal" rows="3" class="input-std" placeholder="Isi pertanyaan..." required></textarea>
                </div>

                <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer bg-gray-50 relative group">
                   <input type="file" accept="image/*" onchange="handleFile(this)" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                   <div id="upload-placeholder">
                     <i class="fas fa-image text-gray-400 text-2xl mb-1"></i>
                     <p class="text-xs text-gray-500">Upload Gambar (Max 2MB)</p>
                   </div>
                   <img id="preview" class="hidden h-32 mx-auto object-contain rounded relative z-10">
                </div>

                <div class="bg-gray-50 p-4 rounded-lg border">
                  <p class="text-xs font-bold text-gray-600 mb-2 uppercase">Pilihan Jawaban</p>
                  <div class="grid gap-2">
                    <div class="flex gap-2"><span class="w-6 pt-1 font-bold text-center text-sm">A</span><input type="text" name="opsiA" class="input-std py-1 text-sm"></div>
                    <div class="flex gap-2"><span class="w-6 pt-1 font-bold text-center text-sm">B</span><input type="text" name="opsiB" class="input-std py-1 text-sm"></div>
                    <div class="flex gap-2"><span class="w-6 pt-1 font-bold text-center text-sm">C</span><input type="text" name="opsiC" class="input-std py-1 text-sm"></div>
                    <div class="flex gap-2"><span class="w-6 pt-1 font-bold text-center text-sm">D</span><input type="text" name="opsiD" class="input-std py-1 text-sm"></div>
                    <div class="flex gap-2"><span class="w-6 pt-1 font-bold text-center text-gray-400 text-sm">E</span><input type="text" name="opsiE" class="input-std py-1 text-sm border-dashed"></div>
                  </div>
                </div>

                <div>
                  <label class="block text-sm font-semibold mb-1">Kunci Jawaban</label>
                  <select name="kunci" class="input-std bg-white" required>
                    <option value="">-- Pilih --</option>
                    <option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option><option value="E">E</option>
                    <option value="ESSAY">ESSAY</option>
                  </select>
                </div>

                <button type="submit" id="btnSave" class="w-full py-3 bg-emerald-600 hover:bg-emerald-700 text-white font-bold rounded-lg shadow">SIMPAN DATA</button>
              </form>
            </div>
          </div>

          <div id="view-akun" class="hidden animate__animated animate__fadeIn">
            
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
              <div class="flex bg-white rounded-lg p-1 shadow-sm border overflow-x-auto max-w-full">
                <button onclick="filterTab('all', this)" class="tab-btn px-4 py-2 rounded-md text-sm font-bold bg-indigo-100 text-indigo-700">Semua</button>
                <button onclick="filterTab('admin', this)" class="tab-btn px-4 py-2 rounded-md text-sm font-bold text-gray-500 hover:bg-gray-50">Admin</button>
                <button onclick="filterTab('guru', this)" class="tab-btn px-4 py-2 rounded-md text-sm font-bold text-gray-500 hover:bg-gray-50">Guru</button>
                <button onclick="filterTab('pengawas', this)" class="tab-btn px-4 py-2 rounded-md text-sm font-bold text-gray-500 hover:bg-gray-50">Pengawas</button>
                <button onclick="filterTab('siswa', this)" class="tab-btn px-4 py-2 rounded-md text-sm font-bold text-gray-500 hover:bg-gray-50">Siswa</button>
              </div>

              <div class="flex gap-2">
                <button onclick="loadUsers()" class="px-4 py-2 bg-white border border-gray-300 text-gray-600 rounded-lg hover:bg-gray-50 transition shadow-sm">
                  <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <button onclick="bukaModalUser()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition shadow-lg flex items-center gap-2">
                  <i class="fas fa-plus"></i> Tambah User
                </button>
              </div>
            </div>

            <div class="bg-white rounded-xl shadow-md overflow-hidden border border-gray-200">
              <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                  <thead class="bg-gray-50 text-gray-600 uppercase text-xs tracking-wider">
                    <tr>
                      <th class="p-4 border-b">Nama Lengkap</th>
                      <th class="p-4 border-b">Username / Role</th>
                      <th class="p-4 border-b">Kelas</th>
                      <th class="p-4 border-b">Status</th>
                      <th class="p-4 border-b text-right">Aksi</th>
                    </tr>
                  </thead>
                  <tbody id="tbody-users" class="text-sm text-gray-700 divide-y divide-gray-100">
                    <tr><td colspan="5" class="p-6 text-center text-gray-400">Memuat data...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div id="view-placeholder" class="hidden flex flex-col items-center justify-center h-64 text-gray-400">
            <i class="fas fa-tools text-5xl mb-3"></i>
            <p class="text-lg">Fitur ini sedang dalam pengembangan.</p>
          </div>

          <div id="modal-user" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm">
            <div class="bg-white w-full max-w-lg rounded-xl shadow-2xl p-6 animate__animated animate__zoomIn">
              <div class="flex justify-between items-center mb-5 border-b pb-3">
                <h3 class="text-xl font-bold text-gray-800" id="modal-title">Tambah User</h3>
                <button onclick="tutupModalUser()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
              </div>
              
              <form onsubmit="simpanUser(event)" class="space-y-4">
                <input type="hidden" id="u-id">
                
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Role</label>
                    <select id="u-role" class="input-std bg-gray-50" onchange="toggleKelasInput()" required>
                      <option value="siswa">Siswa</option>
                      <option value="guru">Guru</option>
                      <option value="pengawas">Pengawas</option>
                      <option value="admin">Admin</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Status Akun</label>
                    <select id="u-status" class="input-std bg-gray-50">
                      <option value="Aktif">Aktif</option>
                      <option value="Nonaktif">Nonaktif (Banned)</option>
                    </select>
                  </div>
                </div>

                <div>
                  <label class="block text-xs font-bold text-gray-500 mb-1">Nama Lengkap</label>
                  <input type="text" id="u-nama" class="input-std" placeholder="Nama User" required>
                </div>

                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Username</label>
                    <input type="text" id="u-username" class="input-std" placeholder="NIS / NIP" required>
                  </div>
                  <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Password</label>
                    <input type="text" id="u-password" class="input-std" placeholder="Password" required>
                  </div>
                </div>

                <div id="div-kelas">
                  <label class="block text-xs font-bold text-gray-500 mb-1">Kelas (Khusus Siswa)</label>
                  <input type="text" id="u-kelas" class="input-std" placeholder="Contoh: XII-RPL-1">
                </div>

                <div class="pt-4 flex justify-end gap-3">
                  <button type="button" onclick="tutupModalUser()" class="px-4 py-2 rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200 font-semibold">Batal</button>
                  <button type="submit" id="btnSimpanUser" class="px-6 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 font-bold shadow">Simpan</button>
                </div>
              </form>
            </div>
          </div>

        </div>
      </main>
    </div>

    <div id="page-siswa" class="hidden fixed inset-0 z-50 bg-gray-100 flex flex-col font-sans">
        <header class="bg-slate-900 text-white px-4 py-3 flex justify-between items-center z-20 shrink-0">
             <div class="flex items-center gap-3">
               <div class="w-10 h-10 bg-indigo-600 rounded-full flex items-center justify-center font-bold">S</div>
               <div><h1 class="font-bold text-sm" id="header-nama">Siswa</h1><p class="text-xs text-gray-400" id="header-mapel">-</p></div>
             </div>
             <div class="bg-slate-800 px-3 py-1.5 rounded text-lg font-mono font-bold text-yellow-400" id="timer-display">--:--</div>
        </header>
        <main class="flex-1 overflow-y-auto p-4 relative" id="main-exam-area">
             <div id="exam-loading" class="flex flex-col items-center justify-center h-full text-gray-500">
                <i class="fas fa-spinner fa-spin text-3xl mb-2"></i> <p>Memuat Soal...</p>
             </div>
             <div id="soal-container" class="hidden max-w-4xl mx-auto bg-white rounded p-6 shadow-sm min-h-[400px]">
                <div class="flex justify-between mb-4"><span class="bg-indigo-100 text-indigo-800 px-3 py-1 rounded text-sm font-bold">No. <span id="disp-no">1</span></span></div>
                <div id="disp-pertanyaan" class="text-lg mb-4"></div>
                <div id="disp-gambar-container" class="hidden mb-4"><img id="disp-gambar" class="max-h-64 rounded border"></div>
                <div id="disp-opsi" class="space-y-2"></div>
             </div>
             <div id="nav-buttons" class="hidden max-w-4xl mx-auto mt-4 flex justify-between">
                <button onclick="prevSoal()" class="px-4 py-2 bg-white border rounded">Prev</button>
                <button onclick="toggleRagu()" id="btn-ragu" class="px-4 py-2 bg-yellow-100 text-yellow-700 border rounded">Ragu</button>
                <button onclick="nextSoal()" class="px-4 py-2 bg-indigo-600 text-white rounded">Next</button>
             </div>
        </main>
        <aside class="hidden md:flex w-64 bg-white border-l flex-col z-30" id="sidebar-nav">
           <div class="p-3 border-b font-bold text-center">Navigasi</div>
           <div class="flex-1 p-3"><div id="grid-nomor" class="grid grid-cols-5 gap-2"></div></div>
           <div class="p-3"><button onclick="selesaiUjian()" class="w-full py-2 bg-green-600 text-white rounded font-bold">SELESAI</button></div>
        </aside>
    </div>

    <div id="lock-screen" class="hidden fixed inset-0 z-[100] bg-red-900 flex items-center justify-center text-white text-center p-6">
       <div class="max-w-md w-full">
         <i class="fas fa-lock text-5xl mb-4"></i>
         <h2 class="text-2xl font-bold mb-2">TERKUNCI!</h2>
         <p id="lock-reason" class="mb-4 text-red-200">Anda keluar dari aplikasi.</p>
         <input type="password" id="token-unlock" class="w-full p-2 text-black text-center text-xl font-bold rounded mb-3" placeholder="TOKEN PENGAWAS">
         <button onclick="bukaKunci()" id="btnUnlock" class="w-full py-2 bg-white text-red-900 font-bold rounded">BUKA KUNCI</button>
       </div>
    </div>

    <script>
      // --- GLOBALS & UTILS ---
      let currentUserRole = '';
      let filePayload = null; let fileName = "";
      
      // Global Exam Vars
      let daftarSoal = []; let jawabanSiswa = {}; let raguSiswa = {}; 
      let currentIdx = 0; let timerInterval = null; let sisaWaktuDetik = 0; let isExamRunning = false;

      let allUsers = [];
      let currentTabRole = 'all';

      // Update Tanggal
      document.getElementById('current-date').innerText = new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

      // --- 1. LOGIN LOGIC ---
      function doLogin(e) {
        e.preventDefault();
        const u = document.getElementById('user').value;
        const p = document.getElementById('pass').value;
        const btn = document.getElementById('btnLogin');
        
        btn.innerText = "Loading..."; btn.disabled = true;

        google.script.run
          .withSuccessHandler((res) => {
             btn.innerText = "MASUK"; btn.disabled = false;
             if (res.status === 'success') {
               currentUserRole = res.role;
               
               // Route berdasarkan Role
               if (currentUserRole === 'siswa') {
                 setupSiswaView(res);
               } else {
                 setupDashboardView(res);
               }
             } else {
               Swal.fire('Login Gagal', res.message, 'error');
             }
          })
          .withFailureHandler((err) => { btn.disabled = false; Swal.fire('Error', err.message, 'error'); })
          .loginUser(u, p);
      }

      function logout() { location.reload(); }

      // --- 2. DASHBOARD LOGIC (ADMIN/GURU/PENGAWAS) ---
      function setupDashboardView(user) {
        document.getElementById('login-container').classList.add('hidden');
        document.getElementById('dashboard-container').classList.remove('hidden');
        
        // Set Profile Info
        document.getElementById('dash-nama').innerText = user.nama;
        document.getElementById('dash-initial').innerText = user.nama.charAt(0);
        document.getElementById('dash-role').innerText = user.role;

        // Render Sidebar Menu berdasarkan Role
        renderMenu(user.role);

        // Load Stats Awal
        google.script.run.withSuccessHandler(stats => {
           document.getElementById('stat-user').innerText = stats.users;
           document.getElementById('stat-soal').innerText = stats.soals;
           document.getElementById('stat-nilai').innerText = stats.nilais;
        }).getDashboardStats();
      }

      function renderMenu(role) {
        const menuContainer = document.getElementById('sidebar-menu');
        menuContainer.innerHTML = '';

        // Definisi Menu
        const menus = [
          { id: 'dashboard', icon: 'fa-home', label: 'Dashboard', roles: ['admin', 'guru', 'pengawas'] },
          { id: 'akun', icon: 'fa-users-cog', label: 'Kelola Akun', roles: ['admin'] },
          { id: 'mapel', icon: 'fa-tags', label: 'Kelola Mapel', roles: ['admin', 'guru'] },
          { id: 'bank-soal', icon: 'fa-file-alt', label: 'Bank Soal', roles: ['admin', 'guru'] },
          { id: 'ujian', icon: 'fa-clock', label: 'Jadwal Ujian', roles: ['admin', 'guru'] },
          { id: 'monitoring', icon: 'fa-desktop', label: 'Monitoring', roles: ['admin', 'pengawas'] },
          { id: 'hasil', icon: 'fa-poll', label: 'Hasil Ujian', roles: ['admin', 'guru'] },
        ];

        menus.forEach(m => {
          if (m.roles.includes(role)) {
            const isActive = m.id === 'dashboard' ? 'bg-slate-800 border-l-4 border-indigo-500' : 'hover:bg-slate-800 text-gray-400 hover:text-white';
            const html = `
              <button onclick="switchView('${m.id}', this)" class="nav-item w-full flex items-center gap-3 px-6 py-3 transition text-left ${isActive}">
                <i class="fas ${m.icon} w-5"></i> <span>${m.label}</span>
              </button>
            `;
            menuContainer.insertAdjacentHTML('beforeend', html);
          }
        });
      }

      // Modifikasi switchView agar memuat data saat menu 'akun' dipilih
      const originalSwitchView = switchView; // Simpan fungsi lama jika perlu, atau timpa langsung

      // Override switchView untuk menghandle logika load data
      function switchView(viewId, btnElement) {
        document.querySelectorAll('.nav-item').forEach(el => {
          el.className = 'nav-item w-full flex items-center gap-3 px-6 py-3 transition text-left hover:bg-slate-800 text-gray-400 hover:text-white';
        });
        if(btnElement) btnElement.className = 'nav-item w-full flex items-center gap-3 px-6 py-3 transition text-left bg-slate-800 border-l-4 border-indigo-500 text-white';

        // Hide All
        ['view-dashboard','view-bank-soal','view-akun','view-placeholder'].forEach(id => {
           const el = document.getElementById(id);
           if(el) el.classList.add('hidden');
        });

        // Judul Halaman
        const titleMap = { 'dashboard':'Dashboard', 'akun':'Kelola Akun Pengguna', 'bank-soal':'Bank Soal', 'ujian':'Jadwal Ujian' };
        document.getElementById('page-title').innerText = titleMap[viewId] || viewId.toUpperCase();

        // Show View
        if(viewId === 'dashboard') document.getElementById('view-dashboard').classList.remove('hidden');
        else if(viewId === 'bank-soal') document.getElementById('view-bank-soal').classList.remove('hidden');
        else if(viewId === 'akun') {
          document.getElementById('view-akun').classList.remove('hidden');
          loadUsers(); // <--- Load data saat menu dibuka
        }
        else document.getElementById('view-placeholder').classList.remove('hidden');
      }

      // 1. Load Data
      function loadUsers() {
        document.getElementById('tbody-users').innerHTML = '<tr><td colspan="5" class="p-6 text-center"><i class="fas fa-spinner fa-spin"></i> Mengambil data...</td></tr>';
        
        google.script.run
          .withSuccessHandler(data => {
            allUsers = data;
            renderUsers(currentTabRole);
          })
          .withFailureHandler(err => Swal.fire('Error', err.message, 'error'))
          .getAllUsers();
      }

      // 2. Tab Filter Logic
      function filterTab(role, btn) {
        currentTabRole = role;
        
        // Update Style Tab
        document.querySelectorAll('.tab-btn').forEach(b => {
           b.classList.remove('bg-indigo-100', 'text-indigo-700');
           b.classList.add('text-gray-500', 'hover:bg-gray-50');
        });
        btn.classList.remove('text-gray-500', 'hover:bg-gray-50');
        btn.classList.add('bg-indigo-100', 'text-indigo-700');

        renderUsers(role);
      }

      // 3. Render Table
      function renderUsers(role) {
        const tbody = document.getElementById('tbody-users');
        tbody.innerHTML = '';

        const filtered = (role === 'all') 
          ? allUsers 
          : allUsers.filter(u => u.role.toLowerCase() === role);

        if (filtered.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="p-6 text-center text-gray-400">Belum ada data user.</td></tr>';
          return;
        }

        filtered.forEach(u => {
           // Role Badge Color
           let badgeColor = 'bg-gray-100 text-gray-800';
           if(u.role.toLowerCase() === 'admin') badgeColor = 'bg-red-100 text-red-800 border-red-200';
           if(u.role.toLowerCase() === 'guru') badgeColor = 'bg-blue-100 text-blue-800 border-blue-200';
           if(u.role.toLowerCase() === 'siswa') badgeColor = 'bg-green-100 text-green-800 border-green-200';

           // Status Badge
           const statusBadge = (u.status === 'Aktif') 
             ? '<span class="px-2 py-0.5 rounded text-xs font-bold bg-green-100 text-green-700">Aktif</span>'
             : '<span class="px-2 py-0.5 rounded text-xs font-bold bg-gray-200 text-gray-500">Nonaktif</span>';

           // Action Buttons (Admin read-only check)
           let btnActions = '';
           if(u.role.toLowerCase() === 'admin') {
              btnActions = `<span class="text-xs text-gray-400 italic"><i class="fas fa-lock"></i> Protected</span>`;
           } else {
              // Kita stringify object user agar bisa dipassing ke fungsi edit
              // Hati-hati dengan kutip, kita encode dulu
              const dataStr = encodeURIComponent(JSON.stringify(u));
              btnActions = `
                <button onclick="editUser('${dataStr}')" class="text-indigo-600 hover:text-indigo-800 mr-3" title="Edit"><i class="fas fa-edit"></i></button>
                <button onclick="hapusUser('${u.id}', '${u.nama}')" class="text-red-500 hover:text-red-700" title="Hapus"><i class="fas fa-trash"></i></button>
              `;
           }

           const html = `
             <tr class="hover:bg-slate-50 transition">
               <td class="p-4 font-semibold text-gray-700">
                 ${u.nama}
               </td>
               <td class="p-4">
                 <div class="flex flex-col">
                   <span class="text-xs text-gray-500 mb-1 font-mono">${u.username}</span>
                   <span class="w-fit px-2 py-0.5 rounded text-[10px] font-bold border uppercase ${badgeColor}">${u.role}</span>
                 </div>
               </td>
               <td class="p-4 text-gray-600">${u.kelas || '-'}</td>
               <td class="p-4">${statusBadge}</td>
               <td class="p-4 text-right">${btnActions}</td>
             </tr>
           `;
           tbody.insertAdjacentHTML('beforeend', html);
        });
      }

      // 4. Modal Logic
      function bukaModalUser() {
        document.getElementById('modal-user').classList.remove('hidden');
        document.getElementById('modal-title').innerText = "Tambah User Baru";
        document.getElementById('u-id').value = ""; // Kosong = Mode Tambah
        // Reset Form
        document.getElementById('u-role').value = "siswa";
        document.getElementById('u-nama').value = "";
        document.getElementById('u-username').value = "";
        document.getElementById('u-password').value = "";
        document.getElementById('u-kelas').value = "";
        document.getElementById('u-status').value = "Aktif";
        toggleKelasInput();
      }

      function tutupModalUser() {
        document.getElementById('modal-user').classList.add('hidden');
      }

      function toggleKelasInput() {
        const r = document.getElementById('u-role').value;
        const div = document.getElementById('div-kelas');
        if(r === 'siswa') div.classList.remove('hidden'); else div.classList.add('hidden');
      }

      function editUser(encodedData) {
        const u = JSON.parse(decodeURIComponent(encodedData));
        document.getElementById('modal-user').classList.remove('hidden');
        document.getElementById('modal-title').innerText = "Edit User";
        
        document.getElementById('u-id').value = u.id;
        document.getElementById('u-role').value = u.role.toLowerCase();
        document.getElementById('u-nama').value = u.nama;
        document.getElementById('u-username').value = u.username;
        document.getElementById('u-password').value = u.password;
        document.getElementById('u-kelas').value = u.kelas;
        document.getElementById('u-status').value = u.status || 'Aktif';
        
        toggleKelasInput();
      }

      function simpanUser(e) {
        e.preventDefault();
        const btn = document.getElementById('btnSimpanUser');
        btn.innerText = "Menyimpan..."; btn.disabled = true;

        const data = {
          id: document.getElementById('u-id').value,
          role: document.getElementById('u-role').value,
          nama: document.getElementById('u-nama').value,
          username: document.getElementById('u-username').value,
          password: document.getElementById('u-password').value,
          kelas: document.getElementById('u-kelas').value,
          status: document.getElementById('u-status').value
        };

        google.script.run
          .withSuccessHandler(res => {
            btn.innerText = "Simpan"; btn.disabled = false;
            if(res.status === 'success') {
              tutupModalUser();
              Swal.fire('Sukses', res.message, 'success');
              loadUsers(); // Reload tabel
            } else {
              Swal.fire('Gagal', res.message, 'error');
            }
          })
          .withFailureHandler(err => {
             btn.innerText = "Simpan"; btn.disabled = false;
             Swal.fire('Error', err.message, 'error');
          })
          .simpanUser(data);
      }

      function hapusUser(id, nama) {
        Swal.fire({
          title: 'Hapus User?',
          text: `Yakin ingin menghapus akun "${nama}"? Data nilai terkait tidak ikut terhapus otomatis.`,
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#d33',
          confirmButtonText: 'Ya, Hapus'
        }).then((result) => {
          if (result.isConfirmed) {
            Swal.showLoading();
            google.script.run
              .withSuccessHandler(res => {
                if(res.status === 'success') {
                  Swal.fire('Terhapus!', res.message, 'success');
                  loadUsers();
                } else {
                  Swal.fire('Gagal', res.message, 'error');
                }
              })
              .hapusUser(id);
          }
        });
      }

      // --- 3. LOGIC INPUT SOAL (Sama seperti sebelumnya, disesuaikan dengan UI baru) ---
      function handleFile(input) {
        if (input.files && input.files[0]) {
          const f = input.files[0];
          const reader = new FileReader();
          reader.onload = (e) => {
             document.getElementById('preview').src = e.target.result;
             document.getElementById('preview').classList.remove('hidden');
             document.getElementById('upload-placeholder').classList.add('hidden');
             filePayload = e.target.result; fileName = f.name;
          }
          reader.readAsDataURL(f);
        }
      }

      function submitSoal(e) {
        e.preventDefault();
        const f = document.getElementById('formSoal');
        const btn = document.getElementById('btnSave');
        btn.innerText = "Processing..."; btn.disabled = true;

        const data = {
          mapel: f.mapel.value, tipe: f.tipe.value, soal: f.soal.value,
          opsiA: f.opsiA.value, opsiB: f.opsiB.value, opsiC: f.opsiC.value, opsiD: f.opsiD.value, opsiE: f.opsiE.value,
          kunci: f.kunci.value, fileData: filePayload, fileName: fileName
        };

        google.script.run
          .withSuccessHandler((res) => {
             btn.innerText = "SIMPAN DATA"; btn.disabled = false;
             if(res.status === 'success') {
                Swal.fire('Sukses', 'Soal berhasil disimpan', 'success');
                f.reset(); 
                document.getElementById('preview').classList.add('hidden');
                document.getElementById('upload-placeholder').classList.remove('hidden');
                filePayload = null;
             } else { Swal.fire('Gagal', res.message, 'error'); }
          })
          .withFailureHandler(err => { btn.disabled = false; Swal.fire('Err', err.message, 'error'); })
          .simpanSoal(data);
      }

      // --- 4. LOGIC SISWA (Disederhanakan untuk integrasi) ---
      function setupSiswaView(user) {
        document.getElementById('login-container').classList.add('hidden');
        document.getElementById('header-nama').innerText = user.nama;
        
        Swal.fire({
          title: 'Masukkan Kode Mapel',
          input: 'text',
          inputPlaceholder: 'Contoh: MTK-X',
          allowOutsideClick: false,
          confirmButtonText: 'Mulai Ujian'
        }).then((result) => {
          if (result.value) {
             startExam(result.value);
          } else { logout(); }
        });
      }

      function startExam(kode) {
        isExamRunning = true;
        enterFullscreen();
        document.getElementById('page-siswa').classList.remove('hidden');
        document.getElementById('header-mapel').innerText = kode;
        startTimer(60); // 60 Menit
        
        google.script.run.withSuccessHandler(res => {
           if(res.status === 'success') {
             daftarSoal = res.data;
             document.getElementById('exam-loading').classList.add('hidden');
             document.getElementById('soal-container').classList.remove('hidden');
             document.getElementById('nav-buttons').classList.remove('hidden');
             document.getElementById('sidebar-nav').classList.remove('hidden'); // Show sidebar for siswa
             renderSoal(0);
           } else {
             Swal.fire('Gagal', res.message, 'warning').then(() => logout());
           }
        }).getSoalUjian(kode);
      }

      // Render Soal Siswa (Sama seperti logika lama)
      function renderSoal(idx) {
        currentIdx = idx;
        const s = daftarSoal[idx];
        document.getElementById('disp-no').innerText = idx + 1;
        document.getElementById('disp-pertanyaan').innerText = s.pertanyaan;
        
        const imgCont = document.getElementById('disp-gambar-container');
        const img = document.getElementById('disp-gambar');
        if(s.gambar) { imgCont.classList.remove('hidden'); img.src = s.gambar; } else { imgCont.classList.add('hidden'); }

        const ops = document.getElementById('disp-opsi'); ops.innerHTML = '';
        ['A','B','C','D','E'].forEach(h => {
           if(s.opsi[h]) {
             const active = jawabanSiswa[s.id] === h ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white hover:bg-gray-50';
             ops.insertAdjacentHTML('beforeend', 
               `<div onclick="pilih('${s.id}','${h}')" class="cursor-pointer border rounded p-3 flex gap-3 items-center ${active}">
                  <span class="font-bold w-6 text-center">${h}</span> <span>${s.opsi[h]}</span>
               </div>`
             );
           }
        });
        renderGrid();
      }
      
      function pilih(id, h) { jawabanSiswa[id] = h; renderSoal(currentIdx); }
      function nextSoal() { if(currentIdx < daftarSoal.length-1) renderSoal(currentIdx+1); }
      function prevSoal() { if(currentIdx > 0) renderSoal(currentIdx-1); }
      function toggleRagu() { 
         const id = daftarSoal[currentIdx].id; 
         if(raguSiswa[id]) delete raguSiswa[id]; else raguSiswa[id] = true; 
         renderSoal(currentIdx); 
      }
      function renderGrid() {
         const g = document.getElementById('grid-nomor'); g.innerHTML='';
         daftarSoal.forEach((s,i) => {
            let c = 'bg-white border text-gray-600';
            if(jawabanSiswa[s.id]) c = 'bg-indigo-600 text-white border-indigo-600';
            if(raguSiswa[s.id]) c = 'bg-yellow-400 text-white border-yellow-400';
            if(i===currentIdx) c += ' ring-2 ring-indigo-300';
            g.insertAdjacentHTML('beforeend', `<button onclick="renderSoal(${i})" class="h-8 w-full rounded font-bold text-xs ${c}">${i+1}</button>`);
         });
      }

      function selesaiUjian() {
         Swal.fire({ title:'Kirim Jawaban?', icon:'question', showCancelButton:true, confirmButtonText:'Ya' }).then(r=>{
            if(r.isConfirmed) kirimJawaban(false);
         });
      }

      function kirimJawaban(auto) {
         isExamRunning = false; clearInterval(timerInterval);
         Swal.showLoading();
         const p = { nama: document.getElementById('header-nama').innerText, mapel: document.getElementById('header-mapel').innerText, jawaban: jawabanSiswa };
         google.script.run.withSuccessHandler(res => {
            if(res.status==='success') Swal.fire('Selesai', `Nilai: ${res.nilai}`, 'success').then(()=>logout());
            else Swal.fire('Gagal', res.message, 'error');
         }).submitUjian(p);
      }

      function startTimer(m) {
         sisaWaktuDetik = m * 60;
         timerInterval = setInterval(() => {
            sisaWaktuDetik--;
            const min = Math.floor(sisaWaktuDetik/60).toString().padStart(2,'0');
            const sec = (sisaWaktuDetik%60).toString().padStart(2,'0');
            document.getElementById('timer-display').innerText = `${min}:${sec}`;
            if(sisaWaktuDetik<=0) { clearInterval(timerInterval); kirimJawaban(true); }
         }, 1000);
      }

      // Security
      function enterFullscreen() { document.documentElement.requestFullscreen().catch(()=>{}); }
      document.addEventListener("visibilitychange", () => { if(isExamRunning && document.hidden) triggerLock("Pindah Tab"); });
      window.addEventListener("blur", () => { if(isExamRunning) triggerLock("Keluar App"); });
      
      function triggerLock(msg) {
         document.getElementById('lock-screen').classList.remove('hidden');
         document.getElementById('lock-reason').innerText = msg;
      }
      function bukaKunci() {
         const t = document.getElementById('token-unlock').value;
         google.script.run.withSuccessHandler(r => {
            if(r.status==='success') { document.getElementById('lock-screen').classList.add('hidden'); enterFullscreen(); }
            else Swal.fire('Salah', 'Token tidak valid', 'error');
         }).verifikasiTokenUnlock(t);
      }

    </script>
  </body>
</html>
