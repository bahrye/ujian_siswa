<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="UTF-8">
    <title>CBT SYSTEM PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    
    <style>
      body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
      .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1); }
      .input-std { width: 100%; padding: 0.6rem; border: 1px solid #d1d5db; border-radius: 0.4rem; outline: none; }
      .input-std:focus { border-color: #4f46e5; ring: 2px; }
      
      /* Sidebar Active State */
      .nav-item.active { background-color: #3730a3; border-left: 4px solid #818cf8; }

      /* Tambahan Style untuk Editor */
      .ql-editor { min-height: 150px; font-family: 'Inter', sans-serif; font-size: 16px; background: white; }
      .ql-container { border-bottom-left-radius: 0.5rem; border-bottom-right-radius: 0.5rem; }
      .ql-toolbar { border-top-left-radius: 0.5rem; border-top-right-radius: 0.5rem; background: #f8fafc; }
    </style>
  </head>
  <body>

    <div id="login-container" class="min-h-screen flex items-center justify-center bg-slate-900 p-4">
      <div class="glass-panel w-full max-w-sm p-8 rounded-xl shadow-2xl">
        <div class="text-center mb-6">
          <div class="w-16 h-16 bg-indigo-600 rounded-lg mx-auto flex items-center justify-center mb-3">
            <i class="fas fa-laptop-code text-white text-3xl"></i>
          </div>
          <h1 class="text-2xl font-bold text-slate-800">CBT LOGIN</h1>
          <p class="text-gray-500 text-xs">Admin â€¢ Guru â€¢ Pengawas â€¢ Siswa</p>
        </div>
        
        <form onsubmit="doLogin(event)" class="space-y-4">
          <input type="text" id="user" class="input-std" placeholder="Username" required>
          <input type="password" id="pass" class="input-std" placeholder="Password" required>
          <button type="submit" id="btnLogin" class="w-full py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded transition">
            MASUK
          </button>
        </form>
      </div>
    </div>

    <div id="dashboard-container" class="hidden flex h-screen overflow-hidden bg-gray-100">
      
      <aside class="w-64 bg-slate-900 text-white flex flex-col shadow-xl z-20">
        <div class="h-16 flex items-center gap-3 px-6 border-b border-slate-700 font-bold text-lg tracking-wider">
          <i class="fas fa-graduation-cap text-indigo-400"></i> CBT ADMIN
        </div>

        <div class="p-4 border-b border-slate-800">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-indigo-500 flex items-center justify-center font-bold text-lg">
              <span id="dash-initial">A</span>
            </div>
            <div>
              <p class="text-sm font-semibold" id="dash-nama">User Name</p>
              <p class="text-xs text-indigo-300 uppercase" id="dash-role">Role</p>
            </div>
          </div>
        </div>

        <nav class="flex-1 overflow-y-auto py-4 space-y-1" id="sidebar-menu">
          </nav>

        <div class="p-4 border-t border-slate-800">
          <button onclick="logout()" class="flex items-center gap-3 w-full px-4 py-2 text-red-400 hover:bg-slate-800 rounded transition">
            <i class="fas fa-sign-out-alt"></i> Logout
          </button>
        </div>
      </aside>

      <main class="flex-1 flex flex-col overflow-hidden relative">
        <header class="h-16 bg-white shadow-sm flex items-center justify-between px-6 z-10">
          <h2 class="text-xl font-bold text-gray-700" id="page-title">Dashboard</h2>
          <div class="text-sm text-gray-500" id="current-date"></div>
        </header>

        <div class="flex-1 overflow-y-auto p-6" id="main-view-area">
          
          <div id="view-dashboard" class="space-y-6 animate__animated animate__fadeIn">
             <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
               <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-blue-500">
                 <div class="flex justify-between items-start">
                   <div>
                     <p class="text-gray-500 text-sm">Total Pengguna</p>
                     <h3 class="text-3xl font-bold text-gray-800 mt-1" id="stat-user">-</h3>
                   </div>
                   <div class="p-3 bg-blue-50 text-blue-600 rounded-lg"><i class="fas fa-users text-xl"></i></div>
                 </div>
               </div>
               <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-green-500">
                 <div class="flex justify-between items-start">
                   <div>
                     <p class="text-gray-500 text-sm">Bank Soal</p>
                     <h3 class="text-3xl font-bold text-gray-800 mt-1" id="stat-soal">-</h3>
                   </div>
                   <div class="p-3 bg-green-50 text-green-600 rounded-lg"><i class="fas fa-book text-xl"></i></div>
                 </div>
               </div>
               <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-purple-500">
                 <div class="flex justify-between items-start">
                   <div>
                     <p class="text-gray-500 text-sm">Ujian Masuk</p>
                     <h3 class="text-3xl font-bold text-gray-800 mt-1" id="stat-nilai">-</h3>
                   </div>
                   <div class="p-3 bg-purple-50 text-purple-600 rounded-lg"><i class="fas fa-file-signature text-xl"></i></div>
                 </div>
               </div>
             </div>

             <div class="bg-blue-50 border border-blue-200 rounded-xl p-6">
               <h3 class="font-bold text-blue-800 text-lg mb-2">Selamat Datang!</h3>
               <p class="text-blue-700">Silakan pilih menu di samping untuk mengelola aplikasi Computer Based Test ini. Pastikan Anda logout setelah selesai menggunakan sistem.</p>
             </div>
          </div>

          <div id="view-bank-soal" class="hidden animate__animated animate__fadeIn">
            
            <div id="bs-list-section" class="w-full">
              
              <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200 mb-6 flex flex-col md:flex-row justify-between items-end md:items-center gap-4">
                <div>
                  <h2 class="text-2xl font-bold text-gray-800">Bank Soal</h2>
                  <p class="text-gray-500 text-sm">Kelola pertanyaan ujian per mata pelajaran.</p>
                </div>
                
                <div class="flex gap-3 w-full md:w-auto">
                  <div class="flex-1 md:w-64">
                    <label class="text-xs font-bold text-gray-500 block mb-1">Filter Mapel</label>
                    <select id="filter-mapel" onchange="loadDaftarSoal()" class="w-full p-2 border rounded-lg bg-gray-50 font-semibold text-gray-700 focus:ring-2 focus:ring-indigo-300 outline-none">
                      <option value="">- Tampilkan Semua -</option>
                      </select>
                  </div>
                  
                  <div class="flex items-end">
                    <button onclick="tampilFormSoal(true)" class="px-5 py-2.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 shadow-lg font-bold flex items-center gap-2 transition transform hover:-translate-y-1">
                      <i class="fas fa-plus"></i> <span class="hidden md:inline">Buat Soal</span>
                    </button>
                  </div>
                </div>
              </div>

              <div class="bg-white rounded-xl shadow border border-gray-200 overflow-hidden">
                <div class="overflow-x-auto">
                  <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-50 text-slate-600 uppercase text-xs font-bold">
                      <tr>
                        <th class="p-4 border-b w-16 text-center">No</th>
                        <th class="p-4 border-b w-32">Tipe</th>
                        <th class="p-4 border-b">Pertanyaan (Snippet)</th>
                        <th class="p-4 border-b w-24">Kunci</th>
                        <th class="p-4 border-b w-32 text-right">Aksi</th>
                      </tr>
                    </thead>
                    <tbody id="tbody-soal" class="text-sm text-gray-700 divide-y divide-gray-100">
                      <tr><td colspan="5" class="p-8 text-center text-gray-400">Silakan pilih Mapel atau klik 'Buat Soal'</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <div id="bs-form-section" class="hidden">
              <div class="flex items-center gap-4 mb-4">
                <button onclick="tampilFormSoal(false)" class="p-2 rounded-full bg-white border hover:bg-gray-100 text-gray-600 shadow-sm">
                  <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="text-xl font-bold text-gray-800" id="form-soal-title">Input Soal Baru</h2>
              </div>

              <div class="bg-white rounded-xl shadow-md p-6 max-w-5xl mx-auto border border-gray-200">
                <form id="formSoal" onsubmit="submitSoal(event)" class="space-y-6">
                  <input type="hidden" id="soal-id" name="id"> <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                      <label class="block font-semibold mb-1 text-sm text-gray-600">Kode Mapel</label>
                      <select name="mapel" id="soal-mapel-select" class="input-std bg-gray-50" required>
                        <option value="">-- Pilih Mapel --</option>
                      </select>
                    </div>
                    <div>
                      <label class="block font-semibold mb-1 text-sm text-gray-600">Tipe Soal</label>
                      <select name="tipe" id="tipe-soal" class="input-std bg-gray-50 font-bold text-indigo-700" onchange="gantiTipeSoal()">
                        <option value="PG">Pilihan Ganda</option>
                        <option value="ISIAN">Isian Singkat</option>
                        <option value="ESSAY">Uraian / Essay</option>
                        <option value="BS">Benar / Salah</option>
                        <option value="COCOK">Pencocokan (Matching)</option>
                      </select>
                    </div>
                  </div>

                  <div>
                    <label class="block font-semibold mb-1 text-sm text-gray-600">Pertanyaan</label>
                    <div id="editor-container"></div>
                  </div>

                  <div class="bg-slate-50 p-5 rounded-lg border border-slate-200">
                    
                    <div id="area-pg" class="opsi-area">
                      <p class="text-xs font-bold text-gray-500 mb-3 uppercase">Pilihan Jawaban</p>
                      <div class="space-y-2">
                        <div class="flex gap-2 items-center"><span class="w-6 font-bold text-center">A</span><input type="text" id="pg-a" class="input-std text-sm" placeholder="Jawaban A"></div>
                        <div class="flex gap-2 items-center"><span class="w-6 font-bold text-center">B</span><input type="text" id="pg-b" class="input-std text-sm" placeholder="Jawaban B"></div>
                        <div class="flex gap-2 items-center"><span class="w-6 font-bold text-center">C</span><input type="text" id="pg-c" class="input-std text-sm" placeholder="Jawaban C"></div>
                        <div class="flex gap-2 items-center"><span class="w-6 font-bold text-center">D</span><input type="text" id="pg-d" class="input-std text-sm" placeholder="Jawaban D"></div>
                        <div class="flex gap-2 items-center"><span class="w-6 font-bold text-center text-gray-400">E</span><input type="text" id="pg-e" class="input-std text-sm" placeholder="Opsional"></div>
                      </div>
                      <div class="mt-4">
                        <label class="block text-xs font-bold text-gray-500 mb-1">Kunci Jawaban</label>
                        <select id="kunci-pg" class="input-std bg-white w-32">
                          <option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option><option value="E">E</option>
                        </select>
                      </div>
                    </div>

                    <div id="area-isian" class="opsi-area hidden">
                      <p class="text-sm text-gray-600 mb-2">Kunci jawaban singkat.</p>
                      <input type="text" id="kunci-isian" class="input-std border-indigo-300">
                    </div>

                    <div id="area-essay" class="opsi-area hidden">
                      <p class="text-sm text-yellow-600"><i class="fas fa-info-circle"></i> Koreksi manual oleh Guru.</p>
                    </div>

                    <div id="area-bs" class="opsi-area hidden">
                      <p class="text-xs font-bold text-gray-500 mb-2">Kunci</p>
                      <div class="flex gap-4">
                        <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="kunci_bs" value="BENAR" class="accent-green-600"> <span class="font-bold text-green-700">BENAR</span></label>
                        <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="kunci_bs" value="SALAH" class="accent-red-600"> <span class="font-bold text-red-700">SALAH</span></label>
                      </div>
                    </div>

                    <div id="area-cocok" class="opsi-area hidden">
                      <p class="text-xs font-bold text-gray-500 mb-2">Pasangan Jawaban</p>
                      <div id="container-cocok" class="space-y-2 mb-3"></div>
                      <button type="button" onclick="tambahBarisCocok()" class="text-xs bg-indigo-100 text-indigo-700 px-3 py-1 rounded font-bold">+ Tambah</button>
                    </div>

                  </div>

                  <div class="flex gap-3">
                    <button type="button" onclick="tampilFormSoal(false)" class="flex-1 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold rounded-lg">BATAL</button>
                    <button type="submit" id="btnSave" class="flex-1 py-3 bg-emerald-600 hover:bg-emerald-700 text-white font-bold rounded-lg shadow">SIMPAN SOAL</button>
                  </div>
                </form>
              </div>
            </div>

          </div>

          <div id="view-akun" class="hidden animate__animated animate__fadeIn">
            
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
              <div class="flex bg-white rounded-lg p-1 shadow-sm border overflow-x-auto max-w-full">
                <button onclick="filterTab('all', this)" class="tab-btn px-4 py-2 rounded-md text-sm font-bold bg-indigo-100 text-indigo-700">Semua</button>
                <button onclick="filterTab('admin', this)" class="tab-btn px-4 py-2 rounded-md text-sm font-bold text-gray-500 hover:bg-gray-50">Admin</button>
                <button onclick="filterTab('guru', this)" class="tab-btn px-4 py-2 rounded-md text-sm font-bold text-gray-500 hover:bg-gray-50">Guru</button>
                <button onclick="filterTab('pengawas', this)" class="tab-btn px-4 py-2 rounded-md text-sm font-bold text-gray-500 hover:bg-gray-50">Pengawas</button>
                <button onclick="filterTab('siswa', this)" class="tab-btn px-4 py-2 rounded-md text-sm font-bold text-gray-500 hover:bg-gray-50">Siswa</button>
              </div>

              <div class="flex gap-2">
                <button onclick="loadUsers()" class="px-4 py-2 bg-white border border-gray-300 text-gray-600 rounded-lg hover:bg-gray-50 transition shadow-sm">
                  <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <button onclick="bukaModalUser()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition shadow-lg flex items-center gap-2">
                  <i class="fas fa-plus"></i> Tambah User
                </button>
              </div>
            </div>

            <div class="bg-white rounded-xl shadow-md overflow-hidden border border-gray-200">
              <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                  <thead class="bg-gray-50 text-gray-600 uppercase text-xs tracking-wider">
                    <tr>
                      <th class="p-4 border-b">Nama Lengkap</th>
                      <th class="p-4 border-b">Username / Role</th>
                      <th class="p-4 border-b">Kelas</th>
                      <th class="p-4 border-b">Status</th>
                      <th class="p-4 border-b text-right">Aksi</th>
                    </tr>
                  </thead>
                  <tbody id="tbody-users" class="text-sm text-gray-700 divide-y divide-gray-100">
                    <tr><td colspan="5" class="p-6 text-center text-gray-400">Memuat data...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div id="view-mapel" class="hidden animate__animated animate__fadeIn">
            <div class="flex justify-between items-center mb-6">
              <div>
                <h2 class="text-2xl font-bold text-gray-800">Daftar Mata Pelajaran</h2>
                <p class="text-gray-500 text-sm">Kelola kode mapel dan guru pengampu.</p>
              </div>
              <button onclick="bukaModalMapel()" class="px-5 py-2.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 shadow-lg flex items-center gap-2 font-semibold">
                <i class="fas fa-plus-circle"></i> Tambah Mapel
              </button>
            </div>

            <div class="bg-white rounded-xl shadow-md overflow-hidden border border-gray-200">
              <table class="w-full text-left border-collapse">
                <thead class="bg-gray-50 text-gray-600 uppercase text-xs font-bold tracking-wider">
                  <tr>
                    <th class="p-4 border-b w-1/4">Kode Mapel</th>
                    <th class="p-4 border-b w-1/3">Nama Pelajaran</th>
                    <th class="p-4 border-b">Guru Pengampu</th>
                    <th class="p-4 border-b text-right">Aksi</th>
                  </tr>
                </thead>
                <tbody id="tbody-mapel" class="text-sm text-gray-700 divide-y divide-gray-100">
                  <tr><td colspan="4" class="p-6 text-center text-gray-400">Memuat data...</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <div id="modal-mapel" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm">
            <div class="bg-white w-full max-w-md rounded-xl shadow-2xl p-6 animate__animated animate__zoomIn">
              <div class="flex justify-between items-center mb-5 border-b pb-3">
                <h3 class="text-xl font-bold text-gray-800" id="modal-mapel-title">Tambah Mapel</h3>
                <button onclick="document.getElementById('modal-mapel').classList.add('hidden')" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
              </div>
              
              <form onsubmit="simpanMapel(event)" class="space-y-4">
                <input type="hidden" id="m-id">
                
                <div>
                  <label class="block text-xs font-bold text-gray-500 mb-1">Kode Mapel (Unik)</label>
                  <input type="text" id="m-kode" class="input-std font-mono uppercase" placeholder="Contoh: MTK-X" required>
                  <p class="text-[10px] text-gray-400 mt-1">Digunakan siswa untuk login ujian.</p>
                </div>

                <div>
                  <label class="block text-xs font-bold text-gray-500 mb-1">Nama Mata Pelajaran</label>
                  <input type="text" id="m-nama" class="input-std" placeholder="Contoh: Matematika Kelas X" required>
                </div>

                <div>
                  <label class="block text-xs font-bold text-gray-500 mb-1">Guru Pengampu</label>
                  <select id="m-guru" class="input-std bg-gray-50">
                    <option value="-">- Pilih Guru -</option>
                    </select>
                </div>

                <div class="pt-4 flex justify-end gap-3">
                  <button type="button" onclick="document.getElementById('modal-mapel').classList.add('hidden')" class="px-4 py-2 rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200 font-semibold">Batal</button>
                  <button type="submit" id="btnSimpanMapel" class="px-6 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 font-bold shadow">Simpan</button>
                </div>
              </form>
            </div>
          </div>

          <div id="view-placeholder" class="hidden flex flex-col items-center justify-center h-64 text-gray-400">
            <i class="fas fa-tools text-5xl mb-3"></i>
            <p class="text-lg">Fitur ini sedang dalam pengembangan.</p>
          </div>

          <div id="modal-user" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm">
            <div class="bg-white w-full max-w-lg rounded-xl shadow-2xl p-6 animate__animated animate__zoomIn">
              <div class="flex justify-between items-center mb-5 border-b pb-3">
                <h3 class="text-xl font-bold text-gray-800" id="modal-title">Tambah User</h3>
                <button onclick="tutupModalUser()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
              </div>
              
              <form onsubmit="simpanUser(event)" class="space-y-4">
                <input type="hidden" id="u-id">
                
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Role</label>
                    <select id="u-role" class="input-std bg-gray-50" onchange="toggleKelasInput()" required>
                      <option value="siswa">Siswa</option>
                      <option value="guru">Guru</option>
                      <option value="pengawas">Pengawas</option>
                      <option value="admin">Admin</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Status Akun</label>
                    <select id="u-status" class="input-std bg-gray-50">
                      <option value="Aktif">Aktif</option>
                      <option value="Nonaktif">Nonaktif (Banned)</option>
                    </select>
                  </div>
                </div>

                <div>
                  <label class="block text-xs font-bold text-gray-500 mb-1">Nama Lengkap</label>
                  <input type="text" id="u-nama" class="input-std" placeholder="Nama User" required>
                </div>

                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Username</label>
                    <input type="text" id="u-username" class="input-std" placeholder="NIS / NIP" required>
                  </div>
                  <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Password</label>
                    <input type="text" id="u-password" class="input-std" placeholder="Password" required>
                  </div>
                </div>

                <div id="div-kelas">
                  <label class="block text-xs font-bold text-gray-500 mb-1">Kelas (Khusus Siswa)</label>
                  <input type="text" id="u-kelas" class="input-std" placeholder="Contoh: XII-RPL-1">
                </div>

                <div class="pt-4 flex justify-end gap-3">
                  <button type="button" onclick="tutupModalUser()" class="px-4 py-2 rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200 font-semibold">Batal</button>
                  <button type="submit" id="btnSimpanUser" class="px-6 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 font-bold shadow">Simpan</button>
                </div>
              </form>
            </div>
          </div>

        </div>
      </main>
    </div>

    <div id="page-siswa" class="hidden fixed inset-0 z-50 bg-gray-100 flex flex-col font-sans">
        <header class="bg-slate-900 text-white px-4 py-3 flex justify-between items-center z-20 shrink-0">
             <div class="flex items-center gap-3">
               <div class="w-10 h-10 bg-indigo-600 rounded-full flex items-center justify-center font-bold">S</div>
               <div><h1 class="font-bold text-sm" id="header-nama">Siswa</h1><p class="text-xs text-gray-400" id="header-mapel">-</p></div>
             </div>
             <div class="bg-slate-800 px-3 py-1.5 rounded text-lg font-mono font-bold text-yellow-400" id="timer-display">--:--</div>
        </header>
        <main class="flex-1 overflow-y-auto p-4 relative" id="main-exam-area">
             <div id="exam-loading" class="flex flex-col items-center justify-center h-full text-gray-500">
                <i class="fas fa-spinner fa-spin text-3xl mb-2"></i> <p>Memuat Soal...</p>
             </div>
             <div id="soal-container" class="hidden max-w-4xl mx-auto bg-white rounded p-6 shadow-sm min-h-[400px]">
                <div class="flex justify-between mb-4"><span class="bg-indigo-100 text-indigo-800 px-3 py-1 rounded text-sm font-bold">No. <span id="disp-no">1</span></span></div>
                <div id="disp-pertanyaan" class="text-lg mb-4"></div>
                <div id="disp-gambar-container" class="hidden mb-4"><img id="disp-gambar" class="max-h-64 rounded border"></div>
                <div id="disp-opsi" class="space-y-2"></div>
             </div>
             <div id="nav-buttons" class="hidden max-w-4xl mx-auto mt-4 flex justify-between">
                <button onclick="prevSoal()" class="px-4 py-2 bg-white border rounded">Prev</button>
                <button onclick="toggleRagu()" id="btn-ragu" class="px-4 py-2 bg-yellow-100 text-yellow-700 border rounded">Ragu</button>
                <button onclick="nextSoal()" class="px-4 py-2 bg-indigo-600 text-white rounded">Next</button>
             </div>
        </main>
        <aside class="hidden md:flex w-64 bg-white border-l flex-col z-30" id="sidebar-nav">
           <div class="p-3 border-b font-bold text-center">Navigasi</div>
           <div class="flex-1 p-3"><div id="grid-nomor" class="grid grid-cols-5 gap-2"></div></div>
           <div class="p-3"><button onclick="selesaiUjian()" class="w-full py-2 bg-green-600 text-white rounded font-bold">SELESAI</button></div>
        </aside>
    </div>

    <div id="lock-screen" class="hidden fixed inset-0 z-[100] bg-red-900 flex items-center justify-center text-white text-center p-6">
       <div class="max-w-md w-full">
         <i class="fas fa-lock text-5xl mb-4"></i>
         <h2 class="text-2xl font-bold mb-2">TERKUNCI!</h2>
         <p id="lock-reason" class="mb-4 text-red-200">Anda keluar dari aplikasi.</p>
         <input type="password" id="token-unlock" class="w-full p-2 text-black text-center text-xl font-bold rounded mb-3" placeholder="TOKEN PENGAWAS">
         <button onclick="bukaKunci()" id="btnUnlock" class="w-full py-2 bg-white text-red-900 font-bold rounded">BUKA KUNCI</button>
       </div>
    </div>

    <script>
      // --- GLOBALS & UTILS ---
      let currentUserRole = '';
      let filePayload = null; let fileName = "";
      
      // Global Exam Vars
      let daftarSoal = []; let jawabanSiswa = {}; let raguSiswa = {}; 
      let currentIdx = 0; let timerInterval = null; let sisaWaktuDetik = 0; let isExamRunning = false;

      let allUsers = [];
      let currentTabRole = 'all';

      let allMapel = [];
      let quillEditor;

      // Update Tanggal
      document.getElementById('current-date').innerText = new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

      // --- 1. LOGIN LOGIC ---
      function doLogin(e) {
        e.preventDefault();
        const u = document.getElementById('user').value;
        const p = document.getElementById('pass').value;
        const btn = document.getElementById('btnLogin');
        
        btn.innerText = "Loading..."; btn.disabled = true;

        google.script.run
          .withSuccessHandler((res) => {
             btn.innerText = "MASUK"; btn.disabled = false;
             if (res.status === 'success') {
               currentUserRole = res.role;
               
               // Route berdasarkan Role
               if (currentUserRole === 'siswa') {
                 setupSiswaView(res);
               } else {
                 setupDashboardView(res);
               }
             } else {
               Swal.fire('Login Gagal', res.message, 'error');
             }
          })
          .withFailureHandler((err) => { btn.disabled = false; Swal.fire('Error', err.message, 'error'); })
          .loginUser(u, p);
      }

      function logout() { location.reload(); }

      // --- 2. DASHBOARD LOGIC (ADMIN/GURU/PENGAWAS) ---
      function setupDashboardView(user) {
        document.getElementById('login-container').classList.add('hidden');
        document.getElementById('dashboard-container').classList.remove('hidden');
        
        // Set Profile Info
        document.getElementById('dash-nama').innerText = user.nama;
        document.getElementById('dash-initial').innerText = user.nama.charAt(0);
        document.getElementById('dash-role').innerText = user.role;

        // Render Sidebar Menu berdasarkan Role
        renderMenu(user.role);

        // Load Stats Awal
        google.script.run.withSuccessHandler(stats => {
           document.getElementById('stat-user').innerText = stats.users;
           document.getElementById('stat-soal').innerText = stats.soals;
           document.getElementById('stat-nilai').innerText = stats.nilais;
        }).getDashboardStats();
      }

      function renderMenu(role) {
        const menuContainer = document.getElementById('sidebar-menu');
        menuContainer.innerHTML = '';

        // Definisi Menu
        const menus = [
          { id: 'dashboard', icon: 'fa-home', label: 'Dashboard', roles: ['admin', 'guru', 'pengawas'] },
          { id: 'akun', icon: 'fa-users-cog', label: 'Kelola Akun', roles: ['admin'] },
          { id: 'mapel', icon: 'fa-tags', label: 'Kelola Mapel', roles: ['admin', 'guru'] },
          { id: 'bank-soal', icon: 'fa-file-alt', label: 'Bank Soal', roles: ['admin', 'guru'] },
          { id: 'ujian', icon: 'fa-clock', label: 'Jadwal Ujian', roles: ['admin', 'guru'] },
          { id: 'monitoring', icon: 'fa-desktop', label: 'Monitoring', roles: ['admin', 'pengawas'] },
          { id: 'hasil', icon: 'fa-poll', label: 'Hasil Ujian', roles: ['admin', 'guru'] },
        ];

        menus.forEach(m => {
          if (m.roles.includes(role)) {
            const isActive = m.id === 'dashboard' ? 'bg-slate-800 border-l-4 border-indigo-500' : 'hover:bg-slate-800 text-gray-400 hover:text-white';
            const html = `
              <button onclick="switchView('${m.id}', this)" class="nav-item w-full flex items-center gap-3 px-6 py-3 transition text-left ${isActive}">
                <i class="fas ${m.icon} w-5"></i> <span>${m.label}</span>
              </button>
            `;
            menuContainer.insertAdjacentHTML('beforeend', html);
          }
        });
      }

      // Modifikasi switchView agar memuat data saat menu 'akun' dipilih
      const originalSwitchView = switchView; // Simpan fungsi lama jika perlu, atau timpa langsung

      // OVERRIDE switchView (Update lagi untuk handle mapel)
      const oldSwitchView = switchView; // chain reference if needed
      
      function switchView(viewId, btnElement) {
         // Reset Sidebar Active
         document.querySelectorAll('.nav-item').forEach(el => {
           el.className = 'nav-item w-full flex items-center gap-3 px-6 py-3 transition text-left hover:bg-slate-800 text-gray-400 hover:text-white';
         });
         if(btnElement) btnElement.className = 'nav-item w-full flex items-center gap-3 px-6 py-3 transition text-left bg-slate-800 border-l-4 border-indigo-500 text-white';

         // Hide All
         ['view-dashboard','view-bank-soal','view-akun','view-mapel','view-placeholder'].forEach(id => {
            const el = document.getElementById(id); if(el) el.classList.add('hidden');
         });

         const titleMap = { 
           'dashboard':'Dashboard', 'akun':'Kelola Akun', 
           'mapel':'Kelola Mata Pelajaran', 'bank-soal':'Bank Soal', 'ujian':'Jadwal' 
         };
         document.getElementById('page-title').innerText = titleMap[viewId] || viewId.toUpperCase();

         if(viewId === 'dashboard') {
            document.getElementById('view-dashboard').classList.remove('hidden');
         } else if(viewId === 'akun') {
            document.getElementById('view-akun').classList.remove('hidden');
            loadUsers();
         } else if(viewId === 'mapel') {
            document.getElementById('view-mapel').classList.remove('hidden');
            loadMapel();
         } else if(viewId === 'bank-soal') {
            document.getElementById('view-bank-soal').classList.remove('hidden');
            // Saat buka bank soal, kita harus load opsi mapel ke dropdown
            loadOptionsMapel(); 
            setTimeout(initQuill, 100);
         } else {
            document.getElementById('view-placeholder').classList.remove('hidden');
         }
      }

      // 1. Load Data Mapel untuk Tabel
      function loadMapel() {
        const tbody = document.getElementById('tbody-mapel');
        tbody.innerHTML = '<tr><td colspan="4" class="p-6 text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>';
        
        google.script.run.withSuccessHandler(data => {
           allMapel = data;
           renderMapelTable(data);
        }).getAllMapel();
      }

      function renderMapelTable(data) {
        const tbody = document.getElementById('tbody-mapel');
        tbody.innerHTML = '';
        if(data.length === 0) {
           tbody.innerHTML = '<tr><td colspan="4" class="p-6 text-center text-gray-400">Belum ada mapel.</td></tr>';
           return;
        }
        data.forEach(m => {
           // Encode object untuk tombol edit
           const dataStr = encodeURIComponent(JSON.stringify(m));
           
           tbody.insertAdjacentHTML('beforeend', `
             <tr class="hover:bg-slate-50 transition border-b border-gray-100">
               <td class="p-4 font-mono font-bold text-indigo-600">${m.kode}</td>
               <td class="p-4 font-semibold text-gray-700">${m.nama}</td>
               <td class="p-4 text-gray-600"><i class="fas fa-user-tie text-gray-400 mr-2"></i>${m.guru || '-'}</td>
               <td class="p-4 text-right">
                 <button onclick="editMapel('${dataStr}')" class="text-indigo-600 hover:text-indigo-800 mr-3"><i class="fas fa-edit"></i></button>
                 <button onclick="hapusMapel('${m.id}', '${m.kode}')" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
               </td>
             </tr>
           `);
        });
      }

      // 2. Modal Tambah/Edit Mapel
      function bukaModalMapel() {
        document.getElementById('modal-mapel').classList.remove('hidden');
        document.getElementById('modal-mapel-title').innerText = "Tambah Mapel";
        document.getElementById('m-id').value = "";
        document.getElementById('m-kode').value = "";
        document.getElementById('m-nama').value = "";
        
        // Load List Guru ke Dropdown Modal
        const selGuru = document.getElementById('m-guru');
        selGuru.innerHTML = '<option value="-">Loading...</option>';
        google.script.run.withSuccessHandler(gurus => {
           selGuru.innerHTML = '<option value="-">- Pilih Guru -</option>';
           gurus.forEach(g => {
             selGuru.insertAdjacentHTML('beforeend', `<option value="${g}">${g}</option>`);
           });
        }).getListGuru();
      }

      function editMapel(str) {
        const m = JSON.parse(decodeURIComponent(str));
        document.getElementById('modal-mapel').classList.remove('hidden');
        document.getElementById('modal-mapel-title').innerText = "Edit Mapel";
        
        document.getElementById('m-id').value = m.id;
        document.getElementById('m-kode').value = m.kode;
        document.getElementById('m-nama').value = m.nama;
        
        // Load Guru dan Set Value
        const selGuru = document.getElementById('m-guru');
        selGuru.innerHTML = '<option>Loading...</option>';
        google.script.run.withSuccessHandler(gurus => {
           selGuru.innerHTML = '<option value="-">- Pilih Guru -</option>';
           gurus.forEach(g => {
             const selected = (g === m.guru) ? 'selected' : '';
             selGuru.insertAdjacentHTML('beforeend', `<option value="${g}" ${selected}>${g}</option>`);
           });
        }).getListGuru();
      }

      function simpanMapel(e) {
        e.preventDefault();
        const btn = document.getElementById('btnSimpanMapel');
        btn.innerText = "Menyimpan..."; btn.disabled = true;

        const data = {
          id: document.getElementById('m-id').value,
          kode: document.getElementById('m-kode').value.toUpperCase(),
          nama: document.getElementById('m-nama').value,
          guru: document.getElementById('m-guru').value
        };

        google.script.run.withSuccessHandler(res => {
           btn.innerText = "Simpan"; btn.disabled = false;
           if(res.status === 'success') {
             document.getElementById('modal-mapel').classList.add('hidden');
             Swal.fire('Sukses', res.message, 'success');
             loadMapel();
           } else {
             Swal.fire('Gagal', res.message, 'error');
           }
        }).simpanMapel(data);
      }
      
      function hapusMapel(id, kode) {
        Swal.fire({
           title: 'Hapus Mapel?', text: `Mapel ${kode} akan dihapus. Soal terkait tidak ikut terhapus otomatis.`, icon: 'warning',
           showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Hapus'
        }).then(res => {
           if(res.isConfirmed) {
              google.script.run.withSuccessHandler(r => {
                 if(r.status==='success') { loadMapel(); Swal.fire('Terhapus', r.message, 'success'); }
                 else Swal.fire('Gagal', r.message, 'error');
              }).hapusMapel(id);
           }
        });
      }

      // 3. FUNGSI UNTUK MENGISI DROPDOWN DI BANK SOAL
      function loadOptionsMapel() {
         // Reset Dropdown
         const selFilter = document.getElementById('filter-mapel');
         const selForm = document.getElementById('soal-mapel-select');
         
         selFilter.innerHTML = '<option value="">Loading...</option>';
         selForm.innerHTML = '<option value="">Loading...</option>';

         google.script.run.withSuccessHandler(data => {
            // Isi Filter
            selFilter.innerHTML = '<option value="">- Tampilkan Semua -</option>';
            // Isi Form
            selForm.innerHTML = '<option value="">-- Pilih Mapel --</option>';

            data.forEach(m => {
               // Filter
               selFilter.insertAdjacentHTML('beforeend', `<option value="${m.kode}">${m.kode} - ${m.nama}</option>`);
               // Form
               selForm.insertAdjacentHTML('beforeend', `<option value="${m.kode}">${m.kode} - ${m.nama}</option>`);
            });

            // Setelah mapel loading, load soal pertama kali (default all)
            loadDaftarSoal();
            
         }).getAllMapel();
      }

      // 2. TAMPILKAN DAFTAR SOAL
      function loadDaftarSoal() {
        const tbody = document.getElementById('tbody-soal');
        const filter = document.getElementById('filter-mapel').value;
        
        tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center"><i class="fas fa-spinner fa-spin text-indigo-600 text-2xl"></i><br>Mengambil data soal...</td></tr>';

        google.script.run.withSuccessHandler(data => {
          tbody.innerHTML = '';
          if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-400">Tidak ada soal ditemukan.</td></tr>';
            return;
          }

          data.forEach((s, idx) => {
             // Bersihkan HTML tag untuk snippet preview agar tabel rapi
             const tmp = document.createElement("DIV");
             tmp.innerHTML = s.soal;
             let textSnippet = tmp.textContent || tmp.innerText || "";
             if(textSnippet.length > 60) textSnippet = textSnippet.substring(0, 60) + "...";
             if(s.soal.includes('<img')) textSnippet = "ðŸ“· [Gambar] " + textSnippet;

             // Encode data untuk tombol Edit
             const dataStr = encodeURIComponent(JSON.stringify(s));

             tbody.insertAdjacentHTML('beforeend', `
               <tr class="hover:bg-slate-50 transition border-b border-gray-100">
                 <td class="p-4 text-center font-bold text-gray-500">${idx+1}</td>
                 <td class="p-4"><span class="bg-indigo-100 text-indigo-800 text-xs px-2 py-1 rounded font-bold">${s.tipe}</span><br><span class="text-xs text-gray-400">${s.mapel}</span></td>
                 <td class="p-4 text-gray-700 font-medium">${textSnippet}</td>
                 <td class="p-4 font-mono text-sm text-emerald-600 font-bold">${s.kunci || '-'}</td>
                 <td class="p-4 text-right">
                   <button onclick="editSoal('${dataStr}')" class="text-blue-600 hover:text-blue-800 mr-3 tooltip" title="Edit"><i class="fas fa-edit"></i></button>
                   <button onclick="hapusSoalConfirm('${s.id}')" class="text-red-500 hover:text-red-700 tooltip" title="Hapus"><i class="fas fa-trash"></i></button>
                 </td>
               </tr>
             `);
          });
        }).getSoalAdmin(filter);
      }

      // 3. SWITCH VIEW: LIST <-> FORM
      function tampilFormSoal(show) {
        if(show) {
           document.getElementById('bs-list-section').classList.add('hidden');
           document.getElementById('bs-form-section').classList.remove('hidden');
           // Inisialisasi Quill jika belum
           setTimeout(initQuill, 100);
           
           // Mode Tambah Baru: Reset Form
           if(!document.getElementById('soal-id').value) {
             resetFormSoal();
           }
        } else {
           document.getElementById('bs-list-section').classList.remove('hidden');
           document.getElementById('bs-form-section').classList.add('hidden');
           resetFormSoal(); // Bersihkan saat kembali
        }
      }

      function resetFormSoal() {
        document.getElementById('formSoal').reset();
        document.getElementById('soal-id').value = ""; // Kosongkan ID
        document.getElementById('form-soal-title').innerText = "Input Soal Baru";
        document.getElementById('btnSave').innerText = "SIMPAN SOAL";
        if(quillEditor) quillEditor.setContents([]);
        gantiTipeSoal(); // Reset ke PG
      }

      // 4. MODE EDIT: ISI FORM DARI DATA
      function editSoal(str) {
        const s = JSON.parse(decodeURIComponent(str));
        
        // Setup Form
        document.getElementById('soal-id').value = s.id;
        document.getElementById('form-soal-title').innerText = "Edit Soal";
        document.getElementById('btnSave').innerText = "UPDATE SOAL";
        
        // Switch View
        tampilFormSoal(true);

        // Isi Field Dasar
        document.getElementById('soal-mapel-select').value = s.mapel;
        document.getElementById('tipe-soal').value = s.tipe;
        
        // Isi Editor Quill
        quillEditor.clipboard.dangerouslyPasteHTML(s.soal);

        // Trigger Ganti Tipe untuk show area yang benar
        gantiTipeSoal();

        // Parse Opsi JSON
        let opsi = {};
        try { opsi = JSON.parse(s.opsi); } catch(e){}

        // Isi Field Opsi Berdasarkan Tipe
        if (s.tipe === 'PG') {
           document.getElementById('pg-a').value = opsi.A || "";
           document.getElementById('pg-b').value = opsi.B || "";
           document.getElementById('pg-c').value = opsi.C || "";
           document.getElementById('pg-d').value = opsi.D || "";
           document.getElementById('pg-e').value = opsi.E || "";
           document.getElementById('kunci-pg').value = s.kunci;
        } 
        else if (s.tipe === 'ISIAN') {
           document.getElementById('kunci-isian').value = s.kunci;
        }
        else if (s.tipe === 'BS') {
           // Radio Button
           const radios = document.getElementsByName('kunci_bs');
           for(let r of radios) {
              if(r.value === s.kunci) r.checked = true;
           }
        }
        else if (s.tipe === 'COCOK') {
           // Opsi adalah Array object [{k:'..', v:'..'}]
           const container = document.getElementById('container-cocok');
           container.innerHTML = ""; // Bersihkan default row
           
           if(Array.isArray(opsi)) {
             opsi.forEach(pair => {
                const div = document.createElement('div');
                div.className = 'flex gap-2 items-center';
                div.innerHTML = `
                  <input type="text" class="input-std text-sm cocok-kiri" value="${pair.k}" placeholder="Kiri">
                  <i class="fas fa-arrow-right text-gray-400"></i>
                  <input type="text" class="input-std text-sm cocok-kanan" value="${pair.v}" placeholder="Kanan">
                  <button type="button" onclick="this.parentElement.remove()" class="text-red-400 hover:text-red-600 px-2"><i class="fas fa-times"></i></button>
                `;
                container.appendChild(div);
             });
           }
        }
      }

      // 1. Load Data
      function loadUsers() {
        document.getElementById('tbody-users').innerHTML = '<tr><td colspan="5" class="p-6 text-center"><i class="fas fa-spinner fa-spin"></i> Mengambil data...</td></tr>';
        
        google.script.run
          .withSuccessHandler(data => {
            allUsers = data;
            renderUsers(currentTabRole);
          })
          .withFailureHandler(err => Swal.fire('Error', err.message, 'error'))
          .getAllUsers();
      }

      // 2. Tab Filter Logic
      function filterTab(role, btn) {
        currentTabRole = role;
        
        // Update Style Tab
        document.querySelectorAll('.tab-btn').forEach(b => {
           b.classList.remove('bg-indigo-100', 'text-indigo-700');
           b.classList.add('text-gray-500', 'hover:bg-gray-50');
        });
        btn.classList.remove('text-gray-500', 'hover:bg-gray-50');
        btn.classList.add('bg-indigo-100', 'text-indigo-700');

        renderUsers(role);
      }

      // 3. Render Table
      function renderUsers(role) {
        const tbody = document.getElementById('tbody-users');
        tbody.innerHTML = '';

        const filtered = (role === 'all') 
          ? allUsers 
          : allUsers.filter(u => u.role.toLowerCase() === role);

        if (filtered.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="p-6 text-center text-gray-400">Belum ada data user.</td></tr>';
          return;
        }

        filtered.forEach(u => {
           // Role Badge Color
           let badgeColor = 'bg-gray-100 text-gray-800';
           if(u.role.toLowerCase() === 'admin') badgeColor = 'bg-red-100 text-red-800 border-red-200';
           if(u.role.toLowerCase() === 'guru') badgeColor = 'bg-blue-100 text-blue-800 border-blue-200';
           if(u.role.toLowerCase() === 'siswa') badgeColor = 'bg-green-100 text-green-800 border-green-200';

           // Status Badge
           const statusBadge = (u.status === 'Aktif') 
             ? '<span class="px-2 py-0.5 rounded text-xs font-bold bg-green-100 text-green-700">Aktif</span>'
             : '<span class="px-2 py-0.5 rounded text-xs font-bold bg-gray-200 text-gray-500">Nonaktif</span>';

           // Action Buttons (Admin read-only check)
           let btnActions = '';
           if(u.role.toLowerCase() === 'admin') {
              btnActions = `<span class="text-xs text-gray-400 italic"><i class="fas fa-lock"></i> Protected</span>`;
           } else {
              // Kita stringify object user agar bisa dipassing ke fungsi edit
              // Hati-hati dengan kutip, kita encode dulu
              const dataStr = encodeURIComponent(JSON.stringify(u));
              btnActions = `
                <button onclick="editUser('${dataStr}')" class="text-indigo-600 hover:text-indigo-800 mr-3" title="Edit"><i class="fas fa-edit"></i></button>
                <button onclick="hapusUser('${u.id}', '${u.nama}')" class="text-red-500 hover:text-red-700" title="Hapus"><i class="fas fa-trash"></i></button>
              `;
           }

           const html = `
             <tr class="hover:bg-slate-50 transition">
               <td class="p-4 font-semibold text-gray-700">
                 ${u.nama}
               </td>
               <td class="p-4">
                 <div class="flex flex-col">
                   <span class="text-xs text-gray-500 mb-1 font-mono">${u.username}</span>
                   <span class="w-fit px-2 py-0.5 rounded text-[10px] font-bold border uppercase ${badgeColor}">${u.role}</span>
                 </div>
               </td>
               <td class="p-4 text-gray-600">${u.kelas || '-'}</td>
               <td class="p-4">${statusBadge}</td>
               <td class="p-4 text-right">${btnActions}</td>
             </tr>
           `;
           tbody.insertAdjacentHTML('beforeend', html);
        });
      }

      // 4. Modal Logic
      function bukaModalUser() {
        document.getElementById('modal-user').classList.remove('hidden');
        document.getElementById('modal-title').innerText = "Tambah User Baru";
        document.getElementById('u-id').value = ""; // Kosong = Mode Tambah
        // Reset Form
        document.getElementById('u-role').value = "siswa";
        document.getElementById('u-nama').value = "";
        document.getElementById('u-username').value = "";
        document.getElementById('u-password').value = "";
        document.getElementById('u-kelas').value = "";
        document.getElementById('u-status').value = "Aktif";
        toggleKelasInput();
      }

      function tutupModalUser() {
        document.getElementById('modal-user').classList.add('hidden');
      }

      function toggleKelasInput() {
        const r = document.getElementById('u-role').value;
        const div = document.getElementById('div-kelas');
        if(r === 'siswa') div.classList.remove('hidden'); else div.classList.add('hidden');
      }

      function editUser(encodedData) {
        const u = JSON.parse(decodeURIComponent(encodedData));
        document.getElementById('modal-user').classList.remove('hidden');
        document.getElementById('modal-title').innerText = "Edit User";
        
        document.getElementById('u-id').value = u.id;
        document.getElementById('u-role').value = u.role.toLowerCase();
        document.getElementById('u-nama').value = u.nama;
        document.getElementById('u-username').value = u.username;
        document.getElementById('u-password').value = u.password;
        document.getElementById('u-kelas').value = u.kelas;
        document.getElementById('u-status').value = u.status || 'Aktif';
        
        toggleKelasInput();
      }

      function simpanUser(e) {
        e.preventDefault();
        const btn = document.getElementById('btnSimpanUser');
        btn.innerText = "Menyimpan..."; btn.disabled = true;

        const data = {
          id: document.getElementById('u-id').value,
          role: document.getElementById('u-role').value,
          nama: document.getElementById('u-nama').value,
          username: document.getElementById('u-username').value,
          password: document.getElementById('u-password').value,
          kelas: document.getElementById('u-kelas').value,
          status: document.getElementById('u-status').value
        };

        google.script.run
          .withSuccessHandler(res => {
            btn.innerText = "Simpan"; btn.disabled = false;
            if(res.status === 'success') {
              tutupModalUser();
              Swal.fire('Sukses', res.message, 'success');
              loadUsers(); // Reload tabel
            } else {
              Swal.fire('Gagal', res.message, 'error');
            }
          })
          .withFailureHandler(err => {
             btn.innerText = "Simpan"; btn.disabled = false;
             Swal.fire('Error', err.message, 'error');
          })
          .simpanUser(data);
      }

      function hapusUser(id, nama) {
        Swal.fire({
          title: 'Hapus User?',
          text: `Yakin ingin menghapus akun "${nama}"? Data nilai terkait tidak ikut terhapus otomatis.`,
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#d33',
          confirmButtonText: 'Ya, Hapus'
        }).then((result) => {
          if (result.isConfirmed) {
            Swal.showLoading();
            google.script.run
              .withSuccessHandler(res => {
                if(res.status === 'success') {
                  Swal.fire('Terhapus!', res.message, 'success');
                  loadUsers();
                } else {
                  Swal.fire('Gagal', res.message, 'error');
                }
              })
              .hapusUser(id);
          }
        });
      }

      // --- 3. LOGIC INPUT SOAL (Sama seperti sebelumnya, disesuaikan dengan UI baru) ---
      function handleFile(input) {
        if (input.files && input.files[0]) {
          const f = input.files[0];
          const reader = new FileReader();
          reader.onload = (e) => {
             document.getElementById('preview').src = e.target.result;
             document.getElementById('preview').classList.remove('hidden');
             document.getElementById('upload-placeholder').classList.add('hidden');
             filePayload = e.target.result; fileName = f.name;
          }
          reader.readAsDataURL(f);
        }
      }

      // Inisialisasi Quill saat halaman dimuat (atau saat pertama kali buka menu)
      function initQuill() {
        if(!quillEditor) {
          quillEditor = new Quill('#editor-container', {
            theme: 'snow',
            placeholder: 'Tulis pertanyaan disini... (Bisa Paste Gambar)',
            modules: {
              toolbar: [
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                [{ 'script': 'sub'}, { 'script': 'super' }],
                [{ 'color': [] }, { 'background': [] }],
                ['image', 'formula'] // Tombol Image aktif
              ]
            }
          });
        }
      }

      // Fungsi Ganti Tipe Soal (Show/Hide Area)
      function gantiTipeSoal() {
        const tipe = document.getElementById('tipe-soal').value;
        
        // Hide Semua Area Dulu
        document.querySelectorAll('.opsi-area').forEach(el => el.classList.add('hidden'));

        // Show Area yang dipilih
        if (tipe === 'PG') document.getElementById('area-pg').classList.remove('hidden');
        if (tipe === 'ISIAN') document.getElementById('area-isian').classList.remove('hidden');
        if (tipe === 'ESSAY') document.getElementById('area-essay').classList.remove('hidden');
        if (tipe === 'BS') document.getElementById('area-bs').classList.remove('hidden');
        if (tipe === 'COCOK') {
          document.getElementById('area-cocok').classList.remove('hidden');
          if(document.getElementById('container-cocok').children.length === 0) tambahBarisCocok(); // Tambah 1 baris default
        }
      }

      // Fungsi Tambah Baris Pencocokan
      function tambahBarisCocok() {
        const div = document.createElement('div');
        div.className = 'flex gap-2 items-center';
        div.innerHTML = `
          <input type="text" class="input-std text-sm cocok-kiri" placeholder="Premis (Kiri)">
          <i class="fas fa-arrow-right text-gray-400"></i>
          <input type="text" class="input-std text-sm cocok-kanan" placeholder="Jawaban (Kanan)">
          <button type="button" onclick="this.parentElement.remove()" class="text-red-400 hover:text-red-600 px-2"><i class="fas fa-times"></i></button>
        `;
        document.getElementById('container-cocok').appendChild(div);
      }

      // FUNGSI SUBMIT SOAL (Diperbarui)
      function submitSoal(e) {
        e.preventDefault();
        
        const idSoal = document.getElementById('soal-id').value; // Ambil ID jika ada
        const mapel = document.getElementById('soal-mapel-select').value;
        const tipe = document.getElementById('tipe-soal').value;
        const htmlSoal = quillEditor.root.innerHTML;
        
        // Validasi Editor Kosong
        if (quillEditor.getText().trim().length === 0 && !htmlSoal.includes('<img')) {
          return Swal.fire('Error', 'Pertanyaan tidak boleh kosong!', 'warning');
        }

        // ... (LOGIKA PENGAMBILAN OPSI & KUNCI SAMA SEPERTI KODE SEBELUMNYA) ...
        // Copy paste logika if(tipe==='PG')... dst dari kode submitSoal sebelumnya
        // Pastikan variabel 'opsiData' dan 'kunciJawaban' terisi.
        
        // --- COPIED & ADAPTED LOGIC START ---
        let opsiData = {}; let kunciJawaban = "";
        if (tipe === 'PG') {
          opsiData = {
            A: document.getElementById('pg-a').value, B: document.getElementById('pg-b').value,
            C: document.getElementById('pg-c').value, D: document.getElementById('pg-d').value, E: document.getElementById('pg-e').value
          };
          kunciJawaban = document.getElementById('kunci-pg').value;
        } else if (tipe === 'ISIAN') {
          kunciJawaban = document.getElementById('kunci-isian').value;
        } else if (tipe === 'BS') {
          const r = document.querySelector('input[name="kunci_bs"]:checked');
          if(r) kunciJawaban = r.value; else return Swal.fire('Warning','Pilih Benar/Salah','warning');
          opsiData = { A: "BENAR", B: "SALAH" };
        } else if (tipe === 'COCOK') {
          const kiris = document.querySelectorAll('.cocok-kiri');
          const kanans = document.querySelectorAll('.cocok-kanan');
          let pairs = [];
          kiris.forEach((el, idx) => { if(el.value && kanans[idx].value) pairs.push({ k: el.value, v: kanans[idx].value }); });
          if(pairs.length < 2) return Swal.fire('Warning','Minimal 2 pasang','warning');
          opsiData = pairs; kunciJawaban = "COCOK_AUTO";
        } else if (tipe === 'ESSAY') { kunciJawaban = "MANUAL"; }
        // --- LOGIC END ---

        const btn = document.getElementById('btnSave');
        btn.innerText = "MENYIMPAN..."; btn.disabled = true;

        const payload = {
          id: idSoal, // Kirim ID (kosong jika baru, isi jika edit)
          mapel: mapel, tipe: tipe, soal: htmlSoal,
          opsiJson: JSON.stringify(opsiData),
          kunci: kunciJawaban
        };

        google.script.run.withSuccessHandler((res) => {
            btn.innerText = "SIMPAN SOAL"; btn.disabled = false;
            if(res.status === 'success') {
              Swal.fire('Sukses', res.message, 'success');
              tampilFormSoal(false); // Kembali ke List
              loadDaftarSoal(); // Refresh Tabel
            } else { Swal.fire('Gagal', res.message, 'error'); }
        }).withFailureHandler(err => { btn.disabled=false; Swal.fire('Err', err.message, 'error'); }).simpanSoal(payload);
      }

      // 6. HAPUS SOAL
      function hapusSoalConfirm(id) {
        Swal.fire({
          title: 'Hapus Soal?', text: "Data tidak bisa dikembalikan.", icon: 'warning',
          showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Ya, Hapus'
        }).then((result) => {
          if (result.isConfirmed) {
            google.script.run.withSuccessHandler(res => {
               if(res.status === 'success') { loadDaftarSoal(); Swal.fire('Deleted', res.message, 'success'); }
               else Swal.fire('Gagal', res.message, 'error');
            }).hapusSoalDb(id);
          }
        });
      }

      // --- 4. LOGIC SISWA (Disederhanakan untuk integrasi) ---
      function setupSiswaView(user) {
        document.getElementById('login-container').classList.add('hidden');
        document.getElementById('header-nama').innerText = user.nama;
        
        Swal.fire({
          title: 'Masukkan Kode Mapel',
          input: 'text',
          inputPlaceholder: 'Contoh: MTK-X',
          allowOutsideClick: false,
          confirmButtonText: 'Mulai Ujian'
        }).then((result) => {
          if (result.value) {
             startExam(result.value);
          } else { logout(); }
        });
      }

      function startExam(kode) {
        isExamRunning = true;
        enterFullscreen();
        document.getElementById('page-siswa').classList.remove('hidden');
        document.getElementById('header-mapel').innerText = kode;
        startTimer(60); // 60 Menit
        
        google.script.run.withSuccessHandler(res => {
           if(res.status === 'success') {
             daftarSoal = res.data;
             document.getElementById('exam-loading').classList.add('hidden');
             document.getElementById('soal-container').classList.remove('hidden');
             document.getElementById('nav-buttons').classList.remove('hidden');
             document.getElementById('sidebar-nav').classList.remove('hidden'); // Show sidebar for siswa
             renderSoal(0);
           } else {
             Swal.fire('Gagal', res.message, 'warning').then(() => logout());
           }
        }).getSoalUjian(kode);
      }

      // Render Soal Siswa (Sama seperti logika lama)
      function renderSoal(idx) {
        currentIdx = idx;
        const s = daftarSoal[idx];
        document.getElementById('disp-no').innerText = idx + 1;
        document.getElementById('disp-pertanyaan').innerText = s.pertanyaan;
        
        const imgCont = document.getElementById('disp-gambar-container');
        const img = document.getElementById('disp-gambar');
        if(s.gambar) { imgCont.classList.remove('hidden'); img.src = s.gambar; } else { imgCont.classList.add('hidden'); }

        const ops = document.getElementById('disp-opsi'); ops.innerHTML = '';
        ['A','B','C','D','E'].forEach(h => {
           if(s.opsi[h]) {
             const active = jawabanSiswa[s.id] === h ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white hover:bg-gray-50';
             ops.insertAdjacentHTML('beforeend', 
               `<div onclick="pilih('${s.id}','${h}')" class="cursor-pointer border rounded p-3 flex gap-3 items-center ${active}">
                  <span class="font-bold w-6 text-center">${h}</span> <span>${s.opsi[h]}</span>
               </div>`
             );
           }
        });
        renderGrid();
      }
      
      function pilih(id, h) { jawabanSiswa[id] = h; renderSoal(currentIdx); }
      function nextSoal() { if(currentIdx < daftarSoal.length-1) renderSoal(currentIdx+1); }
      function prevSoal() { if(currentIdx > 0) renderSoal(currentIdx-1); }
      function toggleRagu() { 
         const id = daftarSoal[currentIdx].id; 
         if(raguSiswa[id]) delete raguSiswa[id]; else raguSiswa[id] = true; 
         renderSoal(currentIdx); 
      }
      function renderGrid() {
         const g = document.getElementById('grid-nomor'); g.innerHTML='';
         daftarSoal.forEach((s,i) => {
            let c = 'bg-white border text-gray-600';
            if(jawabanSiswa[s.id]) c = 'bg-indigo-600 text-white border-indigo-600';
            if(raguSiswa[s.id]) c = 'bg-yellow-400 text-white border-yellow-400';
            if(i===currentIdx) c += ' ring-2 ring-indigo-300';
            g.insertAdjacentHTML('beforeend', `<button onclick="renderSoal(${i})" class="h-8 w-full rounded font-bold text-xs ${c}">${i+1}</button>`);
         });
      }

      function selesaiUjian() {
         Swal.fire({ title:'Kirim Jawaban?', icon:'question', showCancelButton:true, confirmButtonText:'Ya' }).then(r=>{
            if(r.isConfirmed) kirimJawaban(false);
         });
      }

      function kirimJawaban(auto) {
         isExamRunning = false; clearInterval(timerInterval);
         Swal.showLoading();
         const p = { nama: document.getElementById('header-nama').innerText, mapel: document.getElementById('header-mapel').innerText, jawaban: jawabanSiswa };
         google.script.run.withSuccessHandler(res => {
            if(res.status==='success') Swal.fire('Selesai', `Nilai: ${res.nilai}`, 'success').then(()=>logout());
            else Swal.fire('Gagal', res.message, 'error');
         }).submitUjian(p);
      }

      function startTimer(m) {
         sisaWaktuDetik = m * 60;
         timerInterval = setInterval(() => {
            sisaWaktuDetik--;
            const min = Math.floor(sisaWaktuDetik/60).toString().padStart(2,'0');
            const sec = (sisaWaktuDetik%60).toString().padStart(2,'0');
            document.getElementById('timer-display').innerText = `${min}:${sec}`;
            if(sisaWaktuDetik<=0) { clearInterval(timerInterval); kirimJawaban(true); }
         }, 1000);
      }

      // Security
      function enterFullscreen() { document.documentElement.requestFullscreen().catch(()=>{}); }
      document.addEventListener("visibilitychange", () => { if(isExamRunning && document.hidden) triggerLock("Pindah Tab"); });
      window.addEventListener("blur", () => { if(isExamRunning) triggerLock("Keluar App"); });
      
      function triggerLock(msg) {
         document.getElementById('lock-screen').classList.remove('hidden');
         document.getElementById('lock-reason').innerText = msg;
      }
      function bukaKunci() {
         const t = document.getElementById('token-unlock').value;
         google.script.run.withSuccessHandler(r => {
            if(r.status==='success') { document.getElementById('lock-screen').classList.add('hidden'); enterFullscreen(); }
            else Swal.fire('Salah', 'Token tidak valid', 'error');
         }).verifikasiTokenUnlock(t);
      }

    </script>
  </body>
</html>
